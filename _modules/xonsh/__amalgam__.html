


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>xonsh.__amalgam__ &#8212; xonsh 0.10.0.dev117.dev117 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/numpy_friendly.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/runthis-client.min.js"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../../_static/magic_conch.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
     
        <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://xon.sh/_modules/xonsh/__amalgam__.html"/>

  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../contents.html">xonsh 0.10.0.dev117.dev117 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">xonsh.__amalgam__</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for xonsh.__amalgam__</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Amalgamation of xonsh package, made up of the following modules, in order:</span>

<span class="sd">* cli_utils</span>
<span class="sd">* contexts</span>
<span class="sd">* lazyasd</span>
<span class="sd">* lazyjson</span>
<span class="sd">* platform</span>
<span class="sd">* pretty</span>
<span class="sd">* xontribs_meta</span>
<span class="sd">* codecache</span>
<span class="sd">* lazyimps</span>
<span class="sd">* parser</span>
<span class="sd">* tokenize</span>
<span class="sd">* tools</span>
<span class="sd">* ast</span>
<span class="sd">* color_tools</span>
<span class="sd">* commands_cache</span>
<span class="sd">* completer</span>
<span class="sd">* events</span>
<span class="sd">* foreign_shells</span>
<span class="sd">* jobs</span>
<span class="sd">* jsonutils</span>
<span class="sd">* lexer</span>
<span class="sd">* openpy</span>
<span class="sd">* xontribs</span>
<span class="sd">* ansi_colors</span>
<span class="sd">* diff_history</span>
<span class="sd">* dirstack</span>
<span class="sd">* execer</span>
<span class="sd">* shell</span>
<span class="sd">* style_tools</span>
<span class="sd">* timings</span>
<span class="sd">* xonfig</span>
<span class="sd">* base_shell</span>
<span class="sd">* environ</span>
<span class="sd">* imphooks</span>
<span class="sd">* inspectors</span>
<span class="sd">* aliases</span>
<span class="sd">* main</span>
<span class="sd">* readline_shell</span>
<span class="sd">* tracer</span>
<span class="sd">* dumb_shell</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">modules</span> <span class="k">as</span> <span class="n">_modules</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span> <span class="k">as</span> <span class="n">_ModuleType</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span> <span class="k">as</span> <span class="n">_import_module</span>


<span class="k">class</span> <span class="nc">_LazyModule</span><span class="p">(</span><span class="n">_ModuleType</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">asname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Lazy module &#39;pkg.mod&#39; in package &#39;pkg&#39;.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dct__</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;loaded&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;pkg&#39;</span><span class="p">:</span> <span class="n">pkg</span><span class="p">,</span>  <span class="c1"># pkg</span>
            <span class="s1">&#39;mod&#39;</span><span class="p">:</span> <span class="n">mod</span><span class="p">,</span>  <span class="c1"># pkg.mod</span>
            <span class="s1">&#39;asname&#39;</span><span class="p">:</span> <span class="n">asname</span><span class="p">,</span>  <span class="c1"># alias</span>
            <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">asname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">_modules</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">pkg</span> <span class="k">if</span> <span class="n">asname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mod</span>
            <span class="k">return</span> <span class="n">_modules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">asname</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;__dct__&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_LazyModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dct__</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;loaded&#39;</span><span class="p">]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_modules</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_import_module</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
            <span class="n">glbs</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;pkg&#39;</span><span class="p">]</span>
            <span class="n">asname</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;asname&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">asname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">glbs</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span> <span class="o">=</span> <span class="n">_modules</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">glbs</span><span class="p">[</span><span class="n">asname</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;loaded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># cli_utils</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">small functions to create argparser CLI from functions.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">ap</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;argparse&#39;</span><span class="p">,</span> <span class="s1">&#39;argparse&#39;</span><span class="p">,</span> <span class="s1">&#39;ap&#39;</span><span class="p">)</span>
<span class="n">os</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">,</span> <span class="s1">&#39;os&#39;</span><span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;typing&#39;</span><span class="p">,</span> <span class="s1">&#39;typing&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_get_func_doc</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;Parameters&quot;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Parameters&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_from_index_of</span><span class="p">(</span><span class="n">container</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">container</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">container</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">container</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">_get_param_doc</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;Parameters&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">par_doc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lin</span> <span class="ow">in</span> <span class="n">_from_index_of</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lin</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="n">par_doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">par_doc</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_doc</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span> <span class="n">parameter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the function docstring and return its help content</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func</span>
<span class="sd">        a callable object that holds docstring</span>
<span class="sd">    parameter</span>
<span class="sd">        name of the function parameter to parse doc for</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        doc of the parameter/function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">inspect</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parameter</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_param_doc</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_func_doc</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>


<span class="n">_FUNC_NAME</span> <span class="o">=</span> <span class="s2">&quot;_func_&quot;</span>


<span class="k">def</span> <span class="nf">make_parser</span><span class="p">(</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span>
    <span class="n">subparser</span><span class="p">:</span> <span class="n">ap</span><span class="o">.</span><span class="n">_SubParsersAction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ap.ArgumentParser&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A bare-bones argparse builder from functions&quot;&quot;&quot;</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="n">get_doc</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;formatter_class&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subparser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span><span class="n">_FUNC_NAME</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">stdout</span><span class="p">:</span> <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">stdout</span><span class="p">)}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">subparser</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prog&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">_FUNC_NAME</span><span class="p">:</span> <span class="n">func</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="n">get_doc</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">par</span><span class="p">))</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="o">**</span><span class="n">ns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;call the sub-command selected by user&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">inspect</span>

    <span class="n">func</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="n">_FUNC_NAME</span><span class="p">]</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sign</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># contexts</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Context management tools for xonsh.&quot;&quot;&quot;</span>
<span class="n">sys</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">,</span> <span class="s1">&#39;sys&#39;</span><span class="p">)</span>
<span class="n">textwrap</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;textwrap&#39;</span><span class="p">,</span> <span class="s1">&#39;textwrap&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>

<span class="kn">from</span> <span class="nn">xonsh.built_ins</span> <span class="kn">import</span> <span class="n">XSH</span>


<span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a context manager for obtaining a block of lines without actually</span>
<span class="sd">    executing the block. The lines are accessible as the &#39;lines&#39; attribute.</span>
<span class="sd">    This must be used as a macro.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__xonsh_block__</span> <span class="o">=</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        lines : list of str or None</span>
<span class="sd">            Block lines as if split by str.splitlines(), if available.</span>
<span class="sd">        glbs : Mapping or None</span>
<span class="sd">            Global execution context, ie globals().</span>
<span class="sd">        locs : Mapping or None</span>
<span class="sd">            Local execution context, ie locals().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;macro_block&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">XSH</span><span class="o">.</span><span class="n">builtins</span><span class="o">.</span><span class="n">XonshError</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot; must be entered as a macro!&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_block</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_globals</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_locals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_globals</span><span class="p">:</span>
            <span class="c1"># leave locals as None when it is the same as globals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_locals</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Functor</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a context manager that turns the block into a callable</span>
<span class="sd">    object, bound to the execution context it was created in.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rtn</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args : Sequence of str, optional</span>
<span class="sd">            A tuple of argument names for the functor.</span>
<span class="sd">        kwargs : Mapping of str to values or list of item tuples, optional</span>
<span class="sd">            Keyword argument names and values, if available.</span>
<span class="sd">        rtn : str, optional</span>
<span class="sd">            Name of object to return, if available.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        func : function</span>
<span class="sd">            The underlying function object. This defaults to none and is set</span>
<span class="sd">            after the the block is exited.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rtn</span> <span class="o">=</span> <span class="n">rtn</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro_block</span><span class="p">,</span> <span class="s2">&quot;    &quot;</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>  <span class="c1"># should always be a positive int</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;__xonsh_functor_</span><span class="si">{uid}</span><span class="s2">__&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span>
        <span class="c1"># construct signature string</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">rtn</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">kwstr</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;=None&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">kwstr</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sig</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">kwstr</span>
        <span class="c1"># construct return string</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rtn</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rtn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="s2">&quot;    return &quot;</span> <span class="o">+</span> <span class="n">rtn</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="c1"># construct function string</span>
        <span class="n">fstr</span> <span class="o">=</span> <span class="s2">&quot;def </span><span class="si">{name}</span><span class="s2">(</span><span class="si">{sig}</span><span class="s2">):</span><span class="se">\n</span><span class="si">{body}</span><span class="se">\n</span><span class="si">{rtn}</span><span class="s2">&quot;</span>
        <span class="n">fstr</span> <span class="o">=</span> <span class="n">fstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">sig</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">rtn</span><span class="o">=</span><span class="n">rtn</span><span class="p">)</span>
        <span class="n">glbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glbs</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locs</span>
        <span class="n">execer</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">execer</span>
        <span class="n">execer</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">fstr</span><span class="p">,</span> <span class="n">glbs</span><span class="o">=</span><span class="n">glbs</span><span class="p">,</span> <span class="n">locs</span><span class="o">=</span><span class="n">locs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">locs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">glbs</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">glbs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Functor block could not be found in context.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">func</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches to func.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> block with &#39;None&#39; func not callable&quot;</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">formst</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># lazyasd</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Lazy and self destructive containers for speeding up module import.&quot;&quot;&quot;</span>
<span class="c1"># Copyright 2015-2016, the xonsh developers. All rights reserved.</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated sys</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">types</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;types&#39;</span><span class="p">,</span> <span class="s1">&#39;types&#39;</span><span class="p">)</span>
<span class="n">builtins</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;builtins&#39;</span><span class="p">,</span> <span class="s1">&#39;builtins&#39;</span><span class="p">)</span>
<span class="n">threading</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;threading&#39;</span><span class="p">,</span> <span class="s1">&#39;threading&#39;</span><span class="p">)</span>
<span class="n">importlib</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;importlib&#39;</span><span class="p">,</span> <span class="s1">&#39;importlib&#39;</span><span class="p">)</span>
<span class="n">importlib</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;importlib&#39;</span><span class="p">,</span> <span class="s1">&#39;importlib.util&#39;</span><span class="p">)</span>
<span class="n">cabc</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;collections&#39;</span><span class="p">,</span> <span class="s1">&#39;collections.abc&#39;</span><span class="p">,</span> <span class="s1">&#39;cabc&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated typing</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.1.3&quot;</span>


<span class="k">class</span> <span class="nc">LazyObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lazily loads an object via the load function the first time an</span>
<span class="sd">        attribute is accessed. Once loaded it will replace itself in the</span>
<span class="sd">        provided context (typically the globals of the call site) with the</span>
<span class="sd">        given name.</span>

<span class="sd">        For example, you can prevent the compilation of a regular expression</span>
<span class="sd">        until it is actually used::</span>

<span class="sd">            DOT = LazyObject((lambda: re.compile(&#39;.&#39;)), globals(), &#39;DOT&#39;)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        load : function with no arguments</span>
<span class="sd">            A loader function that performs the actual object construction.</span>
<span class="sd">        ctx : Mapping</span>
<span class="sd">            Context to replace the LazyObject instance in</span>
<span class="sd">            with the object returned by load().</span>
<span class="sd">        name : str</span>
<span class="sd">            Name in the context to give the loaded object. This *should*</span>
<span class="sd">            be the name on the LHS of the assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lasdo</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loaded&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span> <span class="n">load</span><span class="p">,</span> <span class="s2">&quot;ctx&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_lazy_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasdo</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;load&quot;</span><span class="p">]()</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ctx&quot;</span><span class="p">][</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;_lasdo&quot;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;_lazy_obj&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">yield from</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="o">&lt;</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="o">&lt;=</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="o">!=</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="o">&gt;</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="o">&gt;=</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="o">|</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lazy_obj</span><span class="p">())</span>


<span class="n">RT</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;RT&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lazyobject</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">RT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RT</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Decorator for constructing lazy objects from a function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LazyObject</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># type: ignore</span>


<span class="k">class</span> <span class="nc">LazyDict</span><span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loaders</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary like object that lazily loads its values from an initial</span>
<span class="sd">        dict of key-loader function pairs.  Each key is loaded when its value</span>
<span class="sd">        is first accessed. Once fully loaded, this object will replace itself</span>
<span class="sd">        in the provided context (typically the globals of the call site) with</span>
<span class="sd">        the given name.</span>

<span class="sd">        For example, you can prevent the compilation of a bunch of regular</span>
<span class="sd">        expressions until they are actually used::</span>

<span class="sd">            RES = LazyDict({</span>
<span class="sd">                    &#39;dot&#39;: lambda: re.compile(&#39;.&#39;),</span>
<span class="sd">                    &#39;all&#39;: lambda: re.compile(&#39;.*&#39;),</span>
<span class="sd">                    &#39;two&#39;: lambda: re.compile(&#39;..&#39;),</span>
<span class="sd">                    }, globals(), &#39;RES&#39;)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loaders : Mapping of keys to functions with no arguments</span>
<span class="sd">            A mapping of loader function that performs the actual value</span>
<span class="sd">            construction upon access.</span>
<span class="sd">        ctx : Mapping</span>
<span class="sd">            Context to replace the LazyDict instance in</span>
<span class="sd">            with the the fully loaded mapping.</span>
<span class="sd">        name : str</span>
<span class="sd">            Name in the context to give the loaded mapping. This *should*</span>
<span class="sd">            be the name on the LHS of the assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span> <span class="o">=</span> <span class="n">loaders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="n">ctx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">loaders</span><span class="p">)()</span>  <span class="c1"># make sure to return the same type</span>

    <span class="k">def</span> <span class="nf">_destruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pop will raise a key error for us</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="n">loader</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_destruct</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_destruct</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_destruct</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loaders</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lazydict</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for constructing lazy dicts from a function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LazyDict</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LazyBool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean like object that lazily computes it boolean value when it is</span>
<span class="sd">        first asked. Once loaded, this result will replace itself</span>
<span class="sd">        in the provided context (typically the globals of the call site) with</span>
<span class="sd">        the given name.</span>

<span class="sd">        For example, you can prevent the complex boolean until it is actually</span>
<span class="sd">        used::</span>

<span class="sd">            ALIVE = LazyDict(lambda: not DEAD, globals(), &#39;ALIVE&#39;)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        load : function with no arguments</span>
<span class="sd">            A loader function that performs the actual boolean evaluation.</span>
<span class="sd">        ctx : Mapping</span>
<span class="sd">            Context to replace the LazyBool instance in</span>
<span class="sd">            with the the fully loaded mapping.</span>
<span class="sd">        name : str</span>
<span class="sd">            Name in the context to give the loaded mapping. This *should*</span>
<span class="sd">            be the name on the LHS of the assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load</span> <span class="o">=</span> <span class="n">load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="n">ctx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>
        <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">lazybool</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for constructing lazy booleans from a function.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LazyBool</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># Background module loaders</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">BackgroundModuleProxy</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Proxy object for modules loaded in the background that block attribute</span>
<span class="sd">    access until the module is loaded..</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dct__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loaded&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;modname&quot;</span><span class="p">:</span> <span class="n">modname</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">passthrough</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;__dct__&quot;</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">,</span> <span class="s2">&quot;__spec__&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">passthrough</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dct__</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;modname&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delay_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">BackgroundModuleProxy</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">delay_types</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
            <span class="n">dct</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># some modules may do construction after import, give them a second</span>
        <span class="n">stall</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">stall</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">stall</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BackgroundModuleLoader</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thread to load modules in the background.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">replacements</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="n">package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span> <span class="o">=</span> <span class="n">replacements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># wait for other modules to stop being imported</span>
        <span class="c1"># We assume that module loading is finished when sys.modules doesn&#39;t</span>
        <span class="c1"># get longer in 5 consecutive 1ms waiting steps</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="n">last</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">new</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="c1"># now import module properly</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">resolve_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">],</span> <span class="n">BackgroundModuleProxy</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">targname</span><span class="p">,</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">targname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="n">targmod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">targname</span><span class="p">]</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">targmod</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_module_in_background</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replacements</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Entry point for loading modules in background thread.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Module name to load in background thread.</span>
<span class="sd">    package : str or None, optional</span>
<span class="sd">        Package name, has the same meaning as in importlib.import_module().</span>
<span class="sd">    debug : str, optional</span>
<span class="sd">        Debugging symbol name to look up in the environment.</span>
<span class="sd">    env : Mapping or None, optional</span>
<span class="sd">        Environment this will default to __xonsh__.env, if available, and</span>
<span class="sd">        os.environ otherwise.</span>
<span class="sd">    replacements : Mapping or None, optional</span>
<span class="sd">        Dictionary mapping fully qualified module names (eg foo.bar.baz) that</span>
<span class="sd">        import the lazily loaded module, with the variable name in that</span>
<span class="sd">        module. For example, suppose that foo.bar imports module a as b,</span>
<span class="sd">        this dict is then {&#39;foo.bar&#39;: &#39;b&#39;}.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    module : ModuleType</span>
<span class="sd">        This is either the original module that is found in sys.modules or</span>
<span class="sd">        a proxy module that will block until delay attribute access until the</span>
<span class="sd">        module is fully loaded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modname</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">resolve_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xonsh_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="s2">&quot;__xonsh__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">if</span> <span class="n">xonsh_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">xonsh_obj</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mod</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span> <span class="o">=</span> <span class="n">BackgroundModuleProxy</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
    <span class="n">BackgroundModuleLoader</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">replacements</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="k">return</span> <span class="n">proxy</span>

<span class="c1">#</span>
<span class="c1"># lazyjson</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Implements a lazy JSON file class that wraps around json data.&quot;&quot;&quot;</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;io&#39;</span><span class="p">,</span> <span class="s1">&#39;io&#39;</span><span class="p">)</span>
<span class="n">weakref</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;weakref&#39;</span><span class="p">,</span> <span class="s1">&#39;weakref&#39;</span><span class="p">)</span>
<span class="n">contextlib</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;contextlib&#39;</span><span class="p">,</span> <span class="s1">&#39;contextlib&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ujson</span> <span class="k">as</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>  <span class="c1"># type: ignore</span>


<span class="k">def</span> <span class="nf">_to_json_with_size</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>  <span class="c1"># size in bytes</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">sort_keys</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">s_k</span><span class="p">,</span> <span class="n">o_k</span><span class="p">,</span> <span class="n">n_k</span><span class="p">,</span> <span class="n">size_k</span> <span class="o">=</span> <span class="n">_to_json_with_size</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span>
            <span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">s_k</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="n">n_k</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">s_v</span><span class="p">,</span> <span class="n">o_v</span><span class="p">,</span> <span class="n">n_v</span><span class="p">,</span> <span class="n">size_v</span> <span class="o">=</span> <span class="n">_to_json_with_size</span><span class="p">(</span>
                <span class="n">val</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span>
            <span class="p">)</span>
            <span class="n">o</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">o_v</span>
            <span class="n">size</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_v</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">s_v</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="n">n_v</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">o</span><span class="p">[</span><span class="s2">&quot;__total__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">size</span><span class="p">[</span><span class="s2">&quot;__total__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">s_x</span><span class="p">,</span> <span class="n">o_x</span><span class="p">,</span> <span class="n">n_x</span><span class="p">,</span> <span class="n">size_x</span> <span class="o">=</span> <span class="n">_to_json_with_size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">)</span>
            <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o_x</span><span class="p">)</span>
            <span class="n">size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">size_x</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">s_x</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="n">n_x</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">size</span>


<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an index for a JSON file.&quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">json_obj</span> <span class="o">=</span> <span class="n">_to_json_with_size</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">)</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;offsets&quot;</span><span class="p">],</span> <span class="n">_</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_obj</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">idx</span>


<span class="n">JSON_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{{&quot;locs&quot;: [</span><span class="si">{iloc:&gt;10}</span><span class="s2">, </span><span class="si">{ilen:&gt;10}</span><span class="s2">, </span><span class="si">{dloc:&gt;10}</span><span class="s2">, </span><span class="si">{dlen:&gt;10}</span><span class="s2">],</span>
<span class="s2"> &quot;index&quot;: </span><span class="si">{index}</span><span class="s2">,</span>
<span class="s2"> &quot;data&quot;: </span><span class="si">{data}</span><span class="s2"></span>
<span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dumps an object to JSON with an index.&quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">)</span>
    <span class="n">jdx</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">)</span>
    <span class="n">iloc</span> <span class="o">=</span> <span class="mi">69</span>
    <span class="n">ilen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jdx</span><span class="p">)</span>
    <span class="n">dloc</span> <span class="o">=</span> <span class="n">iloc</span> <span class="o">+</span> <span class="n">ilen</span> <span class="o">+</span> <span class="mi">11</span>
    <span class="n">dlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">JSON_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">jdx</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">iloc</span><span class="o">=</span><span class="n">iloc</span><span class="p">,</span> <span class="n">ilen</span><span class="o">=</span><span class="n">ilen</span><span class="p">,</span> <span class="n">dloc</span><span class="o">=</span><span class="n">dloc</span><span class="p">,</span> <span class="n">dlen</span><span class="o">=</span><span class="n">dlen</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">ljdump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dumps an object to JSON file.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LJNode</span><span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A proxy node for JSON nodes. Acts as both sequence and mapping.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        offsets : dict, list, or int</span>
<span class="sd">            offsets of corresponding data structure, in bytes</span>
<span class="sd">        sizes : dict, list, or int</span>
<span class="sd">            sizes of corresponding data structure, in bytes</span>
<span class="sd">        root : weakref.proxy of LazyJSON</span>
<span class="sd">            weakref back to root node, which should be a LazyJSON object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span> <span class="o">=</span> <span class="n">sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_mapping</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_sequence</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># recall that for maps, the &#39;__total__&#39; key is added and for</span>
        <span class="c1"># sequences the last element represents the total size/offset.</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the Python data structure represented by the node.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mapping</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="s2">&quot;__total__&quot;</span><span class="p">]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;__total__&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sequence</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_or_node</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_or_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dloc</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">LJNode</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;incorrect types for offset node&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_getitem_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;__total__&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;&quot;__total__&quot; is a special LazyJSON key!&#39;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_or_node</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getitem_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_or_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_or_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;only integer indexing available&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rtn</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mapping</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_mapping</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sequence</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_sequence</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="n">rtn</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mapping</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="s2">&quot;__total__&quot;</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="nb">iter</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sequence</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_or_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">LazyJSON</span><span class="p">(</span><span class="n">LJNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a lazy json file. Can be used like a normal Python</span>
<span class="sd">    dict or list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">reopen</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : file handle or str</span>
<span class="sd">            JSON file to open.</span>
<span class="sd">        reopen : bool, optional</span>
<span class="sd">            Whether new file handle should be opened for each load.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reopen</span> <span class="o">=</span> <span class="n">reopen</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reopen</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_mapping</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_sequence</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the file handle, if appropriate.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reopen</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reopen</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">f</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span>

    <span class="k">def</span> <span class="nf">_load_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads the index from the start of the file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># read in the location data</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iloc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dloc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlen</span> <span class="o">=</span> <span class="n">locs</span>
            <span class="c1"># read in the index</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iloc</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ilen</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;offsets&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">#</span>
<span class="c1"># platform</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Module for platform-specific constants and implementations, as well as</span>
<span class="sd">compatibility layers to make use of the &#39;best&#39; implementation available</span>
<span class="sd">on a platform.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated sys</span>
<span class="n">ctypes</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;ctypes&#39;</span><span class="p">,</span> <span class="s1">&#39;ctypes&#39;</span><span class="p">)</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">)</span>
<span class="n">pathlib</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;pathlib&#39;</span><span class="p">,</span> <span class="s1">&#39;pathlib&#39;</span><span class="p">)</span>
<span class="n">platform</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">)</span>
<span class="n">functools</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;functools&#39;</span><span class="p">,</span> <span class="s1">&#39;functools&#39;</span><span class="p">)</span>
<span class="n">subprocess</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;subprocess&#39;</span><span class="p">,</span> <span class="s1">&#39;subprocess&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="c1"># amalgamated importlib.util</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="n">FD_STDIN</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">FD_STDOUT</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FD_STDERR</span> <span class="o">=</span> <span class="mi">2</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">distro</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">distro</span> <span class="k">as</span> <span class="nn">d</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="c1">#</span>
<span class="c1"># OS</span>
<span class="c1">#</span>
<span class="n">ON_DARWIN</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_DARWIN&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if executed on a Darwin platform, else ``False``. &quot;&quot;&quot;</span>
<span class="n">ON_LINUX</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Linux&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_LINUX&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if executed on a Linux platform, else ``False``. &quot;&quot;&quot;</span>
<span class="n">ON_WINDOWS</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_WINDOWS&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if executed on a native Windows platform, else ``False``. &quot;&quot;&quot;</span>
<span class="n">ON_CYGWIN</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;cygwin&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_CYGWIN&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if executed on a Cygwin Windows platform, else ``False``. &quot;&quot;&quot;</span>
<span class="n">ON_MSYS</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;msys&quot;</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_MSYS&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if executed on a MSYS Windows platform, else ``False``. &quot;&quot;&quot;</span>
<span class="n">ON_POSIX</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;posix&quot;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_POSIX&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if executed on a POSIX-compliant platform, else ``False``. &quot;&quot;&quot;</span>
<span class="n">ON_FREEBSD</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;freebsd&quot;</span><span class="p">)),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_FREEBSD&quot;</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if on a FreeBSD operating system, else ``False``.&quot;&quot;&quot;</span>
<span class="n">ON_DRAGONFLY</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dragonfly&quot;</span><span class="p">)),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_DRAGONFLY&quot;</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if on a DragonFly BSD operating system, else ``False``.&quot;&quot;&quot;</span>
<span class="n">ON_NETBSD</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;netbsd&quot;</span><span class="p">)),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_NETBSD&quot;</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if on a NetBSD operating system, else ``False``.&quot;&quot;&quot;</span>
<span class="n">ON_OPENBSD</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;openbsd&quot;</span><span class="p">)),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;ON_OPENBSD&quot;</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if on a OpenBSD operating system, else ``False``.&quot;&quot;&quot;</span>
<span class="n">IN_APPIMAGE</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;APPIMAGE&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s2">&quot;APPDIR&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;IN_APPIMAGE&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if in AppImage, else ``False``.&quot;&quot;&quot;</span>


<span class="nd">@lazybool</span>
<span class="k">def</span> <span class="nf">ON_BSD</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;``True`` if on a BSD operating system, else ``False``.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_FREEBSD</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_NETBSD</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_OPENBSD</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_DRAGONFLY</span><span class="p">)</span>


<span class="nd">@lazybool</span>
<span class="k">def</span> <span class="nf">ON_BEOS</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;True if we are on BeOS or Haiku.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;beos5&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;haiku1&quot;</span>


<span class="nd">@lazybool</span>
<span class="k">def</span> <span class="nf">ON_WSL</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;True if we are on Windows Subsystem for Linux (WSL)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;microsoft&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>


<span class="c1">#</span>
<span class="c1"># Python &amp; packages</span>
<span class="c1">#</span>

<span class="n">PYTHON_VERSION_INFO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot; Version of Python interpreter as three-value tuple. &quot;&quot;&quot;</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">PYTHON_VERSION_INFO_BYTES</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The python version info tuple in a canonical bytes form.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>


<span class="n">ON_ANACONDA</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;conda-meta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;ON_ANACONDA&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot; ``True`` if executed in an Anaconda instance, else ``False``. &quot;&quot;&quot;</span>
<span class="n">CAN_RESIZE_WINDOW</span> <span class="o">=</span> <span class="n">LazyBool</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;SIGWINCH&quot;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;CAN_RESIZE_WINDOW&quot;</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;``True`` if we can resize terminal window, as provided by the presense of</span>
<span class="sd">signal.SIGWINCH, else ``False``.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="nd">@lazybool</span>
<span class="k">def</span> <span class="nf">HAS_PYGMENTS</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;``True`` if `pygments` is available, else ``False``.&quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;pygments&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pygments_version</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;pygments.__version__ version if available, else None.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">HAS_PYGMENTS</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pygments</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">__version__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">v</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pygments_version_info</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns `pygments`&#39;s version as tuple of integers.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">HAS_PYGMENTS</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pygments_version</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&lt;&gt;+-=.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">has_prompt_toolkit</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Tests if the `prompt_toolkit` is available.&quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ptk_version</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns `prompt_toolkit.__version__` if available, else ``None``.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">has_prompt_toolkit</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">prompt_toolkit</span>

        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prompt_toolkit</span><span class="p">,</span> <span class="s2">&quot;__version__&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;0.57&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ptk_version_info</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns `prompt_toolkit`&#39;s version as tuple of integers.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">has_prompt_toolkit</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ptk_version</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&lt;&gt;+-=.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="n">minimum_required_ptk_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Minimum version of prompt-toolkit supported by Xonsh&quot;&quot;&quot;</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ptk_above_min_supported</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ptk_version_info</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ptk_version_info</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">minimum_required_ptk_version</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">win_ansi_support</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">prompt_toolkit.utils</span> <span class="kn">import</span> <span class="n">is_windows_vt100_supported</span><span class="p">,</span> <span class="n">is_conemu_ansi</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">is_conemu_ansi</span><span class="p">()</span> <span class="ow">or</span> <span class="n">is_windows_vt100_supported</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ptk_below_max_supported</span><span class="p">():</span>
    <span class="n">ptk_max_version_cutoff</span> <span class="o">=</span> <span class="p">(</span><span class="mi">99999</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># currently, no limit.</span>
    <span class="k">return</span> <span class="n">ptk_version_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ptk_max_version_cutoff</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">best_shell_type</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">xonsh.built_ins</span> <span class="kn">import</span> <span class="n">XSH</span>

    <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TERM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;dumb&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;dumb&quot;</span>
    <span class="k">if</span> <span class="n">has_prompt_toolkit</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;prompt_toolkit&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;readline&quot;</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">is_readline_available</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Checks if readline is available to import.&quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;readline&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">seps</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;String of all path separators.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">altsep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">altsep</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">pathsplit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a safe version of os.path.split(), which does not work on input</span>
<span class="sd">    without a drive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># lazy object seps does not get initialized when n is zero</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seps</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">seps</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pre</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span>


<span class="k">def</span> <span class="nf">pathbasename</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a safe version of os.path.basename(), which does not work on</span>
<span class="sd">    input without a drive.  This version does.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pathsplit</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">expanduser</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Dispatches to the correct platform-dependent expanduser() function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">windows_expanduser</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span>


<span class="k">def</span> <span class="nf">windows_expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Windows-specific expanduser() function for xonsh. This is needed</span>
<span class="sd">    since os.path.expanduser() does not check on Windows if the user actually</span>
<span class="sd">    exists. This restricts expanding the &#39;~&#39; if it is not followed by a</span>
<span class="sd">    separator. That is only &#39;~/&#39; and &#39;~\&#39; are expanded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">seps</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span>


<span class="c1"># termios tc(get|set)attr indexes.</span>
<span class="n">IFLAG</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">OFLAG</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">CFLAG</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">LFLAG</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ISPEED</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">OSPEED</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">CC</span> <span class="o">=</span> <span class="mi">6</span>


<span class="c1">#</span>
<span class="c1"># Dev release info</span>
<span class="c1">#</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">githash</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns a tuple contains two strings: the hash and the date.&quot;&quot;&quot;</span>
    <span class="n">install_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">githash_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/dev.githash&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">install_base</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">githash_file</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">sha</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">date_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">githash_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sha</span><span class="p">,</span> <span class="n">date_</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">sha</span><span class="p">,</span> <span class="n">date_</span>


<span class="c1">#</span>
<span class="c1"># Encoding</span>
<span class="c1">#</span>

<span class="n">DEFAULT_ENCODING</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot; Default string encoding. &quot;&quot;&quot;</span>


<span class="c1">#</span>
<span class="c1"># Linux distro</span>
<span class="c1">#</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">linux_distro</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The id of the Linux distribution running on, possibly &#39;unknown&#39;.</span>
<span class="sd">    None on non-Linux platforms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_LINUX</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">distro</span><span class="p">:</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="n">distro</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;-ARCH-&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">():</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="s2">&quot;arch&quot;</span>  <span class="c1"># that&#39;s the only one we need to know for now</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">ld</span>


<span class="c1">#</span>
<span class="c1"># Windows</span>
<span class="c1">#</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">git_for_windows_path</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the path to git for windows, if available and None otherwise.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">winreg</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">OpenKey</span><span class="p">(</span><span class="n">winreg</span><span class="o">.</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> <span class="s2">&quot;SOFTWARE</span><span class="se">\\</span><span class="s2">GitForWindows&quot;</span><span class="p">)</span>
        <span class="n">gfwp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">QueryValueEx</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;InstallPath&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">gfwp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">gfwp</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">windows_bash_command</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Determines the command for Bash on windows.&quot;&quot;&quot;</span>
    <span class="c1"># Check that bash is on path otherwise try the default directory</span>
    <span class="c1"># used by Git for windows</span>
    <span class="kn">from</span> <span class="nn">xonsh.built_ins</span> <span class="kn">import</span> <span class="n">XSH</span>

    <span class="n">wbc</span> <span class="o">=</span> <span class="s2">&quot;bash&quot;</span>
    <span class="n">cmd_cache</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">commands_cache</span>
    <span class="n">bash_on_path</span> <span class="o">=</span> <span class="n">cmd_cache</span><span class="o">.</span><span class="n">lazy_locate_binary</span><span class="p">(</span><span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="n">ignore_alias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bash_on_path</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="n">bash_on_path</span><span class="p">,</span> <span class="s2">&quot;--version&quot;</span><span class="p">],</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
            <span class="n">bash_works</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if Bash is from the &quot;Windows Subsystem for Linux&quot; (WSL)</span>
            <span class="c1"># which can&#39;t be used by xonsh foreign-shell/completer</span>
            <span class="n">bash_works</span> <span class="o">=</span> <span class="n">out</span> <span class="ow">and</span> <span class="s2">&quot;pc-linux-gnu&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">bash_works</span><span class="p">:</span>
            <span class="n">wbc</span> <span class="o">=</span> <span class="n">bash_on_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gfwp</span> <span class="o">=</span> <span class="n">git_for_windows_path</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gfwp</span><span class="p">:</span>
                <span class="n">bashcmd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gfwp</span><span class="p">,</span> <span class="s2">&quot;bin</span><span class="se">\\</span><span class="s2">bash.exe&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">bashcmd</span><span class="p">):</span>
                    <span class="n">wbc</span> <span class="o">=</span> <span class="n">bashcmd</span>
    <span class="k">return</span> <span class="n">wbc</span>


<span class="c1">#</span>
<span class="c1"># Environment variables defaults</span>
<span class="c1">#</span>

<span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">OSEnvironCasePreserving</span><span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Case-preserving wrapper for os.environ on Windows.</span>
<span class="sd">        It uses nt.environ to get the correct cased keys on</span>
<span class="sd">        initialization. It also preserves the case of any variables</span>
<span class="sd">        add after initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">nt</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nt</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Ensure that the case sensitive map of the keys are</span>
<span class="sd">            in sync with os.environ</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">envkeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">envkeys</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">envkeys</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span>

        <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
                <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">getkey_actual_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upperkeys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">os_environ</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This dispatches to the correct, case-sensitive version of os.environ.</span>
<span class="sd">    This is mainly a problem for Windows. See #2024 for more details.</span>
<span class="sd">    This can probably go away once support for Python v3.5 or v3.6 is</span>
<span class="sd">    dropped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OSEnvironCasePreserving</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bash_command</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Determines the command for Bash on the current platform.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">windows_bash_command</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="s2">&quot;bash&quot;</span>
    <span class="k">return</span> <span class="n">bc</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">BASH_COMPLETIONS_DEFAULT</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A possibly empty tuple with default paths to Bash completions known for</span>
<span class="sd">    the current platform.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_LINUX</span> <span class="ow">or</span> <span class="n">ON_CYGWIN</span> <span class="ow">or</span> <span class="n">ON_MSYS</span><span class="p">:</span>
        <span class="n">bcd</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;/usr/share/bash-completion/bash_completion&quot;</span><span class="p">,)</span>
    <span class="k">elif</span> <span class="n">ON_DARWIN</span><span class="p">:</span>
        <span class="n">bcd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;/usr/local/share/bash-completion/bash_completion&quot;</span><span class="p">,</span>  <span class="c1"># v2.x</span>
            <span class="s2">&quot;/usr/local/etc/bash_completion&quot;</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># v1.x</span>
    <span class="k">elif</span> <span class="n">ON_WINDOWS</span> <span class="ow">and</span> <span class="n">git_for_windows_path</span><span class="p">():</span>
        <span class="n">bcd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">git_for_windows_path</span><span class="p">(),</span> <span class="s2">&quot;usr</span><span class="se">\\</span><span class="s2">share</span><span class="se">\\</span><span class="s2">bash-completion</span><span class="se">\\</span><span class="s2">bash_completion&quot;</span>
            <span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">git_for_windows_path</span><span class="p">(),</span>
                <span class="s2">&quot;mingw64</span><span class="se">\\</span><span class="s2">share</span><span class="se">\\</span><span class="s2">git</span><span class="se">\\</span><span class="s2">completion</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="s2">&quot;git-completion.bash&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bcd</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">return</span> <span class="n">bcd</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">PATH_DEFAULT</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_LINUX</span> <span class="ow">or</span> <span class="n">ON_CYGWIN</span> <span class="ow">or</span> <span class="n">ON_MSYS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">linux_distro</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;arch&quot;</span><span class="p">:</span>
            <span class="n">pd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;/usr/local/sbin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/local/bin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/bin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/bin/site_perl&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/bin/vendor_perl&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/bin/core_perl&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/bin&quot;</span><span class="p">),</span>
                <span class="s2">&quot;/usr/local/sbin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/local/bin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/sbin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/bin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/sbin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/bin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/games&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/usr/local/games&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">ON_DARWIN</span><span class="p">:</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;/usr/local/bin&quot;</span><span class="p">,</span> <span class="s2">&quot;/usr/bin&quot;</span><span class="p">,</span> <span class="s2">&quot;/bin&quot;</span><span class="p">,</span> <span class="s2">&quot;/usr/sbin&quot;</span><span class="p">,</span> <span class="s2">&quot;/sbin&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">winreg</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">OpenKey</span><span class="p">(</span>
            <span class="n">winreg</span><span class="o">.</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;SYSTEM\CurrentControlSet\Control\Session Manager\Environment&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">winreg</span><span class="o">.</span><span class="n">QueryValueEx</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;Path&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span>


<span class="c1">#</span>
<span class="c1"># libc</span>
<span class="c1">#</span>
<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">LIBC</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The platform dependent libc implementation.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">ctypes</span>
    <span class="k">if</span> <span class="n">ON_DARWIN</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ctypes.util</span>

        <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">ON_CYGWIN</span><span class="p">:</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;cygwin1.dll&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ON_MSYS</span><span class="p">:</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;msys-2.0.dll&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ON_FREEBSD</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;libc.so.7&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">ON_BSD</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;libc.so&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># OS X; can&#39;t use ctypes.util.find_library because that creates</span>
            <span class="c1"># a new process on Linux, which is undesirable.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;libc.dylib&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">libc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">ON_POSIX</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;libc.so&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># Debian and derivatives do the wrong thing because /usr/lib/libc.so</span>
            <span class="c1"># is a GNU ld script rather than an ELF object. To get around this, we</span>
            <span class="c1"># have to be more specific.</span>
            <span class="c1"># We don&#39;t want to use ctypes.util.find_library because that creates a</span>
            <span class="c1"># new process on Linux. We also don&#39;t want to try too hard because at</span>
            <span class="c1"># this point we&#39;re already pretty sure this isn&#39;t Linux.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;libc.so.6&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">libc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">libc</span><span class="p">,</span> <span class="s2">&quot;sysinfo&quot;</span><span class="p">):</span>
            <span class="c1"># Not Linux.</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">,</span> <span class="s2">&quot;windll&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="p">,</span> <span class="s2">&quot;kernel32&quot;</span><span class="p">):</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Windows CE uses the cdecl calling convention.</span>
                <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;coredll.lib&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                <span class="n">libc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">ON_BEOS</span><span class="p">:</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s2">&quot;libroot.so&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">libc</span>

<span class="c1">#</span>
<span class="c1"># pretty</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Python advanced pretty printer.  This pretty printer is intended to</span>
<span class="sd">replace the old `pprint` python module which does not allow developers</span>
<span class="sd">to provide their own pretty print callbacks.</span>

<span class="sd">This module is based on ruby&#39;s `prettyprint.rb` library by `Tanaka Akira`.</span>

<span class="sd">The following implementations were forked from the IPython project:</span>
<span class="sd">* Copyright (c) 2008-2014, IPython Development Team</span>
<span class="sd">* Copyright (C) 2001-2007 Fernando Perez &lt;fperez@colorado.edu&gt;</span>
<span class="sd">* Copyright (c) 2001, Janko Hauser &lt;jhauser@zscout.de&gt;</span>
<span class="sd">* Copyright (c) 2001, Nathaniel Gray &lt;n8gray@caltech.edu&gt;</span>

<span class="sd">Example Usage</span>
<span class="sd">-------------</span>

<span class="sd">To directly print the representation of an object use `pprint`::</span>

<span class="sd">    from pretty import pretty_print</span>
<span class="sd">    pretty_pprint(complex_object)</span>

<span class="sd">To get a string of the output use `pretty`::</span>

<span class="sd">    from pretty import pretty</span>
<span class="sd">    string = pretty(complex_object)</span>


<span class="sd">Extending</span>
<span class="sd">---------</span>

<span class="sd">The pretty library allows developers to add pretty printing rules for their</span>
<span class="sd">own objects.  This process is straightforward.  All you have to do is to</span>
<span class="sd">add a `_repr_pretty_` method to your object and call the methods on the</span>
<span class="sd">pretty printer passed::</span>

<span class="sd">    class MyObject(object):</span>

<span class="sd">        def _repr_pretty_(self, p, cycle):</span>
<span class="sd">            ...</span>

<span class="sd">Here is an example implementation of a `_repr_pretty_` method for a list</span>
<span class="sd">subclass::</span>

<span class="sd">    class MyList(list):</span>

<span class="sd">        def _repr_pretty_(self, p, cycle):</span>
<span class="sd">            if cycle:</span>
<span class="sd">                p.text(&#39;MyList(...)&#39;)</span>
<span class="sd">            else:</span>
<span class="sd">                with p.group(8, &#39;MyList([&#39;, &#39;])&#39;):</span>
<span class="sd">                    for idx, item in enumerate(self):</span>
<span class="sd">                        if idx:</span>
<span class="sd">                            p.text(&#39;,&#39;)</span>
<span class="sd">                            p.breakable()</span>
<span class="sd">                        p.pretty(item)</span>

<span class="sd">The `cycle` parameter is `True` if pretty detected a cycle.  You *have* to</span>
<span class="sd">react to that or the result is an infinite loop.  `p.text()` just adds</span>
<span class="sd">non breaking text to the output, `p.breakable()` either adds a whitespace</span>
<span class="sd">or breaks here.  If you pass it an argument it&#39;s used instead of the</span>
<span class="sd">default space.  `p.pretty` prettyprints another object using the pretty print</span>
<span class="sd">method.</span>

<span class="sd">The first parameter to the `group` function specifies the extra indentation</span>
<span class="sd">of the next line.  In this example the next item will either be on the same</span>
<span class="sd">line (if the items are short enough) or aligned with the right edge of the</span>
<span class="sd">opening bracket of `MyList`.</span>

<span class="sd">If you just want to indent something you can use the group function</span>
<span class="sd">without open / close parameters.  You can also use this code::</span>

<span class="sd">    with p.indent(2):</span>
<span class="sd">        ...</span>


<span class="sd">:copyright: 2007 by Armin Ronacher.</span>
<span class="sd">            Portions (c) 2009 by Robert Kern.</span>
<span class="sd">:license: BSD License.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated io</span>
<span class="n">re</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;re&#39;</span><span class="p">,</span> <span class="s1">&#39;re&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated types</span>
<span class="n">datetime</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated contextlib</span>
<span class="n">collections</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;collections&#39;</span><span class="p">,</span> <span class="s1">&#39;collections&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;pretty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pretty_print&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PrettyPrinter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RepresentationPrinter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;for_type&quot;</span><span class="p">,</span>
    <span class="s2">&quot;for_type_by_name&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">MAX_SEQ_LENGTH</span> <span class="o">=</span> <span class="mi">1000</span>


<span class="k">def</span> <span class="nf">_safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Safe version of getattr.</span>

<span class="sd">    Same as getattr, but will return ``default`` on any Exception,</span>
<span class="sd">    rather than raising.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>


<span class="n">CUnicodeIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span>


<span class="k">def</span> <span class="nf">pretty</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="n">MAX_SEQ_LENGTH</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pretty print the object&#39;s representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;xonsh_display&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">xonsh_display</span><span class="p">()</span>

    <span class="n">stream</span> <span class="o">=</span> <span class="n">CUnicodeIO</span><span class="p">()</span>
    <span class="n">printer</span> <span class="o">=</span> <span class="n">RepresentationPrinter</span><span class="p">(</span>
        <span class="n">stream</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">max_width</span><span class="p">,</span> <span class="n">newline</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="n">max_seq_length</span>
    <span class="p">)</span>
    <span class="n">printer</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">printer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="n">MAX_SEQ_LENGTH</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Like pretty() but print to stdout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">printer</span> <span class="o">=</span> <span class="n">RepresentationPrinter</span><span class="p">(</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">max_width</span><span class="p">,</span> <span class="n">newline</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="n">max_seq_length</span>
    <span class="p">)</span>
    <span class="n">printer</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">printer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newline</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_PrettyPrinterBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;with statement support for indenting/dedenting.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">+=</span> <span class="n">indent</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">-=</span> <span class="n">indent</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;like begin_group / end_group but for the with statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="nb">open</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_group</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrettyPrinter</span><span class="p">(</span><span class="n">_PrettyPrinterBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Baseclass for the `RepresentationPrinter` prettyprinter that is used to</span>
<span class="sd">    generate pretty reprs of objects.  Contrary to the `RepresentationPrinter`</span>
<span class="sd">    this printer knows nothing about the default pprinters or the `_repr_pretty_`</span>
<span class="sd">    callback method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="n">MAX_SEQ_LENGTH</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_width</span> <span class="o">=</span> <span class="n">max_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span> <span class="o">=</span> <span class="n">newline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_length</span> <span class="o">=</span> <span class="n">max_seq_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>

        <span class="n">root_group</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">root_group</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_queue</span> <span class="o">=</span> <span class="n">GroupQueue</span><span class="p">(</span><span class="n">root_group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_break_outer_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_width</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_queue</span><span class="o">.</span><span class="n">deq</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">while</span> <span class="n">group</span><span class="o">.</span><span class="n">breakables</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Text</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span>

    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add literal text to the output.&quot;&quot;&quot;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span> <span class="o">+=</span> <span class="n">width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_break_outer_groups</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span> <span class="o">+=</span> <span class="n">width</span>

    <span class="k">def</span> <span class="nf">breakable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a breakable separator to the output.  This does not mean that it</span>
<span class="sd">        will automatically break here.  If no breaking on this position takes</span>
<span class="sd">        place the `sep` is inserted which default to one space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">want_break</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Breakable</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span> <span class="o">+=</span> <span class="n">width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_break_outer_groups</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">break_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Explicitly insert a newline into the output, maintaining correct indentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">begin_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">open</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Begin a group.  If you want support for python &lt; 2.5 which doesn&#39;t has</span>
<span class="sd">        the with statement this is the preferred way:</span>

<span class="sd">            p.begin_group(1, &#39;{&#39;)</span>
<span class="sd">            ...</span>
<span class="sd">            p.end_group(1, &#39;}&#39;)</span>

<span class="sd">        The python 2.5 expression would be this:</span>

<span class="sd">            with p.group(1, &#39;{&#39;, &#39;}&#39;):</span>
<span class="sd">                ...</span>

<span class="sd">        The first parameter specifies the indentation for the next line (usually</span>
<span class="sd">        the width of the opening text), the second the opening text.  All</span>
<span class="sd">        parameters are optional.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">open</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="nb">open</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_queue</span><span class="o">.</span><span class="n">enq</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">+=</span> <span class="n">indent</span>

    <span class="k">def</span> <span class="nf">_enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;like enumerate, but with an upper limit on the number of items&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_length</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_length</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">yield</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">end_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dedent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End a group. See `begin_group` for more details.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">-=</span> <span class="n">dedent</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="o">.</span><span class="n">breakables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_queue</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush data that is left in the buffer.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_width</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">_get_mro</span><span class="p">(</span><span class="n">obj_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a reasonable method resolution order of a class and its superclasses</span>
<span class="sd">    for both old-style and new-style classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_class</span><span class="p">,</span> <span class="s2">&quot;__mro__&quot;</span><span class="p">):</span>
        <span class="c1"># Old-style class. Mix in object to make a fake new-style class.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">obj_class</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span> <span class="p">{})</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># Old-style extension type that does not descend from object.</span>
            <span class="c1"># FIXME: try to construct a more thorough MRO.</span>
            <span class="n">mro</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_class</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mro</span> <span class="o">=</span> <span class="n">obj_class</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mro</span> <span class="o">=</span> <span class="n">obj_class</span><span class="o">.</span><span class="vm">__mro__</span>
    <span class="k">return</span> <span class="n">mro</span>


<span class="k">class</span> <span class="nc">RepresentationPrinter</span><span class="p">(</span><span class="n">PrettyPrinter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Special pretty printer that has a `pretty` method that calls the pretty</span>
<span class="sd">    printer for a python object.</span>

<span class="sd">    This class stores processing data on `self` so you must *never* use</span>
<span class="sd">    this class in a threaded environment.  Always lock it or reinstantiate</span>
<span class="sd">    it.</span>

<span class="sd">    Instances also have a verbose flag callbacks can access to control their</span>
<span class="sd">    output.  For example the default instance repr prints all attributes and</span>
<span class="sd">    methods that are not prefixed by an underscore if the printer is in</span>
<span class="sd">    verbose mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">max_width</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span>
        <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">singleton_pprinters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">type_pprinters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deferred_pprinters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_seq_length</span><span class="o">=</span><span class="n">MAX_SEQ_LENGTH</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">PrettyPrinter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">max_width</span><span class="p">,</span> <span class="n">newline</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="n">max_seq_length</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">singleton_pprinters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">singleton_pprinters</span> <span class="o">=</span> <span class="n">_singleton_pprinters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">singleton_pprinters</span> <span class="o">=</span> <span class="n">singleton_pprinters</span>
        <span class="k">if</span> <span class="n">type_pprinters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_pprinters</span> <span class="o">=</span> <span class="n">_type_pprinters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type_pprinters</span> <span class="o">=</span> <span class="n">type_pprinters</span>
        <span class="k">if</span> <span class="n">deferred_pprinters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deferred_pprinters</span> <span class="o">=</span> <span class="n">_deferred_type_pprinters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferred_pprinters</span> <span class="o">=</span> <span class="n">deferred_pprinters</span>

    <span class="k">def</span> <span class="nf">pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pretty print the given object.&quot;&quot;&quot;</span>
        <span class="n">obj_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">cycle</span> <span class="o">=</span> <span class="n">obj_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_group</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj_class</span> <span class="o">=</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="c1"># First try to find registered singleton printers for the type.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">printer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleton_pprinters</span><span class="p">[</span><span class="n">obj_id</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">printer</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
            <span class="c1"># Next walk the mro and check for either:</span>
            <span class="c1">#   1) a registered printer</span>
            <span class="c1">#   2) a _repr_pretty_ method</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">_get_mro</span><span class="p">(</span><span class="n">obj_class</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_pprinters</span><span class="p">:</span>
                    <span class="c1"># printer registered in self.type_pprinters</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_pprinters</span><span class="p">[</span><span class="bp">cls</span><span class="p">](</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># deferred printer</span>
                    <span class="n">printer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_deferred_types</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">printer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">printer</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Finally look for special method names.</span>
                        <span class="c1"># Some objects automatically create any requested</span>
                        <span class="c1"># attribute. Try to ignore most of them by checking for</span>
                        <span class="c1"># callability.</span>
                        <span class="k">if</span> <span class="s2">&quot;_repr_pretty_&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                            <span class="n">meth</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_repr_pretty_</span>
                            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">meth</span><span class="p">):</span>
                                <span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_default_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_group</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_in_deferred_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the given class is specified in the deferred type registry.</span>

<span class="sd">        Returns the printer from the registry if it exists, and None if the</span>
<span class="sd">        class is not in the registry. Successful matches will be moved to the</span>
<span class="sd">        regular type registry for future use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">printer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred_pprinters</span><span class="p">:</span>
            <span class="c1"># Move the printer over to the regular registry.</span>
            <span class="n">printer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred_pprinters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type_pprinters</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">printer</span>
        <span class="k">return</span> <span class="n">printer</span>


<span class="k">class</span> <span class="nc">Printable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">output_width</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">output_width</span>


<span class="k">class</span> <span class="nc">Text</span><span class="p">(</span><span class="n">Printable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">output_width</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objs</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_width</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">+=</span> <span class="n">width</span>


<span class="k">class</span> <span class="nc">Breakable</span><span class="p">(</span><span class="n">Printable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pretty</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty</span> <span class="o">=</span> <span class="n">pretty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">=</span> <span class="n">pretty</span><span class="o">.</span><span class="n">indentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">pretty</span><span class="o">.</span><span class="n">group_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">breakables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">output_width</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">breakables</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">want_break</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty</span><span class="o">.</span><span class="n">newline</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">breakables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pretty</span><span class="o">.</span><span class="n">group_queue</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_width</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>


<span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="n">Printable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breakables</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">want_break</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">GroupQueue</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">groups</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enq</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">enq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">depth</span>
        <span class="k">while</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">stack</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">breakables</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">stack</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">group</span><span class="o">.</span><span class="n">want_break</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="n">group</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">want_break</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">del</span> <span class="n">stack</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">depth</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">_baseclass_reprs</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">br</span> <span class="o">=</span> <span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">InstanceType</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># Python 3</span>
        <span class="n">br</span> <span class="o">=</span> <span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">br</span>


<span class="k">def</span> <span class="nf">_default_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default print function.  Used if an object does not provide one and</span>
<span class="sd">    it&#39;s none of the builtin objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s2">&quot;__repr__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_baseclass_reprs</span><span class="p">:</span>
        <span class="c1"># A user-provided repr. Find newlines and replace them with p.break_()</span>
        <span class="n">_repr_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">p</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot; at 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot; ...&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">p</span><span class="o">.</span><span class="n">indentation</span> <span class="o">+=</span> <span class="n">step</span>
                <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">indentation</span> <span class="o">-=</span> <span class="n">step</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">p</span><span class="o">.</span><span class="n">end_group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_seq_pprinter_factory</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">basetype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Factory that returns a pprint function useful for sequences.  Used by</span>
<span class="sd">    the default pprint for tuples, dicts, and lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">basetype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">basetype</span>
            <span class="ow">and</span> <span class="n">typ</span><span class="o">.</span><span class="fm">__repr__</span> <span class="o">!=</span> <span class="n">basetype</span><span class="o">.</span><span class="fm">__repr__</span>
        <span class="p">):</span>
            <span class="c1"># If the subclass provides its own repr, use it instead.</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">_enumerate</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="c1"># Special case for 1-item tuples.</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">end_group</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span>


<span class="k">def</span> <span class="nf">_set_pprinter_factory</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">basetype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Factory that returns a pprint function useful for sets and frozensets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">basetype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">basetype</span>
            <span class="ow">and</span> <span class="n">typ</span><span class="o">.</span><span class="fm">__repr__</span> <span class="o">!=</span> <span class="n">basetype</span><span class="o">.</span><span class="fm">__repr__</span>
        <span class="p">):</span>
            <span class="c1"># If the subclass provides its own repr, use it instead.</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Special case.</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">basetype</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;()&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="c1"># Like dictionary keys, we will try to sort the items if there aren&#39;t too many</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">max_seq_length</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">max_seq_length</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Sometimes the items don&#39;t sort.</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">_enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">end_group</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span>


<span class="k">def</span> <span class="nf">_dict_pprinter_factory</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">basetype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Factory that returns a pprint function used by the default pprint of</span>
<span class="sd">    dicts and dict proxies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">basetype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">basetype</span>
            <span class="ow">and</span> <span class="n">typ</span><span class="o">.</span><span class="fm">__repr__</span> <span class="o">!=</span> <span class="n">basetype</span><span class="o">.</span><span class="fm">__repr__</span>
        <span class="p">):</span>
            <span class="c1"># If the subclass provides its own repr, use it instead.</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;{...}&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="c1"># if dict isn&#39;t large enough to be truncated, sort keys before displaying</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">max_seq_length</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">max_seq_length</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Sometimes the keys don&#39;t sort.</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">_enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">p</span><span class="o">.</span><span class="n">end_group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span>


<span class="k">def</span> <span class="nf">_super_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The pprint for the super type.&quot;&quot;&quot;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;&lt;super: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__thisclass__</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__self__</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">end_group</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_re_pattern_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The pprint function for regular expression patterns.&quot;&quot;&quot;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;re.compile(&quot;</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pattern</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;uU&quot;</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;ur&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
        <span class="n">done_one</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;TEMPLATE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IGNORECASE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LOCALE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MULTILINE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DOTALL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UNICODE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VERBOSE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">done_one</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;re.&quot;</span> <span class="o">+</span> <span class="n">flag</span><span class="p">)</span>
                <span class="n">done_one</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_type_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The pprint for classes and types.&quot;&quot;&quot;</span>
    <span class="c1"># Heap allocated types might not have the module attribute,</span>
    <span class="c1"># and others may set it to None.</span>

    <span class="c1"># Checks for a __repr__ override in the metaclass</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="fm">__repr__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">:</span>
        <span class="n">_repr_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">mod</span> <span class="o">=</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__qualname__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># This can happen if the type implements __qualname__ as a property</span>
            <span class="c1"># or other descriptor in Python 2.</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Try __name__&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&lt;unknown type&gt;&quot;</span>

    <span class="k">if</span> <span class="n">mod</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;__builtin__&quot;</span><span class="p">,</span> <span class="s2">&quot;builtins&quot;</span><span class="p">,</span> <span class="s2">&quot;exceptions&quot;</span><span class="p">):</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mod</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_repr_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A pprint that just redirects to the normal repr function.&quot;&quot;&quot;</span>
    <span class="c1"># Find newlines and replace them with p.break_()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">output_line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">break_</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">output_line</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_function_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base pprint for all functions and builtin functions.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">_safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__qualname__&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="k">if</span> <span class="n">mod</span> <span class="ow">and</span> <span class="n">mod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;__builtin__&quot;</span><span class="p">,</span> <span class="s2">&quot;builtins&quot;</span><span class="p">,</span> <span class="s2">&quot;exceptions&quot;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span>
    <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;&lt;function </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_exception_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base pprint for all exceptions.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&quot;__qualname__&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;exceptions&quot;</span><span class="p">,</span> <span class="s2">&quot;builtins&quot;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">p</span><span class="o">.</span><span class="n">begin_group</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">())):</span>
        <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">end_group</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">_type_pprinters</span><span class="p">():</span>
    <span class="c1">#: printers for builtin types</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">:</span> <span class="n">_repr_pprint</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">:</span> <span class="n">_repr_pprint</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">:</span> <span class="n">_repr_pprint</span><span class="p">,</span>
        <span class="nb">tuple</span><span class="p">:</span> <span class="n">_seq_pprinter_factory</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span>
        <span class="nb">list</span><span class="p">:</span> <span class="n">_seq_pprinter_factory</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">:</span> <span class="n">_dict_pprinter_factory</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span>
        <span class="nb">set</span><span class="p">:</span> <span class="n">_set_pprinter_factory</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">),</span>
        <span class="nb">frozenset</span><span class="p">:</span> <span class="n">_set_pprinter_factory</span><span class="p">(</span><span class="s2">&quot;frozenset({&quot;</span><span class="p">,</span> <span class="s2">&quot;})&quot;</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">),</span>
        <span class="nb">super</span><span class="p">:</span> <span class="n">_super_pprint</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)):</span> <span class="n">_re_pattern_pprint</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">_type_pprint</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">:</span> <span class="n">_function_pprint</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">:</span> <span class="n">_function_pprint</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">:</span> <span class="n">_repr_pprint</span><span class="p">,</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="n">_repr_pprint</span><span class="p">,</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">:</span> <span class="n">_repr_pprint</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1">#: the exception base</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_exception_base</span> <span class="o">=</span> <span class="ne">BaseException</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">_exception_base</span> <span class="o">=</span> <span class="ne">Exception</span>
    <span class="n">tp</span><span class="p">[</span><span class="n">_exception_base</span><span class="p">]</span> <span class="o">=</span> <span class="n">_exception_pprint</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tp</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">DictProxyType</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dict_pprinter_factory</span><span class="p">(</span><span class="s2">&quot;&lt;dictproxy {&quot;</span><span class="p">,</span> <span class="s2">&quot;}&gt;&quot;</span><span class="p">)</span>
        <span class="n">tp</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">]</span> <span class="o">=</span> <span class="n">_type_pprint</span>
        <span class="n">tp</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">SliceType</span><span class="p">]</span> <span class="o">=</span> <span class="n">_repr_pprint</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># Python 3</span>
        <span class="n">tp</span><span class="p">[</span><span class="nb">slice</span><span class="p">]</span> <span class="o">=</span> <span class="n">_repr_pprint</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tp</span><span class="p">[</span><span class="n">xrange</span><span class="p">]</span> <span class="o">=</span> <span class="n">_repr_pprint</span>
        <span class="n">tp</span><span class="p">[</span><span class="n">long</span><span class="p">]</span> <span class="o">=</span> <span class="n">_repr_pprint</span>
        <span class="n">tp</span><span class="p">[</span><span class="n">unicode</span><span class="p">]</span> <span class="o">=</span> <span class="n">_repr_pprint</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">tp</span><span class="p">[</span><span class="nb">range</span><span class="p">]</span> <span class="o">=</span> <span class="n">_repr_pprint</span>
        <span class="n">tp</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">_repr_pprint</span>
    <span class="k">return</span> <span class="n">tp</span>


<span class="c1">#: printers for types specified by name</span>
<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">_deferred_type_pprinters</span><span class="p">():</span>
    <span class="n">dtp</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">for_type_by_name</span><span class="p">(</span><span class="s2">&quot;collections&quot;</span><span class="p">,</span> <span class="s2">&quot;defaultdict&quot;</span><span class="p">,</span> <span class="n">_defaultdict_pprint</span><span class="p">,</span> <span class="n">dtp</span><span class="o">=</span><span class="n">dtp</span><span class="p">)</span>
    <span class="n">for_type_by_name</span><span class="p">(</span><span class="s2">&quot;collections&quot;</span><span class="p">,</span> <span class="s2">&quot;OrderedDict&quot;</span><span class="p">,</span> <span class="n">_ordereddict_pprint</span><span class="p">,</span> <span class="n">dtp</span><span class="o">=</span><span class="n">dtp</span><span class="p">)</span>
    <span class="n">for_type_by_name</span><span class="p">(</span><span class="s2">&quot;collections&quot;</span><span class="p">,</span> <span class="s2">&quot;deque&quot;</span><span class="p">,</span> <span class="n">_deque_pprint</span><span class="p">,</span> <span class="n">dtp</span><span class="o">=</span><span class="n">dtp</span><span class="p">)</span>
    <span class="n">for_type_by_name</span><span class="p">(</span><span class="s2">&quot;collections&quot;</span><span class="p">,</span> <span class="s2">&quot;Counter&quot;</span><span class="p">,</span> <span class="n">_counter_pprint</span><span class="p">,</span> <span class="n">dtp</span><span class="o">=</span><span class="n">dtp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dtp</span>


<span class="k">def</span> <span class="nf">for_type</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a pretty printer for a given type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">oldfunc</span> <span class="o">=</span> <span class="n">_type_pprinters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># To support easy restoration of old pprinters, we need to ignore Nones.</span>
        <span class="n">_type_pprinters</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">oldfunc</span>


<span class="k">def</span> <span class="nf">for_type_by_name</span><span class="p">(</span><span class="n">type_module</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">dtp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a pretty printer for a type specified by the module and name of a type</span>
<span class="sd">    rather than the type object itself.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dtp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtp</span> <span class="o">=</span> <span class="n">_deferred_type_pprinters</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">type_module</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
    <span class="n">oldfunc</span> <span class="o">=</span> <span class="n">dtp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># To support easy restoration of old pprinters, we need to ignore Nones.</span>
        <span class="n">dtp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">oldfunc</span>


<span class="c1">#: printers for the default singletons</span>
<span class="n">_singleton_pprinters</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">Ellipsis</span><span class="p">,</span> <span class="bp">NotImplemented</span><span class="p">]),</span> <span class="n">_repr_pprint</span>
    <span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;_singleton_pprinters&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_defaultdict_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">default_factory</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_ordereddict_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>


<span class="k">def</span> <span class="nf">_deque_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_counter_pprint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

<span class="c1">#</span>
<span class="c1"># xontribs_meta</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This modules is the place where one would define the xontribs.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">ast</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;ast&#39;</span><span class="p">,</span> <span class="s1">&#39;ast&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated functools</span>
<span class="c1"># amalgamated importlib.util</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="c1"># amalgamated typing</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="k">class</span> <span class="nc">_XontribPkg</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to define package information of a xontrib.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    install</span>
<span class="sd">        a mapping of tools with respective install commands. e.g. {&quot;pip&quot;: &quot;pip install xontrib&quot;}</span>
<span class="sd">    license</span>
<span class="sd">        license type of the xontrib package</span>
<span class="sd">    name</span>
<span class="sd">        full name of the package. e.g. &quot;xontrib-argcomplete&quot;</span>
<span class="sd">    url</span>
<span class="sd">        URL to the homepage of the xontrib package.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">install</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">license</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">Xontrib</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta class that is used to describe xontribs.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    url</span>
<span class="sd">        url to the home page of the xontrib.</span>
<span class="sd">    description</span>
<span class="sd">        short description about the xontrib.</span>
<span class="sd">    package</span>
<span class="sd">        pkg information for installing the xontrib</span>
<span class="sd">    tags</span>
<span class="sd">        category.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LazyObject</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">package</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_XontribPkg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>


<span class="k">def</span> <span class="nf">get_module_docstring</span><span class="p">(</span><span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find the module and return its docstring without actual import&quot;&quot;&quot;</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spec</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">has_location</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()))</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_xontribs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Xontrib</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Return xontrib definitions lazily.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">define_xontribs</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">define_xontribs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Xontrib registry.&quot;&quot;&quot;</span>
    <span class="n">core_pkg</span> <span class="o">=</span> <span class="n">_XontribPkg</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xonsh&quot;</span><span class="p">,</span>
        <span class="n">license</span><span class="o">=</span><span class="s2">&quot;BSD 3-clause&quot;</span><span class="p">,</span>
        <span class="n">install</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;conda&quot;</span><span class="p">:</span> <span class="s2">&quot;conda install -c conda-forge xonsh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xonsh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;aura&quot;</span><span class="p">:</span> <span class="s2">&quot;sudo aura -A xonsh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yaourt&quot;</span><span class="p">:</span> <span class="s2">&quot;yaourt -Sa xonsh&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;abbrevs&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">lazyobject</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get_module_docstring</span><span class="p">(</span><span class="s2">&quot;xontrib.abbrevs&quot;</span><span class="p">)),</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;apt_tabcomplete&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/DangerOnTheRanger/xonsh-apt-tabcomplete&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds tabcomplete functionality to &quot;</span>
            <span class="s2">&quot;apt-get/apt-cache inside of xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xonsh-apt-tabcomplete&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;BSD 2-clause&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xonsh-apt-tabcomplete&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/DangerOnTheRanger/xonsh-apt-tabcomplete&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;argcomplete&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-argcomplete&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Argcomplete support to tab completion of &quot;</span>
            <span class="s2">&quot;python and xonsh scripts in xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-argcomplete&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;BSD&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-argcomplete&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-argcomplete&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;autojump&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/wshanks/xontrib-autojump&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;autojump support for xonsh&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;autovox&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Manages automatic activation of virtual &quot;</span> <span class="s2">&quot;environments.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;autoxsh&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/Granitas/xonsh-autoxsh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds automatic execution of xonsh script files &quot;</span>
            <span class="s2">&quot;called ``.autoxsh`` when enterting a directory &quot;</span>
            <span class="s2">&quot;with ``cd`` function&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xonsh-autoxsh&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;GPLv3&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xonsh-autoxsh&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/Granitas/xonsh-autoxsh&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;avox&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/AstraLuma/xontrib-avox&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Policy for autovox based on project directories&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-avox&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;GPLv3&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-avox&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/AstraLuma/xontrib-avox&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;avox_poetry&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;github.com/jnoortheen/xontrib-avox-poetry&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;auto-activate venv as one cd into a poetry project folder. &quot;</span>
            <span class="s2">&quot;Activate ``.venv`` inside the project folder is also supported.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-avox-poetry&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-avox-poetry&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-avox-poetry&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;back2dir&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-back2dir&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Return to the most recently used directory when &quot;</span>
            <span class="s2">&quot;starting the xonsh shell. For example, if you &quot;</span>
            <span class="s2">&quot;were in the &#39;/work&#39; directory when you last &quot;</span>
            <span class="s2">&quot;exited xonsh, then your next xonsh session will &quot;</span>
            <span class="s2">&quot;start in the &#39;/work&#39; directory, instead of your &quot;</span>
            <span class="s2">&quot;home directory.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-back2dir&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;BSD&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-back2dir&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-back2dir&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;base16_shell&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/ErickTucto/xontrib-base16-shell&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Change base16 shell themes&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;bashisms&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enables additional Bash-like syntax while at the &quot;</span>
            <span class="s2">&quot;command prompt. For example, the ``!!`` syntax &quot;</span>
            <span class="s2">&quot;for running the previous command is now usable. &quot;</span>
            <span class="s2">&quot;Note that these features are implemented as &quot;</span>
            <span class="s2">&quot;precommand events and these additions do not &quot;</span>
            <span class="s2">&quot;affect the xonsh language when run as script. &quot;</span>
            <span class="s2">&quot;That said, you might find them useful if you &quot;</span>
            <span class="s2">&quot;have strong muscle memory.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;**Warning:** This xontrib may modify user &quot;</span>
            <span class="s2">&quot;command line input to implement its behavior. To &quot;</span>
            <span class="s2">&quot;see the modifications as they are applied (in &quot;</span>
            <span class="s2">&quot;unified diffformat), please set ``$XONSH_DEBUG`` &quot;</span>
            <span class="s2">&quot;to ``2`` or higher.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;The xontrib also adds commands: ``alias``, &quot;</span>
            <span class="s2">&quot;``export``, ``unset``, ``set``, ``shopt``, &quot;</span>
            <span class="s2">&quot;``complete``.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;broot&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;github.com/jnoortheen/xontrib-broot&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;supports broot with br alias&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-broot&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-broot&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-broot&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;powerline3&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;github.com/jnoortheen/xontrib-powerline3&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Powerline theme with native $PROMPT_FIELDS support.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-powerline3&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-powerline3&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-broot&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;cd&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/eugenesvk/xontrib-cd&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&#39;cd&#39; to any path without escaping in xonsh shell &quot;</span>
            <span class="s2">&quot;(&#39;cd &#39;&#39;cd! &#39;)&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-cd&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-cd&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/eugenesvk/xontrib-cd&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;cmd_done&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-cmd-durations&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;send notification once long-running command is &quot;</span>
            <span class="s2">&quot;finished. Adds `long_cmd_duration` field to &quot;</span>
            <span class="s2">&quot;$PROMPT_FIELDS. Note: It needs `xdotool` &quot;</span>
            <span class="s2">&quot;installed to detect current window.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-cmd-durations&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-cmd-durations&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-cmd-durations&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-commands&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Some useful commands/aliases to use with Xonsh shell&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-commands&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-commands&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-commands&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;coreutils&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Additional core utilities that are implemented &quot;</span>
            <span class="s2">&quot;in xonsh. The current list includes:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;* cat</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;* echo</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;* pwd</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;* tee</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;* tty</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;* yes</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;In many cases, these may have a lower &quot;</span>
            <span class="s2">&quot;performance overhead than the posix command &quot;</span>
            <span class="s2">&quot;line utility with the same name. This is &quot;</span>
            <span class="s2">&quot;because these tools avoid the need for a full &quot;</span>
            <span class="s2">&quot;subprocess call. Additionally, these tools are &quot;</span>
            <span class="s2">&quot;cross-platform.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;direnv&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/74th/xonsh-direnv&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Supports direnv.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xonsh-direnv&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xonsh-direnv&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/74th/xonsh-direnv&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;distributed&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The distributed parallel computing library &quot;</span>
            <span class="s2">&quot;hooks for xonsh. Importantly this provides a &quot;</span>
            <span class="s2">&quot;substitute &#39;dworker&#39; command which enables &quot;</span>
            <span class="s2">&quot;distributed workers to have access to xonsh &quot;</span>
            <span class="s2">&quot;builtins.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Furthermore, this xontrib adds a &#39;DSubmitter&#39; &quot;</span>
            <span class="s2">&quot;context manager for executing a block &quot;</span>
            <span class="s2">&quot;remotely. Moreover, this also adds a &quot;</span>
            <span class="s2">&quot;convenience function &#39;dsubmit()&#39; for creating &quot;</span>
            <span class="s2">&quot;DSubmitter and Executor instances at the same &quot;</span>
            <span class="s2">&quot;time. Thus users may submit distributed jobs &quot;</span>
            <span class="s2">&quot;with::</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    with dsubmit(&#39;127.0.0.1:8786&#39;, rtn=&#39;x&#39;) &quot;</span>
            <span class="s2">&quot;as dsub:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;        x = $(echo I am elsewhere)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    res = dsub.future.result()</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    print(res)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;This is useful for long running or &quot;</span>
            <span class="s2">&quot;non-blocking jobs.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;docker_tabcomplete&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/xsteadfastx/xonsh-docker-tabcomplete&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds tabcomplete functionality to &quot;</span> <span class="s2">&quot;docker inside of xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xonsh-docker-tabcomplete&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xonsh-docker-tabcomplete&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/xsteadfastx/xonsh-docker-tabcomplete&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;free_cwd&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Windows only xontrib, to release the lock on the &quot;</span>
            <span class="s2">&quot;current directory whenever the prompt is shown. &quot;</span>
            <span class="s2">&quot;Enabling this will allow the other programs or &quot;</span>
            <span class="s2">&quot;Windows Explorer to delete or rename the current &quot;</span>
            <span class="s2">&quot;or parent directories. Internally, it is &quot;</span>
            <span class="s2">&quot;accomplished by temporarily resetting CWD to the &quot;</span>
            <span class="s2">&quot;root drive folder while waiting at the prompt. &quot;</span>
            <span class="s2">&quot;This only works with the prompt_toolkit backend &quot;</span>
            <span class="s2">&quot;and can cause cause issues if any extensions are &quot;</span>
            <span class="s2">&quot;enabled that hook the prompt and relies on &quot;</span>
            <span class="s2">&quot;``os.getcwd()``&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;fzf-widgets&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/laloch/xontrib-fzf-widgets&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds some fzf widgets to your xonsh shell.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-fzf-widgets&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;GPLv3&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-fzf-widgets&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/laloch/xontrib-fzf-widgets&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;gitinfo&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-gitinfo&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Displays git information on entering a repository &quot;</span>
            <span class="s2">&quot;folder. Uses ``onefetch`` if available.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-gitinfo&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-gitinfo&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-gitinfo&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;history_encrypt&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-history-encrypt&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;History backend that encrypt the xonsh shell commands history &quot;</span>
            <span class="s2">&quot;to prevent leaking sensitive data.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-history-encrypt&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-history-encrypt&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-history-encrypt&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;hist_navigator&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-hist-navigator&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Move through directory history with nextd &quot;</span>
            <span class="s2">&quot;and prevd also with keybindings.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-hist-navigator&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-hist-navigator&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/jnoortheen/xontrib-hist-navigator&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;histcpy&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/con-f-use/xontrib-histcpy&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Useful aliases and shortcuts for extracting links &quot;</span>
            <span class="s2">&quot;and textfrom command output history and putting &quot;</span>
            <span class="s2">&quot;them into the clipboard.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-histcpy&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;GPLv3&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-histcpy&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/con-f-use/xontrib-histcpy&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;jedi&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Use Jedi as xonsh&#39;s python completer.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;kitty&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/scopatz/xontrib-kitty&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Xonsh hooks for the Kitty terminal emulator.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-kitty&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;BSD-3-Clause&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;conda&quot;</span><span class="p">:</span> <span class="s2">&quot;conda install -c conda-forge &quot;</span> <span class="s2">&quot;xontrib-kitty&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-kitty&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/scopatz/xontrib-kitty&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;linuxbrew&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/eugenesvk/xontrib-linuxbrew&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Add Homebrew&#39;s shell environment to xonsh shell on Linux&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-linuxbrew&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-linuxbrew&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/eugenesvk/xontrib-linuxbrew&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;macro_lib&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-macro-lib&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Library of the useful macros for the xonsh shell.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-macro-lib&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;BSD&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-macro-lib&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-macro-lib&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;mpl&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Matplotlib hooks for xonsh, including the new &#39;mpl&#39; &quot;</span>
            <span class="s2">&quot;alias that displays the current figure on the screen.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;onepath&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-onepath&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;When you click to a file or folder in graphical &quot;</span>
            <span class="s2">&quot;OS they will be opened in associated app.The &quot;</span>
            <span class="s2">&quot;xontrib-onepath brings the same logic for the &quot;</span>
            <span class="s2">&quot;xonsh shell. Type the filename or pathwithout &quot;</span>
            <span class="s2">&quot;preceding command and an associated action will &quot;</span>
            <span class="s2">&quot;be executed. The actions are customizable.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-onepath&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;BSD&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-onepath&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-onepath&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;output_search&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-output-search&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Get identifiers, names, paths, URLs and &quot;</span>
            <span class="s2">&quot;words from the previous command output and &quot;</span>
            <span class="s2">&quot;use them for the next command.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-output-search&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;BSD&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-output-search&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/tokenizer/xontrib-output-search&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;pdb&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Simple built-in debugger. Runs pdb on reception of &quot;</span>
            <span class="s2">&quot;SIGUSR1 signal.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;pipeliner&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-pipeliner&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Let your pipe lines flow thru the Python code &quot;</span> <span class="s2">&quot;in xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-pipeliner&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-pipeliner&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-pipeliner&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;powerline&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/santagada/xontrib-powerline&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Powerline for Xonsh shell&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-powerline&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-powerline&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/santagada/xontrib-powerline&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;powerline2&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/vaaaaanquish/xontrib-powerline2&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Powerline for Xonsh shell forked from &quot;</span>
            <span class="s2">&quot;santagada/xontrib-powerline&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-powerline2&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-powerline2&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/vaaaaanquish/xontrib-powerline2&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;powerline_binding&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-powerline-binding&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Uses powerline to render the xonsh &quot;</span> <span class="s2">&quot;prompt&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-powerline-binding&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-powerline-binding&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-powerline-binding&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;prompt_bar&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-prompt-bar&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;An elegance bar style for prompt.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-prompt-bar&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-prompt-bar&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-prompt-bar&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;prompt_ret_code&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds return code info to the prompt&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;prompt_starship&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-prompt-starship&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Starship prompt in xonsh shell.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-prompt-starship&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-prompt-starship&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-prompt-starship&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;prompt_vi_mode&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/t184256/xontrib-prompt-vi-mode&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;vi-mode status formatter for xonsh prompt&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-prompt-vi-mode&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-prompt-vi-mode&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/t184256/xontrib-prompt-vi-mode&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;pyenv&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-pyenv&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;pyenv integration for xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-pyenv&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-pyenv&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-pyenv&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;readable-traceback&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/6syun9/xontrib-readable-traceback&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Make traceback easier to see for &quot;</span> <span class="s2">&quot;xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-readable-traceback&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-readable-traceback&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/6syun9/xontrib-readable-traceback&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;schedule&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/AstraLuma/xontrib-schedule&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Xonsh Task Scheduling&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-schedule&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-schedule&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/AstraLuma/xontrib-schedule&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;scrapy_tabcomplete&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/Granitas/xonsh-scrapy-tabcomplete&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds tabcomplete functionality to &quot;</span> <span class="s2">&quot;scrapy inside of xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xonsh-scrapy-tabcomplete&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;GPLv3&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xonsh-scrapy-tabcomplete&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/Granitas/xonsh-scrapy-tabcomplete&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;sh&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Paste and run commands from bash, zsh, fish in xonsh &quot;</span>
            <span class="s2">&quot;shell.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-sh&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-sh&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/anki-code/xontrib-sh&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;ssh_agent&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-ssh-agent&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ssh-agent integration&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-ssh-agent&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-ssh-agent&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-ssh-agent&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;tcg&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/zasdfgbnm/tcg/tree/master/shells/xonsh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;tcg integration.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xonsh-tcg&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xonsh-tcg&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/zasdfgbnm/tcg/tree/master/shells/xonsh&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;vox&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Python virtual environment manager for xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;vox_tabcomplete&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/Granitosaurus/xonsh-vox-tabcomplete&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds tabcomplete functionality to vox &quot;</span> <span class="s2">&quot;inside of xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xonsh-vox-tabcomplete&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;GPLv3&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xonsh-vox-tabcomplete&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/Granitosaurus/xonsh-vox-tabcomplete&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;whole_word_jumping&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Jumping across whole words &quot;</span>
            <span class="s2">&quot;(non-whitespace) with Ctrl+Left/Right. &quot;</span>
            <span class="s2">&quot;Alt+Left/Right remains unmodified to &quot;</span>
            <span class="s2">&quot;jump over smaller word segments. &quot;</span>
            <span class="s2">&quot;Shift+Delete removes the whole word.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;xo&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/scopatz/xo&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds an &#39;xo&#39; alias to run the exofrills text editor in &quot;</span>
            <span class="s2">&quot;the current Python interpreter session. This shaves &quot;</span>
            <span class="s2">&quot;off a bit of the startup time when running your &quot;</span>
            <span class="s2">&quot;favorite, minimal text editor.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;exofrills&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;WTFPL&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;conda&quot;</span><span class="p">:</span> <span class="s2">&quot;conda install -c conda-forge xo&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install exofrills&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://exofrills.org&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;xog&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://xon.sh&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Adds a simple command to establish and print &quot;</span>
            <span class="s2">&quot;temporary traceback log file.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">core_pkg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;xpg&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/fengttt/xsh/tree/master/py&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run/plot/explain sql query for PostgreSQL.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-xpg&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;Apache&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-xpg&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/fengttt/xsh/py&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/AstraLuma/xontrib-z&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Tracks your most used directories, based on &#39;frecency&#39;.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-z&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;GPLv3&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-z&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/AstraLuma/xontrib-z&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s2">&quot;zoxide&quot;</span><span class="p">:</span> <span class="n">Xontrib</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-zoxide&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Zoxide integration for xonsh.&quot;</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="n">_XontribPkg</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xontrib-zoxide&quot;</span><span class="p">,</span>
                <span class="n">license</span><span class="o">=</span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
                <span class="n">install</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pip&quot;</span><span class="p">:</span> <span class="s2">&quot;xpip install xontrib-zoxide&quot;</span><span class="p">},</span>
                <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/dyuri/xontrib-zoxide&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">}</span>

<span class="c1">#</span>
<span class="c1"># codecache</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Tools for caching xonsh code.&quot;&quot;&quot;</span>
<span class="n">hashlib</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;hashlib&#39;</span><span class="p">,</span> <span class="s1">&#39;hashlib&#39;</span><span class="p">)</span>
<span class="n">marshal</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;marshal&#39;</span><span class="p">,</span> <span class="s1">&#39;marshal&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated sys</span>
<span class="kn">from</span> <span class="nn">xonsh</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">XONSH_VERSION</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="k">def</span> <span class="nf">_splitpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sofar</span><span class="o">=</span><span class="p">()):</span>
    <span class="n">folder</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sofar</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">folder</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">sofar</span> <span class="o">+</span> <span class="p">(</span><span class="n">path</span><span class="p">,))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_splitpath</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">sofar</span> <span class="o">+</span> <span class="p">(</span><span class="n">path</span><span class="p">,))</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">_CHARACTER_MAP</span><span class="p">():</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="p">{</span><span class="nb">chr</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">chr</span><span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">91</span><span class="p">)}</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="s2">&quot;_.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span> <span class="s2">&quot;__&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">cmap</span>


<span class="k">def</span> <span class="nf">_cache_renamer</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_CHARACTER_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">_splitpath</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>
    <span class="n">o</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">implementation</span><span class="o">.</span><span class="n">cache_tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">o</span>


<span class="k">def</span> <span class="nf">should_use_cache</span><span class="p">(</span><span class="n">execer</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return ``True`` if caching has been enabled for this mode (through command</span>
<span class="sd">    line flags or environment variables)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;exec&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">execer</span><span class="o">.</span><span class="n">scriptcache</span> <span class="ow">or</span> <span class="n">execer</span><span class="o">.</span><span class="n">cacheall</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_CACHE_SCRIPTS&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_CACHE_EVERYTHING&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">execer</span><span class="o">.</span><span class="n">cacheall</span> <span class="ow">or</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_CACHE_EVERYTHING&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">run_compiled_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">glb</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper to run code in a given mode and context</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">}:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">exec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span>
    <span class="n">func</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">glb</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_cache_filename</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the filename of the cache for the given filename.</span>

<span class="sd">    Cache filenames are similar to those used by the Mercurial DVCS for its</span>
<span class="sd">    internal store.</span>

<span class="sd">    The ``code`` switch should be true if we should use the code store rather</span>
<span class="sd">    than the script store.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_DATA_DIR&quot;</span><span class="p">]</span>
    <span class="n">cachedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;xonsh_code_cache&quot;</span> <span class="k">if</span> <span class="n">code</span> <span class="k">else</span> <span class="s2">&quot;xonsh_script_cache&quot;</span>
    <span class="p">)</span>
    <span class="n">cachefname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="o">*</span><span class="n">_cache_renamer</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cachefname</span>


<span class="k">def</span> <span class="nf">update_cache</span><span class="p">(</span><span class="n">ccode</span><span class="p">,</span> <span class="n">cache_file_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the cache at ``cache_file_name`` to contain the compiled code</span>
<span class="sd">    represented by ``ccode``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cache_file_name</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfile</span><span class="p">:</span>
            <span class="n">cfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">XONSH_VERSION</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">PYTHON_VERSION_INFO_BYTES</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ccode</span><span class="p">,</span> <span class="n">cfile</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_cache_versions</span><span class="p">(</span><span class="n">cfile</span><span class="p">):</span>
    <span class="c1"># version data should be &lt; 1 kb</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="n">cfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ver</span> <span class="o">!=</span> <span class="n">XONSH_VERSION</span><span class="o">.</span><span class="n">encode</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="n">cfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ver</span> <span class="o">==</span> <span class="n">PYTHON_VERSION_INFO_BYTES</span>


<span class="k">def</span> <span class="nf">compile_code</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">execer</span><span class="p">,</span> <span class="n">glb</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for ``execer.compile`` to compile the given code</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">old_filename</span> <span class="o">=</span> <span class="n">execer</span><span class="o">.</span><span class="n">filename</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">execer</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">ccode</span> <span class="o">=</span> <span class="n">execer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">glbs</span><span class="o">=</span><span class="n">glb</span><span class="p">,</span> <span class="n">locs</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">execer</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">old_filename</span>
    <span class="k">return</span> <span class="n">ccode</span>


<span class="k">def</span> <span class="nf">script_cache_check</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cachefname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether the script cache for a particular file is valid.</span>

<span class="sd">    Returns a tuple containing: a boolean representing whether the cached code</span>
<span class="sd">    should be used, and the cached code (or ``None`` if the cache should not be</span>
<span class="sd">    used).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ccode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">run_cached</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cachefname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">cachefname</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cachefname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfile</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_cache_versions</span><span class="p">(</span><span class="n">cfile</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
                <span class="n">ccode</span> <span class="o">=</span> <span class="n">marshal</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cfile</span><span class="p">)</span>
                <span class="n">run_cached</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">run_cached</span><span class="p">,</span> <span class="n">ccode</span>


<span class="k">def</span> <span class="nf">run_script_with_cache</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">execer</span><span class="p">,</span> <span class="n">glb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a script, using a cached version if it exists (and the source has not</span>
<span class="sd">    changed), and updating the cache as necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_cached</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_cache</span> <span class="o">=</span> <span class="n">should_use_cache</span><span class="p">(</span><span class="n">execer</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">cachefname</span> <span class="o">=</span> <span class="n">get_cache_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">run_cached</span><span class="p">,</span> <span class="n">ccode</span> <span class="o">=</span> <span class="n">script_cache_check</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cachefname</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run_cached</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">ccode</span> <span class="o">=</span> <span class="n">compile_code</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">execer</span><span class="p">,</span> <span class="n">glb</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">update_cache</span><span class="p">(</span><span class="n">ccode</span><span class="p">,</span> <span class="n">cachefname</span><span class="p">)</span>
    <span class="n">run_compiled_code</span><span class="p">(</span><span class="n">ccode</span><span class="p">,</span> <span class="n">glb</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">code_cache_name</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an appropriate spoofed filename for the given code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">code_cache_check</span><span class="p">(</span><span class="n">cachefname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether the code cache for a particular piece of code is valid.</span>

<span class="sd">    Returns a tuple containing: a boolean representing whether the cached code</span>
<span class="sd">    should be used, and the cached code (or ``None`` if the cache should not be</span>
<span class="sd">    used).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ccode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">run_cached</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cachefname</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cachefname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_cache_versions</span><span class="p">(</span><span class="n">cfile</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">ccode</span> <span class="o">=</span> <span class="n">marshal</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cfile</span><span class="p">)</span>
            <span class="n">run_cached</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">run_cached</span><span class="p">,</span> <span class="n">ccode</span>


<span class="k">def</span> <span class="nf">run_code_with_cache</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">execer</span><span class="p">,</span> <span class="n">glb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a piece of code, using a cached version if it exists, and updating the</span>
<span class="sd">    cache as necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">use_cache</span> <span class="o">=</span> <span class="n">should_use_cache</span><span class="p">(</span><span class="n">execer</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">code_cache_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">cachefname</span> <span class="o">=</span> <span class="n">get_cache_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">run_cached</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
        <span class="n">run_cached</span><span class="p">,</span> <span class="n">ccode</span> <span class="o">=</span> <span class="n">code_cache_check</span><span class="p">(</span><span class="n">cachefname</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run_cached</span><span class="p">:</span>
        <span class="n">ccode</span> <span class="o">=</span> <span class="n">compile_code</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">execer</span><span class="p">,</span> <span class="n">glb</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">update_cache</span><span class="p">(</span><span class="n">ccode</span><span class="p">,</span> <span class="n">cachefname</span><span class="p">)</span>
    <span class="n">run_compiled_code</span><span class="p">(</span><span class="n">ccode</span><span class="p">,</span> <span class="n">glb</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># lazyimps</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Lazy imports that may apply across the xonsh package.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated importlib</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="n">pygments</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;pygments&quot;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;pygments&quot;</span>
<span class="p">)</span>
<span class="n">pyghooks</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;xonsh.pyghooks&quot;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;pyghooks&quot;</span>
<span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">pty</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;pty&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">termios</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;termios&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">fcntl</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;fcntl&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">tty</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;tty&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">_winapi</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">_winapi</span> <span class="k">as</span> <span class="nn">m</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">msvcrt</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">msvcrt</span> <span class="k">as</span> <span class="nn">m</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">winutils</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">xonsh.winutils</span> <span class="k">as</span> <span class="nn">m</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">macutils</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_DARWIN</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">xonsh.macutils</span> <span class="k">as</span> <span class="nn">m</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">terminal256</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;pygments.formatters.terminal256&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">html</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;pygments.formatters.html&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">os_listxattr</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">dummy_listxattr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;listxattr&quot;</span><span class="p">,</span> <span class="n">dummy_listxattr</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># parser</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Implements the xonsh parser.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">Parser</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">xonsh.parsers.v310</span> <span class="kn">import</span> <span class="n">Parser</span> <span class="k">as</span> <span class="n">p</span>
    <span class="k">elif</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">xonsh.parsers.v39</span> <span class="kn">import</span> <span class="n">Parser</span> <span class="k">as</span> <span class="n">p</span>
    <span class="k">elif</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">xonsh.parsers.v38</span> <span class="kn">import</span> <span class="n">Parser</span> <span class="k">as</span> <span class="n">p</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">xonsh.parsers.v36</span> <span class="kn">import</span> <span class="n">Parser</span> <span class="k">as</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="c1">#</span>
<span class="c1"># tokenize</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Tokenization help for xonsh programs.</span>

<span class="sd">This file is a modified version of tokenize.py form the Python 3.4 and 3.5</span>
<span class="sd">standard libraries (licensed under the Python Software Foundation License,</span>
<span class="sd">version 2), which provides tokenization help for Python programs.</span>

<span class="sd">It is modified to properly tokenize xonsh code, including backtick regex</span>
<span class="sd">path and several xonsh-specific operators.</span>

<span class="sd">Original file credits:</span>
<span class="sd">   __author__ = &#39;Ka-Ping Yee &lt;ping@lfw.org&gt;&#39;</span>
<span class="sd">   __credits__ = (&#39;GvR, ESR, Tim Peters, Thomas Wouters, Fred Drake, &#39;</span>
<span class="sd">                  &#39;Skip Montanaro, Raymond Hettinger, Trent Nelson, &#39;</span>
<span class="sd">                  &#39;Michael Foord&#39;)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated io</span>
<span class="c1"># amalgamated sys</span>
<span class="n">codecs</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;codecs&#39;</span><span class="p">,</span> <span class="s1">&#39;codecs&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated builtins</span>
<span class="n">itertools</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;itertools&#39;</span><span class="p">,</span> <span class="s1">&#39;itertools&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated collections</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="s1">&#39;token&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">token</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AMPER</span><span class="p">,</span>
    <span class="n">AMPEREQUAL</span><span class="p">,</span>
    <span class="n">AT</span><span class="p">,</span>
    <span class="n">CIRCUMFLEX</span><span class="p">,</span>
    <span class="n">CIRCUMFLEXEQUAL</span><span class="p">,</span>
    <span class="n">COLON</span><span class="p">,</span>
    <span class="n">COMMA</span><span class="p">,</span>
    <span class="n">DEDENT</span><span class="p">,</span>
    <span class="n">DOT</span><span class="p">,</span>
    <span class="n">DOUBLESLASH</span><span class="p">,</span>
    <span class="n">DOUBLESLASHEQUAL</span><span class="p">,</span>
    <span class="n">DOUBLESTAR</span><span class="p">,</span>
    <span class="n">DOUBLESTAREQUAL</span><span class="p">,</span>
    <span class="n">ENDMARKER</span><span class="p">,</span>
    <span class="n">EQEQUAL</span><span class="p">,</span>
    <span class="n">EQUAL</span><span class="p">,</span>
    <span class="n">ERRORTOKEN</span><span class="p">,</span>
    <span class="n">GREATER</span><span class="p">,</span>
    <span class="n">GREATEREQUAL</span><span class="p">,</span>
    <span class="n">INDENT</span><span class="p">,</span>
    <span class="n">LBRACE</span><span class="p">,</span>
    <span class="n">LEFTSHIFT</span><span class="p">,</span>
    <span class="n">LEFTSHIFTEQUAL</span><span class="p">,</span>
    <span class="n">LESS</span><span class="p">,</span>
    <span class="n">LESSEQUAL</span><span class="p">,</span>
    <span class="n">LPAR</span><span class="p">,</span>
    <span class="n">LSQB</span><span class="p">,</span>
    <span class="n">MINEQUAL</span><span class="p">,</span>
    <span class="n">MINUS</span><span class="p">,</span>
    <span class="n">NAME</span><span class="p">,</span>
    <span class="n">NEWLINE</span><span class="p">,</span>
    <span class="n">NOTEQUAL</span><span class="p">,</span>
    <span class="n">NUMBER</span><span class="p">,</span>
    <span class="n">N_TOKENS</span><span class="p">,</span>
    <span class="n">OP</span><span class="p">,</span>
    <span class="n">PERCENT</span><span class="p">,</span>
    <span class="n">PERCENTEQUAL</span><span class="p">,</span>
    <span class="n">PLUS</span><span class="p">,</span>
    <span class="n">PLUSEQUAL</span><span class="p">,</span>
    <span class="n">RBRACE</span><span class="p">,</span>
    <span class="n">RIGHTSHIFT</span><span class="p">,</span>
    <span class="n">RIGHTSHIFTEQUAL</span><span class="p">,</span>
    <span class="n">RPAR</span><span class="p">,</span>
    <span class="n">RSQB</span><span class="p">,</span>
    <span class="n">SEMI</span><span class="p">,</span>
    <span class="n">SLASH</span><span class="p">,</span>
    <span class="n">SLASHEQUAL</span><span class="p">,</span>
    <span class="n">STAR</span><span class="p">,</span>
    <span class="n">STAREQUAL</span><span class="p">,</span>
    <span class="n">STRING</span><span class="p">,</span>
    <span class="n">TILDE</span><span class="p">,</span>
    <span class="n">VBAR</span><span class="p">,</span>
    <span class="n">VBAREQUAL</span><span class="p">,</span>
    <span class="n">tok_name</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># amalgamated typing</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="n">HAS_WALRUS</span> <span class="o">=</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="k">if</span> <span class="n">HAS_WALRUS</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">token</span> <span class="kn">import</span> <span class="n">COLONEQUAL</span>  <span class="c1"># type:ignore</span>

<span class="n">cookie_re</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[ \t\f]*#.*coding[:=][ \t]*([-\w.]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">ASCII</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;cookie_re&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">blank_re</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">br</span><span class="s2">&quot;^[ \t\f]*(?:[#\r\n]|$)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">ASCII</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;blank_re&quot;</span>
<span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># token modifications</span>
<span class="c1">#</span>
<span class="n">tok_name</span> <span class="o">=</span> <span class="n">tok_name</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">__all__</span> <span class="o">+</span> <span class="p">[</span>  <span class="c1"># type:ignore</span>
    <span class="s2">&quot;COMMENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tokenize&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detect_encoding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;untokenize&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ENCODING&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TokenInfo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TokenError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SEARCHPATH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ATDOLLAR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ATEQUAL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DOLLARNAME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;IOREDIRECT&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">HAS_ASYNC</span> <span class="o">=</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">if</span> <span class="n">HAS_ASYNC</span><span class="p">:</span>
    <span class="n">ASYNC</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">ASYNC</span>  <span class="c1"># type:ignore</span>
    <span class="n">AWAIT</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">AWAIT</span>  <span class="c1"># type:ignore</span>
    <span class="n">ADDSPACE_TOKS</span> <span class="o">=</span> <span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="n">NUMBER</span><span class="p">,</span> <span class="n">ASYNC</span><span class="p">,</span> <span class="n">AWAIT</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ADDSPACE_TOKS</span> <span class="o">=</span> <span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="n">NUMBER</span><span class="p">)</span>  <span class="c1"># type:ignore</span>
<span class="k">del</span> <span class="n">token</span>  <span class="c1"># must clean up token</span>

<span class="k">if</span> <span class="n">HAS_WALRUS</span><span class="p">:</span>
    <span class="n">AUGASSIGN_OPS</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[+\-*/%&amp;@|^=&lt;&gt;:]=?&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">AUGASSIGN_OPS</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[+\-*/%&amp;@|^=&lt;&gt;]=?&quot;</span>

<span class="n">COMMENT</span> <span class="o">=</span> <span class="n">N_TOKENS</span>
<span class="n">tok_name</span><span class="p">[</span><span class="n">COMMENT</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;COMMENT&quot;</span>
<span class="n">NL</span> <span class="o">=</span> <span class="n">N_TOKENS</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">tok_name</span><span class="p">[</span><span class="n">NL</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NL&quot;</span>
<span class="n">ENCODING</span> <span class="o">=</span> <span class="n">N_TOKENS</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">tok_name</span><span class="p">[</span><span class="n">ENCODING</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ENCODING&quot;</span>
<span class="n">N_TOKENS</span> <span class="o">+=</span> <span class="mi">3</span>
<span class="n">SEARCHPATH</span> <span class="o">=</span> <span class="n">N_TOKENS</span>
<span class="n">tok_name</span><span class="p">[</span><span class="n">N_TOKENS</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SEARCHPATH&quot;</span>
<span class="n">N_TOKENS</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">IOREDIRECT</span> <span class="o">=</span> <span class="n">N_TOKENS</span>
<span class="n">tok_name</span><span class="p">[</span><span class="n">N_TOKENS</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;IOREDIRECT&quot;</span>
<span class="n">N_TOKENS</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">DOLLARNAME</span> <span class="o">=</span> <span class="n">N_TOKENS</span>
<span class="n">tok_name</span><span class="p">[</span><span class="n">N_TOKENS</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DOLLARNAME&quot;</span>
<span class="n">N_TOKENS</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">ATDOLLAR</span> <span class="o">=</span> <span class="n">N_TOKENS</span>
<span class="n">tok_name</span><span class="p">[</span><span class="n">N_TOKENS</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ATDOLLAR&quot;</span>
<span class="n">N_TOKENS</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">ATEQUAL</span> <span class="o">=</span> <span class="n">N_TOKENS</span>
<span class="n">tok_name</span><span class="p">[</span><span class="n">N_TOKENS</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ATEQUAL&quot;</span>
<span class="n">N_TOKENS</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">_xonsh_tokens</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;?&quot;</span><span class="p">:</span> <span class="s2">&quot;QUESTION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;@=&quot;</span><span class="p">:</span> <span class="s2">&quot;ATEQUAL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;@$&quot;</span><span class="p">:</span> <span class="s2">&quot;ATDOLLAR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;||&quot;</span><span class="p">:</span> <span class="s2">&quot;DOUBLEPIPE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">:</span> <span class="s2">&quot;DOUBLEAMPER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;@(&quot;</span><span class="p">:</span> <span class="s2">&quot;ATLPAREN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;!(&quot;</span><span class="p">:</span> <span class="s2">&quot;BANGLPAREN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;![&quot;</span><span class="p">:</span> <span class="s2">&quot;BANGLBRACKET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$(&quot;</span><span class="p">:</span> <span class="s2">&quot;DOLLARLPAREN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$[&quot;</span><span class="p">:</span> <span class="s2">&quot;DOLLARLBRACKET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;${&quot;</span><span class="p">:</span> <span class="s2">&quot;DOLLARLBRACE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;??&quot;</span><span class="p">:</span> <span class="s2">&quot;DOUBLEQUESTION&quot;</span><span class="p">,</span>
    <span class="s2">&quot;@$(&quot;</span><span class="p">:</span> <span class="s2">&quot;ATDOLLARLPAREN&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">additional_parenlevs</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;@(&quot;</span><span class="p">,</span> <span class="s2">&quot;!(&quot;</span><span class="p">,</span> <span class="s2">&quot;![&quot;</span><span class="p">,</span> <span class="s2">&quot;$(&quot;</span><span class="p">,</span> <span class="s2">&quot;$[&quot;</span><span class="p">,</span> <span class="s2">&quot;${&quot;</span><span class="p">,</span> <span class="s2">&quot;@$(&quot;</span><span class="p">})</span>

<span class="n">_glbs</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_xonsh_tokens</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">_glbs</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_TOKENS</span>
    <span class="n">tok_name</span><span class="p">[</span><span class="n">N_TOKENS</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">N_TOKENS</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">del</span> <span class="n">_glbs</span><span class="p">,</span> <span class="n">v</span>

<span class="n">EXACT_TOKEN_TYPES</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;(&quot;</span><span class="p">:</span> <span class="n">LPAR</span><span class="p">,</span>
    <span class="s2">&quot;)&quot;</span><span class="p">:</span> <span class="n">RPAR</span><span class="p">,</span>
    <span class="s2">&quot;[&quot;</span><span class="p">:</span> <span class="n">LSQB</span><span class="p">,</span>
    <span class="s2">&quot;]&quot;</span><span class="p">:</span> <span class="n">RSQB</span><span class="p">,</span>
    <span class="s2">&quot;:&quot;</span><span class="p">:</span> <span class="n">COLON</span><span class="p">,</span>
    <span class="s2">&quot;,&quot;</span><span class="p">:</span> <span class="n">COMMA</span><span class="p">,</span>
    <span class="s2">&quot;;&quot;</span><span class="p">:</span> <span class="n">SEMI</span><span class="p">,</span>
    <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">PLUS</span><span class="p">,</span>
    <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="n">MINUS</span><span class="p">,</span>
    <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="n">STAR</span><span class="p">,</span>
    <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="n">SLASH</span><span class="p">,</span>
    <span class="s2">&quot;|&quot;</span><span class="p">:</span> <span class="n">VBAR</span><span class="p">,</span>
    <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span> <span class="n">AMPER</span><span class="p">,</span>
    <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="n">LESS</span><span class="p">,</span>
    <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="n">GREATER</span><span class="p">,</span>
    <span class="s2">&quot;=&quot;</span><span class="p">:</span> <span class="n">EQUAL</span><span class="p">,</span>
    <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="n">DOT</span><span class="p">,</span>
    <span class="s2">&quot;%&quot;</span><span class="p">:</span> <span class="n">PERCENT</span><span class="p">,</span>
    <span class="s2">&quot;{&quot;</span><span class="p">:</span> <span class="n">LBRACE</span><span class="p">,</span>
    <span class="s2">&quot;}&quot;</span><span class="p">:</span> <span class="n">RBRACE</span><span class="p">,</span>
    <span class="s2">&quot;==&quot;</span><span class="p">:</span> <span class="n">EQEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;!=&quot;</span><span class="p">:</span> <span class="n">NOTEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="n">LESSEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="n">GREATEREQUAL</span><span class="p">,</span>
    <span class="s2">&quot;~&quot;</span><span class="p">:</span> <span class="n">TILDE</span><span class="p">,</span>
    <span class="s2">&quot;^&quot;</span><span class="p">:</span> <span class="n">CIRCUMFLEX</span><span class="p">,</span>
    <span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">:</span> <span class="n">LEFTSHIFT</span><span class="p">,</span>
    <span class="s2">&quot;&gt;&gt;&quot;</span><span class="p">:</span> <span class="n">RIGHTSHIFT</span><span class="p">,</span>
    <span class="s2">&quot;**&quot;</span><span class="p">:</span> <span class="n">DOUBLESTAR</span><span class="p">,</span>
    <span class="s2">&quot;+=&quot;</span><span class="p">:</span> <span class="n">PLUSEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;-=&quot;</span><span class="p">:</span> <span class="n">MINEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;*=&quot;</span><span class="p">:</span> <span class="n">STAREQUAL</span><span class="p">,</span>
    <span class="s2">&quot;/=&quot;</span><span class="p">:</span> <span class="n">SLASHEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;%=&quot;</span><span class="p">:</span> <span class="n">PERCENTEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;&amp;=&quot;</span><span class="p">:</span> <span class="n">AMPEREQUAL</span><span class="p">,</span>
    <span class="s2">&quot;|=&quot;</span><span class="p">:</span> <span class="n">VBAREQUAL</span><span class="p">,</span>
    <span class="s2">&quot;^=&quot;</span><span class="p">:</span> <span class="n">CIRCUMFLEXEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;&lt;&lt;=&quot;</span><span class="p">:</span> <span class="n">LEFTSHIFTEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;&gt;&gt;=&quot;</span><span class="p">:</span> <span class="n">RIGHTSHIFTEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;**=&quot;</span><span class="p">:</span> <span class="n">DOUBLESTAREQUAL</span><span class="p">,</span>
    <span class="s2">&quot;//&quot;</span><span class="p">:</span> <span class="n">DOUBLESLASH</span><span class="p">,</span>
    <span class="s2">&quot;//=&quot;</span><span class="p">:</span> <span class="n">DOUBLESLASHEQUAL</span><span class="p">,</span>
    <span class="s2">&quot;@&quot;</span><span class="p">:</span> <span class="n">AT</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">if</span> <span class="n">HAS_WALRUS</span><span class="p">:</span>
    <span class="n">EXACT_TOKEN_TYPES</span><span class="p">[</span><span class="s2">&quot;:=&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLONEQUAL</span>

<span class="n">EXACT_TOKEN_TYPES</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_xonsh_tokens</span><span class="p">)</span>


<div class="viewcode-block" id="TokenInfo"><a class="viewcode-back" href="../../api/xontribs_meta.html#xonsh.aliases.TokenInfo">[docs]</a><span class="k">class</span> <span class="nc">TokenInfo</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;TokenInfo&quot;</span><span class="p">,</span> <span class="s2">&quot;type string start end line&quot;</span><span class="p">)):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">annotated_type</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">tok_name</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;TokenInfo(type=</span><span class="si">%s</span><span class="s2">, string=</span><span class="si">%r</span><span class="s2">, start=</span><span class="si">%r</span><span class="s2">, end=</span><span class="si">%r</span><span class="s2">, line=</span><span class="si">%r</span><span class="s2">)&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">annotated_type</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exact_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OP</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span> <span class="ow">in</span> <span class="n">EXACT_TOKEN_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EXACT_TOKEN_TYPES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">string</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span></div>


<span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="o">*</span><span class="n">choices</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>


<span class="k">def</span> <span class="nf">tokany</span><span class="p">(</span><span class="o">*</span><span class="n">choices</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="n">choices</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span>


<span class="k">def</span> <span class="nf">maybe</span><span class="p">(</span><span class="o">*</span><span class="n">choices</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="n">choices</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span>


<span class="c1"># Note: we use unicode matching for names (&quot;\w&quot;) but ascii matching for</span>
<span class="c1"># number literals.</span>
<span class="n">Whitespace</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[ \f\t]*&quot;</span>
<span class="n">Comment</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;#[^\r\n]*&quot;</span>
<span class="n">Ignore</span> <span class="o">=</span> <span class="n">Whitespace</span> <span class="o">+</span> <span class="n">tokany</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">\r?\n&quot;</span> <span class="o">+</span> <span class="n">Whitespace</span><span class="p">)</span> <span class="o">+</span> <span class="n">maybe</span><span class="p">(</span><span class="n">Comment</span><span class="p">)</span>
<span class="n">Name_RE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\$?\w+&quot;</span>

<span class="n">Hexnumber</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;0[xX](?:_?[0-9a-fA-F])+&quot;</span>
<span class="n">Binnumber</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;0[bB](?:_?[01])+&quot;</span>
<span class="n">Octnumber</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;0[oO](?:_?[0-7])+&quot;</span>
<span class="n">Decnumber</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:0(?:_?0)*|[1-9](?:_?[0-9])*)&quot;</span>
<span class="n">Intnumber</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">Hexnumber</span><span class="p">,</span> <span class="n">Binnumber</span><span class="p">,</span> <span class="n">Octnumber</span><span class="p">,</span> <span class="n">Decnumber</span><span class="p">)</span>
<span class="n">Exponent</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[eE][-+]?[0-9](?:_?[0-9])*&quot;</span>
<span class="n">Pointfloat</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;[0-9](?:_?[0-9])*\.(?:[0-9](?:_?[0-9])*)?&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\.[0-9](?:_?[0-9])*&quot;</span>
<span class="p">)</span> <span class="o">+</span> <span class="n">maybe</span><span class="p">(</span><span class="n">Exponent</span><span class="p">)</span>
<span class="n">Expfloat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[0-9](?:_?[0-9])*&quot;</span> <span class="o">+</span> <span class="n">Exponent</span>
<span class="n">Floatnumber</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">Pointfloat</span><span class="p">,</span> <span class="n">Expfloat</span><span class="p">)</span>
<span class="n">Imagnumber</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[0-9](?:_?[0-9])*[jJ]&quot;</span><span class="p">,</span> <span class="n">Floatnumber</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;[jJ]&quot;</span><span class="p">)</span>
<span class="n">Number</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">Imagnumber</span><span class="p">,</span> <span class="n">Floatnumber</span><span class="p">,</span> <span class="n">Intnumber</span><span class="p">)</span>

<span class="n">StringPrefix</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:[bB][rR]?|[p][fFrR]?|[rR][bBpfF]?|[uU]|[fF][rR]?[p]?)?&quot;</span>

<span class="c1"># Tail end of &#39; string.</span>
<span class="n">Single</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[^&#39;</span><span class="se">\\</span><span class="s2">]*(?:</span><span class="se">\\</span><span class="s2">.[^&#39;</span><span class="se">\\</span><span class="s2">]*)*&#39;&quot;</span>
<span class="c1"># Tail end of &quot; string.</span>
<span class="n">Double</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[^&quot;</span><span class="se">\\</span><span class="s1">]*(?:</span><span class="se">\\</span><span class="s1">.[^&quot;</span><span class="se">\\</span><span class="s1">]*)*&quot;&#39;</span>
<span class="c1"># Tail end of &#39;&#39;&#39; string.</span>
<span class="n">Single3</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[^&#39;</span><span class="se">\\</span><span class="s2">]*(?:(?:</span><span class="se">\\</span><span class="s2">.|&#39;(?!&#39;&#39;))[^&#39;</span><span class="se">\\</span><span class="s2">]*)*&#39;&#39;&#39;&quot;</span>
<span class="c1"># Tail end of &quot;&quot;&quot; string.</span>
<span class="n">Double3</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[^&quot;</span><span class="se">\\</span><span class="s1">]*(?:(?:</span><span class="se">\\</span><span class="s1">.|&quot;(?!&quot;&quot;))[^&quot;</span><span class="se">\\</span><span class="s1">]*)*&quot;&quot;&quot;&#39;</span>
<span class="n">Triple</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">StringPrefix</span> <span class="o">+</span> <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">,</span> <span class="n">StringPrefix</span> <span class="o">+</span> <span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span>
<span class="c1"># Single-line &#39; or &quot; string.</span>
<span class="n">String</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span>
    <span class="n">StringPrefix</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;&#39;[^\n&#39;</span><span class="se">\\</span><span class="s2">]*(?:</span><span class="se">\\</span><span class="s2">.[^\n&#39;</span><span class="se">\\</span><span class="s2">]*)*&#39;&quot;</span><span class="p">,</span>
    <span class="n">StringPrefix</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;&quot;[^\n&quot;</span><span class="se">\\</span><span class="s1">]*(?:</span><span class="se">\\</span><span class="s1">.[^\n&quot;</span><span class="se">\\</span><span class="s1">]*)*&quot;&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Xonsh-specific Syntax</span>
<span class="n">SearchPath</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;((?:[rgp]+|@\w*)?)`([^\n`</span><span class="se">\\</span><span class="s2">]*(?:</span><span class="se">\\</span><span class="s2">.[^\n`</span><span class="se">\\</span><span class="s2">]*)*)`&quot;</span>

<span class="c1"># Because of leftmost-then-longest match semantics, be sure to put the</span>
<span class="c1"># longest operators first (e.g., if = came before ==, == would get</span>
<span class="c1"># recognized as two instances of =).</span>
<span class="n">_redir_names</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">_redir_map</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c1"># stderr to stdout</span>
    <span class="s2">&quot;err&gt;out&quot;</span><span class="p">,</span>
    <span class="s2">&quot;err&gt;&amp;1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2&gt;out&quot;</span><span class="p">,</span>
    <span class="s2">&quot;err&gt;o&quot;</span><span class="p">,</span>
    <span class="s2">&quot;err&gt;1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;e&gt;out&quot;</span><span class="p">,</span>
    <span class="s2">&quot;e&gt;&amp;1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2&gt;&amp;1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;e&gt;o&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2&gt;o&quot;</span><span class="p">,</span>
    <span class="s2">&quot;e&gt;1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2&gt;1&quot;</span><span class="p">,</span>
    <span class="c1"># stdout to stderr</span>
    <span class="s2">&quot;out&gt;err&quot;</span><span class="p">,</span>
    <span class="s2">&quot;out&gt;&amp;2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1&gt;err&quot;</span><span class="p">,</span>
    <span class="s2">&quot;out&gt;e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;out&gt;2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;o&gt;err&quot;</span><span class="p">,</span>
    <span class="s2">&quot;o&gt;&amp;2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1&gt;&amp;2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;o&gt;e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1&gt;e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;o&gt;2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1&gt;2&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">IORedirect</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="n">_redir_map</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&gt;&gt;?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="n">_redir_names</span><span class="p">)))</span>

<span class="n">_redir_check_0</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_redir_map</span><span class="p">)</span>
<span class="n">_redir_check_1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_redir_names</span><span class="p">}</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">_redir_check_0</span><span class="p">)</span>
<span class="n">_redir_check_2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&gt;&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_redir_names</span><span class="p">}</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">_redir_check_1</span><span class="p">)</span>
<span class="n">_redir_check</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">_redir_check_2</span><span class="p">)</span>

<span class="n">Operator</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\*\*=?&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;&gt;&gt;=?&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;&lt;&lt;=?&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;!=&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;//=?&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;@\$\(?&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;\|\|&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;@\(&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;!\(&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;!\[&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;\$\(&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;\$\[&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;\${&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;\?\?&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;\?&quot;</span><span class="p">,</span>
    <span class="n">AUGASSIGN_OPS</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;~&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">Bracket</span> <span class="o">=</span> <span class="s2">&quot;[][()</span><span class="si">{}</span><span class="s2">]&quot;</span>
<span class="n">Special</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\r?\n&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\.\.\.&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;[:;.,@]&quot;</span><span class="p">)</span>
<span class="n">Funny</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">Operator</span><span class="p">,</span> <span class="n">Bracket</span><span class="p">,</span> <span class="n">Special</span><span class="p">)</span>

<span class="n">PlainToken</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">IORedirect</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Funny</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Name_RE</span><span class="p">,</span> <span class="n">SearchPath</span><span class="p">)</span>

<span class="c1"># First (or only) line of &#39; or &quot; string.</span>
<span class="n">ContStr</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span>
    <span class="n">StringPrefix</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;&#39;[^\n&#39;</span><span class="se">\\</span><span class="s2">]*(?:</span><span class="se">\\</span><span class="s2">.[^\n&#39;</span><span class="se">\\</span><span class="s2">]*)*&quot;</span> <span class="o">+</span> <span class="n">group</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">\r?\n&quot;</span><span class="p">),</span>
    <span class="n">StringPrefix</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;&quot;[^\n&quot;</span><span class="se">\\</span><span class="s1">]*(?:</span><span class="se">\\</span><span class="s1">.[^\n&quot;</span><span class="se">\\</span><span class="s1">]*)*&#39;</span> <span class="o">+</span> <span class="n">group</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">\r?\n&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">PseudoExtras</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">\r?\n|\Z&quot;</span><span class="p">,</span> <span class="n">Comment</span><span class="p">,</span> <span class="n">Triple</span><span class="p">,</span> <span class="n">SearchPath</span><span class="p">)</span>
<span class="n">PseudoToken</span> <span class="o">=</span> <span class="n">Whitespace</span> <span class="o">+</span> <span class="n">group</span><span class="p">(</span>
    <span class="n">PseudoExtras</span><span class="p">,</span> <span class="n">IORedirect</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Funny</span><span class="p">,</span> <span class="n">ContStr</span><span class="p">,</span> <span class="n">Name_RE</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>


<span class="n">endpats</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span> <span class="n">Single</span><span class="p">,</span>
    <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span> <span class="n">Double</span><span class="p">,</span>
    <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;r&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;r&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;b&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;b&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;f&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;f&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;R&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;R&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;B&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;B&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;F&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;F&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;br&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;br&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;fr&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;fr&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;fp&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;fp&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;bR&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;bR&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;Br&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;Br&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;BR&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;BR&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;rb&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;rb&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;rf&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;rf&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;Rb&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;Rb&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;Fr&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;Fr&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;Fp&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;Fp&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;rB&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;rB&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;rF&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;rF&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;RB&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;RB&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;RF&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;RF&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;u&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;u&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;U&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;U&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;p&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;p&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;pr&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;pr&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;pf&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;pf&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;pF&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;pF&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;pR&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;pR&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;rp&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;rp&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;Rp&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="n">Single3</span><span class="p">,</span>
    <span class="s1">&#39;Rp&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="n">Double3</span><span class="p">,</span>
    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">triple_quoted</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span>
    <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;r&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;r&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;R&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;R&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;b&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;b&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;B&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;B&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;f&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;f&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;F&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;F&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;br&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;br&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Br&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Br&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;bR&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;bR&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;BR&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;BR&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rb&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rb&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rB&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rB&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Rb&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Rb&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;RB&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;RB&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;fr&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;fr&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Fr&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Fr&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;fR&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;fR&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;FR&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;FR&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rf&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rf&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rF&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rF&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Rf&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Rf&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;RF&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;RF&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;u&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;u&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;U&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;U&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;p&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;p&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pr&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;pr&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pR&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;pR&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rp&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rp&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Rp&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Rp&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pf&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;pf&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pF&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;pF&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;fp&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;fp&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Fp&#39;&#39;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Fp&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">triple_quoted</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
<span class="n">single_quoted</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span>
    <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;r&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;r&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;R&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;R&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;b&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;b&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;B&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;B&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;f&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;f&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;F&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;F&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;br&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;br&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Br&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Br&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;bR&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;bR&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;BR&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;BR&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rb&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rb&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rB&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rB&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Rb&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Rb&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;RB&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;RB&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;fr&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;fr&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Fr&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Fr&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;fR&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;fR&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;FR&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;FR&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rf&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rf&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rF&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rF&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Rf&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Rf&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;RF&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;RF&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;u&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;u&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;U&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;U&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;p&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;p&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pr&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;pr&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pR&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;pR&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;rp&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;rp&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Rp&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Rp&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pf&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;pf&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;pF&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;pF&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;fp&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;fp&quot;&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Fp&#39;&quot;</span><span class="p">,</span>
    <span class="s1">&#39;Fp&quot;&#39;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">single_quoted</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

<span class="n">tabsize</span> <span class="o">=</span> <span class="mi">8</span>


<div class="viewcode-block" id="TokenError"><a class="viewcode-back" href="../../api/xontribs_meta.html#xonsh.aliases.TokenError">[docs]</a><span class="k">class</span> <span class="nc">TokenError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">StopTokenizing</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Untokenizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_row</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_whitespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_row</span> <span class="ow">or</span> <span class="n">row</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_row</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;start (</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">) precedes previous end (</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">row_offset</span> <span class="o">=</span> <span class="n">row</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_row</span>
        <span class="k">if</span> <span class="n">row_offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">row_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">col_offset</span> <span class="o">=</span> <span class="n">col</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span>
        <span class="k">if</span> <span class="n">col_offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">col_offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">untokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="n">indents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">startline</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">tok_type</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">if</span> <span class="n">tok_type</span> <span class="o">==</span> <span class="n">ENCODING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">token</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">tok_type</span> <span class="o">==</span> <span class="n">ENDMARKER</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">tok_type</span> <span class="o">==</span> <span class="n">INDENT</span><span class="p">:</span>
                <span class="n">indents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">tok_type</span> <span class="o">==</span> <span class="n">DEDENT</span><span class="p">:</span>
                <span class="n">indents</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span> <span class="o">=</span> <span class="n">end</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">tok_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NEWLINE</span><span class="p">,</span> <span class="n">NL</span><span class="p">):</span>
                <span class="n">startline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">startline</span> <span class="ow">and</span> <span class="n">indents</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="n">indents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>
                <span class="n">startline</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_whitespace</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span> <span class="o">=</span> <span class="n">end</span>
            <span class="k">if</span> <span class="n">tok_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NEWLINE</span><span class="p">,</span> <span class="n">NL</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_row</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="n">indents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">toks_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">append</span>
        <span class="n">startline</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NEWLINE</span><span class="p">,</span> <span class="n">NL</span><span class="p">)</span>
        <span class="n">prevstring</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">token</span><span class="p">],</span> <span class="n">iterable</span><span class="p">):</span>
            <span class="n">toknum</span><span class="p">,</span> <span class="n">tokval</span> <span class="o">=</span> <span class="n">tok</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">toknum</span> <span class="o">==</span> <span class="n">ENCODING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">tokval</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">toknum</span> <span class="ow">in</span> <span class="n">ADDSPACE_TOKS</span><span class="p">:</span>
                <span class="n">tokval</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>

            <span class="c1"># Insert a space between two consecutive strings</span>
            <span class="k">if</span> <span class="n">toknum</span> <span class="o">==</span> <span class="n">STRING</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prevstring</span><span class="p">:</span>
                    <span class="n">tokval</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">tokval</span>
                <span class="n">prevstring</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prevstring</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">toknum</span> <span class="o">==</span> <span class="n">INDENT</span><span class="p">:</span>
                <span class="n">indents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokval</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">toknum</span> <span class="o">==</span> <span class="n">DEDENT</span><span class="p">:</span>
                <span class="n">indents</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">toknum</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NEWLINE</span><span class="p">,</span> <span class="n">NL</span><span class="p">):</span>
                <span class="n">startline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">startline</span> <span class="ow">and</span> <span class="n">indents</span><span class="p">:</span>
                <span class="n">toks_append</span><span class="p">(</span><span class="n">indents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">startline</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">toks_append</span><span class="p">(</span><span class="n">tokval</span><span class="p">)</span>


<div class="viewcode-block" id="untokenize"><a class="viewcode-back" href="../../api/xontribs_meta.html#xonsh.aliases.untokenize">[docs]</a><span class="k">def</span> <span class="nf">untokenize</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform tokens back into Python source code.</span>
<span class="sd">    It returns a bytes object, encoded using the ENCODING</span>
<span class="sd">    token, which is the first token sequence output by tokenize.</span>

<span class="sd">    Each element returned by the iterable must be a token sequence</span>
<span class="sd">    with at least two elements, a token number and token value.  If</span>
<span class="sd">    only two tokens are passed, the resulting output is poor.</span>

<span class="sd">    Round-trip invariant for full input:</span>
<span class="sd">        Untokenized source will match input source exactly</span>

<span class="sd">    Round-trip invariant for limited intput:</span>
<span class="sd">        # Output bytes will tokenize the back to the input</span>
<span class="sd">        t1 = [tok[:2] for tok in tokenize(f.readline)]</span>
<span class="sd">        newcode = untokenize(t1)</span>
<span class="sd">        readline = BytesIO(newcode).readline</span>
<span class="sd">        t2 = [tok[:2] for tok in tokenize(readline)]</span>
<span class="sd">        assert t1 == t2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ut</span> <span class="o">=</span> <span class="n">Untokenizer</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">untokenize</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="k">def</span> <span class="nf">_get_normal_name</span><span class="p">(</span><span class="n">orig_enc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Imitates get_normal_name in tokenizer.c.&quot;&quot;&quot;</span>
    <span class="c1"># Only care about the first 12 characters.</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="n">orig_enc</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">enc</span> <span class="o">==</span> <span class="s2">&quot;utf-8&quot;</span> <span class="ow">or</span> <span class="n">enc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;utf-8-&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="k">if</span> <span class="n">enc</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">,</span> <span class="s2">&quot;iso-8859-1&quot;</span><span class="p">,</span> <span class="s2">&quot;iso-latin-1&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">enc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;latin-1-&quot;</span><span class="p">,</span> <span class="s2">&quot;iso-8859-1-&quot;</span><span class="p">,</span> <span class="s2">&quot;iso-latin-1-&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;iso-8859-1&quot;</span>
    <span class="k">return</span> <span class="n">orig_enc</span>


<div class="viewcode-block" id="detect_encoding"><a class="viewcode-back" href="../../api/xontribs_meta.html#xonsh.aliases.detect_encoding">[docs]</a><span class="k">def</span> <span class="nf">detect_encoding</span><span class="p">(</span><span class="n">readline</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The detect_encoding() function is used to detect the encoding that should</span>
<span class="sd">    be used to decode a Python source file.  It requires one argument, readline,</span>
<span class="sd">    in the same way as the tokenize() generator.</span>

<span class="sd">    It will call readline a maximum of twice, and return the encoding used</span>
<span class="sd">    (as a string) and a list of any lines (left as bytes) it has read in.</span>

<span class="sd">    It detects the encoding from the presence of a utf-8 bom or an encoding</span>
<span class="sd">    cookie as specified in pep-0263.  If both a bom and a cookie are present,</span>
<span class="sd">    but disagree, a SyntaxError will be raised.  If the encoding cookie is an</span>
<span class="sd">    invalid charset, raise a SyntaxError.  Note that if a utf-8 bom is found,</span>
<span class="sd">    &#39;utf-8-sig&#39; is returned.</span>

<span class="sd">    If no encoding is specified, then the default of &#39;utf-8&#39; will be returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="n">name</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bom_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>

    <span class="k">def</span> <span class="nf">read_or_stop</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">readline</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">find_cookie</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Decode as UTF-8. Either the line is an encoding declaration,</span>
            <span class="c1"># in which case it should be pure ASCII, or it must be UTF-8</span>
            <span class="c1"># per default encoding.</span>
            <span class="n">line_string</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;invalid or missing encoding declaration&quot;</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> for </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">match</span> <span class="o">=</span> <span class="n">cookie_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">_get_normal_name</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="c1"># This behaviour mimics the Python interpreter</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;unknown encoding: &quot;</span> <span class="o">+</span> <span class="n">encoding</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;unknown encoding for </span><span class="si">{!r}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bom_found</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">:</span>
                <span class="c1"># This behaviour mimics the Python interpreter</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;encoding problem: utf-8&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;encoding problem for </span><span class="si">{!r}</span><span class="s2">: utf-8&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">encoding</span> <span class="o">+=</span> <span class="s2">&quot;-sig&quot;</span>
        <span class="k">return</span> <span class="n">encoding</span>

    <span class="n">first</span> <span class="o">=</span> <span class="n">read_or_stop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">first</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF8</span><span class="p">):</span>
        <span class="n">bom_found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;utf-8-sig&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span><span class="p">,</span> <span class="p">[]</span>

    <span class="n">encoding</span> <span class="o">=</span> <span class="n">find_cookie</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">encoding</span><span class="p">,</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blank_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">first</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">default</span><span class="p">,</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span>

    <span class="n">second</span> <span class="o">=</span> <span class="n">read_or_stop</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">second</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span><span class="p">,</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span>

    <span class="n">encoding</span> <span class="o">=</span> <span class="n">find_cookie</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">encoding</span><span class="p">,</span> <span class="p">[</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">default</span><span class="p">,</span> <span class="p">[</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">tokopen</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open a file in read only mode using the encoding detected by</span>
<span class="sd">    detect_encoding().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">encoding</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">detect_encoding</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
        <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">line_buffering</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">raise</span>


<span class="k">def</span> <span class="nf">_tokenize</span><span class="p">(</span><span class="n">readline</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">tolerant</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">lnum</span> <span class="o">=</span> <span class="n">parenlev</span> <span class="o">=</span> <span class="n">continued</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">numchars</span> <span class="o">=</span> <span class="s2">&quot;0123456789&quot;</span>
    <span class="n">contstr</span><span class="p">,</span> <span class="n">needcont</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">contline</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">indents</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># &#39;stashed&#39; and &#39;async_*&#39; are used for async/await parsing</span>
    <span class="n">stashed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">async_def</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">async_def_indent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">async_def_nl</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s2">&quot;utf-8-sig&quot;</span><span class="p">:</span>
            <span class="c1"># BOM will already have been stripped.</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
        <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">ENCODING</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># loop over lines in stream</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">readline</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">lnum</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pos</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contstr</span><span class="p">:</span>  <span class="c1"># continued string</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tolerant</span><span class="p">:</span>
                    <span class="c1"># return the partial string</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                        <span class="n">ERRORTOKEN</span><span class="p">,</span> <span class="n">contstr</span><span class="p">,</span> <span class="n">strstart</span><span class="p">,</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">contline</span> <span class="o">+</span> <span class="n">line</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TokenError</span><span class="p">(</span><span class="s2">&quot;EOF in multi-line string&quot;</span><span class="p">,</span> <span class="n">strstart</span><span class="p">)</span>
            <span class="n">endmatch</span> <span class="o">=</span> <span class="n">endprog</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">endmatch</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="n">endmatch</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                    <span class="n">STRING</span><span class="p">,</span> <span class="n">contstr</span> <span class="o">+</span> <span class="n">line</span><span class="p">[:</span><span class="n">end</span><span class="p">],</span> <span class="n">strstart</span><span class="p">,</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">contline</span> <span class="o">+</span> <span class="n">line</span>
                <span class="p">)</span>
                <span class="n">contstr</span><span class="p">,</span> <span class="n">needcont</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span>
                <span class="n">contline</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">needcont</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\\\r\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                    <span class="n">ERRORTOKEN</span><span class="p">,</span> <span class="n">contstr</span> <span class="o">+</span> <span class="n">line</span><span class="p">,</span> <span class="n">strstart</span><span class="p">,</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)),</span> <span class="n">contline</span>
                <span class="p">)</span>
                <span class="n">contstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">contline</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">contstr</span> <span class="o">=</span> <span class="n">contstr</span> <span class="o">+</span> <span class="n">line</span>
                <span class="n">contline</span> <span class="o">=</span> <span class="n">contline</span> <span class="o">+</span> <span class="n">line</span>
                <span class="k">continue</span>

        <span class="k">elif</span> <span class="n">parenlev</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">continued</span><span class="p">:</span>  <span class="c1"># new statement</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">column</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">:</span>  <span class="c1"># measure leading whitespace</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                    <span class="n">column</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="p">(</span><span class="n">column</span> <span class="o">//</span> <span class="n">tabsize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tabsize</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\f</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="nb">max</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;#</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># skip comments or blank lines</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                    <span class="n">comment_token</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">nl_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment_token</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                        <span class="n">COMMENT</span><span class="p">,</span>
                        <span class="n">comment_token</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment_token</span><span class="p">)),</span>
                        <span class="n">line</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                        <span class="n">NL</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="n">nl_pos</span><span class="p">:],</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">nl_pos</span><span class="p">),</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)),</span> <span class="n">line</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">NL</span><span class="p">,</span> <span class="n">COMMENT</span><span class="p">)[</span><span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">],</span>
                        <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">:],</span>
                        <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)),</span>
                        <span class="n">line</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">column</span> <span class="o">&gt;</span> <span class="n">indents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># count indents or dedents</span>
                <span class="n">indents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">INDENT</span><span class="p">,</span> <span class="n">line</span><span class="p">[:</span><span class="n">pos</span><span class="p">],</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">column</span> <span class="o">&lt;</span> <span class="n">indents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indents</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tolerant</span>
                <span class="p">):</span>  <span class="c1"># if tolerant, just ignore the error</span>
                    <span class="k">raise</span> <span class="ne">IndentationError</span><span class="p">(</span>
                        <span class="s2">&quot;unindent does not match any outer indentation level&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="s2">&quot;&lt;tokenize&gt;&quot;</span><span class="p">,</span> <span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="n">indents</span> <span class="o">=</span> <span class="n">indents</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">async_def</span> <span class="ow">and</span> <span class="n">async_def_indent</span> <span class="o">&gt;=</span> <span class="n">indents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">async_def</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">async_def_nl</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">async_def_indent</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">DEDENT</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">async_def</span> <span class="ow">and</span> <span class="n">async_def_nl</span> <span class="ow">and</span> <span class="n">async_def_indent</span> <span class="o">&gt;=</span> <span class="n">indents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">async_def</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">async_def_nl</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">async_def_indent</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># continued statement</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tolerant</span><span class="p">:</span>
                    <span class="c1"># no need to raise an error, we&#39;re done</span>
                    <span class="k">break</span>
                <span class="k">raise</span> <span class="n">TokenError</span><span class="p">(</span><span class="s2">&quot;EOF in multi-line statement&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">continued</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">:</span>
            <span class="n">pseudomatch</span> <span class="o">=</span> <span class="n">_compile</span><span class="p">(</span><span class="n">PseudoToken</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pseudomatch</span><span class="p">:</span>  <span class="c1"># scan for tokens</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">pseudomatch</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">start</span><span class="p">),</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">end</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">initial</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">_redir_check</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">IOREDIRECT</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">initial</span> <span class="ow">in</span> <span class="n">numchars</span> <span class="ow">or</span> <span class="p">(</span>  <span class="c1"># ordinary number</span>
                    <span class="n">initial</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span> <span class="ow">and</span> <span class="n">token</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span> <span class="ow">and</span> <span class="n">token</span> <span class="o">!=</span> <span class="s2">&quot;...&quot;</span>
                <span class="p">):</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">NUMBER</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">initial</span> <span class="ow">in</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stashed</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">stashed</span>
                        <span class="n">stashed</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">parenlev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">NL</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">NEWLINE</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">async_def</span><span class="p">:</span>
                            <span class="n">async_def_nl</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">elif</span> <span class="n">initial</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">stashed</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">stashed</span>
                        <span class="n">stashed</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">COMMENT</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="c1"># Xonsh-specific Regex Globbing</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">SearchPath</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">SEARCHPATH</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">triple_quoted</span><span class="p">:</span>
                    <span class="n">endprog</span> <span class="o">=</span> <span class="n">_compile</span><span class="p">(</span><span class="n">endpats</span><span class="p">[</span><span class="n">token</span><span class="p">])</span>
                    <span class="n">endmatch</span> <span class="o">=</span> <span class="n">endprog</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">endmatch</span><span class="p">:</span>  <span class="c1"># all on one line</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">endmatch</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">token</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span>
                        <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">STRING</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">strstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>  <span class="c1"># multiple lines</span>
                        <span class="n">contstr</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>
                        <span class="n">contline</span> <span class="o">=</span> <span class="n">line</span>
                        <span class="k">break</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">initial</span> <span class="ow">in</span> <span class="n">single_quoted</span>
                    <span class="ow">or</span> <span class="n">token</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">single_quoted</span>
                    <span class="ow">or</span> <span class="n">token</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">single_quoted</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># continued string</span>
                        <span class="n">strstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
                        <span class="n">endprog</span> <span class="o">=</span> <span class="n">_compile</span><span class="p">(</span>
                            <span class="n">endpats</span><span class="p">[</span><span class="n">initial</span><span class="p">]</span> <span class="ow">or</span> <span class="n">endpats</span><span class="p">[</span><span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="ow">or</span> <span class="n">endpats</span><span class="p">[</span><span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                        <span class="p">)</span>
                        <span class="n">contstr</span><span class="p">,</span> <span class="n">needcont</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">start</span><span class="p">:],</span> <span class="mi">1</span>
                        <span class="n">contline</span> <span class="o">=</span> <span class="n">line</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># ordinary string</span>
                        <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">STRING</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">DOLLARNAME</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">initial</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">():</span>  <span class="c1"># ordinary name</span>
                    <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;async&quot;</span><span class="p">,</span> <span class="s2">&quot;await&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">async_def</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                                <span class="n">ASYNC</span> <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;async&quot;</span> <span class="k">else</span> <span class="n">AWAIT</span><span class="p">,</span>
                                <span class="n">token</span><span class="p">,</span>
                                <span class="n">spos</span><span class="p">,</span>
                                <span class="n">epos</span><span class="p">,</span>
                                <span class="n">line</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>

                    <span class="n">tok</span> <span class="o">=</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;async&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stashed</span><span class="p">:</span>
                        <span class="n">stashed</span> <span class="o">=</span> <span class="n">tok</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">HAS_ASYNC</span>
                        <span class="ow">and</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;def&quot;</span>
                        <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">stashed</span>
                            <span class="ow">and</span> <span class="n">stashed</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">NAME</span>
                            <span class="ow">and</span> <span class="n">stashed</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;async&quot;</span>
                        <span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">async_def</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">async_def_indent</span> <span class="o">=</span> <span class="n">indents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                        <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                            <span class="n">ASYNC</span><span class="p">,</span>
                            <span class="n">stashed</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                            <span class="n">stashed</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                            <span class="n">stashed</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                            <span class="n">stashed</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">stashed</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">stashed</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">stashed</span>
                        <span class="n">stashed</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">yield</span> <span class="n">tok</span>
                <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\\r\n</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># continued stmt</span>
                    <span class="n">continued</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">ERRORTOKEN</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">initial</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># continued stmt</span>
                    <span class="c1"># for cases like C:\\path\\to\\file</span>
                    <span class="n">continued</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">initial</span> <span class="ow">in</span> <span class="s2">&quot;([{&quot;</span><span class="p">:</span>
                        <span class="n">parenlev</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">initial</span> <span class="ow">in</span> <span class="s2">&quot;)]}&quot;</span><span class="p">:</span>
                        <span class="n">parenlev</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">additional_parenlevs</span><span class="p">:</span>
                        <span class="n">parenlev</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">stashed</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">stashed</span>
                        <span class="n">stashed</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">spos</span><span class="p">,</span> <span class="n">epos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span>
                    <span class="n">ERRORTOKEN</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">line</span>
                <span class="p">)</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">stashed</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">stashed</span>
        <span class="n">stashed</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">indents</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># pop remaining indent levels</span>
        <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">DEDENT</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">TokenInfo</span><span class="p">(</span><span class="n">ENDMARKER</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">lnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="tokenize"><a class="viewcode-back" href="../../api/xontribs_meta.html#xonsh.aliases.tokenize">[docs]</a><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">readline</span><span class="p">,</span> <span class="n">tolerant</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The tokenize() generator requires one argument, readline, which</span>
<span class="sd">    must be a callable object which provides the same interface as the</span>
<span class="sd">    readline() method of built-in file objects.  Each call to the function</span>
<span class="sd">    should return one line of input as bytes.  Alternately, readline</span>
<span class="sd">    can be a callable function terminating with StopIteration:</span>
<span class="sd">        readline = open(myfile, &#39;rb&#39;).__next__  # Example of alternate readline</span>

<span class="sd">    The generator produces 5-tuples with these members: the token type; the</span>
<span class="sd">    token string; a 2-tuple (srow, scol) of ints specifying the row and</span>
<span class="sd">    column where the token begins in the source; a 2-tuple (erow, ecol) of</span>
<span class="sd">    ints specifying the row and column where the token ends in the source;</span>
<span class="sd">    and the line on which the token was found.  The line passed is the</span>
<span class="sd">    logical line; continuation lines are included.</span>

<span class="sd">    The first token sequence will always be an ENCODING token</span>
<span class="sd">    which tells you which encoding was used to decode the bytes stream.</span>

<span class="sd">    If ``tolerant`` is True, yield ERRORTOKEN with the erroneous string instead of</span>
<span class="sd">    throwing an exception when encountering an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">encoding</span><span class="p">,</span> <span class="n">consumed</span> <span class="o">=</span> <span class="n">detect_encoding</span><span class="p">(</span><span class="n">readline</span><span class="p">)</span>
    <span class="n">rl_gen</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">readline</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">empty</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_tokenize</span><span class="p">(</span>
        <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">consumed</span><span class="p">,</span> <span class="n">rl_gen</span><span class="p">,</span> <span class="n">empty</span><span class="p">)</span><span class="o">.</span><span class="fm">__next__</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">tolerant</span>
    <span class="p">)</span></div>


<span class="c1"># An undocumented, backwards compatible, API for all the places in the standard</span>
<span class="c1"># library that expect to be able to use tokenize with strings</span>
<span class="k">def</span> <span class="nf">generate_tokens</span><span class="p">(</span><span class="n">readline</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_tokenize</span><span class="p">(</span><span class="n">readline</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">tokenize_main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="c1"># Helper error handling routines</span>
    <span class="k">def</span> <span class="nf">perror</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">filename</span><span class="p">,)</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="p">(</span><span class="n">message</span><span class="p">,)</span>
            <span class="n">perror</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">: error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">perror</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perror</span><span class="p">(</span><span class="s2">&quot;error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Parse the arguments and options</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s2">&quot;python -m tokenize&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;filename.py&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the file to tokenize; defaults to stdin&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--exact&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;display token names using the exact type&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Tokenize the input</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">filename</span>
            <span class="k">with</span> <span class="n">builtins</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">_tokenize</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Output the tokenization</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">token_type</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">exact</span><span class="p">:</span>
                <span class="n">token_type</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">exact_type</span>
            <span class="n">token_range</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-20s%-15s%-15r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token_range</span><span class="p">,</span> <span class="n">tok_name</span><span class="p">[</span><span class="n">token_type</span><span class="p">],</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">IndentationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">TokenError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;interrupted</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">perror</span><span class="p">(</span><span class="s2">&quot;unexpected error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">raise</span>

<span class="c1">#</span>
<span class="c1"># tools</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Misc. xonsh tools.</span>

<span class="sd">The following implementations were forked from the IPython project:</span>

<span class="sd">* Copyright (c) 2008-2014, IPython Development Team</span>
<span class="sd">* Copyright (C) 2001-2007 Fernando Perez &lt;fperez@colorado.edu&gt;</span>
<span class="sd">* Copyright (c) 2001, Janko Hauser &lt;jhauser@zscout.de&gt;</span>
<span class="sd">* Copyright (c) 2001, Nathaniel Gray &lt;n8gray@caltech.edu&gt;</span>

<span class="sd">Implementations:</span>

<span class="sd">* decode()</span>
<span class="sd">* encode()</span>
<span class="sd">* cast_unicode()</span>
<span class="sd">* safe_hasattr()</span>
<span class="sd">* indent()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated collections</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="c1"># amalgamated contextlib</span>
<span class="c1"># amalgamated ctypes</span>
<span class="c1"># amalgamated datetime</span>
<span class="c1"># amalgamated functools</span>
<span class="n">glob</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;glob&#39;</span><span class="p">,</span> <span class="s1">&#39;glob&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated itertools</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated pathlib</span>
<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated subprocess</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated threading</span>
<span class="n">traceback</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;traceback&#39;</span><span class="p">,</span> <span class="s1">&#39;traceback&#39;</span><span class="p">)</span>
<span class="n">warnings</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;warnings&#39;</span><span class="p">,</span> <span class="s1">&#39;warnings&#39;</span><span class="p">)</span>
<span class="n">operator</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;operator&#39;</span><span class="p">,</span> <span class="s1">&#39;operator&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated ast</span>
<span class="n">string</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated typing</span>
<span class="n">shlex</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;shlex&#39;</span><span class="p">,</span> <span class="s1">&#39;shlex&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">xonsh</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">is_superuser</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">shell32</span><span class="o">.</span><span class="n">IsUserAnAdmin</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">rtn</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">xsh</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">xonsh.built_ins</span> <span class="kn">import</span> <span class="n">XSH</span>

    <span class="k">return</span> <span class="n">XSH</span>


<span class="k">class</span> <span class="nc">XonshError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">XonshCalledProcessError</span><span class="p">(</span><span class="n">XonshError</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when there&#39;s an error with a called process</span>

<span class="sd">    Inherits from XonshError and subprocess.CalledProcessError, catching</span>
<span class="sd">    either will also catch this error.</span>

<span class="sd">    Raised *after* iterating over stdout of a captured command, if the</span>
<span class="sd">    returncode of the command is nonzero.</span>

<span class="sd">    Example:</span>
<span class="sd">    -------</span>
<span class="sd">        try:</span>
<span class="sd">            for line in !(ls):</span>
<span class="sd">                print(line)</span>
<span class="sd">        except subprocess.CalledProcessError as error:</span>
<span class="sd">            print(&quot;Error in process: {}.format(error.completed_command.pid))</span>

<span class="sd">    This also handles differences between Python3.4 and 3.5 where</span>
<span class="sd">    CalledProcessError is concerned.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">completed_command</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">returncode</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed_command</span> <span class="o">=</span> <span class="n">completed_command</span>


<span class="k">def</span> <span class="nf">expand_path</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">expand_user</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes a string path and expands ~ to home if expand_user is set</span>
<span class="sd">    and environment vars if EXPAND_ENV_VARS is set.&quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span> <span class="ow">or</span> <span class="n">os_environ</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EXPAND_ENV_VARS&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expand_user</span><span class="p">:</span>
        <span class="c1"># expand ~ according to Bash unquoted rules &quot;Each variable assignment is</span>
        <span class="c1"># checked for unquoted tilde-prefixes immediately following a &#39;:&#39; or the</span>
        <span class="c1"># first &#39;=&#39;&quot;. See the following for more details.</span>
        <span class="c1"># https://www.gnu.org/software/bash/manual/html_node/Tilde-Expansion.html</span>
        <span class="n">pre</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">char</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span> <span class="o">+</span> <span class="n">char</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">expanduser</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">_expandpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs environment variable / user expansion on a given path</span>
<span class="sd">    if EXPAND_ENV_VARS is set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span> <span class="ow">or</span> <span class="n">os_environ</span>
    <span class="n">expand_user</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EXPAND_ENV_VARS&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">expand_user</span><span class="o">=</span><span class="n">expand_user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">simple_random_choice</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns random element from the list with length less than 1 million elements.&quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">:</span>  <span class="c1"># microsecond maximum</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The list is too long.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lst</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">%</span> <span class="n">size</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">decode_bytes</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tries to decode the bytes using XONSH_ENCODING if available,</span>
<span class="sd">    otherwise using sys.getdefaultencoding().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span> <span class="ow">or</span> <span class="n">os_environ</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_ENCODING</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;strict&quot;</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">findfirst</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substrs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds whichever of the given substrings occurs first in the given string</span>
<span class="sd">    and returns that substring, or returns None if no such strings occur.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">substr</span> <span class="ow">in</span> <span class="n">substrs</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">substr</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">substr</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">EnvPath</span><span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">MutableSequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that implements an environment path, which is a list of</span>
<span class="sd">    strings. Provides a custom method that expands all paths if the</span>
<span class="sd">    relevant env variable has been set.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_l</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="c1"># decode bytes to a string and then split based on</span>
                <span class="c1"># the default path separator</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_l</span> <span class="o">=</span> <span class="n">decode_bytes</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="c1"># put everything in a list -before- performing the type check</span>
                <span class="c1"># in order to be able to retrieve it later, for cases such as</span>
                <span class="c1"># when a generator expression was passed as an argument</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
                    <span class="c1"># make TypeError&#39;s message as informative as possible</span>
                    <span class="c1"># when given an invalid initialization sequence</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;EnvPath&#39;s initialization sequence should only &quot;</span>
                        <span class="s2">&quot;contain str, bytes and pathlib.Path entries&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_l</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;EnvPath cannot be initialized with items &quot;</span>
                    <span class="s2">&quot;of type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c1"># handle slices separately</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">_expandpath</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_expandpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of directories that this EnvPath contains.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pretty print path list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;EnvPath(...)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;EnvPath(</span><span class="se">\n</span><span class="s2">[&quot;</span><span class="p">,</span> <span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">)&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">breakable</span><span class="p">()</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">EnvPath</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_l</span>
        <span class="k">return</span> <span class="n">EnvPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span> <span class="o">+</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">EnvPath</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_l</span>
        <span class="k">return</span> <span class="n">EnvPath</span><span class="p">(</span><span class="n">other</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">front</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a value to this EnvPath,</span>

<span class="sd">        path.add(data, front=bool, replace=bool) -&gt; ensures that path contains data, with position determined by kwargs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : string or bytes or pathlib.Path</span>
<span class="sd">            value to be added</span>
<span class="sd">        front : bool</span>
<span class="sd">            whether the value should be added to the front, will be</span>
<span class="sd">            ignored if the data already exists in this EnvPath and</span>
<span class="sd">            replace is False</span>
<span class="sd">            Default : False</span>
<span class="sd">        replace : bool</span>
<span class="sd">            If True, the value will be removed and added to the</span>
<span class="sd">            start or end(depending on the value of front)</span>
<span class="sd">            Default : False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">front</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">replace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">front</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">FORMATTER</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">Formatter</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DefaultNotGivenType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Singleton for representing when no default value is given.&quot;&quot;&quot;</span>

    <span class="n">__inst</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;DefaultNotGivenType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">DefaultNotGivenType</span><span class="o">.</span><span class="n">__inst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">DefaultNotGivenType</span><span class="o">.</span><span class="n">__inst</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DefaultNotGivenType</span><span class="o">.</span><span class="n">__inst</span>


<span class="n">DefaultNotGiven</span> <span class="o">=</span> <span class="n">DefaultNotGivenType</span><span class="p">()</span>

<span class="n">BEG_TOK_SKIPS</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;WS&quot;</span><span class="p">,</span> <span class="s2">&quot;INDENT&quot;</span><span class="p">,</span> <span class="s2">&quot;NOT&quot;</span><span class="p">,</span> <span class="s2">&quot;LPAREN&quot;</span><span class="p">]),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;BEG_TOK_SKIPS&quot;</span>
<span class="p">)</span>
<span class="n">END_TOK_TYPES</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;SEMI&quot;</span><span class="p">,</span> <span class="s2">&quot;AND&quot;</span><span class="p">,</span> <span class="s2">&quot;OR&quot;</span><span class="p">,</span> <span class="s2">&quot;RPAREN&quot;</span><span class="p">]),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;END_TOK_TYPES&quot;</span>
<span class="p">)</span>
<span class="n">RE_END_TOKS</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(;|and|\&amp;\&amp;|or|\|\||\))&quot;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;RE_END_TOKS&quot;</span>
<span class="p">)</span>
<span class="n">LPARENS</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;LPAREN&quot;</span><span class="p">,</span> <span class="s2">&quot;AT_LPAREN&quot;</span><span class="p">,</span> <span class="s2">&quot;BANG_LPAREN&quot;</span><span class="p">,</span> <span class="s2">&quot;DOLLAR_LPAREN&quot;</span><span class="p">,</span> <span class="s2">&quot;ATDOLLAR_LPAREN&quot;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;LPARENS&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_not_lparen_and_rparen</span><span class="p">(</span><span class="n">lparens</span><span class="p">,</span> <span class="n">rtok</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if an RPAREN token is matched with something other than a plain old</span>
<span class="sd">    LPAREN type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># note that any([]) is False, so this covers len(lparens) == 0</span>
    <span class="k">return</span> <span class="n">rtok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;RPAREN&quot;</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;LPAREN&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lparens</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">balanced_parens</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">mincol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines if parentheses are balanced in an expression.&quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">mincol</span><span class="p">:</span><span class="n">maxcol</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lexer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">execer</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span>
    <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">&quot;)&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lexer</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">lexer</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">LPARENS</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;RPAREN&quot;</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ERRORTOKEN&quot;</span> <span class="ow">and</span> <span class="s2">&quot;)&quot;</span> <span class="ow">in</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">ends_with_colon_token</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines whether a line ends with a colon token, ignoring comments.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lexer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">execer</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span>
    <span class="n">lexer</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lexer</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;COLON&quot;</span>


<span class="k">def</span> <span class="nf">find_next_break</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">mincol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the column number of the next logical break in subproc mode.</span>
<span class="sd">    This function may be useful in finding the maxcol argument of</span>
<span class="sd">    subproc_toks().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mincol</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">mincol</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">lexer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">execer</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span>
    <span class="k">if</span> <span class="n">RE_END_TOKS</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">maxcol</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lparens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lexer</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">lexer</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">LPARENS</span><span class="p">:</span>
            <span class="n">lparens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">END_TOK_TYPES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_not_lparen_and_rparen</span><span class="p">(</span><span class="n">lparens</span><span class="p">,</span> <span class="n">tok</span><span class="p">):</span>
                <span class="n">lparens</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxcol</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">lexpos</span> <span class="o">+</span> <span class="n">mincol</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">elif</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ERRORTOKEN&quot;</span> <span class="ow">and</span> <span class="s2">&quot;)&quot;</span> <span class="ow">in</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">maxcol</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">lexpos</span> <span class="o">+</span> <span class="n">mincol</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;BANG&quot;</span><span class="p">:</span>
            <span class="n">maxcol</span> <span class="o">=</span> <span class="n">mincol</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">maxcol</span>


<span class="k">def</span> <span class="nf">_offset_from_prev_lines</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">last</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">subproc_toks</span><span class="p">(</span>
    <span class="n">line</span><span class="p">,</span> <span class="n">mincol</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">returnline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">greedy</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encapsulates tokens in a source code line in a uncaptured</span>
<span class="sd">    subprocess ![] starting at a minimum column. If there are no tokens</span>
<span class="sd">    (ie in a comment line) this returns None. If greedy is True, it will encapsulate</span>
<span class="sd">    normal parentheses. Greedy is False by default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lexer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">execer</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span>
    <span class="k">if</span> <span class="n">maxcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxcol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">lexer</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">lexer</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lparens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">saw_macro</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">end_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">lexer</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">lexpos</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">END_TOK_TYPES</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">maxcol</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;BANG&quot;</span><span class="p">:</span>
            <span class="n">saw_macro</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">saw_macro</span> <span class="ow">and</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NEWLINE&quot;</span><span class="p">,</span> <span class="s2">&quot;DEDENT&quot;</span><span class="p">):</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">LPARENS</span><span class="p">:</span>
            <span class="n">lparens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">greedy</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lparens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s2">&quot;LPAREN&quot;</span> <span class="ow">in</span> <span class="n">lparens</span><span class="p">:</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;RPAREN&quot;</span><span class="p">:</span>
                <span class="n">lparens</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">BEG_TOK_SKIPS</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># handle indentation</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">END_TOK_TYPES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_not_lparen_and_rparen</span><span class="p">(</span><span class="n">lparens</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">lparens</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># don&#39;t continue or break</span>
            <span class="k">elif</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">maxcol</span> <span class="ow">and</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NEWLINE&quot;</span><span class="p">,</span> <span class="s2">&quot;DEDENT&quot;</span><span class="p">,</span> <span class="s2">&quot;WS&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">greedy</span><span class="p">:</span>
                    <span class="n">toks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">BEG_TOK_SKIPS</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">mincol</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;WS&quot;</span> <span class="ow">and</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># line continuation</span>
        <span class="k">elif</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;NEWLINE&quot;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;DEDENT&quot;</span><span class="p">:</span>
            <span class="c1"># fake a newline when dedenting without a newline</span>
            <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;NEWLINE&quot;</span>
            <span class="n">tok</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">tok</span><span class="o">.</span><span class="n">lineno</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prev_tok_end</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lexpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev_tok_end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="n">prev_tok_end</span><span class="p">:]:</span>
                <span class="n">tok</span><span class="o">.</span><span class="n">lexpos</span> <span class="o">=</span> <span class="n">prev_tok_end</span>  <span class="c1"># prevents wrapping comments</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tok</span><span class="o">.</span><span class="n">lexpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">check_bad_str_token</span><span class="p">(</span><span class="n">tok</span><span class="p">):</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">END_TOK_TYPES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_not_lparen_and_rparen</span><span class="p">(</span><span class="n">lparens</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">greedy</span> <span class="ow">and</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;RPAREN&quot;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">toks</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># handle comment lines</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">lexpos</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">end_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="n">end_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># handle comment lines</span>
    <span class="k">elif</span> <span class="n">saw_macro</span> <span class="ow">or</span> <span class="n">greedy</span><span class="p">:</span>
        <span class="n">end_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span> <span class="o">!=</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span><span class="p">:</span>
        <span class="c1"># handle multiline cases</span>
        <span class="n">end_offset</span> <span class="o">+=</span> <span class="n">_offset_from_prev_lines</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
    <span class="n">beg</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lexpos</span><span class="p">,</span> <span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lexpos</span> <span class="o">+</span> <span class="n">end_offset</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="n">rtn</span> <span class="o">=</span> <span class="s2">&quot;![&quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">beg</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
    <span class="k">if</span> <span class="n">returnline</span><span class="p">:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">beg</span><span class="p">]</span> <span class="o">+</span> <span class="n">rtn</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">end</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">rtn</span>


<span class="k">def</span> <span class="nf">check_bad_str_token</span><span class="p">(</span><span class="n">tok</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if a token is a bad string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ERRORTOKEN&quot;</span> <span class="ow">and</span> <span class="n">tok</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;EOF in multi-line string&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_quotes</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">check_quotes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks a string to make sure that if it starts with quotes, it also</span>
<span class="sd">    ends with quotes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">starts_as_str</span> <span class="o">=</span> <span class="n">RE_BEGIN_STRING</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">ends_as_str</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">starts_as_str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ends_as_str</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">starts_as_str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ends_as_str</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">starts_as_str</span> <span class="ow">and</span> <span class="n">ends_as_str</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">RE_COMPLETE_STRING</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">ok</span>


<span class="k">def</span> <span class="nf">_have_open_triple_quotes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">open_triple</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&quot;&#39;</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">open_triple</span> <span class="o">=</span> <span class="s2">&quot;&#39;&#39;&#39;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">open_triple</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">open_triple</span>


<span class="k">def</span> <span class="nf">get_line_continuation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The line continuation characters used in subproc mode. In interactive</span>
<span class="sd">    mode on Windows the backslash must be preceded by a space. This is because</span>
<span class="sd">    paths on Windows may end in a backslash.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xsh</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">get_logical_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a single logical line (i.e. one without line continuations)</span>
<span class="sd">    from a list of lines.  This line should begin at index idx. This also</span>
<span class="sd">    returns the number of physical lines the logical line spans. The lines</span>
<span class="sd">    should not contain newlines</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">linecont</span> <span class="o">=</span> <span class="n">get_line_continuation</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">linecont</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">idx</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">open_triple</span> <span class="o">=</span> <span class="n">_have_open_triple_quotes</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">linecont</span><span class="p">)</span> <span class="ow">or</span> <span class="n">open_triple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">nlines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">linecont</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">open_triple</span> <span class="o">=</span> <span class="n">_have_open_triple_quotes</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">start</span>


<span class="k">def</span> <span class="nf">replace_logical_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replaces lines at idx that may end in line continuation with a logical</span>
<span class="sd">    line that spans n lines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">linecont</span> <span class="o">=</span> <span class="n">get_line_continuation</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">logical</span>
        <span class="k">return</span>
    <span class="n">space</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">logical</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no space found</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">logical</span>
            <span class="n">logical</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># found space to split on</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">logical</span><span class="p">[:</span><span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="n">linecont</span>
            <span class="n">logical</span> <span class="o">=</span> <span class="n">logical</span><span class="p">[</span><span class="n">b</span><span class="p">:]</span>
    <span class="n">lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">logical</span>


<span class="k">def</span> <span class="nf">is_balanced</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ltok</span><span class="p">,</span> <span class="n">rtok</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines whether an expression has unbalanced opening and closing tokens.&quot;&quot;&quot;</span>
    <span class="n">lcnt</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ltok</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">rcnt</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">rtok</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lcnt</span> <span class="o">==</span> <span class="n">rcnt</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">subexpr_from_unbalanced</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ltok</span><span class="p">,</span> <span class="n">rtok</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempts to pull out a valid subexpression for unbalanced grouping,</span>
<span class="sd">    based on opening tokens, eg. &#39;(&#39;, and closing tokens, eg. &#39;)&#39;.  This</span>
<span class="sd">    does not do full tokenization, but should be good enough for tab</span>
<span class="sd">    completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_balanced</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ltok</span><span class="p">,</span> <span class="n">rtok</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="n">subexpr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">ltok</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">subexpr</span> <span class="o">=</span> <span class="n">subexpr</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">subexpr</span> <span class="o">=</span> <span class="n">subexpr</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">subexpr</span>


<span class="k">def</span> <span class="nf">subexpr_before_unbalanced</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ltok</span><span class="p">,</span> <span class="n">rtok</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Obtains the expression prior to last unbalanced left token.&quot;&quot;&quot;</span>
    <span class="n">subexpr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="n">ltok</span><span class="p">)</span>
    <span class="n">nrtoks_in_post</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">rtok</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">nrtoks_in_post</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrtoks_in_post</span><span class="p">):</span>
            <span class="n">subexpr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">subexpr</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="n">ltok</span><span class="p">)</span>
        <span class="n">nrtoks_in_post</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">rtok</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">subexpr</span> <span class="o">=</span> <span class="n">subexpr</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="n">rtok</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">subexpr</span> <span class="o">=</span> <span class="n">subexpr</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="n">ltok</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subexpr</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">STARTING_WHITESPACE_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\s*)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">starting_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the whitespace at the start of a string&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">STARTING_WHITESPACE_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_ENCODING</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="n">DEFAULT_ENCODING</span>
    <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cast_unicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">safe_hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;In recent versions of Python, hasattr() only catches AttributeError.</span>
<span class="sd">    This catches all errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">nspaces</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ntabs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Indent a string a given number of spaces or tabstops.</span>

<span class="sd">    indent(str,nspaces=4,ntabs=0) -&gt; indent str by ntabs+nspaces.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instr : basestring</span>
<span class="sd">        The string to be indented.</span>
<span class="sd">    nspaces : int (default: 4)</span>
<span class="sd">        The number of spaces to be indented.</span>
<span class="sd">    ntabs : int (default: 0)</span>
<span class="sd">        The number of tabs to be indented.</span>
<span class="sd">    flatten : bool (default: False)</span>
<span class="sd">        Whether to scrub existing indentation.  If True, all lines will be</span>
<span class="sd">        aligned to the same indentation.  If False, existing indentation will</span>
<span class="sd">        be strictly increased.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outstr : string indented by ntabs and nspaces.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">instr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="n">ntabs</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">nspaces</span>
    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="n">outstr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">instr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outstr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span> <span class="o">+</span> <span class="n">ind</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">outstr</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">outstr</span>


<span class="k">def</span> <span class="nf">get_sep</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the appropriate filepath separator char depending on OS and</span>
<span class="sd">    xonsh options set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">and</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FORCE_POSIX_PATHS&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">altsep</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>


<span class="k">def</span> <span class="nf">fallback</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">backup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for returning the object if cond is true and a backup if cond</span>
<span class="sd">    is false.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="n">cond</span> <span class="k">else</span> <span class="n">backup</span>

    <span class="k">return</span> <span class="n">dec</span>


<span class="c1"># The following redirect classes were taken directly from Python 3.5&#39;s source</span>
<span class="c1"># code (from the contextlib module). This can be removed when 3.5 is released,</span>
<span class="c1"># although redirect_stdout exists in 3.4, redirect_stderr does not.</span>
<span class="c1"># See the Python software license: https://docs.python.org/3/license.html</span>
<span class="c1"># Copyright (c) Python Software Foundation. All rights reserved.</span>
<span class="k">class</span> <span class="nc">_RedirectStream</span><span class="p">:</span>
    <span class="n">_stream</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_target</span> <span class="o">=</span> <span class="n">new_target</span>
        <span class="c1"># We use a list of old targets to make this CM re-entrant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old_targets</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old_targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_target</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_target</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exctype</span><span class="p">,</span> <span class="n">excinst</span><span class="p">,</span> <span class="n">exctb</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_old_targets</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">redirect_stdout</span><span class="p">(</span><span class="n">_RedirectStream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for temporarily redirecting stdout to another file::</span>

<span class="sd">        # How to send help() to stderr</span>
<span class="sd">        with redirect_stdout(sys.stderr):</span>
<span class="sd">            help(dir)</span>

<span class="sd">        # How to write help() to a file</span>
<span class="sd">        with open(&#39;help.txt&#39;, &#39;w&#39;) as f:</span>
<span class="sd">            with redirect_stdout(f):</span>
<span class="sd">                help(pow)</span>

<span class="sd">    Mostly for backwards compatibility.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_stream</span> <span class="o">=</span> <span class="s2">&quot;stdout&quot;</span>


<span class="k">class</span> <span class="nc">redirect_stderr</span><span class="p">(</span><span class="n">_RedirectStream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for temporarily redirecting stderr to another file.&quot;&quot;&quot;</span>

    <span class="n">_stream</span> <span class="o">=</span> <span class="s2">&quot;stderr&quot;</span>


<span class="k">def</span> <span class="nf">_yield_accessible_unix_file_names</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;yield file names of executable files in path.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">file_</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">file_</span><span class="o">.</span><span class="n">name</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># broken Symlink are neither dir not files</span>
            <span class="k">pass</span>


<span class="k">def</span> <span class="nf">_executables_in_posix</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">_yield_accessible_unix_file_names</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_executables_in_windows</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PATHEXT&quot;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">is_file</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">is_file</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">base_name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">fname</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="c1"># On Windows, there&#39;s no guarantee for the directory to really</span>
        <span class="c1"># exist even if isdir returns True. This may happen for instance</span>
        <span class="c1"># if the path contains trailing spaces.</span>
        <span class="k">return</span>


<span class="k">def</span> <span class="nf">executables_in</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a generator of files in path that the user could execute.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">_executables_in_windows</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">_executables_in_posix</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">func</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
        <span class="k">return</span>


<span class="k">def</span> <span class="nf">debian_command_not_found</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses the debian/ubuntu command-not-found utility to suggest packages for a</span>
<span class="sd">    command that cannot currently be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ON_LINUX</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">cnf</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">commands_cache</span><span class="o">.</span><span class="n">lazyget</span><span class="p">(</span>
        <span class="s2">&quot;command-not-found&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;/usr/lib/command-not-found&quot;</span><span class="p">,)</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cnf</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">; exit 0&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
        <span class="n">c</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cnf</span><span class="p">,</span> <span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">cmd</span><span class="p">)),</span>
        <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">conda_suggest_command_not_found</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses conda-suggest to suggest packages for a command that cannot</span>
<span class="sd">    currently be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">conda_suggest</span> <span class="kn">import</span> <span class="n">find</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">find</span><span class="o">.</span><span class="n">message_string</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">conda_suggest_path</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CONDA_SUGGEST_PATH&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">command_not_found</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses various mechanism to suggest packages for a command that cannot</span>
<span class="sd">    currently be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_LINUX</span><span class="p">:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">debian_command_not_found</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">conda</span> <span class="o">=</span> <span class="n">conda_suggest_command_not_found</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conda</span><span class="p">:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">rtn</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">conda</span> <span class="k">if</span> <span class="n">rtn</span> <span class="k">else</span> <span class="n">conda</span>
    <span class="k">return</span> <span class="n">rtn</span>


<span class="k">def</span> <span class="nf">suggest_commands</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Suggests alternative commands given an environment and aliases.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SUGGEST_COMMANDS&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SUGGEST_THRESHOLD&quot;</span><span class="p">)</span>
    <span class="n">max_sugg</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SUGGEST_MAX_NUM&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_sugg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">max_sugg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">suggested</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">xsh</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">suggested</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">levenshtein</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">suggested</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Alias&quot;</span>

    <span class="k">for</span> <span class="n">_cmd</span> <span class="ow">in</span> <span class="n">xsh</span><span class="o">.</span><span class="n">commands_cache</span><span class="o">.</span><span class="n">all_commands</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_cmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">suggested</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">levenshtein</span><span class="p">(</span><span class="n">_cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">suggested</span><span class="p">[</span><span class="n">_cmd</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Command (</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_cmd</span><span class="p">)</span>

    <span class="n">suggested</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
        <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">suggested</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">suggestion_sort_helper</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">suggested</span><span class="p">),</span> <span class="n">max_sugg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">command_not_found</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">oneof</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;one of &quot;</span>
        <span class="n">tips</span> <span class="o">=</span> <span class="s2">&quot;Did you mean </span><span class="si">{}</span><span class="s2">the following?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oneof</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">suggested</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">alternatives</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;    {: &lt;</span><span class="si">{}</span><span class="s2">} </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">items</span>
        <span class="p">)</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tips</span><span class="p">,</span> <span class="n">alternatives</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">command_not_found</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">rtn</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rtn</span>


<span class="k">def</span> <span class="nf">_get_manual_env_var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns if the given variable is manually set as well as it&#39;s value.&quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">xsh</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os_environ</span>
        <span class="n">manually_set</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">env</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">manually_set</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">is_manually_set</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">manually_set</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print warnings with/without traceback.&quot;&quot;&quot;</span>
    <span class="n">manually_set_trace</span><span class="p">,</span> <span class="n">show_trace</span> <span class="o">=</span> <span class="n">_get_manual_env_var</span><span class="p">(</span><span class="s2">&quot;XONSH_SHOW_TRACEBACK&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">manually_set_logfile</span><span class="p">,</span> <span class="n">log_file</span> <span class="o">=</span> <span class="n">_get_manual_env_var</span><span class="p">(</span><span class="s2">&quot;XONSH_TRACEBACK_LOGFILE&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">manually_set_trace</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">manually_set_logfile</span><span class="p">):</span>
        <span class="c1"># Notify about the traceback output possibility if neither of</span>
        <span class="c1"># the two options have been manually set</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;xonsh: For full traceback set: &quot;</span> <span class="s2">&quot;$XONSH_SHOW_TRACEBACK = True</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="c1"># convert show_trace to bool if necessary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">show_trace</span><span class="p">):</span>
        <span class="n">show_trace</span> <span class="o">=</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">show_trace</span><span class="p">)</span>
    <span class="c1"># if the trace option has been set, print all traceback info to stderr</span>
    <span class="k">if</span> <span class="n">show_trace</span><span class="p">:</span>
        <span class="c1"># notify user about XONSH_TRACEBACK_LOGFILE if it has</span>
        <span class="c1"># not been set manually</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manually_set_logfile</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;xonsh: To log full traceback to a file set: &quot;</span>
                <span class="s2">&quot;$XONSH_TRACEBACK_LOGFILE = &lt;filename&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_stack</span><span class="p">()</span>
    <span class="c1"># additionally, check if a file for traceback logging has been</span>
    <span class="c1"># specified and convert to a proper option if needed</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">to_logfile_opt</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log_file</span><span class="p">:</span>
        <span class="c1"># if log_file &lt;&gt; &#39;&#39; or log_file &lt;&gt; None, append</span>
        <span class="c1"># traceback log there as well</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_stack</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_exception</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print exceptions with/without traceback.&quot;&quot;&quot;</span>
    <span class="n">manually_set_trace</span><span class="p">,</span> <span class="n">show_trace</span> <span class="o">=</span> <span class="n">_get_manual_env_var</span><span class="p">(</span><span class="s2">&quot;XONSH_SHOW_TRACEBACK&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">manually_set_logfile</span><span class="p">,</span> <span class="n">log_file</span> <span class="o">=</span> <span class="n">_get_manual_env_var</span><span class="p">(</span><span class="s2">&quot;XONSH_TRACEBACK_LOGFILE&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">manually_set_trace</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">manually_set_logfile</span><span class="p">):</span>
        <span class="c1"># Notify about the traceback output possibility if neither of</span>
        <span class="c1"># the two options have been manually set</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;xonsh: For full traceback set: &quot;</span> <span class="s2">&quot;$XONSH_SHOW_TRACEBACK = True</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="c1"># convert show_trace to bool if necessary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">show_trace</span><span class="p">):</span>
        <span class="n">show_trace</span> <span class="o">=</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">show_trace</span><span class="p">)</span>
    <span class="c1"># if the trace option has been set, print all traceback info to stderr</span>
    <span class="k">if</span> <span class="n">show_trace</span><span class="p">:</span>
        <span class="c1"># notify user about XONSH_TRACEBACK_LOGFILE if it has</span>
        <span class="c1"># not been set manually</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manually_set_logfile</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;xonsh: To log full traceback to a file set: &quot;</span>
                <span class="s2">&quot;$XONSH_TRACEBACK_LOGFILE = &lt;filename&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="c1"># additionally, check if a file for traceback logging has been</span>
    <span class="c1"># specified and convert to a proper option if needed</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">to_logfile_opt</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log_file</span><span class="p">:</span>
        <span class="c1"># if log_file &lt;&gt; &#39;&#39; or log_file &lt;&gt; None, append</span>
        <span class="c1"># traceback log there as well</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">show_trace</span><span class="p">:</span>
        <span class="c1"># if traceback output is disabled, print the exception&#39;s</span>
        <span class="c1"># error message on stderr.</span>
        <span class="n">display_error_message</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">display_error_message</span><span class="p">(</span><span class="n">strip_xonsh_error_types</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints the error message of the current exception on stderr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
    <span class="n">exception_only</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="n">XonshError</span> <span class="ow">and</span> <span class="n">strip_xonsh_error_types</span><span class="p">:</span>
        <span class="n">exception_only</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">exception_only</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exception_only</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">is_writable_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if a filepath is valid for writing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="c1"># convert to absolute path if needed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="c1"># cannot write to directories</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># if the file exists and is writable, we&#39;re fine</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="c1"># if the path doesn&#39;t exist, isolate its directory component</span>
    <span class="c1"># and ensure that directory is writable instead</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span>


<span class="c1"># Modified from Public Domain code, by Magnus Lie Hetland</span>
<span class="c1"># from http://hetland.org/coding/python/levenshtein.py</span>
<span class="k">def</span> <span class="nf">levenshtein</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the Levenshtein distance between a and b.&quot;&quot;&quot;</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_dist</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">:</span>
        <span class="c1"># Make sure n &lt;= m, to use O(min(n,m)) space</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span>
    <span class="n">current</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">previous</span><span class="p">,</span> <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">add</span><span class="p">,</span> <span class="n">delete</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">current</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">change</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">change</span> <span class="o">=</span> <span class="n">change</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">current</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">change</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">suggestion_sort_helper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a score (lower is better) for x based on how similar</span>
<span class="sd">    it is to y.  Used to rank suggestions.&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">lendiff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">inx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span>
    <span class="n">iny</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">lendiff</span> <span class="o">+</span> <span class="n">inx</span> <span class="o">+</span> <span class="n">iny</span>


<span class="k">def</span> <span class="nf">escape_windows_cmd_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a string that is usable by the Windows cmd.exe.</span>
<span class="sd">    The escaping is based on details here and empirical testing:</span>
<span class="sd">    http://www.robvanderwoude.com/escapechars.php</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;^()%!&lt;&gt;&amp;|&quot;&#39;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">argvquote</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an argument quoted in such a way that that CommandLineToArgvW</span>
<span class="sd">    on Windows will return the argument string unchanged.</span>
<span class="sd">    This is the same thing Popen does when supplied with an list of arguments.</span>
<span class="sd">    Arguments in a command line should be separated by spaces; this</span>
<span class="sd">    function does not add these spaces. This implementation follows the</span>
<span class="sd">    suggestions outlined here:</span>
<span class="sd">    https://blogs.msdn.microsoft.com/twistylittlepassagesallalike/2011/04/23/everyone-quotes-command-line-arguments-the-wrong-way/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">in</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39; </span><span class="se">\t\n\v</span><span class="s1">&quot;&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">arg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_backslashes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cmdline</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="c1"># first count the number of current backslashes</span>
                <span class="n">n_backslashes</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>
                <span class="c1"># Escape all backslashes and the following double quotation mark</span>
                <span class="n">cmdline</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_backslashes</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># backslashes are not special here</span>
                <span class="n">cmdline</span> <span class="o">+=</span> <span class="n">n_backslashes</span> <span class="o">*</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>
            <span class="n">n_backslashes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cmdline</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="c1"># Escape all backslashes, but let the terminating</span>
        <span class="c1"># double quotation mark we add below be interpreted</span>
        <span class="c1"># as a metacharacter</span>
        <span class="n">cmdline</span> <span class="o">+=</span> <span class="o">+</span><span class="n">n_backslashes</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">return</span> <span class="n">cmdline</span>


<span class="k">def</span> <span class="nf">on_main_thread</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Checks if we are on the main thread or not.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span> <span class="ow">is</span> <span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">()</span>


<span class="n">_DEFAULT_SENTINEL</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_DEFAULT_SENTINEL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Swaps a current variable name in a namespace for another value, and then</span>
<span class="sd">    replaces it when the context is exited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">value</span>
    <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">default</span><span class="p">:</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">swap_values</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_DEFAULT_SENTINEL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates a dictionary (or other mapping) with values from another mapping,</span>
<span class="sd">    and then restores the original mapping when the context is exited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">}</span>
    <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">default</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>


<span class="c1">#</span>
<span class="c1"># Validators and converters</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">detype</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This assumes that the object has a detype method, and calls that.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">detype</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">is_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is an integer&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_float</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a float&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_string</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a string&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_slice</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a slice&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_callable</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is callable&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">callable</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_string_or_callable</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a string or callable&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">is_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_callable</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_class</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a class&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">always_true</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">always_false</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns False&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">always_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns None&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">ensure_string</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a string if x is not a string, and x if it already is.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_path</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This tests if something is a path.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_env_path</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This tests if something is an environment path, ie a list of strings.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">EnvPath</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">str_to_path</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a string to a path.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># checking x is needed to avoid uncontrolled converting empty string to Path(&#39;.&#39;)</span>
        <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">EnvPath</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Variable should be a pathlib.Path, str or single EnvPath type. </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> given.&quot;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">str_to_env_path</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a string to an environment path, ie a list of strings,</span>
<span class="sd">    splitting on the OS separator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># splitting will be done implicitly in EnvPath&#39;s __init__</span>
    <span class="k">return</span> <span class="n">EnvPath</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">path_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a path to a string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">env_path_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts an environment path to a string by joining on the OS</span>
<span class="sd">    separator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_bool</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a boolean.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_bool_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a boolean or None.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_logfile_opt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if x is a valid $XONSH_TRACEBACK_LOGFILE option. Returns False</span>
<span class="sd">    if x is not a writable/creatable file or an empty string or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">is_writable_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">to_logfile_opt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a $XONSH_TRACEBACK_LOGFILE option to either a str containing</span>
<span class="sd">    the filepath if it is a writable file or None if the filepath is not</span>
<span class="sd">    valid, informing the user on stderr about the invalid choice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_logfile_opt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if option is not valid, return a proper</span>
        <span class="c1"># option and inform the user on stderr</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;xonsh: $XONSH_TRACEBACK_LOGFILE must be a &quot;</span>
            <span class="s2">&quot;filepath pointing to a file that either exists &quot;</span>
            <span class="s2">&quot;and is writable or that can be created.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">logfile_opt_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detypes a $XONSH_TRACEBACK_LOGFILE option.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># None should not be detyped to &#39;None&#39;, as &#39;None&#39; constitutes</span>
        <span class="c1"># a perfectly valid filename and retyping it would introduce</span>
        <span class="c1"># ambiguity. Detype to the empty string instead.</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="n">_FALSES</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">]),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;_FALSES&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">to_bool</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts to a boolean in a semantically meaningful way.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">_FALSES</span> <span class="k">else</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">to_bool_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts to a boolean or none in a semantically meaningful way.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">low_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">low_x</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">_FALSES</span> <span class="k">else</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">to_itself</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;No conversion, returns itself.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">to_int_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Convert the given value to integer if possible. Otherwise return None&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bool_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a bool to an empty string if False and the string &#39;1&#39; if</span>
<span class="sd">    True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">bool_or_none_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a bool or None value to a string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;None&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>


<span class="n">_BREAKS</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;break&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">]),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;_BREAKS&quot;</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">to_bool_or_break</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">_BREAKS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;break&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_bool_or_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns whether a value is a boolean or integer.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">to_bool_or_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a value to a boolean or an integer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># bools are ints too!</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bool_or_int_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a boolean or integer to a string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">bool_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">SLICE_REG</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;(?P&lt;start&gt;(?:-\d)?\d*):(?P&lt;end&gt;(?:-\d)?\d*):?(?P&lt;step&gt;(?:-\d)?\d*)&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">ensure_slice</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to convert an object into a slice, complain on failure&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_slice</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;[]()&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">SLICE_REG</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot convert </span><span class="si">{!r}</span><span class="s2"> to slice&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot convert </span><span class="si">{!r}</span><span class="s2"> to slice&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">get_portions</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">slices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield from portions of an iterable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    it : iterable</span>
<span class="sd">    slices : a slice or a list of slice objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_slice</span><span class="p">(</span><span class="n">slices</span><span class="p">):</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">slices</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">slices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># islice failed</span>
            <span class="k">pass</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">it</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">is_slice_as_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if string x is a slice. If not a string return False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;[]()&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">SLICE_REG</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">is_int_as_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if string x is an integer. If not a string return False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">isdecimal</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">is_string_set</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a set of strings&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Set</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">csv_to_set</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a comma-separated list of strings to a set of strings.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">set_to_csv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a set of strings to a comma-separated list of strings.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pathsep_to_set</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a os.pathsep separated string to a set of strings.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">set_to_pathsep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a set to an os.pathsep separated string. The sort kwarg</span>
<span class="sd">    specifies whether to sort the set prior to str conversion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_string_seq</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a sequence of strings&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_nonstring_seq_of_strings</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a sequence of strings, where the top-level</span>
<span class="sd">    sequence is not a string itself.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">pathsep_to_seq</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a os.pathsep separated string to a sequence of strings.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">seq_to_pathsep</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a sequence to an os.pathsep separated string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pathsep_to_upper_seq</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a os.pathsep separated string to a sequence of</span>
<span class="sd">    uppercase strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">seq_to_upper_pathsep</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a sequence to an uppercase os.pathsep separated string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">is_bool_seq</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if an object is a sequence of bools.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">csv_to_bool_seq</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes a comma-separated string and converts it into a list of bools.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">to_bool</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">csv_to_set</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">bool_seq_to_csv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a sequence of bools to a comma-separated string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">ptk2_color_depth_setter</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setter function for $PROMPT_TOOLKIT_COLOR_DEPTH. Also</span>
<span class="sd">    updates os.environ so prompt toolkit can pickup the value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span>
        <span class="s2">&quot;DEPTH_1_BIT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MONOCHROME&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DEPTH_4_BIT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ANSI_COLORS_ONLY&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DEPTH_8_BIT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DEFAULT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DEPTH_24_BIT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;TRUE_COLOR&quot;</span><span class="p">,</span>
    <span class="p">}:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">}:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; is not a valid value for $PROMPT_TOOLKIT_COLOR_DEPTH. &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="s2">&quot;PROMPT_TOOLKIT_COLOR_DEPTH&quot;</span> <span class="ow">in</span> <span class="n">os_environ</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">os_environ</span><span class="p">[</span><span class="s2">&quot;PROMPT_TOOLKIT_COLOR_DEPTH&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os_environ</span><span class="p">[</span><span class="s2">&quot;PROMPT_TOOLKIT_COLOR_DEPTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">is_completions_display_value</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enumerated values of ``$COMPLETIONS_DISPLAY``&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="s2">&quot;multi&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">to_completions_display_value</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert user input to value of ``$COMPLETIONS_DISPLAY``&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">}:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;multi&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">}:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;multi&quot;</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="s2">&quot;readline&quot;</span><span class="p">}:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; is not a valid value for $COMPLETIONS_DISPLAY. &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;Using &quot;multi&quot;.&#39;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;multi&quot;</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="n">CANONIC_COMPLETION_MODES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;menu-complete&quot;</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">is_completion_mode</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enumerated values of $COMPLETION_MODE&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">CANONIC_COMPLETION_MODES</span>


<span class="k">def</span> <span class="nf">to_completion_mode</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert user input to value of $COMPLETION_MODE&quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;default&quot;</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;xonsh&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;def&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="s2">&quot;menu-complete&quot;</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;menu&quot;</span><span class="p">,</span> <span class="s2">&quot;menu-completion&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">y</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CANONIC_COMPLETION_MODES</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#39; is not valid for $COMPLETION_MODE, must be one of </span><span class="si">{</span><span class="n">CANONIC_COMPLETION_MODES</span><span class="si">}</span><span class="s2">.  Using &#39;default&#39;.&quot;</span><span class="p">,</span>
            <span class="ne">RuntimeWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">is_str_str_dict</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a str:str dictionary&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a string to a dictionary&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; can not be converted to Python dictionary.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">to_str_str_dict</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a string to str:str dictionary&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_str_str_dict</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">to_dict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_str_str_dict</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; can not be converted to str:str dictionary.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">dict_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a dictionary to a string&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="c1"># history validation</span>

<span class="n">_min_to_sec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">_hour_to_sec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="n">_min_to_sec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">_day_to_sec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="n">_hour_to_sec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">_month_to_sec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">30.4375</span> <span class="o">*</span> <span class="n">_day_to_sec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">_year_to_sec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">365.25</span> <span class="o">*</span> <span class="n">_day_to_sec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">_kb_to_b</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">_mb_to_b</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">_kb_to_b</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">_gb_to_b</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">_mb_to_b</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">_tb_to_b</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">_tb_to_b</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

<span class="n">CANON_HISTORY_UNITS</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;CANON_HISTORY_UNITS&quot;</span>
<span class="p">)</span>

<span class="n">HISTORY_UNITS</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;cmds&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;sec&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;second&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_min_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_min_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;mins&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_min_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_hour_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;hr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_hour_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_hour_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;hours&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_hour_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_day_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_day_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;days&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_day_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;mon&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_month_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_month_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;months&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_month_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_year_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;yr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_year_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;yrs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_year_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_year_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;years&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">_year_to_sec</span><span class="p">),</span>
        <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;byte&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;bytes&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;kb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_kb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;kilobyte&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_kb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;kilobytes&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_kb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;mb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_mb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;meg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_mb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;megs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_mb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;megabyte&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_mb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;megabytes&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_mb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;gb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_gb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;gig&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_gb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;gigs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_gb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;gigabyte&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_gb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;gigabytes&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_gb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;tb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_tb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;terabyte&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_tb_to_b</span><span class="p">),</span>
        <span class="s2">&quot;terabytes&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">_tb_to_b</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;HISTORY_UNITS&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Maps lowercase unit names to canonical name and conversion utilities.&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">is_history_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a proper history value, units tuple.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
        <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">CANON_HISTORY_UNITS</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">is_history_backend</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if something is a valid history backend.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">is_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_class</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_dynamic_cwd_width</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine if the input is a valid input for the DYNAMIC_CWD_WIDTH</span>
<span class="sd">    environment variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot;c%&quot;</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">to_dynamic_cwd_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert to a canonical cwd_width tuple.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;%&quot;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">unit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">dynamic_cwd_tuple_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a canonical cwd_width tuple to a string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;%&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="n">RE_HISTORY_TUPLE</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)\s*([A-Za-z]*)&quot;</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;RE_HISTORY_TUPLE&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">to_history_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts to a canonical history tuple.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;history size must be given as a sequence or number&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">RE_HISTORY_TUPLE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">to_history_tuple</span><span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">to_history_tuple</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">))</span>
    <span class="n">units</span><span class="p">,</span> <span class="n">converter</span> <span class="o">=</span> <span class="n">HISTORY_UNITS</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">history_tuple_to_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a valid history tuple to a canonical string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">all_permutations</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yeilds all permutations, not just those of a specified length&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">format_color</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Formats strings that may contain colors. This simply dispatches to the</span>
<span class="sd">    shell instances method of the same name. The results of this function should</span>
<span class="sd">    be directly usable by print_color().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;shell&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">format_color</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># fallback for ANSI if shell is not yet initialized</span>
        <span class="kn">from</span> <span class="nn">xonsh.ansi_colors</span> <span class="kn">import</span> <span class="n">ansi_partial_color_format</span>

        <span class="n">style</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ansi_partial_color_format</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_color</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints a string that may contain colors. This dispatched to the shell</span>
<span class="sd">    method of the same name. Colors will be formatted if they have not already</span>
<span class="sd">    been.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;shell&quot;</span><span class="p">):</span>
        <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">print_color</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># fallback for ANSI if shell is not yet initialized</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">format_color</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">color_style_names</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns an iterable of all available style names.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">color_style_names</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">color_style</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the current color map.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">color_style</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">register_custom_style</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">styles</span><span class="p">,</span> <span class="n">highlight_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;default&quot;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register custom style.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Style name.</span>
<span class="sd">    styles : dict</span>
<span class="sd">        Token -&gt; style mapping.</span>
<span class="sd">    highlight_color : str</span>
<span class="sd">        Hightlight color.</span>
<span class="sd">    background_color : str</span>
<span class="sd">        Background color.</span>
<span class="sd">    base : str, optional</span>
<span class="sd">        Base style to use as default.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    style : The style object created, None if not succeeded</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">style</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">pygments_version_info</span><span class="p">():</span>
        <span class="kn">from</span> <span class="nn">xonsh.pyghooks</span> <span class="kn">import</span> <span class="n">register_custom_pygments_style</span>

        <span class="n">style</span> <span class="o">=</span> <span class="n">register_custom_pygments_style</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">styles</span><span class="p">,</span> <span class="n">highlight_color</span><span class="p">,</span> <span class="n">background_color</span><span class="p">,</span> <span class="n">base</span>
        <span class="p">)</span>

    <span class="c1"># register ANSI colors</span>
    <span class="kn">from</span> <span class="nn">xonsh.ansi_colors</span> <span class="kn">import</span> <span class="n">register_custom_ansi_style</span>

    <span class="n">register_custom_ansi_style</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">styles</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_token_attr_from_stylemap</span><span class="p">(</span><span class="n">stylemap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;yields tokens attr, and index from a stylemap&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">prompt_toolkit</span> <span class="k">as</span> <span class="nn">ptk</span>

    <span class="k">if</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;prompt_toolkit1&quot;</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">ptk</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">style_from_dict</span><span class="p">(</span><span class="n">stylemap</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">stylemap</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">token</span><span class="p">,</span> <span class="n">style</span><span class="o">.</span><span class="n">token_to_attrs</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">ptk</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">style_from_pygments_dict</span><span class="p">(</span><span class="n">stylemap</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">stylemap</span><span class="p">:</span>
            <span class="n">style_str</span> <span class="o">=</span> <span class="s2">&quot;class:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ptk</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">pygments</span><span class="o">.</span><span class="n">pygments_token_to_classname</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">style</span><span class="o">.</span><span class="n">get_attrs_for_style_str</span><span class="p">(</span><span class="n">style_str</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_color_lookup_table</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the prompt_toolkit win32 ColorLookupTable&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;prompt_toolkit1&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">prompt_toolkit.terminal.win32_output</span> <span class="kn">import</span> <span class="n">ColorLookupTable</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">prompt_toolkit.output.win32</span> <span class="kn">import</span> <span class="n">ColorLookupTable</span>
    <span class="k">return</span> <span class="n">ColorLookupTable</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_color_indexes</span><span class="p">(</span><span class="n">style_map</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates the color and windows color index for a style&quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">_get_color_lookup_table</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_token_attr_from_stylemap</span><span class="p">(</span><span class="n">style_map</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">color</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">lookup_fg_color</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">rgb</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">yield</span> <span class="n">token</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rgb</span>


<span class="c1"># Map of new PTK2 color names to PTK1 variants</span>
<span class="n">PTK_NEW_OLD_COLOR_MAP</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;black&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="s2">&quot;darkred&quot;</span><span class="p">,</span>
        <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="s2">&quot;darkgreen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yellow&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span><span class="p">,</span>
        <span class="s2">&quot;blue&quot;</span><span class="p">:</span> <span class="s2">&quot;darkblue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;magenta&quot;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cyan&quot;</span><span class="p">:</span> <span class="s2">&quot;teal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gray&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
        <span class="s2">&quot;brightblack&quot;</span><span class="p">:</span> <span class="s2">&quot;darkgray&quot;</span><span class="p">,</span>
        <span class="s2">&quot;brightred&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;brightgreen&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="s2">&quot;brightyellow&quot;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
        <span class="s2">&quot;brightblue&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;brightmagenta&quot;</span><span class="p">:</span> <span class="s2">&quot;fuchsia&quot;</span><span class="p">,</span>
        <span class="s2">&quot;brightcyan&quot;</span><span class="p">:</span> <span class="s2">&quot;turquoise&quot;</span><span class="p">,</span>
        <span class="s2">&quot;white&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;PTK_NEW_OLD_COLOR_MAP&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Map of new ansicolor names to old PTK1 names</span>
<span class="n">ANSICOLOR_NAMES_MAP</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ansi&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">:</span> <span class="s2">&quot;#ansi&quot;</span> <span class="o">+</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">PTK_NEW_OLD_COLOR_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;ANSICOLOR_NAMES_MAP&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_win10_color_map</span><span class="p">():</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ansiblack&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
        <span class="s2">&quot;ansiblue&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">218</span><span class="p">),</span>
        <span class="s2">&quot;ansigreen&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
        <span class="s2">&quot;ansicyan&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">58</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">221</span><span class="p">),</span>
        <span class="s2">&quot;ansired&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">197</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
        <span class="s2">&quot;ansimagenta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">136</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">152</span><span class="p">),</span>
        <span class="s2">&quot;ansiyellow&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">193</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;ansigray&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">204</span><span class="p">),</span>
        <span class="s2">&quot;ansibrightblack&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">118</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">118</span><span class="p">),</span>
        <span class="s2">&quot;ansibrightblue&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">59</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s2">&quot;ansibrightgreen&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
        <span class="s2">&quot;ansibrightcyan&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">214</span><span class="p">),</span>
        <span class="s2">&quot;ansibrightred&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">231</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">86</span><span class="p">),</span>
        <span class="s2">&quot;ansibrightmagenta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">158</span><span class="p">),</span>
        <span class="s2">&quot;ansibrightyellow&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">249</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">165</span><span class="p">),</span>
        <span class="s2">&quot;ansiwhite&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">242</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">242</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="s2">&quot;#</span><span class="si">{0:02x}{1:02x}{2:02x}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cmap</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>


<span class="n">WIN10_COLOR_MAP</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span><span class="n">_win10_color_map</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;WIN10_COLOR_MAP&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_win_bold_color_map</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Map dark ansi colors to lighter version.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;ansiblack&quot;</span><span class="p">:</span> <span class="s2">&quot;ansibrightblack&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ansiblue&quot;</span><span class="p">:</span> <span class="s2">&quot;ansibrightblue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ansigreen&quot;</span><span class="p">:</span> <span class="s2">&quot;ansibrightgreen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ansicyan&quot;</span><span class="p">:</span> <span class="s2">&quot;ansibrightcyan&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ansired&quot;</span><span class="p">:</span> <span class="s2">&quot;ansibrightred&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ansimagenta&quot;</span><span class="p">:</span> <span class="s2">&quot;ansibrightmagenta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ansiyellow&quot;</span><span class="p">:</span> <span class="s2">&quot;ansibrightyellow&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ansigray&quot;</span><span class="p">:</span> <span class="s2">&quot;ansiwhite&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="n">WIN_BOLD_COLOR_MAP</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span><span class="n">_win_bold_color_map</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;WIN_BOLD_COLOR_MAP&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">hardcode_colors_for_win10</span><span class="p">(</span><span class="n">style_map</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace all ansi colors with hardcoded colors to avoid unreadable defaults</span>
<span class="sd">    in conhost.exe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modified_style</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PROMPT_TOOLKIT_COLOR_DEPTH&quot;</span><span class="p">]:</span>
        <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PROMPT_TOOLKIT_COLOR_DEPTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DEPTH_24_BIT&quot;</span>
    <span class="c1"># Replace all ansi colors with hardcoded colors to avoid unreadable defaults</span>
    <span class="c1"># in conhost.exe</span>
    <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">style_str</span> <span class="ow">in</span> <span class="n">style_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">ansicolor</span> <span class="ow">in</span> <span class="n">WIN10_COLOR_MAP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ansicolor</span> <span class="ow">in</span> <span class="n">style_str</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;bold&quot;</span> <span class="ow">in</span> <span class="n">style_str</span> <span class="ow">and</span> <span class="s2">&quot;nobold&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">style_str</span><span class="p">:</span>
                    <span class="c1"># Win10  doesn&#39;t yet handle bold colors. Instead dark</span>
                    <span class="c1"># colors are mapped to their lighter version. We simulate</span>
                    <span class="c1"># the same here.</span>
                    <span class="n">style_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">hexcolor</span> <span class="o">=</span> <span class="n">WIN10_COLOR_MAP</span><span class="p">[</span>
                        <span class="n">WIN_BOLD_COLOR_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ansicolor</span><span class="p">,</span> <span class="n">ansicolor</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hexcolor</span> <span class="o">=</span> <span class="n">WIN10_COLOR_MAP</span><span class="p">[</span><span class="n">ansicolor</span><span class="p">]</span>
                <span class="n">style_str</span> <span class="o">=</span> <span class="n">style_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ansicolor</span><span class="p">,</span> <span class="n">hexcolor</span><span class="p">)</span>
        <span class="n">modified_style</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">style_str</span>
    <span class="k">return</span> <span class="n">modified_style</span>


<span class="k">def</span> <span class="nf">ansicolors_to_ptk1_names</span><span class="p">(</span><span class="n">stylemap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts ansicolor names in a stylemap to old PTK1 color names&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pygments_version_info</span><span class="p">()</span> <span class="ow">and</span> <span class="n">pygments_version_info</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">stylemap</span>
    <span class="n">modified_stylemap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">style_str</span> <span class="ow">in</span> <span class="n">stylemap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">ptk1_color</span> <span class="ow">in</span> <span class="n">ANSICOLOR_NAMES_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">color</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">style_str</span><span class="p">:</span>
                <span class="n">style_str</span> <span class="o">=</span> <span class="n">style_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">ptk1_color</span><span class="p">)</span>
        <span class="n">modified_stylemap</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">style_str</span>
    <span class="k">return</span> <span class="n">modified_stylemap</span>


<span class="k">def</span> <span class="nf">intensify_colors_for_cmd_exe</span><span class="p">(</span><span class="n">style_map</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a modified style to where colors that maps to dark</span>
<span class="sd">    colors are replaced with brighter versions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modified_style</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">replace_colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;ansibrightcyan&quot;</span><span class="p">,</span>  <span class="c1"># subst blue with bright cyan</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;ansibrightgreen&quot;</span><span class="p">,</span>  <span class="c1"># subst green with bright green</span>
        <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;ansibrightred&quot;</span><span class="p">,</span>  <span class="c1"># subst red with bright red</span>
        <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;ansibrightmagenta&quot;</span><span class="p">,</span>  <span class="c1"># subst magenta with bright magenta</span>
        <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;ansibrightyellow&quot;</span><span class="p">,</span>  <span class="c1"># subst yellow with bright yellow</span>
        <span class="mi">9</span><span class="p">:</span> <span class="s2">&quot;ansicyan&quot;</span><span class="p">,</span>  <span class="c1"># subst intense blue with dark cyan (more readable)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;prompt_toolkit1&quot;</span><span class="p">:</span>
        <span class="n">replace_colors</span> <span class="o">=</span> <span class="n">ansicolors_to_ptk1_names</span><span class="p">(</span><span class="n">replace_colors</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">_get_color_indexes</span><span class="p">(</span><span class="n">style_map</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">replace_colors</span><span class="p">:</span>
            <span class="n">modified_style</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace_colors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">modified_style</span>


<span class="k">def</span> <span class="nf">intensify_colors_on_win_setter</span><span class="p">(</span><span class="n">enable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resets the style when setting the INTENSIFY_COLORS_ON_WIN</span>
<span class="sd">    environment variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">enable</span> <span class="o">=</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">enable</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">xsh</span><span class="p">,</span> <span class="s2">&quot;shell&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">styler</span><span class="p">,</span> <span class="s2">&quot;style_name&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">styler</span><span class="p">,</span> <span class="s2">&quot;style_name&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">enable</span>


<span class="k">def</span> <span class="nf">format_std_prepost</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Formats a template prefix/postfix string for a standard buffer.</span>
<span class="sd">    Returns a string suitable for prepending or appending.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">template</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span> <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">env</span>
    <span class="n">invis</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\001\002</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># shell hasn&#39;t fully started up (probably still in xonshrc)</span>
        <span class="kn">from</span> <span class="nn">xonsh.prompt.base</span> <span class="kn">import</span> <span class="n">PromptFormatter</span>
        <span class="kn">from</span> <span class="nn">xonsh.ansi_colors</span> <span class="kn">import</span> <span class="n">ansi_partial_color_format</span>

        <span class="n">pf</span> <span class="o">=</span> <span class="n">PromptFormatter</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pf</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">ansi_partial_color_format</span><span class="p">(</span><span class="n">invis</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">invis</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># shell has fully started. do the normal thing</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">prompt_formatter</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">print_exception</span><span class="p">()</span>
        <span class="c1"># \001\002 is there to fool pygments into not returning an empty string</span>
        <span class="c1"># for potentially empty input. This happens when the template is just a</span>
        <span class="c1"># color code with no visible text.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">format_color</span><span class="p">(</span><span class="n">invis</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">invis</span><span class="p">,</span> <span class="n">force_string</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">invis</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="n">_RE_STRING_START</span> <span class="o">=</span> <span class="s2">&quot;[bBprRuUf]*&quot;</span>
<span class="n">_RE_STRING_TRIPLE_DOUBLE</span> <span class="o">=</span> <span class="s1">&#39;&quot;&quot;&quot;&#39;</span>
<span class="n">_RE_STRING_TRIPLE_SINGLE</span> <span class="o">=</span> <span class="s2">&quot;&#39;&#39;&#39;&quot;</span>
<span class="n">_RE_STRING_DOUBLE</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span>
<span class="n">_RE_STRING_SINGLE</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span>
<span class="n">_STRINGS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">_RE_STRING_TRIPLE_DOUBLE</span><span class="p">,</span>
    <span class="n">_RE_STRING_TRIPLE_SINGLE</span><span class="p">,</span>
    <span class="n">_RE_STRING_DOUBLE</span><span class="p">,</span>
    <span class="n">_RE_STRING_SINGLE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">RE_BEGIN_STRING</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">_RE_STRING_START</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_STRINGS</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;))&quot;</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;RE_BEGIN_STRING&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Regular expression matching the start of a string, including quotes and</span>
<span class="sd">leading characters (r, b, or u)&quot;&quot;&quot;</span>

<span class="n">RE_STRING_START</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_RE_STRING_START</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;RE_STRING_START&quot;</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Regular expression matching the characters before the quotes when starting a</span>
<span class="sd">string (r, b, or u, case insensitive)&quot;&quot;&quot;</span>

<span class="n">RE_STRING_CONT</span> <span class="o">=</span> <span class="n">LazyDict</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;((</span><span class="se">\\</span><span class="s1">(.|\n))|([^&quot;</span><span class="se">\\</span><span class="s1">]))*&#39;</span><span class="p">),</span>
        <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((</span><span class="se">\\</span><span class="s2">(.|\n))|([^&#39;</span><span class="se">\\</span><span class="s2">]))*&quot;</span><span class="p">),</span>
        <span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;((</span><span class="se">\\</span><span class="s1">(.|\n))|([^&quot;</span><span class="se">\\</span><span class="s1">])|(&quot;(?!&quot;&quot;))|\n)*&#39;</span><span class="p">),</span>
        <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((</span><span class="se">\\</span><span class="s2">(.|\n))|([^&#39;</span><span class="se">\\</span><span class="s2">])|(&#39;(?!&#39;&#39;))|\n)*&quot;</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;RE_STRING_CONT&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Dictionary mapping starting quote sequences to regular expressions that</span>
<span class="sd">match the contents of a string beginning with those quotes (not including the</span>
<span class="sd">terminating quotes)&quot;&quot;&quot;</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">RE_COMPLETE_STRING</span><span class="p">():</span>
    <span class="n">ptrn</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;^&quot;</span>
        <span class="o">+</span> <span class="n">_RE_STRING_START</span>
        <span class="o">+</span> <span class="s2">&quot;(?P&lt;quote&gt;&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_STRINGS</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;.*?(?P=quote)$&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">ptrn</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">strip_simple_quotes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets rid of single quotes, double quotes, single triple quotes, and</span>
<span class="sd">    single double quotes from a string, if present front and back of a string.</span>
<span class="sd">    Otherwiswe, does nothing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">starts_single</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="n">starts_double</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">starts_single</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">starts_double</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">elif</span> <span class="n">starts_single</span><span class="p">:</span>
        <span class="n">ends_single</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ends_single</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># starts double</span>
        <span class="n">ends_double</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ends_double</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">check_for_partial_string</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the starting index (inclusive), ending index (exclusive), and</span>
<span class="sd">    starting quote string of the most recent Python string found in the input.</span>

<span class="sd">    check_for_partial_string(x) -&gt; (startix, endix, quote)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : str</span>
<span class="sd">        The string to be checked (representing a line of terminal input)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    startix : int (or None)</span>
<span class="sd">        The index where the most recent Python string found started</span>
<span class="sd">        (inclusive), or None if no strings exist in the input</span>

<span class="sd">    endix : int (or None)</span>
<span class="sd">        The index where the most recent Python string found ended (exclusive),</span>
<span class="sd">        or None if no strings exist in the input OR if the input ended in the</span>
<span class="sd">        middle of a Python string</span>

<span class="sd">    quote : str (or None)</span>
<span class="sd">        A string containing the quote used to start the string (e.g., b&quot;, &quot;,</span>
<span class="sd">        &#39;&#39;&#39;), or None if no string was found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">string_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">starting_quote</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">RE_BEGIN_STRING</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># add the start in</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">quote</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lenquote</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quote</span><span class="p">)</span>
        <span class="n">current_index</span> <span class="o">+=</span> <span class="n">start</span>
        <span class="c1"># store the starting index of the string, as well as the</span>
        <span class="c1"># characters in the starting quotes (e.g., &quot;, &#39;, &quot;&quot;&quot;, r&quot;, etc)</span>
        <span class="n">string_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_index</span><span class="p">)</span>
        <span class="n">starting_quote</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quote</span><span class="p">)</span>
        <span class="c1"># determine the string that should terminate this string</span>
        <span class="n">ender</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RE_STRING_START</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">lenquote</span> <span class="p">:]</span>
        <span class="n">current_index</span> <span class="o">+=</span> <span class="n">lenquote</span>
        <span class="c1"># figure out what is inside the string</span>
        <span class="n">continuer</span> <span class="o">=</span> <span class="n">RE_STRING_CONT</span><span class="p">[</span><span class="n">ender</span><span class="p">]</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">continuer</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">leninside</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inside</span><span class="p">)</span>
        <span class="n">current_index</span> <span class="o">+=</span> <span class="n">contents</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="n">leninside</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ender</span><span class="p">)</span>
        <span class="c1"># if we are not at the end of the input string, add the ending index of</span>
        <span class="c1"># the string to string_indices</span>
        <span class="k">if</span> <span class="n">contents</span><span class="o">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">string_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_index</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">leninside</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ender</span><span class="p">)</span> <span class="p">:]</span>
        <span class="c1"># find the next match</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">RE_BEGIN_STRING</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">numquotes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string_indices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numquotes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">numquotes</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">string_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">starting_quote</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">string_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">string_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">starting_quote</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


<span class="c1"># regular expressions for matching environment variables</span>
<span class="c1"># i.e $FOO, ${&#39;FOO&#39;}</span>
<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">POSIX_ENVVAR_REGEX</span><span class="p">():</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;\$({(?P&lt;quote&gt;[&#39;&quot;])|)(?P&lt;envvar&gt;\w+)((?P=quote)}|(?:\1\b))&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">expandvars</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expand shell variables of the forms $var, ${var} and %var%.</span>
<span class="sd">    Unknown variables are left unchanged.&quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">),</span> <span class="n">errors</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
        <span class="c1"># get the path&#39;s string representation</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;$&quot;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">POSIX_ENVVAR_REGEX</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;envvar&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
                <span class="n">detyper</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_detyper</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">detyper</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">detyper</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">value</span>
                <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
                <span class="n">path_len_before_replace</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span> <span class="n">start_pos</span> <span class="o">+</span> <span class="n">shift</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="n">end_pos</span> <span class="o">+</span> <span class="n">shift</span> <span class="p">:]</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="n">path_len_before_replace</span>
    <span class="k">return</span> <span class="n">path</span>


<span class="c1">#</span>
<span class="c1"># File handling tools</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">backup_file</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Moves an existing file to a new name that has the current time right</span>
<span class="sd">    before the extension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># lazy imports</span>
    <span class="kn">import</span> <span class="nn">shutil</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

    <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%H-%M-%S-</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">newfname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">newfname</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">normabspath</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns as normalized absolute path, namely, normcase(abspath(p))&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">expanduser_abs_path</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides user expanded absolute path&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="n">inp</span><span class="p">))</span>


<span class="n">WINDOWS_DRIVE_MATCHER</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\w:&quot;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;WINDOWS_DRIVE_MATCHER&quot;</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">expand_case_matching</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expands a string to a case insensitive globable string.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">openers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">}</span>
    <span class="n">closers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">}</span>
    <span class="n">nesting</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">drive_part</span> <span class="o">=</span> <span class="n">WINDOWS_DRIVE_MATCHER</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">drive_part</span><span class="p">:</span>
        <span class="n">drive_part</span> <span class="o">=</span> <span class="n">drive_part</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drive_part</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">drive_part</span><span class="p">)</span> <span class="p">:]</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">openers</span><span class="p">:</span>
            <span class="n">nesting</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">closers</span><span class="p">:</span>
            <span class="n">nesting</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">nesting</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="n">folded</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{0}{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newc</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[</span><span class="si">{0}{1}</span><span class="s2">]?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folded</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">newc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newc</span><span class="p">)</span>
                <span class="n">newc</span> <span class="o">+=</span> <span class="s2">&quot;[</span><span class="si">{0}{1}{2}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folded</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">folded</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">newc</span>
        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">globpath</span><span class="p">(</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">ignore_case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_dotfiles</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple wrapper around glob that also expands home and env vars.&quot;&quot;&quot;</span>
    <span class="n">o</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">_iglobpath</span><span class="p">(</span>
        <span class="n">s</span><span class="p">,</span>
        <span class="n">ignore_case</span><span class="o">=</span><span class="n">ignore_case</span><span class="p">,</span>
        <span class="n">sort_result</span><span class="o">=</span><span class="n">sort_result</span><span class="p">,</span>
        <span class="n">include_dotfiles</span><span class="o">=</span><span class="n">include_dotfiles</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="n">no_match</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">return_empty</span> <span class="k">else</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">o</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">no_match</span>


<span class="k">def</span> <span class="nf">_dotglobstr</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dotted_s</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">if</span> <span class="s2">&quot;/*&quot;</span> <span class="ow">in</span> <span class="n">dotted_s</span><span class="p">:</span>
        <span class="n">dotted_s</span> <span class="o">=</span> <span class="n">dotted_s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/*&quot;</span><span class="p">,</span> <span class="s2">&quot;/.*&quot;</span><span class="p">)</span>
        <span class="n">dotted_s</span> <span class="o">=</span> <span class="n">dotted_s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/.**/.*&quot;</span><span class="p">,</span> <span class="s2">&quot;/**/.*&quot;</span><span class="p">)</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">dotted_s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dotted_s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">):</span>
        <span class="n">dotted_s</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">dotted_s</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">dotted_s</span><span class="p">,</span> <span class="n">modified</span>


<span class="k">def</span> <span class="nf">_iglobpath</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ignore_case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_dotfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sort_result</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GLOB_SORTED&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_dotfiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">include_dotfiles</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOTGLOB&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ignore_case</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">expand_case_matching</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;**&quot;</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">and</span> <span class="s2">&quot;**/*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;**/*&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_dotfiles</span><span class="p">:</span>
        <span class="n">dotted_s</span><span class="p">,</span> <span class="n">dotmodified</span> <span class="o">=</span> <span class="n">_dotglobstr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort_result</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_dotfiles</span> <span class="ow">and</span> <span class="n">dotmodified</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">dotted_s</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_dotfiles</span> <span class="ow">and</span> <span class="n">dotmodified</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">dotted_s</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">paths</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span><span class="p">,</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">iglobpath</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ignore_case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_dotfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple wrapper around iglob that also expands home and env vars.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_iglobpath</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="n">ignore_case</span><span class="o">=</span><span class="n">ignore_case</span><span class="p">,</span>
            <span class="n">sort_result</span><span class="o">=</span><span class="n">sort_result</span><span class="p">,</span>
            <span class="n">include_dotfiles</span><span class="o">=</span><span class="n">include_dotfiles</span><span class="p">,</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="c1"># something went wrong in the actual iglob() call</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>


<span class="k">def</span> <span class="nf">ensure_timestamp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">datetime_format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">t</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">datetime_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">datetime_format</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_DATETIME_FORMAT&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">datetime_format</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">t</span>


<span class="k">def</span> <span class="nf">format_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format datetime object to string base on $XONSH_DATETIME_FORMAT Env.&quot;&quot;&quot;</span>
    <span class="n">format_</span> <span class="o">=</span> <span class="n">xsh</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_DATETIME_FORMAT&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format_</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">columnize</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes an iterable of strings and returns a list of lines with the</span>
<span class="sd">    elements placed in columns. Each line will be at most *width* columns.</span>
<span class="sd">    The newline character will be appended to the end of each line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
    <span class="n">nelem</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">sizes</span><span class="p">]</span>
        <span class="n">last_longest_row</span> <span class="o">=</span> <span class="n">total</span>
        <span class="n">enter_loop</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">sizes</span><span class="p">]</span>
        <span class="n">last_longest_row</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="n">enter_loop</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">enter_loop</span><span class="p">:</span>
        <span class="n">longest_row</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">longest_row</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="p">:</span>
            <span class="c1"># we might be able to fit another column.</span>
            <span class="n">ncols</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">nelem</span> <span class="o">//</span> <span class="n">ncols</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">sizes</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">nrows</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)]</span>
            <span class="n">last_longest_row</span> <span class="o">=</span> <span class="n">longest_row</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we can&#39;t fit another column</span>
            <span class="n">ncols</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">nelem</span> <span class="o">//</span> <span class="n">ncols</span>
            <span class="k">break</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">last_longest_row</span> <span class="o">+</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncols</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="n">pad</span> <span class="k">if</span> <span class="n">pad</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">elems</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">nrows</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)]</span>
    <span class="n">colwidths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">+</span> <span class="n">pad</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="n">colwidths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">pad</span>
    <span class="n">row_t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;{{row[</span><span class="si">{i}</span><span class="s2">]: &lt;{{w[</span><span class="si">{i}</span><span class="s2">]}}}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)])</span>
    <span class="n">row_t</span> <span class="o">+=</span> <span class="n">newline</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">row_t</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">colwidths</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">lines</span>


<span class="n">ALIAS_KWARG_NAMES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="s2">&quot;stdin&quot;</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;spec&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">unthreadable</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator that specifies that a callable alias should be run only</span>
<span class="sd">    on the main thread process. This is often needed for debuggers and</span>
<span class="sd">    profilers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">__xonsh_threadable__</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">uncapturable</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator that specifies that a callable alias should not be run with</span>
<span class="sd">    any capturing. This is often needed if the alias call interactive</span>
<span class="sd">    subprocess, like pagers and text editors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">__xonsh_capturable__</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">carriage_return</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Writes a carriage return to stdout, and nothing else.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">deprecated</span><span class="p">(</span><span class="n">deprecated_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">removed_in</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parametrized decorator that deprecates a function in a graceful manner.</span>

<span class="sd">    Updates the decorated function&#39;s docstring to mention the version</span>
<span class="sd">    that deprecation occurred in and the version it will be removed</span>
<span class="sd">    in if both of these values are passed.</span>

<span class="sd">    When removed_in is not a release equal to or less than the current</span>
<span class="sd">    release, call ``warnings.warn`` with details, while raising</span>
<span class="sd">    ``DeprecationWarning``.</span>

<span class="sd">    When removed_in is a release equal to or less than the current release,</span>
<span class="sd">    raise an ``AssertionError``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    deprecated_in : str</span>
<span class="sd">        The version number that deprecated this function.</span>
<span class="sd">    removed_in : str</span>
<span class="sd">        The version number that this function will be removed in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">message_suffix</span> <span class="o">=</span> <span class="n">_deprecated_message_suffix</span><span class="p">(</span><span class="n">deprecated_in</span><span class="p">,</span> <span class="n">removed_in</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message_suffix</span><span class="p">:</span>
        <span class="n">message_suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">warning_message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has been deprecated&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">warning_message</span> <span class="o">+=</span> <span class="n">message_suffix</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">_deprecated_error_on_expiration</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">removed_in</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_message</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="n">wrapped</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wrapped</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">warning_message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wrapped</span><span class="o">.</span><span class="vm">__doc__</span>
            <span class="k">else</span> <span class="n">warning_message</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped</span>

    <span class="k">return</span> <span class="n">decorated</span>


<span class="k">def</span> <span class="nf">_deprecated_message_suffix</span><span class="p">(</span><span class="n">deprecated_in</span><span class="p">,</span> <span class="n">removed_in</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">deprecated_in</span> <span class="ow">and</span> <span class="n">removed_in</span><span class="p">:</span>
        <span class="n">message_suffix</span> <span class="o">=</span> <span class="s2">&quot; in version </span><span class="si">{}</span><span class="s2"> and will be removed in version </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">deprecated_in</span><span class="p">,</span> <span class="n">removed_in</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">deprecated_in</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">removed_in</span><span class="p">:</span>
        <span class="n">message_suffix</span> <span class="o">=</span> <span class="s2">&quot; in version </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deprecated_in</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">deprecated_in</span> <span class="ow">and</span> <span class="n">removed_in</span><span class="p">:</span>
        <span class="n">message_suffix</span> <span class="o">=</span> <span class="s2">&quot; and will be removed in version </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">removed_in</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">message_suffix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">message_suffix</span>


<span class="k">def</span> <span class="nf">_deprecated_error_on_expiration</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">removed_in</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">distutils.version</span> <span class="kn">import</span> <span class="n">LooseVersion</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">removed_in</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">removed_in</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has passed its version </span><span class="si">{}</span><span class="s2"> expiry date!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">removed_in</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">to_repr_pretty_</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">inst</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cycle</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">break_</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">pretty</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">XAttr</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;hold attribute and value&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;XAttr&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&gt;&quot;</span>


<span class="k">class</span> <span class="nc">NamedConstantMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;utility class to hold list of values as class-attributes&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="n">XAttr</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># ast</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The xonsh abstract syntax tree node.&quot;&quot;&quot;</span>
<span class="c1"># These are imported into our module namespace for the benefit of parser.py.</span>
<span class="c1"># pylint: disable=unused-import</span>
<span class="c1"># amalgamated sys</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Module</span><span class="p">,</span>
    <span class="n">Num</span><span class="p">,</span>
    <span class="n">Expr</span><span class="p">,</span>
    <span class="n">Str</span><span class="p">,</span>
    <span class="n">Bytes</span><span class="p">,</span>
    <span class="n">UnaryOp</span><span class="p">,</span>
    <span class="n">UAdd</span><span class="p">,</span>
    <span class="n">USub</span><span class="p">,</span>
    <span class="n">Invert</span><span class="p">,</span>
    <span class="n">BinOp</span><span class="p">,</span>
    <span class="n">Add</span><span class="p">,</span>
    <span class="n">Sub</span><span class="p">,</span>
    <span class="n">Mult</span><span class="p">,</span>
    <span class="n">Div</span><span class="p">,</span>
    <span class="n">FloorDiv</span><span class="p">,</span>
    <span class="n">Mod</span><span class="p">,</span>
    <span class="n">Pow</span><span class="p">,</span>
    <span class="n">Compare</span><span class="p">,</span>
    <span class="n">Lt</span><span class="p">,</span>
    <span class="n">Gt</span><span class="p">,</span>
    <span class="n">LtE</span><span class="p">,</span>
    <span class="n">GtE</span><span class="p">,</span>
    <span class="n">Eq</span><span class="p">,</span>
    <span class="n">NotEq</span><span class="p">,</span>
    <span class="n">In</span><span class="p">,</span>
    <span class="n">NotIn</span><span class="p">,</span>
    <span class="n">Is</span><span class="p">,</span>
    <span class="n">IsNot</span><span class="p">,</span>
    <span class="n">Not</span><span class="p">,</span>
    <span class="n">BoolOp</span><span class="p">,</span>
    <span class="n">Or</span><span class="p">,</span>
    <span class="n">And</span><span class="p">,</span>
    <span class="n">Subscript</span><span class="p">,</span>
    <span class="n">Load</span><span class="p">,</span>
    <span class="n">Slice</span><span class="p">,</span>
    <span class="n">ExtSlice</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">AST</span><span class="p">,</span>
    <span class="n">NameConstant</span><span class="p">,</span>
    <span class="n">Name</span><span class="p">,</span>
    <span class="n">GeneratorExp</span><span class="p">,</span>
    <span class="n">Store</span><span class="p">,</span>
    <span class="n">comprehension</span><span class="p">,</span>
    <span class="n">ListComp</span><span class="p">,</span>
    <span class="n">SetComp</span><span class="p">,</span>
    <span class="n">DictComp</span><span class="p">,</span>
    <span class="n">Assign</span><span class="p">,</span>
    <span class="n">AugAssign</span><span class="p">,</span>
    <span class="n">BitXor</span><span class="p">,</span>
    <span class="n">BitAnd</span><span class="p">,</span>
    <span class="n">BitOr</span><span class="p">,</span>
    <span class="n">LShift</span><span class="p">,</span>
    <span class="n">RShift</span><span class="p">,</span>
    <span class="n">Assert</span><span class="p">,</span>
    <span class="n">Delete</span><span class="p">,</span>
    <span class="n">Del</span><span class="p">,</span>
    <span class="n">Pass</span><span class="p">,</span>
    <span class="n">Raise</span><span class="p">,</span>
    <span class="n">Import</span><span class="p">,</span>
    <span class="n">alias</span><span class="p">,</span>
    <span class="n">ImportFrom</span><span class="p">,</span>
    <span class="n">Continue</span><span class="p">,</span>
    <span class="n">Break</span><span class="p">,</span>
    <span class="n">Yield</span><span class="p">,</span>
    <span class="n">YieldFrom</span><span class="p">,</span>
    <span class="n">Return</span><span class="p">,</span>
    <span class="n">IfExp</span><span class="p">,</span>
    <span class="n">Lambda</span><span class="p">,</span>
    <span class="n">arguments</span><span class="p">,</span>
    <span class="n">arg</span><span class="p">,</span>
    <span class="n">Call</span><span class="p">,</span>
    <span class="n">keyword</span><span class="p">,</span>
    <span class="n">Attribute</span><span class="p">,</span>
    <span class="n">Global</span><span class="p">,</span>
    <span class="n">Nonlocal</span><span class="p">,</span>
    <span class="n">If</span><span class="p">,</span>
    <span class="n">While</span><span class="p">,</span>
    <span class="n">For</span><span class="p">,</span>
    <span class="n">withitem</span><span class="p">,</span>
    <span class="n">With</span><span class="p">,</span>
    <span class="n">Try</span><span class="p">,</span>
    <span class="n">ExceptHandler</span><span class="p">,</span>
    <span class="n">FunctionDef</span><span class="p">,</span>
    <span class="n">ClassDef</span><span class="p">,</span>
    <span class="n">Starred</span><span class="p">,</span>
    <span class="n">NodeTransformer</span><span class="p">,</span>
    <span class="n">Interactive</span><span class="p">,</span>
    <span class="n">Expression</span><span class="p">,</span>
    <span class="n">Index</span><span class="p">,</span>
    <span class="n">literal_eval</span><span class="p">,</span>
    <span class="n">dump</span><span class="p">,</span>
    <span class="n">walk</span><span class="p">,</span>
    <span class="n">increment_lineno</span><span class="p">,</span>
    <span class="n">Constant</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="bp">Ellipsis</span> <span class="k">as</span> <span class="n">EllipsisNode</span>

<span class="c1"># pylint: enable=unused-import</span>
<span class="c1"># amalgamated textwrap</span>
<span class="c1"># amalgamated itertools</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MatMult</span><span class="p">,</span>
    <span class="n">AsyncFunctionDef</span><span class="p">,</span>
    <span class="n">AsyncWith</span><span class="p">,</span>
    <span class="n">AsyncFor</span><span class="p">,</span>
    <span class="n">Await</span><span class="p">,</span>
    <span class="n">JoinedStr</span><span class="p">,</span>
    <span class="n">FormattedValue</span><span class="p">,</span>
    <span class="n">AnnAssign</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># amalgamated xonsh.platform</span>
<span class="k">if</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">NamedExpr</span>  <span class="c1"># type:ignore</span>

<span class="n">STATEMENTS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">FunctionDef</span><span class="p">,</span>
    <span class="n">ClassDef</span><span class="p">,</span>
    <span class="n">Return</span><span class="p">,</span>
    <span class="n">Delete</span><span class="p">,</span>
    <span class="n">Assign</span><span class="p">,</span>
    <span class="n">AugAssign</span><span class="p">,</span>
    <span class="n">For</span><span class="p">,</span>
    <span class="n">While</span><span class="p">,</span>
    <span class="n">If</span><span class="p">,</span>
    <span class="n">With</span><span class="p">,</span>
    <span class="n">Raise</span><span class="p">,</span>
    <span class="n">Try</span><span class="p">,</span>
    <span class="n">Assert</span><span class="p">,</span>
    <span class="n">Import</span><span class="p">,</span>
    <span class="n">ImportFrom</span><span class="p">,</span>
    <span class="n">Global</span><span class="p">,</span>
    <span class="n">Nonlocal</span><span class="p">,</span>
    <span class="n">Expr</span><span class="p">,</span>
    <span class="n">Pass</span><span class="p">,</span>
    <span class="n">Break</span><span class="p">,</span>
    <span class="n">Continue</span><span class="p">,</span>
    <span class="n">AnnAssign</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempts to find the first name in the tree.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Name</span><span class="p">):</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">BinOp</span><span class="p">,</span> <span class="n">Compare</span><span class="p">)):</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">Attribute</span><span class="p">,</span> <span class="n">Subscript</span><span class="p">,</span> <span class="n">Starred</span><span class="p">,</span> <span class="n">Expr</span><span class="p">)):</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Call</span><span class="p">):</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">UnaryOp</span><span class="p">):</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">BoolOp</span><span class="p">):</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Assign</span><span class="p">):</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">AnnAssign</span><span class="p">):</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">Str</span><span class="p">,</span> <span class="n">Bytes</span><span class="p">,</span> <span class="n">JoinedStr</span><span class="p">)):</span>
        <span class="c1"># handles case of &quot;./my executable&quot;</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># handles case of echo ,1,2,3</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">rtn</span>


<span class="k">def</span> <span class="nf">get_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the lineno of a node or returns the default.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;lineno&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">min_line</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the minimum lineno.&quot;&quot;&quot;</span>
    <span class="n">node_line</span> <span class="o">=</span> <span class="n">get_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_lineno</span><span class="p">,</span> <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">node_line</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">max_line</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the maximum lineno.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_lineno</span><span class="p">,</span> <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">get_col</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the col_offset of a node, or returns the default&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;col_offset&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">min_col</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the minimum col_offset.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_col</span><span class="p">,</span> <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">max_col</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the maximum col_offset of the node and all sub-nodes.&quot;&quot;&quot;</span>
    <span class="n">col</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;max_col&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">col</span>
    <span class="n">highest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">get_col</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">highest</span><span class="o">.</span><span class="n">col_offset</span> <span class="o">+</span> <span class="n">node_len</span><span class="p">(</span><span class="n">highest</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">col</span>


<span class="k">def</span> <span class="nf">node_len</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The length of a node as a string&quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Name</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># this may need to be added to for more nodes as more cases are found</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the id attribute of a node, or returns a default.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gather_names</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the set of all names present in the node&#39;s tree.&quot;&quot;&quot;</span>
    <span class="n">rtn</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_id</span><span class="p">,</span> <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">)))</span>
    <span class="n">rtn</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rtn</span>


<span class="k">def</span> <span class="nf">get_id_ctx</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the id and attribute of a node, or returns a default.&quot;&quot;&quot;</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gather_load_store_names</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the names present in the node&#39;s tree in a set of load nodes and</span>
<span class="sd">    a set of store nodes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">load</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">store</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">get_id_ctx</span><span class="p">,</span> <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">Load</span><span class="p">):</span>
            <span class="n">load</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">store</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">has_elts</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if x is an AST node with elements.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">AST</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;elts&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_attribute_chain</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an AST that loads variable name that may (or may not)</span>
<span class="sd">    have attribute chains. For example, &quot;a.b.c&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">(),</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">Attribute</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">(),</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">col</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span>


<span class="k">def</span> <span class="nf">xonsh_call</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the AST node for calling a function of a given name.</span>
<span class="sd">    Functions names may contain attribute access, e.g. __xonsh__.env.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Call</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="n">load_attribute_chain</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">),</span>
        <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
        <span class="n">keywords</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">starargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span>
        <span class="n">col_offset</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">isdescendable</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines whether or not a node is worth visiting. Currently only</span>
<span class="sd">    UnaryOp and BoolOp nodes are visited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">UnaryOp</span><span class="p">,</span> <span class="n">BoolOp</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">isexpression</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines whether a node (or code string) is an expression, and</span>
<span class="sd">    does not contain any statements. The execution context (ctx) and</span>
<span class="sd">    other args and kwargs are passed down to the parser, as needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># parse string to AST</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">ctx</span> <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ctx</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">execer</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># determine if expression-like enough</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)):</span>
        <span class="n">isexpr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Module</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">isexpr</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">Expr</span><span class="p">,</span> <span class="n">Expression</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">isexpr</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">isexpr</span>


<span class="k">class</span> <span class="nc">CtxAwareTransformer</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transforms a xonsh AST based to use subprocess calls when</span>
<span class="sd">    the first name in an expression statement is not known in the context.</span>
<span class="sd">    This assumes that the expression statement is instead parseable as</span>
<span class="sd">    a subprocess.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parser : xonsh.Parser</span>
<span class="sd">            A parse instance to try to parse subprocess statements with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CtxAwareTransformer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nwith</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&lt;xonsh-code&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">ctxvisit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transforms the node in a context-dependent way.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node : ast.AST</span>
<span class="sd">            A syntax tree to transform.</span>
<span class="sd">        inp : str</span>
<span class="sd">            The input code in string format.</span>
<span class="sd">        ctx : dict</span>
<span class="sd">            The root context to use.</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            File we are to transform.</span>
<span class="sd">        debug_level : int, optional</span>
<span class="sd">            Debugging level to use in lexing and parsing.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        node : ast.AST</span>
<span class="sd">            The transformed node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">=</span> <span class="n">debug_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctx</span><span class="p">,</span> <span class="nb">set</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nwith</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nwith</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">ctxupdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updated the most recent context.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ctxadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a value the most recent context.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ctxremove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes a value the most recent context.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">try_subproc_toks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">strip_expr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tries to parse the line of the node as a subprocess.&quot;&quot;&quot;</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">nlogical</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_logical_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;eval&quot;</span><span class="p">:</span>
            <span class="n">mincol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
            <span class="n">maxcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mincol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_col</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">maxcol</span> <span class="o">=</span> <span class="n">max_col</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mincol</span> <span class="o">==</span> <span class="n">maxcol</span><span class="p">:</span>
                <span class="n">maxcol</span> <span class="o">=</span> <span class="n">find_next_break</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">mincol</span><span class="o">=</span><span class="n">mincol</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">nlogical</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">maxcol</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">maxcol</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="n">maxcol</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;;&quot;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxcol</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">spline</span> <span class="o">=</span> <span class="n">subproc_toks</span><span class="p">(</span>
            <span class="n">line</span><span class="p">,</span>
            <span class="n">mincol</span><span class="o">=</span><span class="n">mincol</span><span class="p">,</span>
            <span class="n">maxcol</span><span class="o">=</span><span class="n">maxcol</span><span class="p">,</span>
            <span class="n">returnline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">lexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">spline</span> <span class="o">!=</span> <span class="s2">&quot;![</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">mincol</span><span class="p">:</span><span class="n">maxcol</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
            <span class="c1"># failed to get something consistent, try greedy wrap</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">subproc_toks</span><span class="p">(</span>
                <span class="n">line</span><span class="p">,</span>
                <span class="n">mincol</span><span class="o">=</span><span class="n">mincol</span><span class="p">,</span>
                <span class="n">maxcol</span><span class="o">=</span><span class="n">maxcol</span><span class="p">,</span>
                <span class="n">returnline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">lexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span><span class="p">,</span>
                <span class="n">greedy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">spline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                <span class="n">spline</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                <span class="n">debug_level</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="n">newnode</span><span class="o">.</span><span class="n">body</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newnode</span><span class="p">,</span> <span class="n">AST</span><span class="p">):</span>
                <span class="c1"># take the first (and only) Expr</span>
                <span class="n">newnode</span> <span class="o">=</span> <span class="n">newnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">increment_lineno</span><span class="p">(</span><span class="n">newnode</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">newnode</span><span class="o">.</span><span class="n">col_offset</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">col_offset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">:</span><span class="si">{2}{3}</span><span class="s2"> - </span><span class="si">{4}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">:</span><span class="si">{2}{3}</span><span class="s2"> + </span><span class="si">{5}</span><span class="s2">&quot;</span>
                <span class="n">mstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">maxcol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">maxcol</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">mincol</span><span class="p">,</span> <span class="n">mstr</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">spline</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">if</span> <span class="n">strip_expr</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newnode</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="n">newnode</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">newnode</span>

    <span class="k">def</span> <span class="nf">is_in_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines whether or not the current node is in scope.&quot;&quot;&quot;</span>
        <span class="n">names</span><span class="p">,</span> <span class="n">store</span> <span class="o">=</span> <span class="n">gather_load_store_names</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">-=</span> <span class="n">store</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">inscope</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">-=</span> <span class="n">ctx</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">inscope</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">inscope</span>

    <span class="c1">#</span>
    <span class="c1"># Replacement visitors</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">visit_Expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting an expression body.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isdescendable</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span>
        <span class="n">inscope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_scope</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inscope</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_subproc_toks</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting an expression.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isdescendable</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># this allows diving into BoolOps</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_scope</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_subproc_toks</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newnode</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
                <span class="n">newnode</span> <span class="o">=</span> <span class="n">Expr</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">newnode</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">col_offset</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;max_lineno&quot;</span><span class="p">):</span>
                    <span class="n">newnode</span><span class="o">.</span><span class="n">max_lineno</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">max_lineno</span>
                    <span class="n">newnode</span><span class="o">.</span><span class="n">max_col</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">max_col</span>
            <span class="k">return</span> <span class="n">newnode</span>

    <span class="k">def</span> <span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting an unary operands, like not.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isdescendable</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">operand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>
        <span class="n">operand</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">operand</span>
        <span class="n">inscope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_scope</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inscope</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">operand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_subproc_toks</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">strip_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_BoolOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting an boolean operands, like and/or.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">)):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">isdescendable</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">inscope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_scope</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inscope</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_subproc_toks</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">strip_expr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="c1">#</span>
    <span class="c1"># Context aggregator visitors</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting an assignment statement.&quot;&quot;&quot;</span>
        <span class="n">ups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">targ</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">targ</span><span class="p">,</span> <span class="p">(</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">)):</span>
                <span class="n">ups</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">leftmostname</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span> <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">targ</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">targ</span><span class="p">,</span> <span class="n">BinOp</span><span class="p">):</span>
                <span class="n">newnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_subproc_toks</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newnode</span> <span class="ow">is</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">ups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">leftmostname</span><span class="p">(</span><span class="n">targ</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">newnode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">leftmostname</span><span class="p">(</span><span class="n">targ</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctxupdate</span><span class="p">(</span><span class="n">ups</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_AnnAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting an annotated assignment statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctxadd</span><span class="p">(</span><span class="n">leftmostname</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a import statement.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">asname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctxadd</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctxadd</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">asname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_ImportFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a &quot;from ... import ...&quot; statement.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">asname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctxadd</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctxadd</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">asname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a with statement.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">optional_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctxupdate</span><span class="p">(</span><span class="n">gather_names</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">optional_vars</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nwith</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nwith</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a for statement.&quot;&quot;&quot;</span>
        <span class="n">targ</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctxupdate</span><span class="p">(</span><span class="n">gather_names</span><span class="p">(</span><span class="n">targ</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a function definition.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctxadd</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span>
        <span class="n">argchain</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">vararg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">argchain</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">args</span><span class="o">.</span><span class="n">vararg</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">kwarg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">argchain</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">args</span><span class="o">.</span><span class="n">kwarg</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctxupdate</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">arg</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">argchain</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a class definition.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctxadd</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a del statement.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">targ</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">targ</span><span class="p">,</span> <span class="n">Name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctxremove</span><span class="p">(</span><span class="n">targ</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Try</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a try statement.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctxadd</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle visiting a global statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>  <span class="c1"># contexts[1] is the global ctx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>


<span class="k">def</span> <span class="nf">pdump</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;performs a pretty dump of an AST node.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AST</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">dump</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">openers</span> <span class="o">=</span> <span class="s2">&quot;([{&quot;</span>
    <span class="n">closers</span> <span class="o">=</span> <span class="s2">&quot;)]}&quot;</span>
    <span class="n">lens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">lens</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">%</span> <span class="n">lens</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">openers</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">lens</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="n">closer</span> <span class="o">=</span> <span class="n">closers</span><span class="p">[</span><span class="n">openers</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">closer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">pdump</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]),</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">j</span><span class="p">]</span>
    <span class="n">post</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">pdump</span><span class="p">(</span><span class="n">mid</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">post</span> <span class="ow">or</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">post</span> <span class="ow">or</span> <span class="s2">&quot;{&quot;</span> <span class="ow">in</span> <span class="n">post</span><span class="p">:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">pdump</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pre</span> <span class="o">+</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">post</span>


<span class="k">def</span> <span class="nf">pprint_ast</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs a pretty print of the AST nodes.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pdump</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># Private helpers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_getblockattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calls getattr(name, &#39;__xonsh_block__&#39;, False).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">xonsh_call</span><span class="p">(</span>
        <span class="s2">&quot;getattr&quot;</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">[</span>
            <span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">(),</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">col</span><span class="p">),</span>
            <span class="n">Str</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="s2">&quot;__xonsh_block__&quot;</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">col</span><span class="p">),</span>
            <span class="n">NameConstant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">col</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># color_tools</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Tools for color handling in xonsh.</span>

<span class="sd">This includes Convert values between RGB hex codes and xterm-256</span>
<span class="sd">color codes. Parts of this file were originally forked from Micah Elliott</span>
<span class="sd">http://MicahElliott.com Copyright (C) 2011 Micah Elliott. All rights reserved.</span>
<span class="sd">WTFPL http://sam.zoy.org/wtfpl/</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated re</span>
<span class="n">math</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;math&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="n">_NO_COLOR_WARNING_SHOWN</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">RE_BACKGROUND</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(BG#|BGHEX|BACKGROUND)&quot;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;RE_BACKGROUND&quot;</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">COLORS</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;constants&quot;&quot;&quot;</span>

    <span class="n">RESET</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">&quot;</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{RED}</span><span class="s2">&quot;</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{GREEN}</span><span class="s2">&quot;</span>
    <span class="n">BOLD_RED</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{BOLD_RED}</span><span class="s2">&quot;</span>
    <span class="n">BOLD_GREEN</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{BOLD_GREEN}</span><span class="s2">&quot;</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">KNOWN_XONSH_COLORS</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;These are the minimum number of colors that need to be implemented by</span>
<span class="sd">    any style.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;DEFAULT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BLACK&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RED&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GREEN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;YELLOW&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BLUE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PURPLE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CYAN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WHITE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">BASE_XONSH_COLORS</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">),</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">),</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">),</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">),</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
    <span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">RE_XONSH_COLOR</span><span class="p">():</span>
    <span class="nb">hex</span> <span class="o">=</span> <span class="s2">&quot;[0-9a-fA-F]&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># background</span>
        <span class="sa">r</span><span class="s2">&quot;((?P&lt;background&gt;BACKGROUND_)|(?P&lt;modifiers&gt;(&quot;</span>
        <span class="c1"># modifiers, only apply to foreground</span>
        <span class="sa">r</span><span class="s2">&quot;BOLD_|FAINT_|ITALIC_|UNDERLINE_|SLOWBLINK_|FASTBLINK_|INVERT_|CONCEAL_|&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;STRIKETHROUGH_|BOLDOFF_|FAINTOFF_|ITALICOFF_|UNDERLINEOFF_|BLINKOFF_|&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;INVERTOFF_|REVEALOFF_|STRIKETHROUGHOFF_)+))?&quot;</span>
        <span class="c1"># colors</span>
        <span class="sa">r</span><span class="s2">&quot;(?P&lt;color&gt;BLACK|RED|GREEN|YELLOW|BLUE|PURPLE|CYAN|WHITE|INTENSE_BLACK|&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;INTENSE_RED|INTENSE_GREEN|INTENSE_YELLOW|INTENSE_BLUE|INTENSE_PURPLE|&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;INTENSE_CYAN|INTENSE_WHITE|#&quot;</span> <span class="o">+</span> <span class="nb">hex</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{3}</span><span class="s2">|#&quot;</span> <span class="o">+</span> <span class="nb">hex</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{6}</span><span class="s2">|DEFAULT)&quot;</span>
    <span class="p">)</span>
    <span class="n">bghex</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;bg#&quot;</span> <span class="o">+</span> <span class="nb">hex</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{3}</span><span class="s2">|&quot;</span>
        <span class="s2">&quot;bg#&quot;</span> <span class="o">+</span> <span class="nb">hex</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{6}</span><span class="s2">|&quot;</span>
        <span class="s2">&quot;BG#&quot;</span> <span class="o">+</span> <span class="nb">hex</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{3}</span><span class="s2">|&quot;</span>
        <span class="s2">&quot;BG#&quot;</span> <span class="o">+</span> <span class="nb">hex</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{6}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;^((?P&lt;reset&gt;RESET|NO_COLOR)|(?P&lt;bghex&gt;&quot;</span> <span class="o">+</span> <span class="n">bghex</span> <span class="o">+</span> <span class="s2">&quot;)|&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;)$&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">iscolor</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests if a string is a valid color&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">RE_XONSH_COLOR</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">CLUT</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;color look-up table&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="c1">#    8-bit, RGB hex</span>
        <span class="c1"># Primary 3-bit (8 colors). Unique representation!</span>
        <span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;000000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;800000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;008000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;808000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;000080&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;800080&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;008080&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;c0c0c0&quot;</span><span class="p">),</span>
        <span class="c1"># Equivalent &quot;bright&quot; versions of original 8 colors.</span>
        <span class="p">(</span><span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;808080&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;9&quot;</span><span class="p">,</span> <span class="s2">&quot;ff0000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;00ff00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="s2">&quot;ffff00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="s2">&quot;0000ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;13&quot;</span><span class="p">,</span> <span class="s2">&quot;ff00ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;14&quot;</span><span class="p">,</span> <span class="s2">&quot;00ffff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;15&quot;</span><span class="p">,</span> <span class="s2">&quot;ffffff&quot;</span><span class="p">),</span>
        <span class="c1"># Strictly ascending.</span>
        <span class="p">(</span><span class="s2">&quot;16&quot;</span><span class="p">,</span> <span class="s2">&quot;000000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;17&quot;</span><span class="p">,</span> <span class="s2">&quot;00005f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;18&quot;</span><span class="p">,</span> <span class="s2">&quot;000087&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;19&quot;</span><span class="p">,</span> <span class="s2">&quot;0000af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;20&quot;</span><span class="p">,</span> <span class="s2">&quot;0000d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;21&quot;</span><span class="p">,</span> <span class="s2">&quot;0000ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">,</span> <span class="s2">&quot;005f00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;23&quot;</span><span class="p">,</span> <span class="s2">&quot;005f5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;24&quot;</span><span class="p">,</span> <span class="s2">&quot;005f87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;25&quot;</span><span class="p">,</span> <span class="s2">&quot;005faf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;26&quot;</span><span class="p">,</span> <span class="s2">&quot;005fd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;27&quot;</span><span class="p">,</span> <span class="s2">&quot;005fff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;28&quot;</span><span class="p">,</span> <span class="s2">&quot;008700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;29&quot;</span><span class="p">,</span> <span class="s2">&quot;00875f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;30&quot;</span><span class="p">,</span> <span class="s2">&quot;008787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;31&quot;</span><span class="p">,</span> <span class="s2">&quot;0087af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;32&quot;</span><span class="p">,</span> <span class="s2">&quot;0087d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;33&quot;</span><span class="p">,</span> <span class="s2">&quot;0087ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;34&quot;</span><span class="p">,</span> <span class="s2">&quot;00af00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;35&quot;</span><span class="p">,</span> <span class="s2">&quot;00af5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;36&quot;</span><span class="p">,</span> <span class="s2">&quot;00af87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;37&quot;</span><span class="p">,</span> <span class="s2">&quot;00afaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;38&quot;</span><span class="p">,</span> <span class="s2">&quot;00afd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;39&quot;</span><span class="p">,</span> <span class="s2">&quot;00afff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;40&quot;</span><span class="p">,</span> <span class="s2">&quot;00d700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;41&quot;</span><span class="p">,</span> <span class="s2">&quot;00d75f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;42&quot;</span><span class="p">,</span> <span class="s2">&quot;00d787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;43&quot;</span><span class="p">,</span> <span class="s2">&quot;00d7af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;44&quot;</span><span class="p">,</span> <span class="s2">&quot;00d7d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;45&quot;</span><span class="p">,</span> <span class="s2">&quot;00d7ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;46&quot;</span><span class="p">,</span> <span class="s2">&quot;00ff00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;00ff5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;00ff87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;49&quot;</span><span class="p">,</span> <span class="s2">&quot;00ffaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;50&quot;</span><span class="p">,</span> <span class="s2">&quot;00ffd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;51&quot;</span><span class="p">,</span> <span class="s2">&quot;00ffff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;52&quot;</span><span class="p">,</span> <span class="s2">&quot;5f0000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;53&quot;</span><span class="p">,</span> <span class="s2">&quot;5f005f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;54&quot;</span><span class="p">,</span> <span class="s2">&quot;5f0087&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;55&quot;</span><span class="p">,</span> <span class="s2">&quot;5f00af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;56&quot;</span><span class="p">,</span> <span class="s2">&quot;5f00d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;57&quot;</span><span class="p">,</span> <span class="s2">&quot;5f00ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;58&quot;</span><span class="p">,</span> <span class="s2">&quot;5f5f00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;59&quot;</span><span class="p">,</span> <span class="s2">&quot;5f5f5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;60&quot;</span><span class="p">,</span> <span class="s2">&quot;5f5f87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;61&quot;</span><span class="p">,</span> <span class="s2">&quot;5f5faf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;62&quot;</span><span class="p">,</span> <span class="s2">&quot;5f5fd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;63&quot;</span><span class="p">,</span> <span class="s2">&quot;5f5fff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;64&quot;</span><span class="p">,</span> <span class="s2">&quot;5f8700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;65&quot;</span><span class="p">,</span> <span class="s2">&quot;5f875f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;66&quot;</span><span class="p">,</span> <span class="s2">&quot;5f8787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;67&quot;</span><span class="p">,</span> <span class="s2">&quot;5f87af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;68&quot;</span><span class="p">,</span> <span class="s2">&quot;5f87d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;69&quot;</span><span class="p">,</span> <span class="s2">&quot;5f87ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;70&quot;</span><span class="p">,</span> <span class="s2">&quot;5faf00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;71&quot;</span><span class="p">,</span> <span class="s2">&quot;5faf5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;72&quot;</span><span class="p">,</span> <span class="s2">&quot;5faf87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;73&quot;</span><span class="p">,</span> <span class="s2">&quot;5fafaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;74&quot;</span><span class="p">,</span> <span class="s2">&quot;5fafd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;75&quot;</span><span class="p">,</span> <span class="s2">&quot;5fafff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;76&quot;</span><span class="p">,</span> <span class="s2">&quot;5fd700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;77&quot;</span><span class="p">,</span> <span class="s2">&quot;5fd75f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;78&quot;</span><span class="p">,</span> <span class="s2">&quot;5fd787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;79&quot;</span><span class="p">,</span> <span class="s2">&quot;5fd7af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;80&quot;</span><span class="p">,</span> <span class="s2">&quot;5fd7d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;81&quot;</span><span class="p">,</span> <span class="s2">&quot;5fd7ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;82&quot;</span><span class="p">,</span> <span class="s2">&quot;5fff00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;83&quot;</span><span class="p">,</span> <span class="s2">&quot;5fff5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;84&quot;</span><span class="p">,</span> <span class="s2">&quot;5fff87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;85&quot;</span><span class="p">,</span> <span class="s2">&quot;5fffaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;86&quot;</span><span class="p">,</span> <span class="s2">&quot;5fffd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;87&quot;</span><span class="p">,</span> <span class="s2">&quot;5fffff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;88&quot;</span><span class="p">,</span> <span class="s2">&quot;870000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;89&quot;</span><span class="p">,</span> <span class="s2">&quot;87005f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;90&quot;</span><span class="p">,</span> <span class="s2">&quot;870087&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;91&quot;</span><span class="p">,</span> <span class="s2">&quot;8700af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;92&quot;</span><span class="p">,</span> <span class="s2">&quot;8700d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;93&quot;</span><span class="p">,</span> <span class="s2">&quot;8700ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;94&quot;</span><span class="p">,</span> <span class="s2">&quot;875f00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;95&quot;</span><span class="p">,</span> <span class="s2">&quot;875f5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;96&quot;</span><span class="p">,</span> <span class="s2">&quot;875f87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;97&quot;</span><span class="p">,</span> <span class="s2">&quot;875faf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;98&quot;</span><span class="p">,</span> <span class="s2">&quot;875fd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;99&quot;</span><span class="p">,</span> <span class="s2">&quot;875fff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;100&quot;</span><span class="p">,</span> <span class="s2">&quot;878700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;101&quot;</span><span class="p">,</span> <span class="s2">&quot;87875f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;102&quot;</span><span class="p">,</span> <span class="s2">&quot;878787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;103&quot;</span><span class="p">,</span> <span class="s2">&quot;8787af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;104&quot;</span><span class="p">,</span> <span class="s2">&quot;8787d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;105&quot;</span><span class="p">,</span> <span class="s2">&quot;8787ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;106&quot;</span><span class="p">,</span> <span class="s2">&quot;87af00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;107&quot;</span><span class="p">,</span> <span class="s2">&quot;87af5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;108&quot;</span><span class="p">,</span> <span class="s2">&quot;87af87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;109&quot;</span><span class="p">,</span> <span class="s2">&quot;87afaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;110&quot;</span><span class="p">,</span> <span class="s2">&quot;87afd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;111&quot;</span><span class="p">,</span> <span class="s2">&quot;87afff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;112&quot;</span><span class="p">,</span> <span class="s2">&quot;87d700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;113&quot;</span><span class="p">,</span> <span class="s2">&quot;87d75f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;114&quot;</span><span class="p">,</span> <span class="s2">&quot;87d787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;115&quot;</span><span class="p">,</span> <span class="s2">&quot;87d7af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;116&quot;</span><span class="p">,</span> <span class="s2">&quot;87d7d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;117&quot;</span><span class="p">,</span> <span class="s2">&quot;87d7ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;118&quot;</span><span class="p">,</span> <span class="s2">&quot;87ff00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;119&quot;</span><span class="p">,</span> <span class="s2">&quot;87ff5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;120&quot;</span><span class="p">,</span> <span class="s2">&quot;87ff87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;121&quot;</span><span class="p">,</span> <span class="s2">&quot;87ffaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;122&quot;</span><span class="p">,</span> <span class="s2">&quot;87ffd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="s2">&quot;87ffff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;124&quot;</span><span class="p">,</span> <span class="s2">&quot;af0000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;125&quot;</span><span class="p">,</span> <span class="s2">&quot;af005f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;126&quot;</span><span class="p">,</span> <span class="s2">&quot;af0087&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;127&quot;</span><span class="p">,</span> <span class="s2">&quot;af00af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;128&quot;</span><span class="p">,</span> <span class="s2">&quot;af00d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;129&quot;</span><span class="p">,</span> <span class="s2">&quot;af00ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;130&quot;</span><span class="p">,</span> <span class="s2">&quot;af5f00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;131&quot;</span><span class="p">,</span> <span class="s2">&quot;af5f5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;132&quot;</span><span class="p">,</span> <span class="s2">&quot;af5f87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;133&quot;</span><span class="p">,</span> <span class="s2">&quot;af5faf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;134&quot;</span><span class="p">,</span> <span class="s2">&quot;af5fd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;135&quot;</span><span class="p">,</span> <span class="s2">&quot;af5fff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;136&quot;</span><span class="p">,</span> <span class="s2">&quot;af8700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;137&quot;</span><span class="p">,</span> <span class="s2">&quot;af875f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;138&quot;</span><span class="p">,</span> <span class="s2">&quot;af8787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;139&quot;</span><span class="p">,</span> <span class="s2">&quot;af87af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;140&quot;</span><span class="p">,</span> <span class="s2">&quot;af87d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;141&quot;</span><span class="p">,</span> <span class="s2">&quot;af87ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;142&quot;</span><span class="p">,</span> <span class="s2">&quot;afaf00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;143&quot;</span><span class="p">,</span> <span class="s2">&quot;afaf5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;144&quot;</span><span class="p">,</span> <span class="s2">&quot;afaf87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;145&quot;</span><span class="p">,</span> <span class="s2">&quot;afafaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;146&quot;</span><span class="p">,</span> <span class="s2">&quot;afafd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;147&quot;</span><span class="p">,</span> <span class="s2">&quot;afafff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;148&quot;</span><span class="p">,</span> <span class="s2">&quot;afd700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;149&quot;</span><span class="p">,</span> <span class="s2">&quot;afd75f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;150&quot;</span><span class="p">,</span> <span class="s2">&quot;afd787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;151&quot;</span><span class="p">,</span> <span class="s2">&quot;afd7af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;152&quot;</span><span class="p">,</span> <span class="s2">&quot;afd7d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;153&quot;</span><span class="p">,</span> <span class="s2">&quot;afd7ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;154&quot;</span><span class="p">,</span> <span class="s2">&quot;afff00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;155&quot;</span><span class="p">,</span> <span class="s2">&quot;afff5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;156&quot;</span><span class="p">,</span> <span class="s2">&quot;afff87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;157&quot;</span><span class="p">,</span> <span class="s2">&quot;afffaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;158&quot;</span><span class="p">,</span> <span class="s2">&quot;afffd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;159&quot;</span><span class="p">,</span> <span class="s2">&quot;afffff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;160&quot;</span><span class="p">,</span> <span class="s2">&quot;d70000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;161&quot;</span><span class="p">,</span> <span class="s2">&quot;d7005f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;162&quot;</span><span class="p">,</span> <span class="s2">&quot;d70087&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;163&quot;</span><span class="p">,</span> <span class="s2">&quot;d700af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;164&quot;</span><span class="p">,</span> <span class="s2">&quot;d700d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;165&quot;</span><span class="p">,</span> <span class="s2">&quot;d700ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;166&quot;</span><span class="p">,</span> <span class="s2">&quot;d75f00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;167&quot;</span><span class="p">,</span> <span class="s2">&quot;d75f5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;168&quot;</span><span class="p">,</span> <span class="s2">&quot;d75f87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;169&quot;</span><span class="p">,</span> <span class="s2">&quot;d75faf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;170&quot;</span><span class="p">,</span> <span class="s2">&quot;d75fd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;171&quot;</span><span class="p">,</span> <span class="s2">&quot;d75fff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;172&quot;</span><span class="p">,</span> <span class="s2">&quot;d78700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;173&quot;</span><span class="p">,</span> <span class="s2">&quot;d7875f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;174&quot;</span><span class="p">,</span> <span class="s2">&quot;d78787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;175&quot;</span><span class="p">,</span> <span class="s2">&quot;d787af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;176&quot;</span><span class="p">,</span> <span class="s2">&quot;d787d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;177&quot;</span><span class="p">,</span> <span class="s2">&quot;d787ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;178&quot;</span><span class="p">,</span> <span class="s2">&quot;d7af00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;179&quot;</span><span class="p">,</span> <span class="s2">&quot;d7af5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;180&quot;</span><span class="p">,</span> <span class="s2">&quot;d7af87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;181&quot;</span><span class="p">,</span> <span class="s2">&quot;d7afaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;182&quot;</span><span class="p">,</span> <span class="s2">&quot;d7afd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;183&quot;</span><span class="p">,</span> <span class="s2">&quot;d7afff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;184&quot;</span><span class="p">,</span> <span class="s2">&quot;d7d700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;185&quot;</span><span class="p">,</span> <span class="s2">&quot;d7d75f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;186&quot;</span><span class="p">,</span> <span class="s2">&quot;d7d787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;187&quot;</span><span class="p">,</span> <span class="s2">&quot;d7d7af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;188&quot;</span><span class="p">,</span> <span class="s2">&quot;d7d7d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;189&quot;</span><span class="p">,</span> <span class="s2">&quot;d7d7ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;190&quot;</span><span class="p">,</span> <span class="s2">&quot;d7ff00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;191&quot;</span><span class="p">,</span> <span class="s2">&quot;d7ff5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;192&quot;</span><span class="p">,</span> <span class="s2">&quot;d7ff87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;193&quot;</span><span class="p">,</span> <span class="s2">&quot;d7ffaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;194&quot;</span><span class="p">,</span> <span class="s2">&quot;d7ffd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;195&quot;</span><span class="p">,</span> <span class="s2">&quot;d7ffff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;196&quot;</span><span class="p">,</span> <span class="s2">&quot;ff0000&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;197&quot;</span><span class="p">,</span> <span class="s2">&quot;ff005f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;198&quot;</span><span class="p">,</span> <span class="s2">&quot;ff0087&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;199&quot;</span><span class="p">,</span> <span class="s2">&quot;ff00af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;200&quot;</span><span class="p">,</span> <span class="s2">&quot;ff00d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;201&quot;</span><span class="p">,</span> <span class="s2">&quot;ff00ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;202&quot;</span><span class="p">,</span> <span class="s2">&quot;ff5f00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;203&quot;</span><span class="p">,</span> <span class="s2">&quot;ff5f5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;204&quot;</span><span class="p">,</span> <span class="s2">&quot;ff5f87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;205&quot;</span><span class="p">,</span> <span class="s2">&quot;ff5faf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;206&quot;</span><span class="p">,</span> <span class="s2">&quot;ff5fd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;207&quot;</span><span class="p">,</span> <span class="s2">&quot;ff5fff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;208&quot;</span><span class="p">,</span> <span class="s2">&quot;ff8700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;209&quot;</span><span class="p">,</span> <span class="s2">&quot;ff875f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;210&quot;</span><span class="p">,</span> <span class="s2">&quot;ff8787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;211&quot;</span><span class="p">,</span> <span class="s2">&quot;ff87af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;212&quot;</span><span class="p">,</span> <span class="s2">&quot;ff87d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;213&quot;</span><span class="p">,</span> <span class="s2">&quot;ff87ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;214&quot;</span><span class="p">,</span> <span class="s2">&quot;ffaf00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;215&quot;</span><span class="p">,</span> <span class="s2">&quot;ffaf5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;216&quot;</span><span class="p">,</span> <span class="s2">&quot;ffaf87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;217&quot;</span><span class="p">,</span> <span class="s2">&quot;ffafaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;218&quot;</span><span class="p">,</span> <span class="s2">&quot;ffafd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;219&quot;</span><span class="p">,</span> <span class="s2">&quot;ffafff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;220&quot;</span><span class="p">,</span> <span class="s2">&quot;ffd700&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;221&quot;</span><span class="p">,</span> <span class="s2">&quot;ffd75f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;222&quot;</span><span class="p">,</span> <span class="s2">&quot;ffd787&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;223&quot;</span><span class="p">,</span> <span class="s2">&quot;ffd7af&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;224&quot;</span><span class="p">,</span> <span class="s2">&quot;ffd7d7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;225&quot;</span><span class="p">,</span> <span class="s2">&quot;ffd7ff&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;226&quot;</span><span class="p">,</span> <span class="s2">&quot;ffff00&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;227&quot;</span><span class="p">,</span> <span class="s2">&quot;ffff5f&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;228&quot;</span><span class="p">,</span> <span class="s2">&quot;ffff87&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;229&quot;</span><span class="p">,</span> <span class="s2">&quot;ffffaf&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;230&quot;</span><span class="p">,</span> <span class="s2">&quot;ffffd7&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;231&quot;</span><span class="p">,</span> <span class="s2">&quot;ffffff&quot;</span><span class="p">),</span>
        <span class="c1"># Gray-scale range.</span>
        <span class="p">(</span><span class="s2">&quot;232&quot;</span><span class="p">,</span> <span class="s2">&quot;080808&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;233&quot;</span><span class="p">,</span> <span class="s2">&quot;121212&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;234&quot;</span><span class="p">,</span> <span class="s2">&quot;1c1c1c&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;235&quot;</span><span class="p">,</span> <span class="s2">&quot;262626&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;236&quot;</span><span class="p">,</span> <span class="s2">&quot;303030&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;237&quot;</span><span class="p">,</span> <span class="s2">&quot;3a3a3a&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;238&quot;</span><span class="p">,</span> <span class="s2">&quot;444444&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;239&quot;</span><span class="p">,</span> <span class="s2">&quot;4e4e4e&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;240&quot;</span><span class="p">,</span> <span class="s2">&quot;585858&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;241&quot;</span><span class="p">,</span> <span class="s2">&quot;626262&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;242&quot;</span><span class="p">,</span> <span class="s2">&quot;6c6c6c&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;243&quot;</span><span class="p">,</span> <span class="s2">&quot;767676&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;244&quot;</span><span class="p">,</span> <span class="s2">&quot;808080&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;245&quot;</span><span class="p">,</span> <span class="s2">&quot;8a8a8a&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;246&quot;</span><span class="p">,</span> <span class="s2">&quot;949494&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;247&quot;</span><span class="p">,</span> <span class="s2">&quot;9e9e9e&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;248&quot;</span><span class="p">,</span> <span class="s2">&quot;a8a8a8&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;249&quot;</span><span class="p">,</span> <span class="s2">&quot;b2b2b2&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;250&quot;</span><span class="p">,</span> <span class="s2">&quot;bcbcbc&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;251&quot;</span><span class="p">,</span> <span class="s2">&quot;c6c6c6&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;252&quot;</span><span class="p">,</span> <span class="s2">&quot;d0d0d0&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;253&quot;</span><span class="p">,</span> <span class="s2">&quot;dadada&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;254&quot;</span><span class="p">,</span> <span class="s2">&quot;e4e4e4&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;255&quot;</span><span class="p">,</span> <span class="s2">&quot;eeeeee&quot;</span><span class="p">),</span>
    <span class="p">]</span>


<span class="k">def</span> <span class="nf">_str2hex</span><span class="p">(</span><span class="n">hexstr</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">hexstr</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_strip_hash</span><span class="p">(</span><span class="n">rgb</span><span class="p">):</span>
    <span class="c1"># Strip leading `#` if exists.</span>
    <span class="k">if</span> <span class="n">rgb</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">rgb</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rgb</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">SHORT_TO_RGB</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">CLUT</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">RGB_TO_SHORT</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">SHORT_TO_RGB</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">short2rgb</span><span class="p">(</span><span class="n">short</span><span class="p">):</span>
    <span class="n">short</span> <span class="o">=</span> <span class="n">short</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">short</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">short</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
    <span class="k">return</span> <span class="n">SHORT_TO_RGB</span><span class="p">[</span><span class="n">short</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">rgb_to_256</span><span class="p">(</span><span class="n">rgb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the closest ANSI 256 approximation to the given RGB value.</span>

<span class="sd">        &gt;&gt;&gt; rgb2short(&#39;123456&#39;)</span>
<span class="sd">        (&#39;23&#39;, &#39;005f5f&#39;)</span>
<span class="sd">        &gt;&gt;&gt; rgb2short(&#39;ffffff&#39;)</span>
<span class="sd">        (&#39;231&#39;, &#39;ffffff&#39;)</span>
<span class="sd">        &gt;&gt;&gt; rgb2short(&#39;0DADD6&#39;) # vimeo logo</span>
<span class="sd">        (&#39;38&#39;, &#39;00afd7&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rgb : Hex code representing an RGB value, eg, &#39;abcdef&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple of String between 0 and 255 (compatible with xterm) and</span>
<span class="sd">    hex code (length-6).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">rgb</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;000000&quot;</span>
    <span class="n">incs</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">)</span>
    <span class="c1"># Break 6-char RGB code into 3 integer vals.</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">rgb_to_ints</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">incs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">incs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">incs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># smaller, bigger</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">part</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">part</span><span class="p">)</span>
                <span class="n">b1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">part</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s1</span> <span class="o">&lt;</span> <span class="n">b1</span><span class="p">:</span>
                    <span class="n">closest</span> <span class="o">=</span> <span class="n">s</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">closest</span> <span class="o">=</span> <span class="n">b</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">closest</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="s2">&quot;%02.x&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>
    <span class="n">equiv</span> <span class="o">=</span> <span class="n">RGB_TO_SHORT</span><span class="p">[</span><span class="n">res</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">equiv</span><span class="p">,</span> <span class="n">res</span>


<span class="n">rgb2short</span> <span class="o">=</span> <span class="n">rgb_to_256</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">RE_RGB3</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.)(.)(.)&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">RE_RGB6</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(..)(..)(..)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">rgb_to_ints</span><span class="p">(</span><span class="n">rgb</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">RE_RGB6</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rgb</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">RE_RGB3</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rgb</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]])</span>


<span class="k">def</span> <span class="nf">short_to_ints</span><span class="p">(</span><span class="n">short</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Coverts a short (256) color to a 3-tuple of ints.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rgb_to_ints</span><span class="p">(</span><span class="n">short2rgb</span><span class="p">(</span><span class="n">short</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">color_dist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_closest_color</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">palette</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span>
        <span class="nb">sorted</span><span class="p">(</span><span class="n">palette</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">color_dist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">palette</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">make_palette</span><span class="p">(</span><span class="n">strings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a color palette from a collection of strings.&quot;&quot;&quot;</span>
    <span class="n">palette</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">:</span>
        <span class="k">while</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">palette</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb_to_ints</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">palette</span>


<span class="k">def</span> <span class="nf">warn_deprecated_no_color</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Show a warning once if NO_COLOR was used instead of RESET.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_NO_COLOR_WARNING_SHOWN</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_NO_COLOR_WARNING_SHOWN</span><span class="p">:</span>
        <span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;NO_COLOR is deprecated and should be replaced with RESET.&quot;</span><span class="p">)</span>
        <span class="n">_NO_COLOR_WARNING_SHOWN</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#</span>
<span class="c1"># commands_cache</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Module for caching command &amp; alias names as well as for predicting whether</span>
<span class="sd">a command will be able to be run in the background.</span>

<span class="sd">A background predictor is a function that accepts a single argument list</span>
<span class="sd">and returns whether or not the process can be run in the background (returns</span>
<span class="sd">True) or must be run the foreground (returns False).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="n">pickle</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;pickle&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated threading</span>
<span class="c1"># amalgamated time</span>
<span class="n">argparse</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;argparse&#39;</span><span class="p">,</span> <span class="s1">&#39;argparse&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="c1"># amalgamated typing</span>
<span class="c1"># amalgamated from pathlib import Path</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="k">class</span> <span class="nc">CommandsCache</span><span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A lazy cache representing the commands available on the file system.</span>
<span class="sd">    The keys are the command names and the values a tuple of (loc, has_alias)</span>
<span class="sd">    where loc is either a str pointing to the executable on the file system or</span>
<span class="sd">    None (if no executable exists) and has_alias is a boolean flag for whether</span>
<span class="sd">    the command has an alias.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CACHE_FILE</span> <span class="o">=</span> <span class="s2">&quot;commands-cache.pickle&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_checksum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias_checksum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_mtime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threadable_predictors</span> <span class="o">=</span> <span class="n">default_threadable_predictors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_pickled</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Path to the cache-file where all commands/aliases are cached for pre-loading&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_DATA_DIR&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CACHE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
            <span class="k">if</span> <span class="s2">&quot;XONSH_DATA_DIR&quot;</span> <span class="ow">in</span> <span class="n">env</span> <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COMMANDS_CACHE_SAVE_INTERMEDIATE&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_commands</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazyin</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_commands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># All command keys are stored in uppercase on Windows.</span>
                <span class="c1"># This ensures the original command name is returned.</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">pathbasename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_commands</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_commands</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazyget</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether the cache is populated or not.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_possible_names</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates the possible `PATHEXT` extension variants of a given executable</span>
<span class="sd">        name on Windows as a list, conserving the ordering in `PATHEXT`.</span>
<span class="sd">        Returns a list as `name` being the only item in it on other platforms.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="n">pathext</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATHEXT&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="n">ext</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pathext</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_dups</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cont</span><span class="p">:</span>
                <span class="n">cont</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_update_if_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">aliases</span><span class="p">):</span>
        <span class="c1"># did PATH change?</span>
        <span class="n">path_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">path_hash</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_checksum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_checksum</span> <span class="o">=</span> <span class="n">path_hash</span>

        <span class="c1"># did aliases change?</span>
        <span class="n">al_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">aliases</span><span class="p">))</span>
        <span class="k">yield</span> <span class="n">al_hash</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alias_checksum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alias_checksum</span> <span class="o">=</span> <span class="n">al_hash</span>

        <span class="c1"># did the contents of any directory in PATH change?</span>
        <span class="n">max_mtime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">paths</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">max_mtime</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_mtime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_mtime</span> <span class="o">=</span> <span class="n">max_mtime</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_immut</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">CommandsCache</span><span class="o">.</span><span class="n">remove_dups</span><span class="p">(</span><span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="p">[])))</span>
        <span class="n">alss</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">XSH</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="p">(</span>
            <span class="n">has_path_changed</span><span class="p">,</span>
            <span class="n">has_alias_changed</span><span class="p">,</span>
            <span class="n">has_any_path_updated</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_if_changed</span><span class="p">(</span><span class="n">path_immut</span><span class="p">,</span> <span class="n">alss</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">has_path_changed</span> <span class="ow">and</span> <span class="n">has_any_path_updated</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_alias_changed</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">alss</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="k">else</span> <span class="n">cmd</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">alias</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="c1"># save the changes to cache as well</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_cmds_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># pickle the result only if XONSH_DATA_DIR is set</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_pickled</span><span class="p">:</span>
                <span class="c1"># first time load the commands from cache-file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_commands</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_pickled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># also start a thread that updates the cache in the bg</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_cmds_cache</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">path_immut</span><span class="p">,</span> <span class="n">alss</span><span class="p">],</span>
                <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_cmds_cache</span><span class="p">(</span><span class="n">path_immut</span><span class="p">,</span> <span class="n">alss</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span>

    <span class="k">def</span> <span class="nf">_update_cmds_cache</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">aliases</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Update the cmds_cache variable in background without slowing down parseLexer&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>  <span class="c1"># type: ignore</span>

        <span class="n">allcmds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="c1"># iterate backwards so that entries at the front of PATH overwrite</span>
            <span class="c1"># entries at the back.</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">executables_in</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="k">else</span> <span class="n">cmd</span>
                <span class="n">allcmds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cmd</span><span class="p">),</span> <span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">warn_cnt</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COMMANDS_CACHE_SIZE_WARNING&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warn_cnt</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">allcmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">warn_cnt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning! Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">allcmds</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> executable files in the PATH directories!&quot;</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allcmds</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="k">else</span> <span class="n">cmd</span>
                <span class="n">allcmds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cmds_cache</span><span class="p">(</span><span class="n">allcmds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_cached_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">())</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># the file is corrupt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">set_cmds_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allcmds</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;write cmds to cache-file and instance-attribute&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">allcmds</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span> <span class="o">=</span> <span class="n">allcmds</span>
        <span class="k">return</span> <span class="n">allcmds</span>

    <span class="k">def</span> <span class="nf">cached_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the name that would appear in the cache, if it exists.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="n">pathbasename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_possible_names</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cached</span>

    <span class="k">def</span> <span class="nf">lazyin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if the value is in the current cache without the potential to</span>
<span class="sd">        update the cache. It just says whether the value is known *now*. This</span>
<span class="sd">        may not reflect precisely what is on the $PATH.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_name</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span>

    <span class="k">def</span> <span class="nf">lazyiter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an iterator over the current cache contents without the</span>
<span class="sd">        potential to update the cache. This may not reflect what is on the</span>
<span class="sd">        $PATH.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lazylen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the length of the current cache contents without the</span>
<span class="sd">        potential to update the cache. This may not reflect precisely</span>
<span class="sd">        what is on the $PATH.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lazyget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A lazy value getter.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cached_name</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">locate_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ignore_alias</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Locates an executable on the file system using the cache.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            name of binary to search for</span>
<span class="sd">        ignore_alias : bool, optional</span>
<span class="sd">            Force return of binary path even if alias of ``name`` exists</span>
<span class="sd">            (default ``False``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make sure the cache is up to date by accessing the property</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_commands</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_locate_binary</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ignore_alias</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lazy_locate_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ignore_alias</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Locates an executable in the cache, without checking its validity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            name of binary to search for</span>
<span class="sd">        ignore_alias : bool, optional</span>
<span class="sd">            Force return of binary path even if alias of ``name`` exists</span>
<span class="sd">            (default ``False``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">possibilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_possible_names</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="c1"># Windows users expect to be able to execute files in the same</span>
            <span class="c1"># directory without `./`</span>
            <span class="n">local_bin</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">fn</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">possibilities</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fn</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">local_bin</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">local_bin</span><span class="p">)</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">cmd</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">possibilities</span> <span class="k">if</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
            <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="p">[</span><span class="n">cached</span><span class="p">]</span>
            <span class="n">ispure</span> <span class="o">=</span> <span class="n">path</span> <span class="o">==</span> <span class="n">pathbasename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="ow">and</span> <span class="n">ignore_alias</span> <span class="ow">and</span> <span class="n">ispure</span><span class="p">:</span>
                <span class="c1"># pure alias, which we are ignoring</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">pathbasename</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">is_only_functional_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether or not a command is only a functional alias, and has</span>
<span class="sd">        no underlying executable. For example, the &quot;cd&quot; command is only available</span>
<span class="sd">        as a functional alias.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_commands</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_is_only_functional_alias</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lazy_is_only_functional_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether or not a command is only a functional alias, and has</span>
<span class="sd">        no underlying executable. For example, the &quot;cd&quot; command is only available</span>
<span class="sd">        as a functional alias. This search is performed lazily.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmds_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">val</span> <span class="o">==</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">locate_binary</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ignore_alias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict_threadable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predicts whether a command list is able to be run on a background</span>
<span class="sd">        thread, rather than the main thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_predictor_threadable</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">predictor</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">get_predictor_threadable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the predictor whether a command list is able to be run on a</span>
<span class="sd">        background thread, rather than the main thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_name</span><span class="p">(</span><span class="n">cmd0</span><span class="p">)</span>
        <span class="n">predictors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threadable_predictors</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="c1"># On all names (keys) are stored in upper case so instead</span>
            <span class="c1"># we get the original cmd or alias name</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazyget</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">predict_true</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">pathbasename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">predictors</span><span class="p">:</span>
                <span class="n">pre</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pre</span> <span class="ow">in</span> <span class="n">predictors</span><span class="p">:</span>
                    <span class="n">predictors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictors</span><span class="p">[</span><span class="n">pre</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">predictors</span><span class="p">:</span>
            <span class="n">predictors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_predictor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd0</span><span class="p">)</span>
        <span class="n">predictor</span> <span class="o">=</span> <span class="n">predictors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">predictor</span>

    <span class="c1">#</span>
    <span class="c1"># Background Predictors (as methods)</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">default_predictor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cmd0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default predictor, using predictor from original command if the</span>
<span class="sd">        command is an alias, elseif build a predictor based on binary analysis</span>
<span class="sd">        on POSIX, else return predict_true.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># alias stuff</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">cmd0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd0</span><span class="p">:</span>
            <span class="n">alss</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">XSH</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">cmd0</span> <span class="ow">in</span> <span class="n">alss</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_predictor_alias</span><span class="p">(</span><span class="n">cmd0</span><span class="p">)</span>

        <span class="c1"># other default stuff</span>
        <span class="k">if</span> <span class="n">ON_POSIX</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_predictor_readbin</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">cmd0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">failure</span><span class="o">=</span><span class="n">predict_true</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predict_true</span>

    <span class="k">def</span> <span class="nf">default_predictor_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd0</span><span class="p">):</span>
        <span class="n">alias_recursion_limit</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">10</span>  <span class="c1"># this limit is se to handle infinite loops in aliases definition</span>
        <span class="p">)</span>
        <span class="n">first_args</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># contains in reverse order args passed to the aliased command</span>
        <span class="n">alss</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">XSH</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="k">while</span> <span class="n">cmd0</span> <span class="ow">in</span> <span class="n">alss</span><span class="p">:</span>
            <span class="n">alias_name</span> <span class="o">=</span> <span class="n">alss</span><span class="p">[</span><span class="n">cmd0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alias_name</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">alias_name</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">predict_true</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">alias_name</span><span class="p">[:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">first_args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd0</span> <span class="o">==</span> <span class="n">alias_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># it is a self-alias stop recursion immediatly</span>
                <span class="k">return</span> <span class="n">predict_true</span>
            <span class="n">cmd0</span> <span class="o">=</span> <span class="n">alias_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">alias_recursion_limit</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">alias_recursion_limit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">predict_true</span>
        <span class="n">predictor_cmd0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_predictor_threadable</span><span class="p">(</span><span class="n">cmd0</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">cmd1</span><span class="p">:</span> <span class="n">predictor_cmd0</span><span class="p">(</span><span class="n">first_args</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmd1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">default_predictor_readbin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cmd0</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">failure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a default predictor by</span>
<span class="sd">        analyzing the content of the binary. Should only works on POSIX.</span>
<span class="sd">        Return failure if the analysis fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">cmd0</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">cmd0</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">cmd0</span> <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">cmd0</span> <span class="k">else</span> <span class="n">fname</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_locate_binary</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname</span>

        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">failure</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">failure</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">failure</span>  <span class="c1"># opening error</span>

        <span class="n">search_for</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;ncurses&quot;</span><span class="p">,):</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span>
            <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;libgpm&quot;</span><span class="p">,):</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span>
            <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;isatty&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;tcgetattr&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;tcsetattr&quot;</span><span class="p">):</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">block</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tstart</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">previous_block</span> <span class="o">=</span> <span class="n">block</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">block</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># should not occur, except e.g. if a file is deleted a a dir is</span>
                <span class="c1"># created with the same name between os.path.isfile and os.open</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">failure</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">predict_true</span>  <span class="c1"># no keys of search_for found</span>
            <span class="n">analyzed_block</span> <span class="o">=</span> <span class="n">previous_block</span> <span class="o">+</span> <span class="n">block</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">search_for</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">analyzed_block</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">predict_false</span>  <span class="c1"># use one key of search_for</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">failure</span>  <span class="c1"># timeout</span>


<span class="c1">#</span>
<span class="c1"># Background Predictors</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">predict_true</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Always say the process is threadable.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">predict_false</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Never say the process is threadable.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">SHELL_PREDICTOR_PARSER</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">predict_shell</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predict the backgroundability of the normal shell interface, which</span>
<span class="sd">    comes down to whether it is being run in subproc mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ns</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SHELL_PREDICTOR_PARSER</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ns</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">pred</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">HELP_VER_PREDICTOR_PARSER</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;-V&quot;</span><span class="p">,</span> <span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">predict_help_ver</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predict the backgroundability of commands that have help &amp; version</span>
<span class="sd">    switches: -h, --help, -v, -V, --version. If either of these options is</span>
<span class="sd">    present, the command is assumed to print to stdout normally and is therefore</span>
<span class="sd">    threadable. Otherwise, the command is assumed to not be threadable.</span>
<span class="sd">    This is useful for commands, like top, that normally enter alternate mode</span>
<span class="sd">    but may not in certain circumstances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ns</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">HELP_VER_PREDICTOR_PARSER</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">help</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ns</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">pred</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">HG_PREDICTOR_PARSER</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s2">&quot;hg&quot;</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--interactive&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;interactive&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">predict_hg</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predict if mercurial is about to be run in interactive mode.</span>
<span class="sd">    If it is interactive, predict False. If it isn&#39;t, predict True.</span>
<span class="sd">    Also predict False for certain commands, such as split.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ns</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">HG_PREDICTOR_PARSER</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;split&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">ns</span><span class="o">.</span><span class="n">interactive</span>


<span class="k">def</span> <span class="nf">predict_env</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predict if env is launching a threadable command or not.</span>
<span class="sd">    The launched command is extracted from env args, and the predictor of</span>
<span class="sd">    lauched command is used.&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="s2">&quot;=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="c1"># args[i] is the command and the following is its arguments</span>
            <span class="c1"># so args[i:] is used to predict if the command is threadable</span>
            <span class="k">return</span> <span class="n">XSH</span><span class="o">.</span><span class="n">commands_cache</span><span class="o">.</span><span class="n">predict_threadable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">default_threadable_predictors</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Generates a new defaultdict for known threadable predictors.</span>
<span class="sd">    The default is to predict true.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># alphabetical, for what it is worth.</span>
    <span class="n">predictors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;asciinema&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;aurman&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;awk&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;cat&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;clear&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;cryptop&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;cryptsetup&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;csh&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;curl&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;elvish&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;emacsclient&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="n">predict_env</span><span class="p">,</span>
        <span class="s2">&quot;ex&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;fish&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;gawk&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;ghci&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;git&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;gvim&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;hg&quot;</span><span class="p">:</span> <span class="n">predict_hg</span><span class="p">,</span>
        <span class="s2">&quot;htop&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;ipython&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;julia&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;ksh&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;less&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;man&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;mc&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;more&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;mutt&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;mvim&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;nano&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;nmcli&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;nvim&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;percol&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;ponysay&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;psql&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;push&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;pv&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;python&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;python2&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;python3&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;ranger&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;repo&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;rview&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;rvim&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;rwt&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;scp&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;sh&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;ssh&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;startx&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;sudo&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;sudoedit&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;systemctl&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;tcsh&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;telnet&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;tput&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;udisksctl&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;unzip&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;vi&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;view&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;vim&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;vimpager&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;weechat&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;wget&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;xclip&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;xdg-open&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;xo&quot;</span><span class="p">:</span> <span class="n">predict_help_ver</span><span class="p">,</span>
        <span class="s2">&quot;xon.sh&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;xonsh&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
        <span class="s2">&quot;yes&quot;</span><span class="p">:</span> <span class="n">predict_false</span><span class="p">,</span>
        <span class="s2">&quot;zip&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;zipinfo&quot;</span><span class="p">:</span> <span class="n">predict_true</span><span class="p">,</span>
        <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="n">predict_shell</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">predictors</span>

<span class="c1">#</span>
<span class="c1"># completer</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;A (tab-)completer for xonsh.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated typing</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="kn">from</span> <span class="nn">xonsh.completers.tools</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">is_contextual_completer</span><span class="p">,</span>
    <span class="n">Completion</span><span class="p">,</span>
    <span class="n">RichCompletion</span><span class="p">,</span>
    <span class="n">apply_lprefix</span><span class="p">,</span>
    <span class="n">is_exclusive_completer</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="kn">from</span> <span class="nn">xonsh.parsers.completion_context</span> <span class="kn">import</span> <span class="n">CompletionContext</span><span class="p">,</span> <span class="n">CompletionContextParser</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="k">class</span> <span class="nc">Completer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This provides a list of optional completions for the xonsh shell.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_parser</span> <span class="o">=</span> <span class="n">CompletionContextParser</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">,</span>
        <span class="n">line</span><span class="p">,</span>
        <span class="n">begidx</span><span class="p">,</span>
        <span class="n">endidx</span><span class="p">,</span>
        <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">multiline_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cursor_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Complete the string, given a possible execution context.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefix : str</span>
<span class="sd">            The string to match</span>
<span class="sd">        line : str</span>
<span class="sd">            The line that prefix appears on.</span>
<span class="sd">        begidx : int</span>
<span class="sd">            The index in line that prefix starts on.</span>
<span class="sd">        endidx : int</span>
<span class="sd">            The index in line that prefix ends on.</span>
<span class="sd">        ctx : dict, optional</span>
<span class="sd">            Names in the current execution context.</span>
<span class="sd">        multiline_text : str</span>
<span class="sd">            The complete multiline text. Needed to get completion context.</span>
<span class="sd">        cursor_index : int</span>
<span class="sd">            The current cursor&#39;s index in the multiline text.</span>
<span class="sd">            May be ``len(multiline_text)`` for cursor at the end.</span>
<span class="sd">            Needed to get completion context.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rtn : list of str</span>
<span class="sd">            Possible completions of prefix, sorted alphabetically.</span>
<span class="sd">        lprefix : int</span>
<span class="sd">            Length of the prefix to be replaced in the completion.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">multiline_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cursor_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">completion_context</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span>
                <span class="n">CompletionContext</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                <span class="n">multiline_text</span><span class="p">,</span>
                <span class="n">cursor_index</span><span class="p">,</span>
                <span class="n">ctx</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">completion_context</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_from_context</span><span class="p">(</span>
            <span class="n">completion_context</span><span class="p">,</span>
            <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">begidx</span><span class="p">,</span> <span class="n">endidx</span><span class="p">,</span> <span class="n">ctx</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_format_completion</span><span class="p">(</span>
        <span class="n">completion</span><span class="p">,</span>
        <span class="n">completion_context</span><span class="p">,</span>
        <span class="n">completing_contextual_command</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">lprefix</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">custom_lprefix</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Completion</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">completing_contextual_command</span>
            <span class="ow">and</span> <span class="n">completion_context</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">is_after_closing_quote</span>
        <span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The cursor is appending to a closed string literal, i.e. cursor at the end of ``ls &quot;/usr/&quot;``.</span>
<span class="sd">            1. The closing quote will be appended to all completions.</span>
<span class="sd">                I.e the completion ``/usr/bin`` will turn into ``/usr/bin&quot;``</span>
<span class="sd">                To prevent this behavior, a completer can return a ``RichCompletion`` with ``append_closing_quote=False``.</span>
<span class="sd">            2. If not specified, lprefix will cover the closing prefix.</span>
<span class="sd">                I.e for ``ls &quot;/usr/&quot;``, the default lprefix will be 6 to include the closing quote.</span>
<span class="sd">                To prevent this behavior, a completer can return a different lprefix or specify it inside ``RichCompletion``.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">closing_quote</span> <span class="o">=</span> <span class="n">completion_context</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">closing_quote</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_lprefix</span><span class="p">:</span>
                <span class="n">lprefix</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">closing_quote</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">closing_quote</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">completion</span><span class="p">,</span> <span class="n">RichCompletion</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">completion</span><span class="o">.</span><span class="n">append_closing_quote</span><span class="p">:</span>
                        <span class="n">completion</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">completion</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">closing_quote</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">completion</span> <span class="o">=</span> <span class="n">completion</span> <span class="o">+</span> <span class="n">closing_quote</span>

        <span class="n">completion</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">apply_lprefix</span><span class="p">([</span><span class="n">completion</span><span class="p">],</span> <span class="n">lprefix</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">completion</span><span class="p">,</span> <span class="n">RichCompletion</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">completion</span><span class="o">.</span><span class="n">append_space</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">completion</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># append spaces AFTER appending closing quote</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">completion</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">completion</span><span class="p">,</span> <span class="n">lprefix</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_completions</span><span class="p">(</span>
        <span class="n">completion_context</span><span class="p">,</span> <span class="n">old_completer_args</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Completion</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">XSH</span><span class="o">.</span><span class="n">completers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_contextual_completer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">completion_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">completion_context</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">old_completer_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">old_completer_args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="c1"># completer requested to stop collecting completions</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">print_exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Completer </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> raises exception when gets &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;old_args=</span><span class="si">{</span><span class="n">old_completer_args</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> / completion_context=</span><span class="si">{</span><span class="n">completion_context</span><span class="si">!r}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">completing_contextual_command</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">is_contextual_completer</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">completion_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">completion_context</span><span class="o">.</span><span class="n">command</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
                <span class="n">res</span><span class="p">,</span> <span class="n">lprefix</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">custom_lprefix</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">custom_lprefix</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">completing_contextual_command</span><span class="p">:</span>
                    <span class="n">lprefix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">completion_context</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">old_completer_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lprefix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_completer_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lprefix</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">Completer</span><span class="o">.</span><span class="n">_format_completion</span><span class="p">(</span>
                    <span class="n">comp</span><span class="p">,</span>
                    <span class="n">completion_context</span><span class="p">,</span>
                    <span class="n">completing_contextual_command</span><span class="p">,</span>
                    <span class="n">lprefix</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">custom_lprefix</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>  <span class="c1"># empty completion</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;TRACE COMPLETIONS: Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2"> results&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; from </span><span class="si">{</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">is_exclusive_completer</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;non-&#39;</span><span class="si">}</span><span class="s2">exclusive completer &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;:&quot;</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">displayhook</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_exclusive_completer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                <span class="c1"># we got completions for an exclusive completer</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">complete_from_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completion_context</span><span class="p">,</span> <span class="n">old_completer_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_TRACE_COMPLETIONS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TRACE COMPLETIONS: Getting completions with context:&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">displayhook</span><span class="p">(</span><span class="n">completion_context</span><span class="p">)</span>
        <span class="n">lprefix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">completions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">query_limit</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COMPLETION_QUERY_LIMIT&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_completions</span><span class="p">(</span>
            <span class="n">completion_context</span><span class="p">,</span>
            <span class="n">old_completer_args</span><span class="p">,</span>
            <span class="n">trace</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">completion</span><span class="p">,</span> <span class="n">lprefix</span> <span class="o">=</span> <span class="n">comp</span>
            <span class="n">completions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">query_limit</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">completions</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">query_limit</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;TRACE COMPLETIONS: Stopped after $COMPLETION_QUERY_LIMIT reached.&quot;</span>
                    <span class="p">)</span>
                <span class="k">break</span>

        <span class="k">def</span> <span class="nf">sortkey</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;&#39;&quot;&#39;&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># the last completer&#39;s lprefix is returned. other lprefix values are inside the RichCompletions.</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sortkey</span><span class="p">)),</span> <span class="n">lprefix</span>

<span class="c1">#</span>
<span class="c1"># events</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Events for xonsh.</span>

<span class="sd">In all likelihood, you want xonsh.built_ins.XSH.events</span>

<span class="sd">The best way to &quot;declare&quot; an event is something like::</span>

<span class="sd">    events.doc(&#39;on_spam&#39;, &quot;Comes with eggs&quot;)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">abc</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">)</span>
<span class="n">collections</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;collections&#39;</span><span class="p">,</span> <span class="s1">&#39;collections.abc&#39;</span><span class="p">)</span>
<span class="n">inspect</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;inspect&#39;</span><span class="p">,</span> <span class="s1">&#39;inspect&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="k">def</span> <span class="nf">has_kwargs</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_KEYWORD</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">debug_level</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_DEBUG&quot;</span><span class="p">)</span>
    <span class="c1"># FIXME: Under py.test, return 1(?)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Optimize for speed, not guaranteed correctness</span>


<span class="k">class</span> <span class="nc">AbstractEvent</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableSet</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A given event that handlers can register against.</span>

<span class="sd">    Acts as a ``MutableSet`` for registered handlers.</span>

<span class="sd">    Note that ordering is never guaranteed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The species (basically, class) of the event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span>
            <span class="mi">0</span>
        <span class="p">]</span>  <span class="c1"># events.on_chdir -&gt; &lt;class on_chdir&gt; -&gt; &lt;class Event&gt;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a handler. It&#39;s suggested to use this as a decorator.</span>

<span class="sd">        A decorator method is added to the handler, validator(). If a validator</span>
<span class="sd">        function is added, it can filter if the handler will be considered. The</span>
<span class="sd">        validator takes the same arguments as the handler. If it returns False,</span>
<span class="sd">        the handler will not called or considered, as if it was not registered</span>
<span class="sd">        at all.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        handler : callable</span>
<span class="sd">            The handler to register</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rtn : callable</span>
<span class="sd">            The handler</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#  Using Python&#39;s &quot;private&quot; munging to minimize hypothetical collisions</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">__validator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">debug_level</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_kwargs</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Event handlers need a **kwargs for future proofing&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">validator</span><span class="p">(</span><span class="n">vfunc</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Adds a validator function to a handler to limit when it is considered.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">debug_level</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_kwargs</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Event validators need a **kwargs for future proofing&quot;</span>
                    <span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">__validator</span> <span class="o">=</span> <span class="n">vfunc</span>

        <span class="n">handler</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">validator</span>

        <span class="k">return</span> <span class="n">handler</span>

    <span class="k">def</span> <span class="nf">_filterhandlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method for implementing classes. Generates the handlers that pass validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">__validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">handler</span><span class="o">.</span><span class="n">__validator</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">handler</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">fire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fires an event, calling registered handlers with the given arguments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Keyword arguments to pass to each handler</span>
<span class="sd">        &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">AbstractEvent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An event species for notify and scatter-gather events.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Wish I could just pull from set...</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_firing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_adds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_discards</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an element to a set.</span>

<span class="sd">        This has no effect if the element is already present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_firing</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_adds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_adds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_adds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove an element from a set if it is a member.</span>

<span class="sd">        If the element is not a member, do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_firing</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_discards</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_discards</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_discards</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fires an event, calling registered handlers with the given arguments. A non-unique iterable</span>
<span class="sd">        of the results is returned.</span>

<span class="sd">        Each handler is called immediately. Exceptions are turned in to warnings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Keyword arguments to pass to each handler</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vals : iterable</span>
<span class="sd">            Return values of each handler. If multiple handlers return the same value, it will</span>
<span class="sd">            appear multiple times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_firing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filterhandlers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">print_exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in event handler; ignored.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="c1"># clean up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_firing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_adds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayed_adds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_adds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_discards</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayed_discards</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_discards</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">vals</span>


<span class="k">class</span> <span class="nc">LoadEvent</span><span class="p">(</span><span class="n">AbstractEvent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An event species where each handler is called exactly once, shortly after either the event is</span>
<span class="sd">    fired or the handler is registered (whichever is later). Additional firings are ignored.</span>

<span class="sd">    Note: Does not support scatter/gather, due to never knowing when we have all the handlers.</span>

<span class="sd">    Note: Maintains a strong reference to pargs/kwargs in case of the addition of future handlers.</span>

<span class="sd">    Note: This is currently NOT thread safe.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fired</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unfired</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hasfired</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fired</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unfired</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fired</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unfired</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fired</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unfired</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an element to a set.</span>

<span class="sd">        This has no effect if the element is already present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasfired</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fired</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unfired</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove an element from a set if it is a member.</span>

<span class="sd">        If the element is not a member, do nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fired</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unfired</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">print_exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in event handler; ignored.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasfired</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unfired</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unfired</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hasfired</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">()</span>  <span class="c1"># Entirely for API compatibility</span>


<span class="k">class</span> <span class="nc">EventManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for all events in a system.</span>

<span class="sd">    Meant to be a singleton, but doesn&#39;t enforce that itself.</span>

<span class="sd">    Each event is just an attribute. They&#39;re created dynamically on first use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">docstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a docstring to an event.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the event, eg &quot;on_precommand&quot;</span>
<span class="sd">        docstring : str</span>
<span class="sd">            The docstring to apply to the event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">docstring</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_mkevent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">Event</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># NOTE: Also used in `xonsh_events` test fixture</span>
        <span class="c1"># (A little bit of magic to enable docstrings to work right)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="p">(</span><span class="n">species</span><span class="p">,),</span>
            <span class="p">{</span>
                <span class="s2">&quot;__doc__&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                <span class="s2">&quot;__module__&quot;</span><span class="p">:</span> <span class="s2">&quot;xonsh.events&quot;</span><span class="p">,</span>
                <span class="s2">&quot;__qualname__&quot;</span><span class="p">:</span> <span class="s2">&quot;events.&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)()</span>

    <span class="k">def</span> <span class="nf">transmogrify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts an event from one species to another, preserving handlers and docstring.</span>

<span class="sd">        Please note: Some species maintain specialized state. This is lost on transmogrification.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the event, eg &quot;on_precommand&quot;</span>
<span class="sd">        species : subclass of AbstractEvent</span>
<span class="sd">            The type to turn the event in to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">species</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">species</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">AbstractEvent</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid event class; must be a subclass of AbstractEvent&quot;</span><span class="p">)</span>

        <span class="n">oldevent</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">newevent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mkevent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">oldevent</span><span class="p">)</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">newevent</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">oldevent</span><span class="p">:</span>
            <span class="n">newevent</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if an event with a given name exist. If it does not exist, it</span>
<span class="sd">        will not be created. That is what makes this different than</span>
<span class="sd">        ``hasattr(events, name)``, which will create the event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an event, if it doesn&#39;t already exist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>
        <span class="c1"># This is only called if the attribute doesn&#39;t exist, so create the Event...</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mkevent</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># ... and save it.</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="c1"># Now it exists, and we won&#39;t be called again.</span>
        <span class="k">return</span> <span class="n">e</span>


<span class="c1"># Not lazy because:</span>
<span class="c1"># 1. Initialization of EventManager can&#39;t be much cheaper</span>
<span class="c1"># 2. It&#39;s expected to be used at load time, negating any benefits of using lazy object</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">EventManager</span><span class="p">()</span>

<span class="c1">#</span>
<span class="c1"># foreign_shells</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Tools to help interface with foreign shells, such as Bash.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated re</span>
<span class="n">json</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated shlex</span>
<span class="c1"># amalgamated sys</span>
<span class="n">tempfile</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;tempfile&#39;</span><span class="p">,</span> <span class="s1">&#39;tempfile&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated subprocess</span>
<span class="c1"># amalgamated warnings</span>
<span class="c1"># amalgamated functools</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="n">COMMAND</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">{seterrprevcmd}</span><span class="s2"></span>
<span class="si">{prevcmd}</span><span class="s2"></span>
<span class="s2">echo __XONSH_ENV_BEG__</span>
<span class="si">{envcmd}</span><span class="s2"></span>
<span class="s2">echo __XONSH_ENV_END__</span>
<span class="s2">echo __XONSH_ALIAS_BEG__</span>
<span class="si">{aliascmd}</span><span class="s2"></span>
<span class="s2">echo __XONSH_ALIAS_END__</span>
<span class="s2">echo __XONSH_FUNCS_BEG__</span>
<span class="si">{funcscmd}</span><span class="s2"></span>
<span class="s2">echo __XONSH_FUNCS_END__</span>
<span class="si">{postcmd}</span><span class="s2"></span>
<span class="si">{seterrpostcmd}</span><span class="s2">&quot;&quot;&quot;</span>

<span class="n">DEFAULT_BASH_FUNCSCMD</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;# get function names from declare</span>
<span class="s2">declstr=$(echo $(declare -F))</span>
<span class="s2">read -r -a decls &lt;&lt;&lt; $declstr</span>
<span class="s2">funcnames=&quot;&quot;</span>
<span class="s2">for((n=0;n&lt;${#decls[@]};n++)); do</span>
<span class="s2">  if (( $(($n % 3 )) == 2 )); then</span>
<span class="s2">    # get every 3rd entry</span>
<span class="s2">    funcnames=&quot;$funcnames $</span><span class="si">{decls[$n]}</span><span class="s2">&quot;</span>
<span class="s2">  fi</span>
<span class="s2">done</span>

<span class="s2"># get functions locations: funcname lineno filename</span>
<span class="s2">shopt -s extdebug</span>
<span class="s2">namelocfilestr=$(declare -F $funcnames)</span>
<span class="s2">shopt -u extdebug</span>

<span class="s2"># print just names and files as JSON object</span>
<span class="s2">read -r -a namelocfile &lt;&lt;&lt; $namelocfilestr</span>
<span class="s2">sep=&quot; &quot;</span>
<span class="s2">namefile=&quot;{&quot;</span>
<span class="s2">while IFS=&#39;&#39; read -r line || [[ -n &quot;$line&quot; ]]; do</span>
<span class="s2">  name=${line</span><span class="si">%%</span><span class="s2">&quot;$sep&quot;*}</span>
<span class="s2">  locfile=${line#*&quot;$sep&quot;}</span>
<span class="s2">  loc=${locfile</span><span class="si">%%</span><span class="s2">&quot;$sep&quot;*}</span>
<span class="s2">  file=${locfile#*&quot;$sep&quot;}</span>
<span class="s2">  namefile=&quot;$</span><span class="si">{namefile}</span><span class="s2">\&quot;$</span><span class="si">{name}</span><span class="s2">\&quot;:\&quot;${file//\\/\\\\}\&quot;,&quot;</span>
<span class="s2">done &lt;&lt;&lt; &quot;$namelocfilestr&quot;</span>
<span class="s2">if [[ &quot;{&quot; == &quot;$</span><span class="si">{namefile}</span><span class="s2">&quot; ]]; then</span>
<span class="s2">  namefile=&quot;$</span><span class="si">{namefile}</span><span class="s2">}&quot;</span>
<span class="s2">else</span>
<span class="s2">  namefile=&quot;${namefile%?}}&quot;</span>
<span class="s2">fi</span>
<span class="s2">echo $namefile&quot;&quot;&quot;</span>

<span class="n">DEFAULT_ZSH_FUNCSCMD</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# get function names</span>
<span class="s2">autoload -U is-at-least  # We&#39;ll need to version check zsh</span>
<span class="s2">namefile=&quot;{&quot;</span>
<span class="s2">for name in ${(ok)functions}; do</span>
<span class="s2">  # force zsh to load the func in order to get the filename,</span>
<span class="s2">  # but use +X so that it isn&#39;t executed.</span>
<span class="s2">  autoload +X $name || continue</span>
<span class="s2">  loc=$(whence -v $name)</span>
<span class="s2">  loc=${(z)loc}</span>
<span class="s2">  if is-at-least 5.2; then</span>
<span class="s2">    file=$</span><span class="si">{loc[-1]}</span><span class="s2"></span>
<span class="s2">  else</span>
<span class="s2">    file=$</span><span class="si">{loc[7,-1]}</span><span class="s2"></span>
<span class="s2">  fi</span>
<span class="s2">  namefile=&quot;$</span><span class="si">{namefile}</span><span class="se">\\</span><span class="s2">&quot;$</span><span class="si">{name}</span><span class="se">\\</span><span class="s2">&quot;:</span><span class="se">\\</span><span class="s2">&quot;${(Q)file:A}</span><span class="se">\\</span><span class="s2">&quot;,&quot;</span>
<span class="s2">done</span>
<span class="s2">if [[ &quot;{&quot; == &quot;$</span><span class="si">{namefile}</span><span class="s2">&quot; ]]; then</span>
<span class="s2">  namefile=&quot;$</span><span class="si">{namefile}</span><span class="s2">}&quot;</span>
<span class="s2">else</span>
<span class="s2">  namefile=&quot;${namefile%?}}&quot;</span>
<span class="s2">fi</span>
<span class="s2">echo $</span><span class="si">{namefile}</span><span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># mapping of shell name aliases to keys in other lookup dictionaries.</span>
<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">CANON_SHELL_NAMES</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;bash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/bin/bash&quot;</span><span class="p">:</span> <span class="s2">&quot;bash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;zsh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/bin/zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;zsh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/usr/bin/zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;zsh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;cmd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cmd.exe&quot;</span><span class="p">:</span> <span class="s2">&quot;cmd&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_ENVCMDS</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;set&quot;</span><span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_ALIASCMDS</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;alias&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;alias -L&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_FUNCSCMDS</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="n">DEFAULT_BASH_FUNCSCMD</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="n">DEFAULT_ZSH_FUNCSCMD</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_SOURCERS</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;call&quot;</span><span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_TMPFILE_EXT</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;.sh&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;.zsh&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;.bat&quot;</span><span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_RUNCMD</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;/C&quot;</span><span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_SETERRPREVCMD</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;set -e&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;set -e&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;@echo off&quot;</span><span class="p">}</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_SETERRPOSTCMD</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bash&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;if errorlevel 1 exit 1&quot;</span><span class="p">}</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">foreign_shell_data</span><span class="p">(</span>
    <span class="n">shell</span><span class="p">,</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">login</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">envcmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">aliascmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_args</span><span class="o">=</span><span class="p">(),</span>
    <span class="n">currenv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">prevcmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">postcmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">funcscmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sourcer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_tmpfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">tmpfile_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">runcmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">seterrprevcmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">seterrpostcmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extracts data from a foreign (non-xonsh) shells. Currently this gets</span>
<span class="sd">    the environment, aliases, and functions but may be extended in the future.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shell : str</span>
<span class="sd">        The name of the shell, such as &#39;bash&#39; or &#39;/bin/sh&#39;.</span>
<span class="sd">    interactive : bool, optional</span>
<span class="sd">        Whether the shell should be run in interactive mode.</span>
<span class="sd">    login : bool, optional</span>
<span class="sd">        Whether the shell should be a login shell.</span>
<span class="sd">    envcmd : str or None, optional</span>
<span class="sd">        The command to generate environment output with.</span>
<span class="sd">    aliascmd : str or None, optional</span>
<span class="sd">        The command to generate alias output with.</span>
<span class="sd">    extra_args : tuple of str, optional</span>
<span class="sd">        Additional command line options to pass into the shell.</span>
<span class="sd">    currenv : tuple of items or None, optional</span>
<span class="sd">        Manual override for the current environment.</span>
<span class="sd">    safe : bool, optional</span>
<span class="sd">        Flag for whether or not to safely handle exceptions and other errors.</span>
<span class="sd">    prevcmd : str, optional</span>
<span class="sd">        A command to run in the shell before anything else, useful for</span>
<span class="sd">        sourcing and other commands that may require environment recovery.</span>
<span class="sd">    postcmd : str, optional</span>
<span class="sd">        A command to run after everything else, useful for cleaning up any</span>
<span class="sd">        damage that the prevcmd may have caused.</span>
<span class="sd">    funcscmd : str or None, optional</span>
<span class="sd">        This is a command or script that can be used to determine the names</span>
<span class="sd">        and locations of any functions that are native to the foreign shell.</span>
<span class="sd">        This command should print *only* a JSON object that maps</span>
<span class="sd">        function names to the filenames where the functions are defined.</span>
<span class="sd">        If this is None, then a default script will attempted to be looked</span>
<span class="sd">        up based on the shell name. Callable wrappers for these functions</span>
<span class="sd">        will be returned in the aliases dictionary.</span>
<span class="sd">    sourcer : str or None, optional</span>
<span class="sd">        How to source a foreign shell file for purposes of calling functions</span>
<span class="sd">        in that shell. If this is None, a default value will attempt to be</span>
<span class="sd">        looked up based on the shell name.</span>
<span class="sd">    use_tmpfile : bool, optional</span>
<span class="sd">        This specifies if the commands are written to a tmp file or just</span>
<span class="sd">        parsed directly to the shell</span>
<span class="sd">    tmpfile_ext : str or None, optional</span>
<span class="sd">        If tmpfile is True this sets specifies the extension used.</span>
<span class="sd">    runcmd : str or None, optional</span>
<span class="sd">        Command line switches to use when running the script, such as</span>
<span class="sd">        -c for Bash and /C for cmd.exe.</span>
<span class="sd">    seterrprevcmd : str or None, optional</span>
<span class="sd">        Command that enables exit-on-error for the shell that is run at the</span>
<span class="sd">        start of the script. For example, this is &quot;set -e&quot; in Bash. To disable</span>
<span class="sd">        exit-on-error behavior, simply pass in an empty string.</span>
<span class="sd">    seterrpostcmd : str or None, optional</span>
<span class="sd">        Command that enables exit-on-error for the shell that is run at the end</span>
<span class="sd">        of the script. For example, this is &quot;if errorlevel 1 exit 1&quot; in</span>
<span class="sd">        cmd.exe. To disable exit-on-error behavior, simply pass in an</span>
<span class="sd">        empty string.</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        Whether or not to display the script that will be run.</span>
<span class="sd">    dryrun : bool, optional</span>
<span class="sd">        Whether or not to actually run and process the command.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    env : dict</span>
<span class="sd">        Dictionary of shell&#39;s environment. (None if the subproc command fails)</span>
<span class="sd">    aliases : dict</span>
<span class="sd">        Dictionary of shell&#39;s aliases, this includes foreign function</span>
<span class="sd">        wrappers.(None if the subproc command fails)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">shell</span><span class="p">]</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_args</span><span class="p">)</span>  <span class="c1"># needs to come here for GNU long options</span>
    <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">login</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-l&quot;</span><span class="p">)</span>
    <span class="n">shkey</span> <span class="o">=</span> <span class="n">CANON_SHELL_NAMES</span><span class="p">[</span><span class="n">shell</span><span class="p">]</span>
    <span class="n">envcmd</span> <span class="o">=</span> <span class="n">DEFAULT_ENVCMDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shkey</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">envcmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">envcmd</span>
    <span class="n">aliascmd</span> <span class="o">=</span> <span class="n">DEFAULT_ALIASCMDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shkey</span><span class="p">,</span> <span class="s2">&quot;alias&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">aliascmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">aliascmd</span>
    <span class="n">funcscmd</span> <span class="o">=</span> <span class="n">DEFAULT_FUNCSCMDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shkey</span><span class="p">,</span> <span class="s2">&quot;echo </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">funcscmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">funcscmd</span>
    <span class="n">tmpfile_ext</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">DEFAULT_TMPFILE_EXT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shkey</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tmpfile_ext</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tmpfile_ext</span>
    <span class="p">)</span>
    <span class="n">runcmd</span> <span class="o">=</span> <span class="n">DEFAULT_RUNCMD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shkey</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">runcmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">runcmd</span>
    <span class="n">seterrprevcmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">DEFAULT_SETERRPREVCMD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shkey</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">seterrprevcmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">seterrprevcmd</span>
    <span class="p">)</span>
    <span class="n">seterrpostcmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">DEFAULT_SETERRPOSTCMD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shkey</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">seterrpostcmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">seterrpostcmd</span>
    <span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">COMMAND</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">envcmd</span><span class="o">=</span><span class="n">envcmd</span><span class="p">,</span>
        <span class="n">aliascmd</span><span class="o">=</span><span class="n">aliascmd</span><span class="p">,</span>
        <span class="n">prevcmd</span><span class="o">=</span><span class="n">prevcmd</span><span class="p">,</span>
        <span class="n">postcmd</span><span class="o">=</span><span class="n">postcmd</span><span class="p">,</span>
        <span class="n">funcscmd</span><span class="o">=</span><span class="n">funcscmd</span><span class="p">,</span>
        <span class="n">seterrprevcmd</span><span class="o">=</span><span class="n">seterrprevcmd</span><span class="p">,</span>
        <span class="n">seterrpostcmd</span><span class="o">=</span><span class="n">seterrpostcmd</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runcmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_tmpfile</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="n">tmpfile_ext</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tmpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
        <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">currenv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
        <span class="n">currenv</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">detype</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">currenv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">currenv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">currenv</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">currenv</span><span class="p">,</span>
            <span class="c1"># start new session to avoid hangs</span>
            <span class="c1"># (doesn&#39;t work on Cygwin though)</span>
            <span class="n">start_new_session</span><span class="o">=</span><span class="p">((</span><span class="ow">not</span> <span class="n">ON_CYGWIN</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ON_MSYS</span><span class="p">)),</span>
            <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">safe</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_tmpfile</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">parse_env</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="n">parse_aliases</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span> <span class="n">sourcer</span><span class="o">=</span><span class="n">sourcer</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="n">extra_args</span><span class="p">)</span>
    <span class="n">funcs</span> <span class="o">=</span> <span class="n">parse_funcs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span> <span class="n">sourcer</span><span class="o">=</span><span class="n">sourcer</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="n">extra_args</span><span class="p">)</span>
    <span class="n">aliases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span><span class="p">,</span> <span class="n">aliases</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">ENV_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;__XONSH_ENV_BEG__</span><span class="se">\n</span><span class="s2">(.*)&quot;</span> <span class="s2">&quot;__XONSH_ENV_END__&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">ENV_SPLIT_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^([^=]+)=([^=]*|[^</span><span class="se">\n</span><span class="s2">]*)$&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_env</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses the environment portion of string into a dict.&quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ENV_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="n">g1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">g1</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">g1</span>
    <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ENV_SPLIT_RE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">g1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">env</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">ALIAS_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s2">&quot;__XONSH_ALIAS_BEG__</span><span class="se">\n</span><span class="s2">(.*)&quot;</span> <span class="s2">&quot;__XONSH_ALIAS_END__&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
    <span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">FS_EXEC_ALIAS_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;;|`|\$\(&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_aliases</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">sourcer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;Parses the aliases portion of string into a dict.&quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ALIAS_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">g1</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;alias &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">line</span>
    <span class="p">]</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>  <span class="c1"># lstrip &#39;alias &#39;</span>
            <span class="c1"># undo bash&#39;s weird quoting of single quotes (sh_single_quote)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="se">\\</span><span class="s2">&#39;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="c1"># strip one single quote at the start and end of value</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># now compute actual alias</span>
            <span class="k">if</span> <span class="n">FS_EXEC_ALIAS_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># simple list of args alias</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># alias is more complex, use ExecAlias, but via shell</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&lt;foreign-shell-exec-alias:&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">ForeignShellExecAlias</span><span class="p">(</span>
                    <span class="n">src</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                    <span class="n">sourcer</span><span class="o">=</span><span class="n">sourcer</span><span class="p">,</span>
                    <span class="n">extra_args</span><span class="o">=</span><span class="n">extra_args</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;could not parse alias &quot;</span><span class="si">{0}</span><span class="s1">&quot;: </span><span class="si">{1!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span> <span class="ne">RuntimeWarning</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">aliases</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">aliases</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">FUNCS_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s2">&quot;__XONSH_FUNCS_BEG__</span><span class="se">\n</span><span class="s2">(.+)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;__XONSH_FUNCS_END__&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_funcs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">sourcer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;Parses the funcs portion of a string into a dict of callable foreign</span>
<span class="sd">    function wrappers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">FUNCS_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="n">g1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">altsep</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">namefiles</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">g1</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0!r}</span><span class="se">\n\n</span><span class="s2">could not parse </span><span class="si">{1}</span><span class="s2"> functions:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  s  = </span><span class="si">{2!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  g1 = </span><span class="si">{3!r}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Note: you may be seeing this error if you use zsh with &quot;</span>
            <span class="s2">&quot;prezto. Prezto overwrites GNU coreutils functions (like echo) &quot;</span>
            <span class="s2">&quot;with its own zsh functions. Please try disabling prezto.&quot;</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">g1</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">sourcer</span> <span class="o">=</span> <span class="n">DEFAULT_SOURCERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">sourcer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sourcer</span>
    <span class="n">funcs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">namefiles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">funcname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># skip private functions and invalid files</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">ForeignShellFunctionAlias</span><span class="p">(</span>
            <span class="n">funcname</span><span class="o">=</span><span class="n">funcname</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span>
            <span class="n">sourcer</span><span class="o">=</span><span class="n">sourcer</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">extra_args</span><span class="o">=</span><span class="n">extra_args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">funcs</span><span class="p">[</span><span class="n">funcname</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">funcs</span>


<span class="k">class</span> <span class="nc">ForeignShellBaseAlias</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is responsible for calling foreign shell functions as if</span>
<span class="sd">    they were aliases. This does not currently support taking stdin.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">INPUT</span> <span class="o">=</span> <span class="s2">&quot;echo ForeignShellBaseAlias </span><span class="si">{shell}</span><span class="s2"> </span><span class="si">{filename}</span><span class="s2"> </span><span class="si">{args}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sourcer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shell : str</span>
<span class="sd">            Name or path to shell</span>
<span class="sd">        filename : str</span>
<span class="sd">            Where the function is defined, path to source.</span>
<span class="sd">        sourcer : str or None, optional</span>
<span class="sd">            Command to source foreign files with.</span>
<span class="sd">        extra_args : tuple of str, optional</span>
<span class="sd">            Additional command line options to pass into the shell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sourcer</span> <span class="o">=</span> <span class="n">DEFAULT_SOURCERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">sourcer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sourcer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">shell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcer</span> <span class="o">=</span> <span class="n">sourcer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_args</span> <span class="o">=</span> <span class="n">extra_args</span>

    <span class="k">def</span> <span class="nf">_input_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;shell&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="s2">&quot;sourcer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourcer</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_args</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;_input_kwargs&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">streaming</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_streaming</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INPUT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">())</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_args</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="nb">input</span><span class="p">]</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
        <span class="n">denv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">detype</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">streaming</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">denv</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">denv</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">),</span>
                <span class="n">errors</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="o">+</span> <span class="s2">&quot;(&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;</span><span class="si">{k}</span><span class="s2">=</span><span class="si">{v!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_streaming</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test and modify args if --xonsh-stream is present.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;--xonsh-stream&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;--xonsh-stream&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">ForeignShellFunctionAlias</span><span class="p">(</span><span class="n">ForeignShellBaseAlias</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is responsible for calling foreign shell functions as if</span>
<span class="sd">    they were aliases. This does not currently support taking stdin.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">INPUT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{sourcer}</span><span class="s1"> &quot;</span><span class="si">{filename}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="s2">&quot;</span><span class="si">{funcname}</span><span class="s2"> </span><span class="si">{args}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sourcer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        funcname : str</span>
<span class="sd">            function name</span>
<span class="sd">        shell : str</span>
<span class="sd">            Name or path to shell</span>
<span class="sd">        filename : str</span>
<span class="sd">            Where the function is defined, path to source.</span>
<span class="sd">        sourcer : str or None, optional</span>
<span class="sd">            Command to source foreign files with.</span>
<span class="sd">        extra_args : tuple of str, optional</span>
<span class="sd">            Additional command line options to pass into the shell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">sourcer</span><span class="o">=</span><span class="n">sourcer</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="n">extra_args</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcname</span> <span class="o">=</span> <span class="n">funcname</span>

    <span class="k">def</span> <span class="nf">_input_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">()</span>
        <span class="n">inp</span><span class="p">[</span><span class="s2">&quot;funcname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcname</span>
        <span class="k">return</span> <span class="n">inp</span>


<span class="k">class</span> <span class="nc">ForeignShellExecAlias</span><span class="p">(</span><span class="n">ForeignShellBaseAlias</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides a callable alias for source code in a foreign shell.&quot;&quot;&quot;</span>

    <span class="n">INPUT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{src}</span><span class="s2"> </span><span class="si">{args}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">src</span><span class="p">,</span>
        <span class="n">shell</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&lt;foreign-shell-exec-alias&gt;&quot;</span><span class="p">,</span>
        <span class="n">sourcer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="o">=</span><span class="p">(),</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        src : str</span>
<span class="sd">            Source code in the shell language</span>
<span class="sd">        shell : str</span>
<span class="sd">            Name or path to shell</span>
<span class="sd">        filename : str</span>
<span class="sd">            Where the function is defined, path to source.</span>
<span class="sd">        sourcer : str or None, optional</span>
<span class="sd">            Command to source foreign files with.</span>
<span class="sd">        extra_args : tuple of str, optional</span>
<span class="sd">            Additional command line options to pass into the shell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">sourcer</span><span class="o">=</span><span class="n">sourcer</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="n">extra_args</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_input_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_input_kwargs</span><span class="p">()</span>
        <span class="n">inp</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span>
        <span class="k">return</span> <span class="n">inp</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">VALID_SHELL_PARAMS</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interactive&quot;</span><span class="p">,</span>
            <span class="s2">&quot;login&quot;</span><span class="p">,</span>
            <span class="s2">&quot;envcmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;aliascmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">,</span>
            <span class="s2">&quot;currenv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;safe&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prevcmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;postcmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;funcscmd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sourcer&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">ensure_shell</span><span class="p">(</span><span class="n">shell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensures that a mapping follows the shell specification.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shell</span><span class="p">)</span>
    <span class="n">shell_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">shell</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">shell_keys</span> <span class="o">&lt;=</span> <span class="n">VALID_SHELL_PARAMS</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;unknown shell keys: </span><span class="si">{0}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shell_keys</span> <span class="o">-</span> <span class="n">VALID_SHELL_PARAMS</span><span class="p">))</span>
    <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;shell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;shell&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;interactive&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;interactive&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;login&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;envcmd&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;envcmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;envcmd&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;envcmd&quot;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;aliascmd&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;aliascmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;aliascmd&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;aliascmd&quot;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;extra_args&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;extra_args&quot;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;extra_args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ensure_string</span><span class="p">,</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;extra_args&quot;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="s2">&quot;currenv&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;currenv&quot;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;currenv&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="n">ce</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">ensure_string</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ce</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
            <span class="n">ce</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">ensure_string</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ce</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;unrecognized type for currenv&quot;</span><span class="p">)</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;currenv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ce</span>
    <span class="k">if</span> <span class="s2">&quot;safe&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;safe&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;safe&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;prevcmd&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;prevcmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;prevcmd&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;postcmd&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;postcmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;postcmd&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;funcscmd&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;funcscmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;funcscmd&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;funcscmd&quot;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;sourcer&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;sourcer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;sourcer&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;sourcer&quot;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;seterrprevcmd&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;seterrprevcmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>
            <span class="k">if</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;seterrprevcmd&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;seterrprevcmd&quot;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;seterrpostcmd&quot;</span> <span class="ow">in</span> <span class="n">shell_keys</span><span class="p">:</span>
        <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;seterrpostcmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>
            <span class="k">if</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;seterrpostcmd&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">ensure_string</span><span class="p">(</span><span class="n">shell</span><span class="p">[</span><span class="s2">&quot;seterrpostcmd&quot;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">shell</span>


<span class="k">def</span> <span class="nf">load_foreign_envs</span><span class="p">(</span><span class="n">shells</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads environments from foreign shells.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shells : sequence of dicts</span>
<span class="sd">        An iterable of dicts that can be passed into foreign_shell_data() as</span>
<span class="sd">        keyword arguments.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    env : dict</span>
<span class="sd">        A dictionary of the merged environments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">shell</span> <span class="ow">in</span> <span class="n">shells</span><span class="p">:</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="n">ensure_shell</span><span class="p">(</span><span class="n">shell</span><span class="p">)</span>
        <span class="n">shenv</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">foreign_shell_data</span><span class="p">(</span><span class="o">**</span><span class="n">shell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shenv</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shenv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">env</span>


<span class="k">def</span> <span class="nf">load_foreign_aliases</span><span class="p">(</span><span class="n">shells</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads aliases from foreign shells.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shells : sequence of dicts</span>
<span class="sd">        An iterable of dicts that can be passed into foreign_shell_data() as</span>
<span class="sd">        keyword arguments.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aliases : dict</span>
<span class="sd">        A dictionary of the merged aliases.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">xonsh_aliases</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">aliases</span>
    <span class="k">for</span> <span class="n">shell</span> <span class="ow">in</span> <span class="n">shells</span><span class="p">:</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="n">ensure_shell</span><span class="p">(</span><span class="n">shell</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">shaliases</span> <span class="o">=</span> <span class="n">foreign_shell_data</span><span class="p">(</span><span class="o">**</span><span class="n">shell</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FOREIGN_ALIASES_OVERRIDE&quot;</span><span class="p">):</span>
            <span class="n">shaliases</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">shaliases</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">shaliases</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">shaliases</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">xonsh_aliases</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">shaliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_DEBUG&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;aliases: ignoring alias </span><span class="si">{!r}</span><span class="s2"> of shell </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;which tries to override xonsh alias.&quot;</span>
                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">shell</span><span class="p">[</span><span class="s2">&quot;shell&quot;</span><span class="p">]),</span>
                        <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="n">aliases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shaliases</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aliases</span>

<span class="c1">#</span>
<span class="c1"># jobs</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Job control for the xonsh shell.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated time</span>
<span class="c1"># amalgamated ctypes</span>
<span class="c1"># amalgamated signal</span>
<span class="c1"># amalgamated argparse</span>
<span class="c1"># amalgamated subprocess</span>
<span class="c1"># amalgamated collections</span>
<span class="c1"># amalgamated typing</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="n">tasks</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Deque</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
<span class="c1"># Track time stamp of last exit command, so that two consecutive attempts to</span>
<span class="c1"># exit can kill all jobs and exit.</span>
<span class="n">_last_exit_time</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">if</span> <span class="n">ON_DARWIN</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_send_signal</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
        <span class="c1"># On OS X, os.killpg() may cause PermissionError when there are</span>
        <span class="c1"># any zombie processes in the process group.</span>
        <span class="c1"># See github issue #1012 for details</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;pids&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># the pid of an aliased proc is None</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
                <span class="k">pass</span>


<span class="k">elif</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">elif</span> <span class="n">ON_CYGWIN</span> <span class="ow">or</span> <span class="n">ON_MSYS</span><span class="p">:</span>
    <span class="c1"># Similar to what happened on OSX, more issues on Cygwin</span>
    <span class="c1"># (see Github issue #514).</span>
    <span class="k">def</span> <span class="nf">_send_signal</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;pgrp&quot;</span><span class="p">],</span> <span class="n">signal</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;pids&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>


<span class="k">else</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_send_signal</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">signal</span><span class="p">):</span>
        <span class="n">pgrp</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;pgrp&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pgrp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;pids&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;pgrp&quot;</span><span class="p">],</span> <span class="n">signal</span><span class="p">)</span>


<span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_continue</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
        <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>

    <span class="k">def</span> <span class="nf">_kill</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;taskkill&quot;</span><span class="p">,</span> <span class="s2">&quot;/F&quot;</span><span class="p">,</span> <span class="s2">&quot;/T&quot;</span><span class="p">,</span> <span class="s2">&quot;/PID&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pid</span><span class="p">)],</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ignore_sigtstp</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">give_terminal_to</span><span class="p">(</span><span class="n">pgid</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">wait_for_active_job</span><span class="p">(</span><span class="n">last_task</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backgrounded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the active job to finish, to be killed by SIGINT, or to be</span>
<span class="sd">        suspended by ctrl-z.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_task</span> <span class="o">=</span> <span class="n">get_next_task</span><span class="p">()</span>
        <span class="c1"># Return when there are no foreground active task</span>
        <span class="k">if</span> <span class="n">active_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">last_task</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">active_task</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span>
        <span class="n">_continue</span><span class="p">(</span><span class="n">active_task</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">obj</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_kill</span><span class="p">(</span><span class="n">active_task</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># ignore error if process closed before we got here</span>
        <span class="k">return</span> <span class="n">wait_for_active_job</span><span class="p">(</span><span class="n">last_task</span><span class="o">=</span><span class="n">active_task</span><span class="p">)</span>


<span class="k">else</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_continue</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
        <span class="n">_send_signal</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGCONT</span><span class="p">)</span>
        <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>

    <span class="k">def</span> <span class="nf">_kill</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
        <span class="n">_send_signal</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ignore_sigtstp</span><span class="p">():</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTSTP</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>

    <span class="n">_shell_pgrp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpgrp</span><span class="p">()</span>  <span class="c1"># type:ignore</span>

    <span class="n">_block_when_giving</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">SIGTTOU</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">SIGTTIN</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">SIGTSTP</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span>  <span class="c1"># type:ignore</span>
        <span class="p">),</span>
        <span class="nb">globals</span><span class="p">(),</span>
        <span class="s2">&quot;_block_when_giving&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">ON_CYGWIN</span> <span class="ow">or</span> <span class="n">ON_MSYS</span><span class="p">:</span>
        <span class="c1"># on cygwin, signal.pthread_sigmask does not exist in Python, even</span>
        <span class="c1"># though pthread_sigmask is defined in the kernel.  thus, we use</span>
        <span class="c1"># ctypes to mimic the calls in the &quot;normal&quot; version below.</span>
        <span class="n">LIBC</span><span class="o">.</span><span class="n">pthread_sigmask</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>
        <span class="n">LIBC</span><span class="o">.</span><span class="n">pthread_sigmask</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">),</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">_pthread_sigmask</span><span class="p">(</span><span class="n">how</span><span class="p">,</span> <span class="n">signals</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sig</span>
            <span class="n">oldmask</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">LIBC</span><span class="o">.</span><span class="n">pthread_sigmask</span><span class="p">(</span>
                <span class="n">how</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">oldmask</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;Sigmask error.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="n">sig</span>
                <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;Signals&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">65</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">oldmask</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="n">sig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
            <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">_pthread_sigmask</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">pthread_sigmask</span>  <span class="c1"># type:ignore</span>

    <span class="c1"># give_terminal_to is a simplified version of:</span>
    <span class="c1">#    give_terminal_to from bash 4.3 source, jobs.c, line 4030</span>
    <span class="c1"># this will give the terminal to the process group pgid</span>
    <span class="k">def</span> <span class="nf">give_terminal_to</span><span class="p">(</span><span class="n">pgid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pgid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">oldmask</span> <span class="o">=</span> <span class="n">_pthread_sigmask</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="n">_block_when_giving</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">tcsetpgrp</span><span class="p">(</span><span class="n">FD_STDERR</span><span class="p">,</span> <span class="n">pgid</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
            <span class="c1"># when the process finished before giving terminal to it,</span>
            <span class="c1"># see issue #2288</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>  <span class="c1"># [Errno 22] Invalid argument</span>
                <span class="c1"># there are cases that all the processes of pgid have</span>
                <span class="c1"># finished, then we don&#39;t need to do anything here, see</span>
                <span class="c1"># issue #2220</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>  <span class="c1"># [Errno 25] Inappropriate ioctl for device</span>
                <span class="c1"># There are also cases where we are not connected to a</span>
                <span class="c1"># real TTY, even though we may be run in interactive</span>
                <span class="c1"># mode. See issue #2267 for an example with emacs</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_pthread_sigmask</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="n">oldmask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wait_for_active_job</span><span class="p">(</span><span class="n">last_task</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backgrounded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the active job to finish, to be killed by SIGINT, or to be</span>
<span class="sd">        suspended by ctrl-z.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_task</span> <span class="o">=</span> <span class="n">get_next_task</span><span class="p">()</span>
        <span class="c1"># Return when there are no foreground active task</span>
        <span class="k">if</span> <span class="n">active_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">last_task</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">active_task</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span>
        <span class="n">backgrounded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">wcode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WUNTRACED</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ChildProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># No child processes</span>
            <span class="k">if</span> <span class="n">return_error</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_safe_wait_for_active_job</span><span class="p">(</span>
                    <span class="n">last_task</span><span class="o">=</span><span class="n">active_task</span><span class="p">,</span> <span class="n">backgrounded</span><span class="o">=</span><span class="n">backgrounded</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">wcode</span><span class="p">):</span>
            <span class="n">active_task</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;stopped&quot;</span>
            <span class="n">backgrounded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">wcode</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">()</span>  <span class="c1"># get a newline because ^C will have been printed</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">wcode</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">WCOREDUMP</span><span class="p">(</span><span class="n">wcode</span><span class="p">))</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">wcode</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">wait_for_active_job</span><span class="p">(</span><span class="n">last_task</span><span class="o">=</span><span class="n">active_task</span><span class="p">,</span> <span class="n">backgrounded</span><span class="o">=</span><span class="n">backgrounded</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_safe_wait_for_active_job</span><span class="p">(</span><span class="n">last_task</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backgrounded</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Safely call wait_for_active_job()&quot;&quot;&quot;</span>
    <span class="n">have_error</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">have_error</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="n">wait_for_active_job</span><span class="p">(</span>
                <span class="n">last_task</span><span class="o">=</span><span class="n">last_task</span><span class="p">,</span> <span class="n">backgrounded</span><span class="o">=</span><span class="n">backgrounded</span><span class="p">,</span> <span class="n">return_error</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ChildProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">have_error</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span> <span class="ne">ChildProcessError</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rtn</span>


<span class="k">def</span> <span class="nf">get_next_task</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the next active task and put it on top of the queue&quot;&quot;&quot;</span>
    <span class="n">_clear_dead_jobs</span><span class="p">()</span>
    <span class="n">selected_task</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">get_task</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
            <span class="n">selected_task</span> <span class="o">=</span> <span class="n">tid</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">selected_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">selected_task</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">selected_task</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_task</span><span class="p">(</span><span class="n">selected_task</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="n">tid</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_clear_dead_jobs</span><span class="p">():</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">get_task</span><span class="p">(</span><span class="n">tid</span><span class="p">)[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">print_one_job</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print a line describing job number ``num``.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">num</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">num</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;cmds&quot;</span><span class="p">]]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;pids&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bg</span> <span class="o">=</span> <span class="s2">&quot; &amp;&quot;</span> <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">]</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">pid</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_next_job_number</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the lowest available unique job number (for the next job created).&quot;&quot;&quot;</span>
    <span class="n">_clear_dead_jobs</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>


<span class="k">def</span> <span class="nf">add_job</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a new job to the jobs dictionary.&quot;&quot;&quot;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">get_next_job_number</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;started&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">):</span>
        <span class="n">print_one_job</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">clean_jobs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Clean up jobs for exiting shell</span>

<span class="sd">    In non-interactive mode, kill all jobs.</span>

<span class="sd">    In interactive mode, check for suspended or background jobs, print a</span>
<span class="sd">    warning if any exist, and return False. Otherwise, return True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jobs_clean</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">]:</span>
        <span class="n">_clear_dead_jobs</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">_last_exit_time</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">history</span>
            <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">tss</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">last_cmd_start</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">tss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_cmd_start</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">_last_exit_time</span> <span class="ow">and</span> <span class="n">last_cmd_start</span> <span class="ow">and</span> <span class="n">_last_exit_time</span> <span class="o">&gt;</span> <span class="n">last_cmd_start</span><span class="p">:</span>
                <span class="c1"># Exit occurred after last command started, so it was called as</span>
                <span class="c1"># part of the last command and is now being called again</span>
                <span class="c1"># immediately. Kill jobs and exit without reminder about</span>
                <span class="c1"># unfinished jobs in this case.</span>
                <span class="n">kill_all_jobs</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;there are unfinished jobs&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;there is an unfinished job&quot;</span>

                <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;SHELL_TYPE&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">:</span>
                    <span class="c1"># The Ctrl+D binding for prompt_toolkit already inserts a</span>
                    <span class="c1"># newline</span>
                    <span class="nb">print</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xonsh: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">jobs</span><span class="p">([],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Type &quot;exit&quot; or press &quot;ctrl-d&quot; again to force quit.&#39;</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">jobs_clean</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">_last_exit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kill_all_jobs</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jobs_clean</span>


<span class="k">def</span> <span class="nf">kill_all_jobs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send SIGKILL to all child processes (called when exiting xonsh).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_clear_dead_jobs</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">_kill</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">jobs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    xonsh command: jobs</span>

<span class="sd">    Display a list of all current jobs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_clear_dead_jobs</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="n">print_one_job</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">resume_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">wording</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    used by fg and bg to resume a job either in the foreground or in the background.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_clear_dead_jobs</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;There are currently no suspended jobs&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># take the last manipulated task by default</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>  <span class="c1"># take the last manipulated task</span>
                <span class="n">tid</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>  <span class="c1"># take the second to last manipulated task</span>
                <span class="n">tid</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Invalid job: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Invalid job: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> expects 0 or 1 arguments, not </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wording</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

    <span class="c1"># Put this one on top of the queue</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
    <span class="n">tasks</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>

    <span class="n">job</span> <span class="o">=</span> <span class="n">get_task</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
    <span class="n">job</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
    <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">):</span>
        <span class="n">print_one_job</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">resume</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>


<span class="nd">@unthreadable</span>
<span class="k">def</span> <span class="nf">fg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    xonsh command: fg</span>

<span class="sd">    Bring the currently active job to the foreground, or, if a single number is</span>
<span class="sd">    given as an argument, bring that job to the foreground. Additionally,</span>
<span class="sd">    specify &quot;+&quot; for the most recent job and &quot;-&quot; for the second most recent job.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">resume_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">wording</span><span class="o">=</span><span class="s2">&quot;fg&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;xonsh command: bg</span>

<span class="sd">    Resume execution of the currently active job in the background, or, if a</span>
<span class="sd">    single number is given as an argument, resume that job in the background.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">resume_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">wording</span><span class="o">=</span><span class="s2">&quot;bg&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">curtask</span> <span class="o">=</span> <span class="n">get_task</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">curtask</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_continue</span><span class="p">(</span><span class="n">curtask</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">disown</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    xonsh command: disown</span>

<span class="sd">    Remove the specified jobs from the job table; the shell will no longer</span>
<span class="sd">    report their status, and will not complain if you try to exit an</span>
<span class="sd">    interactive shell with them running or stopped. If no job is specified,</span>
<span class="sd">    disown the current job.</span>

<span class="sd">    If the jobs are currently stopped and the $AUTO_CONTINUE option is not set</span>
<span class="sd">    ($AUTO_CONTINUE = False), a warning is printed containing information about</span>
<span class="sd">    how to make them continue after they have been disowned.</span>

<span class="sd">    Specifying the -c or --continue option for this command is equivalent to</span>
<span class="sd">    setting $AUTO_CONTINUE=True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s2">&quot;disown&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">disown</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;job_ids&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Jobs to act on or none to use the current job&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--continue&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;force_auto_continue&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Automatically continue stopped jobs when they are disowned&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">pargs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;There are no active jobs&quot;</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># if args.job_ids is empty, use the active task</span>
    <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">pargs</span><span class="o">.</span><span class="n">job_ids</span> <span class="ow">or</span> <span class="p">[</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_task</span> <span class="o">=</span> <span class="n">get_task</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2">&#39; is not a valid job ID&quot;</span>

        <span class="n">auto_cont</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTO_CONTINUE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auto_cont</span> <span class="ow">or</span> <span class="n">pargs</span><span class="o">.</span><span class="n">force_auto_continue</span><span class="p">:</span>
            <span class="n">_continue</span><span class="p">(</span><span class="n">current_task</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">current_task</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stopped&quot;</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;warning: job is suspended, use &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;kill -CONT -</span><span class="si">{</span><span class="n">current_task</span><span class="p">[</span><span class="s1">&#39;pids&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;to resume</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Stop tracking this task</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">XSH</span><span class="o">.</span><span class="n">all_jobs</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed job </span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">current_task</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># jsonutils</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Custom tools for managing JSON serialization / deserialization of xonsh</span>
<span class="sd">objects.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated functools</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="nd">@functools</span><span class="o">.</span><span class="n">singledispatch</span>
<span class="k">def</span> <span class="nf">serialize_xonsh_json</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;JSON serializer for xonsh custom data structures. This is only</span>
<span class="sd">    called when another normal JSON types are not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="nd">@serialize_xonsh_json</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">EnvPath</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_serialize_xonsh_json_env_path</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">paths</span>

<span class="c1">#</span>
<span class="c1"># lexer</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Lexer for xonsh code.</span>

<span class="sd">Written using a hybrid of ``tokenize`` and PLY.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated io</span>
<span class="c1"># amalgamated re</span>
<span class="n">kwmod</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;keyword&#39;</span><span class="p">,</span> <span class="s1">&#39;keyword&#39;</span><span class="p">,</span> <span class="s1">&#39;kwmod&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated typing</span>
<span class="kn">from</span> <span class="nn">xonsh.ply.ply.lex</span> <span class="kn">import</span> <span class="n">LexToken</span>

<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.tokenize</span>
<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">token_map</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Mapping from ``tokenize`` tokens (or token types) to PLY token types. If</span>
<span class="sd">    a simple one-to-one mapping from ``tokenize`` to PLY exists, the lexer will</span>
<span class="sd">    look it up here and generate a single PLY token of the given type.</span>
<span class="sd">    Otherwise, it will fall back to handling that token using one of the</span>
<span class="sd">    handlers in``special_handlers``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># operators</span>
    <span class="n">_op_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># punctuation</span>
        <span class="s2">&quot;,&quot;</span><span class="p">:</span> <span class="s2">&quot;COMMA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="s2">&quot;PERIOD&quot;</span><span class="p">,</span>
        <span class="s2">&quot;;&quot;</span><span class="p">:</span> <span class="s2">&quot;SEMI&quot;</span><span class="p">,</span>
        <span class="s2">&quot;:&quot;</span><span class="p">:</span> <span class="s2">&quot;COLON&quot;</span><span class="p">,</span>
        <span class="s2">&quot;...&quot;</span><span class="p">:</span> <span class="s2">&quot;ELLIPSIS&quot;</span><span class="p">,</span>
        <span class="c1"># basic operators</span>
        <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="s2">&quot;PLUS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="s2">&quot;MINUS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;TIMES&quot;</span><span class="p">,</span>
        <span class="s2">&quot;@&quot;</span><span class="p">:</span> <span class="s2">&quot;AT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="s2">&quot;DIVIDE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;//&quot;</span><span class="p">:</span> <span class="s2">&quot;DOUBLEDIV&quot;</span><span class="p">,</span>
        <span class="s2">&quot;%&quot;</span><span class="p">:</span> <span class="s2">&quot;MOD&quot;</span><span class="p">,</span>
        <span class="s2">&quot;**&quot;</span><span class="p">:</span> <span class="s2">&quot;POW&quot;</span><span class="p">,</span>
        <span class="s2">&quot;|&quot;</span><span class="p">:</span> <span class="s2">&quot;PIPE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;~&quot;</span><span class="p">:</span> <span class="s2">&quot;TILDE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;^&quot;</span><span class="p">:</span> <span class="s2">&quot;XOR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">:</span> <span class="s2">&quot;LSHIFT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&gt;&gt;&quot;</span><span class="p">:</span> <span class="s2">&quot;RSHIFT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="s2">&quot;LT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;LE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="s2">&quot;GT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;GE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;==&quot;</span><span class="p">:</span> <span class="s2">&quot;EQ&quot;</span><span class="p">,</span>
        <span class="s2">&quot;!=&quot;</span><span class="p">:</span> <span class="s2">&quot;NE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-&gt;&quot;</span><span class="p">:</span> <span class="s2">&quot;RARROW&quot;</span><span class="p">,</span>
        <span class="c1"># assignment operators</span>
        <span class="s2">&quot;=&quot;</span><span class="p">:</span> <span class="s2">&quot;EQUALS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;+=&quot;</span><span class="p">:</span> <span class="s2">&quot;PLUSEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-=&quot;</span><span class="p">:</span> <span class="s2">&quot;MINUSEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*=&quot;</span><span class="p">:</span> <span class="s2">&quot;TIMESEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;@=&quot;</span><span class="p">:</span> <span class="s2">&quot;ATEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/=&quot;</span><span class="p">:</span> <span class="s2">&quot;DIVEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;%=&quot;</span><span class="p">:</span> <span class="s2">&quot;MODEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;**=&quot;</span><span class="p">:</span> <span class="s2">&quot;POWEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;&lt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;LSHIFTEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&gt;&gt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;RSHIFTEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&amp;=&quot;</span><span class="p">:</span> <span class="s2">&quot;AMPERSANDEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;^=&quot;</span><span class="p">:</span> <span class="s2">&quot;XOREQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;|=&quot;</span><span class="p">:</span> <span class="s2">&quot;PIPEEQUAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;//=&quot;</span><span class="p">:</span> <span class="s2">&quot;DOUBLEDIVEQUAL&quot;</span><span class="p">,</span>
        <span class="c1"># extra xonsh operators</span>
        <span class="s2">&quot;?&quot;</span><span class="p">:</span> <span class="s2">&quot;QUESTION&quot;</span><span class="p">,</span>
        <span class="s2">&quot;??&quot;</span><span class="p">:</span> <span class="s2">&quot;DOUBLE_QUESTION&quot;</span><span class="p">,</span>
        <span class="s2">&quot;@$&quot;</span><span class="p">:</span> <span class="s2">&quot;ATDOLLAR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span> <span class="s2">&quot;AMPERSAND&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_op_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">tm</span><span class="p">[(</span><span class="n">OP</span><span class="p">,</span> <span class="n">op</span><span class="p">)]</span> <span class="o">=</span> <span class="n">typ</span>
    <span class="n">tm</span><span class="p">[</span><span class="n">IOREDIRECT</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;IOREDIRECT&quot;</span>
    <span class="n">tm</span><span class="p">[</span><span class="n">STRING</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;STRING&quot;</span>
    <span class="n">tm</span><span class="p">[</span><span class="n">DOLLARNAME</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DOLLAR_NAME&quot;</span>
    <span class="n">tm</span><span class="p">[</span><span class="n">NUMBER</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NUMBER&quot;</span>
    <span class="n">tm</span><span class="p">[</span><span class="n">SEARCHPATH</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SEARCHPATH&quot;</span>
    <span class="n">tm</span><span class="p">[</span><span class="n">NEWLINE</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NEWLINE&quot;</span>
    <span class="n">tm</span><span class="p">[</span><span class="n">INDENT</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;INDENT&quot;</span>
    <span class="n">tm</span><span class="p">[</span><span class="n">DEDENT</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DEDENT&quot;</span>
    <span class="k">if</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">xonsh.tokenize</span> <span class="kn">import</span> <span class="n">ASYNC</span><span class="p">,</span> <span class="n">AWAIT</span>

        <span class="n">tm</span><span class="p">[</span><span class="n">ASYNC</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ASYNC&quot;</span>
        <span class="n">tm</span><span class="p">[</span><span class="n">AWAIT</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;AWAIT&quot;</span>
    <span class="k">if</span> <span class="n">HAS_WALRUS</span><span class="p">:</span>
        <span class="n">tm</span><span class="p">[(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;:=&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;COLONEQUAL&quot;</span>
    <span class="k">return</span> <span class="n">tm</span>


<span class="n">NEED_WHITESPACE</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">])</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">RE_NEED_WHITESPACE</span><span class="p">():</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s?(&quot;</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NEED_WHITESPACE</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;)(\s|[</span><span class="se">\\</span><span class="s2">]$)&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_name</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function for handling name tokens&quot;&quot;&quot;</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;NAME&quot;</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="n">needs_whitespace</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span> <span class="ow">in</span> <span class="n">NEED_WHITESPACE</span>
    <span class="n">has_whitespace</span> <span class="o">=</span> <span class="n">needs_whitespace</span> <span class="ow">and</span> <span class="n">RE_NEED_WHITESPACE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
        <span class="n">token</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">needs_whitespace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_whitespace</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span> <span class="ow">in</span> <span class="n">kwmod</span><span class="o">.</span><span class="n">kwlist</span><span class="p">:</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_whitespace</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;and&quot;</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;AND&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">has_whitespace</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;or&quot;</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;OR&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_end_delimiter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">py</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mode</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; at </span><span class="si">{}</span><span class="s1"> ends &quot;</span><span class="si">{}</span><span class="s1">&quot; at </span><span class="si">{}</span><span class="s1"> (expected &quot;</span><span class="si">{}</span><span class="s1">&quot;)&#39;</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">orig</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Unmatched &quot;</span><span class="si">{}</span><span class="s1">&quot; at line </span><span class="si">{}</span><span class="s1">, column </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_rparen</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for handling ``)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">_end_delimiter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;tolerant&quot;</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;RPAREN&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;ERRORTOKEN&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_rbrace</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function for handling ``}``&quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">_end_delimiter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;tolerant&quot;</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;RBRACE&quot;</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;ERRORTOKEN&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_rbracket</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for handling ``]``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">_end_delimiter</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;tolerant&quot;</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;RBRACKET&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;ERRORTOKEN&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_error_space</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for handling special whitespace characters in subprocess mode</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;WS&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">handle_error_linecont</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function for handling special line continuations as whitespace</span>
<span class="sd">    characters in subprocess mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">prev</span><span class="o">.</span><span class="n">end</span> <span class="o">!=</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># previous token is separated by whitespace</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;WS&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_error_token</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for handling error tokens</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;BANG&quot;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;NAME&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;ERRORTOKEN&quot;</span>
    <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_ignore</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function for handling tokens that should be ignored&quot;&quot;&quot;</span>
    <span class="k">yield from</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">handle_double_amps</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;AND&quot;</span><span class="p">,</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_double_pipe</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;OR&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_redirect</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="c1"># The parser expects whitespace after a redirection in subproc mode.</span>
    <span class="c1"># If whitespace does not exist, we&#39;ll issue an empty whitespace</span>
    <span class="c1"># token before proceeding.</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span> <span class="ow">in</span> <span class="n">token_map</span> <span class="k">else</span> <span class="n">typ</span>
    <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="n">token_map</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">st</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="c1"># add a whitespace token after a redirection, if we need to</span>
    <span class="n">next_tok</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">next_tok</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;WS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">handle_token</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">next_tok</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_matcher_handler</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">pymode</span><span class="p">,</span> <span class="n">ender</span><span class="p">,</span> <span class="n">handlers</span><span class="p">):</span>
    <span class="n">matcher</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;)&quot;</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="s2">&quot;}&quot;</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="s2">&quot;]&quot;</span>
        <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_inner_handler</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pymode</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">matcher</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

    <span class="n">handlers</span><span class="p">[(</span><span class="n">OP</span><span class="p">,</span> <span class="n">tok</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_inner_handler</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">special_handlers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Mapping from ``tokenize`` tokens (or token types) to the proper</span>
<span class="sd">    function for generating PLY tokens from them.  In addition to</span>
<span class="sd">    yielding PLY tokens, these functions may manipulate the Lexer&#39;s state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">NL</span><span class="p">:</span> <span class="n">handle_ignore</span><span class="p">,</span>
        <span class="n">COMMENT</span><span class="p">:</span> <span class="n">handle_ignore</span><span class="p">,</span>
        <span class="n">ENCODING</span><span class="p">:</span> <span class="n">handle_ignore</span><span class="p">,</span>
        <span class="n">ENDMARKER</span><span class="p">:</span> <span class="n">handle_ignore</span><span class="p">,</span>
        <span class="n">NAME</span><span class="p">:</span> <span class="n">handle_name</span><span class="p">,</span>
        <span class="n">ERRORTOKEN</span><span class="p">:</span> <span class="n">handle_error_token</span><span class="p">,</span>
        <span class="n">LESS</span><span class="p">:</span> <span class="n">handle_redirect</span><span class="p">,</span>
        <span class="n">GREATER</span><span class="p">:</span> <span class="n">handle_redirect</span><span class="p">,</span>
        <span class="n">RIGHTSHIFT</span><span class="p">:</span> <span class="n">handle_redirect</span><span class="p">,</span>
        <span class="n">IOREDIRECT</span><span class="p">:</span> <span class="n">handle_redirect</span><span class="p">,</span>
        <span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">):</span> <span class="n">handle_redirect</span><span class="p">,</span>
        <span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">):</span> <span class="n">handle_redirect</span><span class="p">,</span>
        <span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;&gt;&gt;&quot;</span><span class="p">):</span> <span class="n">handle_redirect</span><span class="p">,</span>
        <span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">):</span> <span class="n">handle_rparen</span><span class="p">,</span>
        <span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">):</span> <span class="n">handle_rbrace</span><span class="p">,</span>
        <span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">):</span> <span class="n">handle_rbracket</span><span class="p">,</span>
        <span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">):</span> <span class="n">handle_double_amps</span><span class="p">,</span>
        <span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="s2">&quot;||&quot;</span><span class="p">):</span> <span class="n">handle_double_pipe</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ERRORTOKEN</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">):</span> <span class="n">handle_error_space</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ERRORTOKEN</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span><span class="p">):</span> <span class="n">handle_error_linecont</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ERRORTOKEN</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\r\n</span><span class="s2">&quot;</span><span class="p">):</span> <span class="n">handle_error_linecont</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;LPAREN&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;LBRACKET&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;LBRACE&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;$(&quot;</span><span class="p">,</span> <span class="s2">&quot;DOLLAR_LPAREN&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;$[&quot;</span><span class="p">,</span> <span class="s2">&quot;DOLLAR_LBRACKET&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">,</span> <span class="s2">&quot;DOLLAR_LBRACE&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;!(&quot;</span><span class="p">,</span> <span class="s2">&quot;BANG_LPAREN&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;![&quot;</span><span class="p">,</span> <span class="s2">&quot;BANG_LBRACKET&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;@(&quot;</span><span class="p">,</span> <span class="s2">&quot;AT_LPAREN&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="n">_make_matcher_handler</span><span class="p">(</span><span class="s2">&quot;@$(&quot;</span><span class="p">,</span> <span class="s2">&quot;ATDOLLAR_LPAREN&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sh</span>


<span class="k">def</span> <span class="nf">handle_token</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General-purpose token handler.  Makes use of ``token_map`` or</span>
<span class="sd">    ``special_map`` to yield one or more PLY tokens from the given input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    state</span>
<span class="sd">        The current state of the lexer, including information about whether</span>
<span class="sd">        we are in Python mode or subprocess mode, which changes the lexer&#39;s</span>
<span class="sd">        behavior.  Also includes the stream of tokens yet to be considered.</span>
<span class="sd">    token</span>
<span class="sd">        The token (from ``tokenize``) currently under consideration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">string</span>
    <span class="n">pymode</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pymode</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">!=</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
            <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">cur</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">old</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;WS&quot;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">line</span><span class="p">[</span><span class="n">old</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">cur</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">old</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span> <span class="ow">in</span> <span class="n">special_handlers</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">special_handlers</span><span class="p">[(</span><span class="n">typ</span><span class="p">,</span> <span class="n">st</span><span class="p">)](</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span> <span class="ow">in</span> <span class="n">token_map</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="n">token_map</span><span class="p">[(</span><span class="n">typ</span><span class="p">,</span> <span class="n">st</span><span class="p">)],</span> <span class="n">st</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">special_handlers</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">special_handlers</span><span class="p">[</span><span class="n">typ</span><span class="p">](</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">token_map</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="n">token_map</span><span class="p">[</span><span class="n">typ</span><span class="p">],</span> <span class="n">st</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;Unexpected token: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;ERRORTOKEN&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_tokens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tolerant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a string containing xonsh code, generates a stream of relevant PLY</span>
<span class="sd">    tokens using ``handle_token``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;indents&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;last&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;pymode&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))],</span>
        <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="n">tolerant</span><span class="p">),</span>
        <span class="s2">&quot;tolerant&quot;</span><span class="p">:</span> <span class="n">tolerant</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">])</span>
            <span class="k">yield from</span> <span class="n">handle_token</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tolerant</span><span class="p">:</span>
                <span class="n">pm</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pymode&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">e</span> <span class="o">=</span> <span class="s1">&#39;Unmatched &quot;</span><span class="si">{}</span><span class="s1">&quot; at line </span><span class="si">{}</span><span class="s1">, column </span><span class="si">{}</span><span class="s1">&#39;</span>
                <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;ERRORTOKEN&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">TokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># this is recoverable in single-line mode (from the shell)</span>
            <span class="c1"># (e.g., EOF while scanning string literal)</span>
            <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;ERRORTOKEN&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">IndentationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># this is never recoverable</span>
            <span class="k">yield</span> <span class="n">_new_token</span><span class="p">(</span><span class="s2">&quot;ERRORTOKEN&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">break</span>


<span class="c1"># synthesize a new PLY token</span>
<span class="k">def</span> <span class="nf">_new_token</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">LexToken</span><span class="p">()</span>
    <span class="n">o</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
    <span class="n">o</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">o</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">lexpos</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="k">return</span> <span class="n">o</span>


<span class="k">class</span> <span class="nc">Lexer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements a lexer for the xonsh language.&quot;&quot;&quot;</span>

    <span class="n">_tokens</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tolerant</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            Filename</span>
<span class="sd">        last : token</span>
<span class="sd">            The last token seen.</span>
<span class="sd">        lineno : int</span>
<span class="sd">            The last line number seen.</span>
<span class="sd">        tolerant : bool</span>
<span class="sd">            Tokenize without extra checks (e.g. paren matching).</span>
<span class="sd">            When True, ERRORTOKEN contains the erroneous string instead of an error msg.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beforelast</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerant</span> <span class="o">=</span> <span class="n">tolerant</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Part of the PLY lexer API.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls the lexer on the string s.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_stream</span> <span class="o">=</span> <span class="n">get_tokens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerant</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the next token.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beforelast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_stream</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">t</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Splits a string into a list of strings which are whitespace-separated</span>
<span class="sd">        tokens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="s2">&quot;WS&quot;</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ws</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="n">lineno</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">lexpos</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">nnl</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">nl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nnl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">lineno</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">lexpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">lineno</span> <span class="o">+</span> <span class="n">nnl</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="n">nl</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">vals</span>

    <span class="c1">#</span>
    <span class="c1"># All the tokens recognized by the lexer</span>
    <span class="c1">#</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwlist</span> <span class="o">=</span> <span class="n">kwmod</span><span class="o">.</span><span class="n">kwlist</span><span class="p">[:]</span>
            <span class="k">if</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">PYTHON_VERSION_INFO</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
                <span class="n">kwlist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;__peg_parser__&quot;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">token_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="s2">&quot;NAME&quot;</span><span class="p">,</span>  <span class="c1"># name tokens</span>
                    <span class="s2">&quot;BANG&quot;</span><span class="p">,</span>  <span class="c1"># ! tokens</span>
                    <span class="s2">&quot;WS&quot;</span><span class="p">,</span>  <span class="c1"># whitespace in subprocess mode</span>
                    <span class="s2">&quot;LPAREN&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;RPAREN&quot;</span><span class="p">,</span>  <span class="c1"># ( )</span>
                    <span class="s2">&quot;LBRACKET&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;RBRACKET&quot;</span><span class="p">,</span>  <span class="c1"># [ ]</span>
                    <span class="s2">&quot;LBRACE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;RBRACE&quot;</span><span class="p">,</span>  <span class="c1"># { }</span>
                    <span class="s2">&quot;AT_LPAREN&quot;</span><span class="p">,</span>  <span class="c1"># @(</span>
                    <span class="s2">&quot;BANG_LPAREN&quot;</span><span class="p">,</span>  <span class="c1"># !(</span>
                    <span class="s2">&quot;BANG_LBRACKET&quot;</span><span class="p">,</span>  <span class="c1"># ![</span>
                    <span class="s2">&quot;DOLLAR_LPAREN&quot;</span><span class="p">,</span>  <span class="c1"># $(</span>
                    <span class="s2">&quot;DOLLAR_LBRACE&quot;</span><span class="p">,</span>  <span class="c1"># ${</span>
                    <span class="s2">&quot;DOLLAR_LBRACKET&quot;</span><span class="p">,</span>  <span class="c1"># $[</span>
                    <span class="s2">&quot;ATDOLLAR_LPAREN&quot;</span><span class="p">,</span>  <span class="c1"># @$(</span>
                    <span class="s2">&quot;ERRORTOKEN&quot;</span><span class="p">,</span>  <span class="c1"># whoops!</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">kwlist</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span>

<span class="c1">#</span>
<span class="c1"># openpy</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Tools to open ``*.py`` files as Unicode.</span>

<span class="sd">Uses the encoding specified within the file, as per PEP 263.</span>

<span class="sd">Much of the code is taken from the tokenize module in Python 3.2.</span>

<span class="sd">This file was forked from the IPython project:</span>

<span class="sd">* Copyright (c) 2008-2014, IPython Development Team</span>
<span class="sd">* Copyright (C) 2001-2007 Fernando Perez &lt;fperez@colorado.edu&gt;</span>
<span class="sd">* Copyright (c) 2001, Janko Hauser &lt;jhauser@zscout.de&gt;</span>
<span class="sd">* Copyright (c) 2001, Nathaniel Gray &lt;n8gray@caltech.edu&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated io</span>
<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.tokenize</span>
<span class="n">cookie_comment_re</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*#.*coding[:=]\s*([-\w.]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;cookie_comment_re&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">source_to_unicode</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="n">skip_encoding_cookie</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a bytes string with python source code to unicode.</span>

<span class="sd">    Unicode strings are passed through unchanged. Byte strings are checked</span>
<span class="sd">    for the python source file encoding cookie to determine encoding.</span>
<span class="sd">    txt can be either a bytes buffer or a string containing the source</span>
<span class="sd">    code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">txt</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">txt</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">encoding</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">detect_encoding</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;ascii&quot;</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span> <span class="n">line_buffering</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
    <span class="k">if</span> <span class="n">skip_encoding_cookie</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strip_encoding_cookie</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">strip_encoding_cookie</span><span class="p">(</span><span class="n">filelike</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator to pull lines from a text-mode file, skipping the encoding</span>
<span class="sd">    cookie if it is found in the first two lines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">filelike</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie_comment_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">first</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">first</span>
        <span class="n">second</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie_comment_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">second</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">second</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">line</span>


<span class="k">def</span> <span class="nf">read_py_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">skip_encoding_cookie</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a Python file, using the encoding declared inside the file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The path to the file to read.</span>
<span class="sd">    skip_encoding_cookie : bool</span>
<span class="sd">        If True (the default), and the encoding declaration is found in the first</span>
<span class="sd">        two lines, that line will be excluded from the output - compiling a</span>
<span class="sd">        unicode string with an encoding declaration is a SyntaxError in Python 2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A unicode string containing the contents of the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tokopen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># the open function defined in this module.</span>
        <span class="k">if</span> <span class="n">skip_encoding_cookie</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strip_encoding_cookie</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">read_py_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="n">skip_encoding_cookie</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a Python file from a URL, using the encoding declared inside the file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        The URL from which to fetch the file.</span>
<span class="sd">    errors : str</span>
<span class="sd">        How to handle decoding errors in the file. Options are the same as for</span>
<span class="sd">        bytes.decode(), but here &#39;replace&#39; is the default.</span>
<span class="sd">    skip_encoding_cookie : bool</span>
<span class="sd">        If True (the default), and the encoding declaration is found in the first</span>
<span class="sd">        two lines, that line will be excluded from the output - compiling a</span>
<span class="sd">        unicode string with an encoding declaration is a SyntaxError in Python 2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A unicode string containing the contents of the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Deferred import for faster start</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>  <span class="c1"># Py 3</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlopen</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">source_to_unicode</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">skip_encoding_cookie</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_list_readline</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a list, returns a readline() function that returns the next element</span>
<span class="sd">    with each call.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readline</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">readline</span>

<span class="c1">#</span>
<span class="c1"># xontribs</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Tools for helping manage xontributions.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated argparse</span>
<span class="c1"># amalgamated functools</span>
<span class="c1"># amalgamated importlib</span>
<span class="c1"># amalgamated importlib.util</span>
<span class="c1"># amalgamated json</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated typing</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">IntEnum</span>
<span class="c1"># amalgamated from pathlib import Path</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.xontribs_meta</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="k">class</span> <span class="nc">ExitCode</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">OK</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">NOT_FOUND</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">INIT_FAILED</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">find_xontrib</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds a xontribution from its name.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s2">&quot;xontrib&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s2">&quot;xontrib&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spec</span> <span class="ow">or</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">xontrib_context</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a context dictionary for a xontrib of a given name.&quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">find_xontrib</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">pubnames</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s2">&quot;__all__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pubnames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pubnames</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">ctx</span>


<span class="k">def</span> <span class="nf">prompt_xontrib_install</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Returns a formatted string with name of xontrib package to prompt user&quot;&quot;&quot;</span>
    <span class="n">xontribs</span> <span class="o">=</span> <span class="n">get_xontribs</span><span class="p">()</span>
    <span class="n">packages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">xontribs</span><span class="p">:</span>
            <span class="n">xontrib</span> <span class="o">=</span> <span class="n">xontribs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">xontrib</span><span class="o">.</span><span class="n">package</span><span class="p">:</span>
                <span class="n">packages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xontrib</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;The following xontribs are enabled but not installed: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;   </span><span class="si">{xontribs}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;To install them run </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    xpip install </span><span class="si">{packages}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">xontribs</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="n">packages</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">update_context</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates a context in place from a xontrib. If ctx is not provided,</span>
<span class="sd">    then __xonsh__.ctx is updated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">ctx</span>
    <span class="n">modctx</span> <span class="o">=</span> <span class="n">xontrib_context</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_context</span><span class="p">,</span> <span class="s2">&quot;bad_imports&quot;</span><span class="p">):</span>
            <span class="n">update_context</span><span class="o">.</span><span class="n">bad_imports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">update_context</span><span class="o">.</span><span class="n">bad_imports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>
    <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">modctx</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">xontribs_load</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load xontribs from a list of names&quot;&quot;&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">ctx</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ExitCode</span><span class="o">.</span><span class="n">OK</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading xontrib </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">update_context</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">ExitCode</span><span class="o">.</span><span class="n">INIT_FAILED</span>
            <span class="n">print_exception</span><span class="p">(</span><span class="s2">&quot;Failed to load xontrib </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">update_context</span><span class="p">,</span> <span class="s2">&quot;bad_imports&quot;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">ExitCode</span><span class="o">.</span><span class="n">NOT_FOUND</span>
        <span class="n">prompt_xontrib_install</span><span class="p">(</span><span class="n">update_context</span><span class="o">.</span><span class="n">bad_imports</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">update_context</span><span class="o">.</span><span class="n">bad_imports</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load xontribs&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">xontribs_load</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">xontrib_installed</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Returns list of installed xontribs.&quot;&quot;&quot;</span>
    <span class="n">installed_xontribs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;xontrib&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
        <span class="n">xontrib_locations</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">submodule_search_locations</span>
        <span class="k">if</span> <span class="n">xontrib_locations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">xl</span> <span class="ow">in</span> <span class="n">xontrib_locations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">names</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">installed_xontribs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">installed_xontribs</span>


<span class="k">def</span> <span class="nf">xontrib_data</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Collects and returns the data about xontribs.&quot;&quot;&quot;</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">get_xontribs</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ns</span> <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">xo_name</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xo_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">find_xontrib</span><span class="p">(</span><span class="n">xo_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">installed</span> <span class="o">=</span> <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">installed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>
        <span class="n">data</span><span class="p">[</span><span class="n">xo_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">xo_name</span><span class="p">,</span> <span class="s2">&quot;installed&quot;</span><span class="p">:</span> <span class="n">installed</span><span class="p">,</span> <span class="s2">&quot;loaded&quot;</span><span class="p">:</span> <span class="n">loaded</span><span class="p">}</span>

    <span class="n">installed_xontribs</span> <span class="o">=</span> <span class="n">xontrib_installed</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">installed_xontribs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;xontrib.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>
            <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;installed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;loaded&quot;</span><span class="p">:</span> <span class="n">loaded</span><span class="p">}</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>


<span class="k">def</span> <span class="nf">xontribs_loaded</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns list of loaded xontribs.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">xontrib_data</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">_list</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lists xontribs.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xontrib_data</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nname</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lname</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{PURPLE}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nname</span> <span class="o">-</span> <span class="n">lname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;installed&quot;</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{GREEN}</span><span class="s2">installed</span><span class="si">{RESET}</span><span class="s2">      &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{RED}</span><span class="s2">not-installed</span><span class="si">{RESET}</span><span class="s2">  &quot;</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{GREEN}</span><span class="s2">loaded</span><span class="si">{RESET}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{RED}</span><span class="s2">not-loaded</span><span class="si">{RESET}</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">print_color</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_create_xontrib_parser</span><span class="p">():</span>
    <span class="c1"># parse command line args</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="s2">&quot;xontrib&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Manages xonsh extensions&quot;</span>
    <span class="p">)</span>
    <span class="n">subp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;action&quot;</span><span class="p">)</span>
    <span class="n">load</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;loads xontribs&quot;</span><span class="p">)</span>
    <span class="n">load</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbose&quot;</span>
    <span class="p">)</span>
    <span class="n">load</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;names of xontribs&quot;</span><span class="p">)</span>
    <span class="n">lyst</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;list xontribs, whether they are &quot;</span> <span class="s2">&quot;installed, and loaded.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">lyst</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--json&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;reports results as json&quot;</span>
    <span class="p">)</span>
    <span class="n">lyst</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">(),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;names of xontribs&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>


<span class="n">_MAIN_XONTRIB_ACTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;load&quot;</span><span class="p">:</span> <span class="n">_load</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span> <span class="n">_list</span><span class="p">}</span>


<span class="nd">@unthreadable</span>
<span class="k">def</span> <span class="nf">xontribs_main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias that loads xontribs&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_MAIN_XONTRIB_ACTIONS</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">}</span>
    <span class="p">):</span>
        <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;load&quot;</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">_create_xontrib_parser</span><span class="p">()</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># apply default action</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([</span><span class="s2">&quot;load&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_MAIN_XONTRIB_ACTIONS</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">action</span><span class="p">](</span><span class="n">ns</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># ansi_colors</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Tools for helping with ANSI color codes.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated warnings</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.color_tools</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="n">_PART_STYLE_CODE_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;bold&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nobold&quot;</span><span class="p">:</span> <span class="s2">&quot;21&quot;</span><span class="p">,</span>
    <span class="s2">&quot;italic&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;noitalic&quot;</span><span class="p">:</span> <span class="s2">&quot;23&quot;</span><span class="p">,</span>
    <span class="s2">&quot;underline&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nounderline&quot;</span><span class="p">:</span> <span class="s2">&quot;24&quot;</span><span class="p">,</span>
    <span class="s2">&quot;blink&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;noblink&quot;</span><span class="p">:</span> <span class="s2">&quot;25&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reverse&quot;</span><span class="p">:</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span>
    <span class="s2">&quot;noreverse&quot;</span><span class="p">:</span> <span class="s2">&quot;27&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hidden&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nohidden&quot;</span><span class="p">:</span> <span class="s2">&quot;28&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_ensure_color_map</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">ANSI_STYLES</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">ANSI_STYLES</span><span class="p">[</span><span class="n">style</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># dynamically loading the style</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">ansi_style_by_name</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Could not find color style </span><span class="si">{0!r}</span><span class="s2">, using default.&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">style</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">ANSI_STYLES</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cmap</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">ANSI_ESCAPE_MODIFIERS</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;BOLD&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FAINT&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ITALIC&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UNDERLINE&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SLOWBLINK&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FASTBLINK&quot;</span><span class="p">:</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INVERT&quot;</span><span class="p">:</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CONCEAL&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;STRIKETHROUGH&quot;</span><span class="p">:</span> <span class="s2">&quot;9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BOLDOFF&quot;</span><span class="p">:</span> <span class="s2">&quot;21&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FAINTOFF&quot;</span><span class="p">:</span> <span class="s2">&quot;22&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ITALICOFF&quot;</span><span class="p">:</span> <span class="s2">&quot;23&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UNDERLINEOFF&quot;</span><span class="p">:</span> <span class="s2">&quot;24&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLINKOFF&quot;</span><span class="p">:</span> <span class="s2">&quot;25&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INVERTOFF&quot;</span><span class="p">:</span> <span class="s2">&quot;27&quot;</span><span class="p">,</span>
        <span class="s2">&quot;REVEALOFF&quot;</span><span class="p">:</span> <span class="s2">&quot;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;STRIKETHROUGHOFF&quot;</span><span class="p">:</span> <span class="s2">&quot;29&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">ansi_color_name_to_escape_code</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a color name to the inner part of an ANSI escape code&quot;&quot;&quot;</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">_ensure_color_map</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cmap</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cmap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">RE_XONSH_COLOR</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2"> is not a color!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
    <span class="c1"># convert regex match into actual ANSI colors</span>
    <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NO_COLOR&quot;</span><span class="p">:</span>
            <span class="n">warn_deprecated_no_color</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
    <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="s2">&quot;bghex&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;48;5;&quot;</span> <span class="o">+</span> <span class="n">rgb_to_256</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="s2">&quot;bghex&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;48;5;&quot;</span> <span class="o">+</span> <span class="n">rgb_to_256</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fgcolor</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">color</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fgcolor</span><span class="o">.</span><span class="n">isdecimal</span><span class="p">():</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fgcolor</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fgcolor</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;38;&quot;</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span> <span class="o">+</span> <span class="n">fgcolor</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">fgcolor</span> <span class="o">==</span> <span class="s2">&quot;DEFAULT&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;39&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;when converting </span><span class="si">{!r}</span><span class="s2">, did not recognize </span><span class="si">{!r}</span><span class="s2"> within &quot;</span>
                    <span class="s2">&quot;the following color map as a valid color:</span><span class="se">\n\n</span><span class="si">{!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fgcolor</span><span class="p">,</span> <span class="n">cmap</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># have regular, non-background color</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="s2">&quot;modifiers&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="p">[</span><span class="n">ANSI_ESCAPE_MODIFIERS</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">]</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;38;5;&quot;</span> <span class="o">+</span> <span class="n">rgb_to_256</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">:])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;DEFAULT&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;39&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap</span><span class="p">[</span><span class="n">color</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span>
    <span class="n">cmap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">ansi_partial_color_format</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Formats a template string but only with respect to the colors.</span>
<span class="sd">    Another template string is returned, with the color values filled in.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    template : str</span>
<span class="sd">        The template string, potentially with color names.</span>
<span class="sd">    style : str, optional</span>
<span class="sd">        Style name to look up color map from.</span>
<span class="sd">    cmap : dict, optional</span>
<span class="sd">        A color map to use, this will prevent the color map from being</span>
<span class="sd">        looked up via the style name.</span>
<span class="sd">    hide : bool, optional</span>
<span class="sd">        Whether to wrap the color codes in the \\001 and \\002 escape</span>
<span class="sd">        codes, so that the color codes are not counted against line</span>
<span class="sd">        length.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A template string with the color values filled in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_ansi_partial_color_format_main</span><span class="p">(</span>
            <span class="n">template</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="n">hide</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">template</span>


<span class="k">def</span> <span class="nf">_ansi_partial_color_format_main</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">_ensure_color_map</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">overrides</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_STYLE_OVERRIDES&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">overrides</span><span class="p">:</span>
        <span class="n">cmap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_style_dict_to_ansi</span><span class="p">(</span><span class="n">overrides</span><span class="p">))</span>
    <span class="n">esc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\001</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">hide</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\002</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">hide</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">bopen</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span>
    <span class="n">bclose</span> <span class="o">=</span> <span class="s2">&quot;}&quot;</span>
    <span class="n">colon</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span>
    <span class="n">expl</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">literal</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="n">FORMATTER</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">template</span><span class="p">):</span>
        <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">literal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cmap</span><span class="p">:</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">esc</span><span class="p">,</span> <span class="n">cmap</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">m</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">iscolor</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">ansi_color_name_to_escape_code</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">cmap</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">esc</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">m</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bopen</span><span class="p">)</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expl</span><span class="p">)</span>
                <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colon</span><span class="p">)</span>
                <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bclose</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ansi_color_style_names</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns an iterable of all ANSI color style names.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ANSI_STYLES</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">ansi_color_style</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the current color map.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">ANSI_STYLES</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">ANSI_STYLES</span><span class="p">[</span><span class="n">style</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Could not find color style </span><span class="si">{0!r}</span><span class="s2">, using default.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">ANSI_STYLES</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cmap</span>


<span class="k">def</span> <span class="nf">ansi_reverse_style</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">return_style</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reverses an ANSI color style mapping so that escape codes map to</span>
<span class="sd">    colors. Style may either be string or mapping. May also return</span>
<span class="sd">    the style it looked up.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">ansi_style_by_name</span><span class="p">(</span><span class="n">style</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">style</span>
    <span class="n">reversed_style</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">style</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="c1"># add keys to make this more useful</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;BOLD_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;FAINT_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;ITALIC_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="s2">&quot;UNDERLINE_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;SLOWBLINK_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;6&quot;</span><span class="p">:</span> <span class="s2">&quot;FASTBLINK_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;7&quot;</span><span class="p">:</span> <span class="s2">&quot;INVERT_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;8&quot;</span><span class="p">:</span> <span class="s2">&quot;CONCEAL_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;9&quot;</span><span class="p">:</span> <span class="s2">&quot;STRIKETHROUGH_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;21&quot;</span><span class="p">:</span> <span class="s2">&quot;BOLDOFF_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;22&quot;</span><span class="p">:</span> <span class="s2">&quot;FAINTOFF_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;23&quot;</span><span class="p">:</span> <span class="s2">&quot;ITALICOFF_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;24&quot;</span><span class="p">:</span> <span class="s2">&quot;UNDERLINEOFF_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;25&quot;</span><span class="p">:</span> <span class="s2">&quot;BLINKOFF_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;27&quot;</span><span class="p">:</span> <span class="s2">&quot;INVERTOFF_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;28&quot;</span><span class="p">:</span> <span class="s2">&quot;REVEALOFF_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;29&quot;</span><span class="p">:</span> <span class="s2">&quot;STRIKETHROUGHOFF_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;38&quot;</span><span class="p">:</span> <span class="s2">&quot;SET_FOREGROUND_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;48&quot;</span><span class="p">:</span> <span class="s2">&quot;SET_BACKGROUND_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;38;2&quot;</span><span class="p">:</span> <span class="s2">&quot;SET_FOREGROUND_FAINT_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;48;2&quot;</span><span class="p">:</span> <span class="s2">&quot;SET_BACKGROUND_FAINT_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;38;5&quot;</span><span class="p">:</span> <span class="s2">&quot;SET_FOREGROUND_SLOWBLINK_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;48;5&quot;</span><span class="p">:</span> <span class="s2">&quot;SET_BACKGROUND_SLOWBLINK_&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">ec</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">reversed_style</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">no_left_zero</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_left_zero</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">no_left_zero</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">elif</span> <span class="n">no_left_zero</span> <span class="o">!=</span> <span class="n">ec</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">no_left_zero</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">reversed_style</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>
    <span class="c1"># return results</span>
    <span class="k">if</span> <span class="n">return_style</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">style</span><span class="p">,</span> <span class="n">reversed_style</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reversed_style</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">ANSI_ESCAPE_CODE_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\001?(\033\[)?([0-9;]+)m?\002?&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">ANSI_COLOR_NAME_SET_3INTS_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+_)?SET_(FORE|BACK)GROUND_FAINT_(\d+)_(\d+)_(\d+)&quot;</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">ANSI_COLOR_NAME_SET_SHORT_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+_)?SET_(FORE|BACK)GROUND_SLOWBLINK_(\d+)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_color_name_from_ints</span><span class="p">(</span><span class="n">ints</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">find_closest_color</span><span class="p">(</span><span class="n">ints</span><span class="p">,</span> <span class="n">BASE_XONSH_COLORS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;BACKGROUND_&quot;</span> <span class="o">+</span> <span class="n">name</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">name</span>


<span class="k">def</span> <span class="nf">ansi_color_escape_code_to_name</span><span class="p">(</span><span class="n">escape_code</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">reversed_style</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts an ANSI color code escape sequence to a tuple of color names</span>
<span class="sd">    in the provided style (&#39;default&#39; should almost be the style). For example,</span>
<span class="sd">    &#39;0&#39; becomes (&#39;RESET&#39;,) and &#39;32;41&#39; becomes (&#39;GREEN&#39;, &#39;BACKGROUND_RED&#39;).</span>
<span class="sd">    The style keyword may either be a string, in which the style is looked up,</span>
<span class="sd">    or an actual style dict.  You can also provide a reversed style mapping,</span>
<span class="sd">    too, which is just the keys/values of the style dict swapped. If reversed</span>
<span class="sd">    style is not provided, it is computed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reversed_style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">style</span><span class="p">,</span> <span class="n">reversed_style</span> <span class="o">=</span> <span class="n">ansi_reverse_style</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">return_style</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># strip some actual escape codes, if needed.</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">ANSI_ESCAPE_CODE_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">escape_code</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid ANSI color sequence &quot;</span><span class="si">{0}</span><span class="s1">&quot;, using &quot;RESET&quot; instead.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">escape_code</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,)</span>
    <span class="n">ec</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_ints</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">seen_set_foreback</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
        <span class="n">no_left_zero</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">e</span>
        <span class="k">if</span> <span class="n">seen_set_foreback</span> <span class="ow">and</span> <span class="n">n_ints</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">n_ints</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n_ints</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">seen_set_foreback</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reversed_style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">no_left_zero</span><span class="p">,</span> <span class="n">no_left_zero</span><span class="p">))</span>
        <span class="c1"># set the flags for next time</span>
        <span class="k">if</span> <span class="s2">&quot;38&quot;</span> <span class="o">==</span> <span class="n">e</span> <span class="ow">or</span> <span class="s2">&quot;48&quot;</span> <span class="o">==</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">seen_set_foreback</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">seen_set_foreback</span> <span class="ow">and</span> <span class="s2">&quot;2&quot;</span> <span class="o">==</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">n_ints</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">seen_set_foreback</span> <span class="ow">and</span> <span class="s2">&quot;5&quot;</span> <span class="o">==</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">n_ints</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># normalize names</span>
    <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">norm_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prefixes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,</span> <span class="s2">&quot;NO_COLOR&quot;</span><span class="p">):</span>
            <span class="c1"># skip most &#39;0&#39; entries</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="s2">&quot;BACKGROUND_&quot;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">prefixes</span> <span class="o">+=</span> <span class="n">n</span>
            <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">name</span> <span class="k">if</span> <span class="n">n</span> <span class="k">else</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">ANSI_COLOR_NAME_SET_SHORT_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pre</span><span class="p">,</span> <span class="n">fore_back</span><span class="p">,</span> <span class="n">short</span> <span class="o">=</span> <span class="n">ANSI_COLOR_NAME_SET_SHORT_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">_color_name_from_ints</span><span class="p">(</span>
                <span class="n">short_to_ints</span><span class="p">(</span><span class="n">short</span><span class="p">),</span> <span class="n">background</span><span class="o">=</span><span class="p">(</span><span class="n">fore_back</span> <span class="o">==</span> <span class="s2">&quot;BACK&quot;</span><span class="p">),</span> <span class="n">prefix</span><span class="o">=</span><span class="n">pre</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">ANSI_COLOR_NAME_SET_3INTS_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pre</span><span class="p">,</span> <span class="n">fore_back</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ANSI_COLOR_NAME_SET_3INTS_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">_color_name_from_ints</span><span class="p">(</span>
                <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span> <span class="n">background</span><span class="o">=</span><span class="p">(</span><span class="n">fore_back</span> <span class="o">==</span> <span class="s2">&quot;BACK&quot;</span><span class="p">),</span> <span class="n">prefix</span><span class="o">=</span><span class="n">pre</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;GROUND_FAINT_&quot;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
            <span class="c1"># have 1 or 2, but not 3 ints</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span>
            <span class="k">continue</span>
        <span class="c1"># error check</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iscolor</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Could not translate ANSI color code </span><span class="si">{escape_code!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;into a known color in the palette. Specifically, the </span><span class="si">{n!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;portion of </span><span class="si">{name!r}</span><span class="s2"> in </span><span class="si">{names!r}</span><span class="s2"> seems to missing.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escape_code</span><span class="o">=</span><span class="n">escape_code</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">norm_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># check if we have pre- &amp; post-fixes to apply to the last, non-background element</span>
    <span class="n">prefixes</span> <span class="o">+=</span> <span class="n">n</span>
    <span class="k">if</span> <span class="n">prefixes</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">norm_names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;BACKGROUND_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">norm_names</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">norm_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefixes</span> <span class="o">+</span> <span class="n">norm_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># only have background colors, so select WHITE as default color</span>
            <span class="n">norm_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefixes</span> <span class="o">+</span> <span class="s2">&quot;WHITE&quot;</span><span class="p">)</span>
    <span class="c1"># return</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">norm_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">norm_names</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_bw_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;0;30&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;0;37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;0;37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;0;37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;0;37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;0;37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;0;37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;0;37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACKGROUND_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;40&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACKGROUND_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACKGROUND_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACKGROUND_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACKGROUND_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACKGROUND_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACKGROUND_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACKGROUND_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;0;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;0;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;0;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;0;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;0;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;0;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;0;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;0;97&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_default_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Reset</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>  <span class="c1"># Text Reset</span>
        <span class="c1"># Regular Colors</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;30&quot;</span><span class="p">,</span>  <span class="c1"># BLACK</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;31&quot;</span><span class="p">,</span>  <span class="c1"># RED</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;32&quot;</span><span class="p">,</span>  <span class="c1"># GREEN</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;33&quot;</span><span class="p">,</span>  <span class="c1"># YELLOW</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;34&quot;</span><span class="p">,</span>  <span class="c1"># BLUE</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;35&quot;</span><span class="p">,</span>  <span class="c1"># PURPLE</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;36&quot;</span><span class="p">,</span>  <span class="c1"># CYAN</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;37&quot;</span><span class="p">,</span>  <span class="c1"># WHITE</span>
        <span class="c1"># Background</span>
        <span class="s2">&quot;BACKGROUND_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;40&quot;</span><span class="p">,</span>  <span class="c1"># BLACK</span>
        <span class="s2">&quot;BACKGROUND_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;41&quot;</span><span class="p">,</span>  <span class="c1"># RED</span>
        <span class="s2">&quot;BACKGROUND_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;42&quot;</span><span class="p">,</span>  <span class="c1"># GREEN</span>
        <span class="s2">&quot;BACKGROUND_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;43&quot;</span><span class="p">,</span>  <span class="c1"># YELLOW</span>
        <span class="s2">&quot;BACKGROUND_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;44&quot;</span><span class="p">,</span>  <span class="c1"># BLUE</span>
        <span class="s2">&quot;BACKGROUND_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;45&quot;</span><span class="p">,</span>  <span class="c1"># PURPLE</span>
        <span class="s2">&quot;BACKGROUND_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;46&quot;</span><span class="p">,</span>  <span class="c1"># CYAN</span>
        <span class="s2">&quot;BACKGROUND_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;47&quot;</span><span class="p">,</span>  <span class="c1"># WHITE</span>
        <span class="c1"># High Intensity</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;90&quot;</span><span class="p">,</span>  <span class="c1"># BLACK</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;91&quot;</span><span class="p">,</span>  <span class="c1"># RED</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;92&quot;</span><span class="p">,</span>  <span class="c1"># GREEN</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;93&quot;</span><span class="p">,</span>  <span class="c1"># YELLOW</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;94&quot;</span><span class="p">,</span>  <span class="c1"># BLUE</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;95&quot;</span><span class="p">,</span>  <span class="c1"># PURPLE</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;96&quot;</span><span class="p">,</span>  <span class="c1"># CYAN</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;97&quot;</span><span class="p">,</span>  <span class="c1"># WHITE</span>
        <span class="c1"># High Intensity backgrounds</span>
        <span class="s2">&quot;BACKGROUND_INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;100&quot;</span><span class="p">,</span>  <span class="c1"># BLACK</span>
        <span class="s2">&quot;BACKGROUND_INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;101&quot;</span><span class="p">,</span>  <span class="c1"># RED</span>
        <span class="s2">&quot;BACKGROUND_INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;102&quot;</span><span class="p">,</span>  <span class="c1"># GREEN</span>
        <span class="s2">&quot;BACKGROUND_INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;103&quot;</span><span class="p">,</span>  <span class="c1"># YELLOW</span>
        <span class="s2">&quot;BACKGROUND_INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;104&quot;</span><span class="p">,</span>  <span class="c1"># BLUE</span>
        <span class="s2">&quot;BACKGROUND_INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;105&quot;</span><span class="p">,</span>  <span class="c1"># PURPLE</span>
        <span class="s2">&quot;BACKGROUND_INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;106&quot;</span><span class="p">,</span>  <span class="c1"># CYAN</span>
        <span class="s2">&quot;BACKGROUND_INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;107&quot;</span><span class="p">,</span>  <span class="c1"># WHITE</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_monokai_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;63&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;81&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;40&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;89&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;184&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;44&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;148&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;141&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;197&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;186&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="c1">####################################</span>
<span class="c1"># Auto-generated below this line   #</span>
<span class="c1">####################################</span>


<span class="k">def</span> <span class="nf">_algol_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_algol_nu_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_autumn_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;19&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;37&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;33&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;33&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;217&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;130&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;217&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;130&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_borland_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;30&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;21&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;194&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;224&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_colorful_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;61&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;217&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;217&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;130&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_emacs_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;26&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;26&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;129&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;167&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;130&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_friendly_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;22&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;74&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;74&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;71&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;134&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;167&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_fruity_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;32&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;32&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;33&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;33&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;198&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;202&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;187&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;198&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;187&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;202&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_igor_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;21&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;30&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;30&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;21&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;30&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;163&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;163&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;163&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;163&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_lovelace_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;25&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;29&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;65&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;25&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;29&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;133&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;131&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;136&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;133&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;130&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_manni_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;30&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;40&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;105&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;45&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;113&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;165&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;202&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;224&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;221&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;165&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_murphy_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;63&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;86&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;86&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;213&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;209&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;222&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_native_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;52&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;67&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;68&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;87&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;70&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;160&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;214&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_paraiso_dark_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;95&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;39&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;72&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;95&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;79&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;72&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;203&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;220&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;203&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;79&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;214&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_paraiso_light_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;39&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;72&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;79&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;72&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;203&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;79&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;220&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;97&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;214&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_pastie_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;25&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;61&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;194&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;172&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;125&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;130&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_perldoc_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;134&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;134&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;167&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;166&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_rrt_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;117&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;117&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;46&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;117&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;117&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;122&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;46&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;213&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;222&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;213&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;117&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_tango_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;61&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;34&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;24&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;62&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;178&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;94&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_trac_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;30&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;100&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;59&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;60&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;194&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;137&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;224&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;145&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;100&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_vim_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;18&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;44&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;40&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;60&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;68&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;44&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;40&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;164&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;184&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;164&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;160&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;188&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;160&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_vs_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;21&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;09&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;124&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_xcode_style</span><span class="p">():</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;16&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;60&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;28&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLACK&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;60&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_BLUE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_CYAN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;60&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_GREEN&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;60&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;126&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;160&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;60&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INTENSE_YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;94&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PURPLE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;126&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RED&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;160&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHITE&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;60&quot;</span><span class="p">,</span>
        <span class="s2">&quot;YELLOW&quot;</span><span class="p">:</span> <span class="s2">&quot;38;5;94&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="n">ANSI_STYLES</span> <span class="o">=</span> <span class="n">LazyDict</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;algol&quot;</span><span class="p">:</span> <span class="n">_algol_style</span><span class="p">,</span>
        <span class="s2">&quot;algol_nu&quot;</span><span class="p">:</span> <span class="n">_algol_nu_style</span><span class="p">,</span>
        <span class="s2">&quot;autumn&quot;</span><span class="p">:</span> <span class="n">_autumn_style</span><span class="p">,</span>
        <span class="s2">&quot;borland&quot;</span><span class="p">:</span> <span class="n">_borland_style</span><span class="p">,</span>
        <span class="s2">&quot;bw&quot;</span><span class="p">:</span> <span class="n">_bw_style</span><span class="p">,</span>
        <span class="s2">&quot;colorful&quot;</span><span class="p">:</span> <span class="n">_colorful_style</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">_default_style</span><span class="p">,</span>
        <span class="s2">&quot;emacs&quot;</span><span class="p">:</span> <span class="n">_emacs_style</span><span class="p">,</span>
        <span class="s2">&quot;friendly&quot;</span><span class="p">:</span> <span class="n">_friendly_style</span><span class="p">,</span>
        <span class="s2">&quot;fruity&quot;</span><span class="p">:</span> <span class="n">_fruity_style</span><span class="p">,</span>
        <span class="s2">&quot;igor&quot;</span><span class="p">:</span> <span class="n">_igor_style</span><span class="p">,</span>
        <span class="s2">&quot;lovelace&quot;</span><span class="p">:</span> <span class="n">_lovelace_style</span><span class="p">,</span>
        <span class="s2">&quot;manni&quot;</span><span class="p">:</span> <span class="n">_manni_style</span><span class="p">,</span>
        <span class="s2">&quot;monokai&quot;</span><span class="p">:</span> <span class="n">_monokai_style</span><span class="p">,</span>
        <span class="s2">&quot;murphy&quot;</span><span class="p">:</span> <span class="n">_murphy_style</span><span class="p">,</span>
        <span class="s2">&quot;native&quot;</span><span class="p">:</span> <span class="n">_native_style</span><span class="p">,</span>
        <span class="s2">&quot;paraiso-dark&quot;</span><span class="p">:</span> <span class="n">_paraiso_dark_style</span><span class="p">,</span>
        <span class="s2">&quot;paraiso-light&quot;</span><span class="p">:</span> <span class="n">_paraiso_light_style</span><span class="p">,</span>
        <span class="s2">&quot;pastie&quot;</span><span class="p">:</span> <span class="n">_pastie_style</span><span class="p">,</span>
        <span class="s2">&quot;perldoc&quot;</span><span class="p">:</span> <span class="n">_perldoc_style</span><span class="p">,</span>
        <span class="s2">&quot;rrt&quot;</span><span class="p">:</span> <span class="n">_rrt_style</span><span class="p">,</span>
        <span class="s2">&quot;tango&quot;</span><span class="p">:</span> <span class="n">_tango_style</span><span class="p">,</span>
        <span class="s2">&quot;trac&quot;</span><span class="p">:</span> <span class="n">_trac_style</span><span class="p">,</span>
        <span class="s2">&quot;vim&quot;</span><span class="p">:</span> <span class="n">_vim_style</span><span class="p">,</span>
        <span class="s2">&quot;vs&quot;</span><span class="p">:</span> <span class="n">_vs_style</span><span class="p">,</span>
        <span class="s2">&quot;xcode&quot;</span><span class="p">:</span> <span class="n">_xcode_style</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;ANSI_STYLES&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">del</span> <span class="p">(</span>
    <span class="n">_algol_style</span><span class="p">,</span>
    <span class="n">_algol_nu_style</span><span class="p">,</span>
    <span class="n">_autumn_style</span><span class="p">,</span>
    <span class="n">_borland_style</span><span class="p">,</span>
    <span class="n">_bw_style</span><span class="p">,</span>
    <span class="n">_colorful_style</span><span class="p">,</span>
    <span class="n">_default_style</span><span class="p">,</span>
    <span class="n">_emacs_style</span><span class="p">,</span>
    <span class="n">_friendly_style</span><span class="p">,</span>
    <span class="n">_fruity_style</span><span class="p">,</span>
    <span class="n">_igor_style</span><span class="p">,</span>
    <span class="n">_lovelace_style</span><span class="p">,</span>
    <span class="n">_manni_style</span><span class="p">,</span>
    <span class="n">_monokai_style</span><span class="p">,</span>
    <span class="n">_murphy_style</span><span class="p">,</span>
    <span class="n">_native_style</span><span class="p">,</span>
    <span class="n">_paraiso_dark_style</span><span class="p">,</span>
    <span class="n">_paraiso_light_style</span><span class="p">,</span>
    <span class="n">_pastie_style</span><span class="p">,</span>
    <span class="n">_perldoc_style</span><span class="p">,</span>
    <span class="n">_rrt_style</span><span class="p">,</span>
    <span class="n">_tango_style</span><span class="p">,</span>
    <span class="n">_trac_style</span><span class="p">,</span>
    <span class="n">_vim_style</span><span class="p">,</span>
    <span class="n">_vs_style</span><span class="p">,</span>
    <span class="n">_xcode_style</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># Dynamically generated styles</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">make_ansi_style</span><span class="p">(</span><span class="n">palette</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes an ANSI color style from a color palette&quot;&quot;&quot;</span>
    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RESET&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">BASE_XONSH_COLORS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">closest</span> <span class="o">=</span> <span class="n">find_closest_color</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">palette</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">closest</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">closest</span><span class="p">])</span>
        <span class="n">short</span> <span class="o">=</span> <span class="n">rgb2short</span><span class="p">(</span><span class="n">closest</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">style</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;38;5;&quot;</span> <span class="o">+</span> <span class="n">short</span>
    <span class="k">return</span> <span class="n">style</span>


<span class="k">def</span> <span class="nf">_pygments_to_ansi_style</span><span class="p">(</span><span class="n">style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tries to convert the given pygments style to ANSI style.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    style : pygments style value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ANSI style</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ansi_style_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">_PART_STYLE_CODE_MAPPING</span><span class="p">:</span>
            <span class="n">ansi_style_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_PART_STYLE_CODE_MAPPING</span><span class="p">[</span><span class="n">part</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">part</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bg:&quot;</span><span class="p">:</span>
            <span class="n">ansi_style_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;48;5;&quot;</span> <span class="o">+</span> <span class="n">rgb2short</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="mi">3</span><span class="p">:])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ansi_style_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;38;5;&quot;</span> <span class="o">+</span> <span class="n">rgb2short</span><span class="p">(</span><span class="n">part</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ansi_style_list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_style_dict_to_ansi</span><span class="p">(</span><span class="n">styles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts pygments like style dict to ANSI rules&quot;&quot;&quot;</span>
    <span class="n">ansi_style</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">styles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>  <span class="c1"># convert pygments token to str</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Color&quot;</span><span class="p">:</span>
            <span class="n">ansi_style</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_pygments_to_ansi_style</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ansi_style</span>


<span class="k">def</span> <span class="nf">register_custom_ansi_style</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">styles</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register custom ANSI style.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Style name.</span>
<span class="sd">    styles : dict</span>
<span class="sd">        Token (or str) -&gt; style mapping.</span>
<span class="sd">    base : str, optional</span>
<span class="sd">        Base style to use as default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_style</span> <span class="o">=</span> <span class="n">ANSI_STYLES</span><span class="p">[</span><span class="n">base</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">base_style</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_style_dict_to_ansi</span><span class="p">(</span><span class="n">styles</span><span class="p">))</span>

    <span class="n">ANSI_STYLES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_style</span>


<span class="k">def</span> <span class="nf">ansi_style_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets or makes an ANSI color style by name. If the styles does not</span>
<span class="sd">    exist, it will look for a style using the pygments name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ANSI_STYLES</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ANSI_STYLES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">HAS_PYGMENTS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;could not find style </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="kn">from</span> <span class="nn">xonsh.pygments_cache</span> <span class="kn">import</span> <span class="n">get_style_by_name</span>
    <span class="kn">from</span> <span class="nn">pygments.util</span> <span class="kn">import</span> <span class="n">ClassNotFound</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pstyle</span> <span class="o">=</span> <span class="n">get_style_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="n">ClassNotFound</span><span class="p">):</span>
        <span class="n">pstyle</span> <span class="o">=</span> <span class="n">get_style_by_name</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
    <span class="n">palette</span> <span class="o">=</span> <span class="n">make_palette</span><span class="p">(</span><span class="n">pstyle</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">astyle</span> <span class="o">=</span> <span class="n">make_ansi_style</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>
    <span class="n">ANSI_STYLES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">astyle</span>
    <span class="k">return</span> <span class="n">astyle</span>

<span class="c1">#</span>
<span class="c1"># diff_history</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Tools for diff&#39;ing two xonsh history files in a meaningful fashion.&quot;&quot;&quot;</span>
<span class="n">difflib</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;difflib&#39;</span><span class="p">,</span> <span class="s1">&#39;difflib&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated datetime</span>
<span class="c1"># amalgamated itertools</span>
<span class="c1"># amalgamated argparse</span>
<span class="c1"># amalgamated typing</span>
<span class="c1"># amalgamated xonsh.lazyjson</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.color_tools</span>
<span class="n">REPLACE_S</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span>
<span class="n">DELETE_S</span> <span class="o">=</span> <span class="s2">&quot;delete&quot;</span>
<span class="n">INSERT_S</span> <span class="o">=</span> <span class="s2">&quot;insert&quot;</span>
<span class="n">EQUAL_S</span> <span class="o">=</span> <span class="s2">&quot;equal&quot;</span>


<span class="k">def</span> <span class="nf">bold_str_diff</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">sm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">()</span>
    <span class="n">aline</span> <span class="o">=</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;- &quot;</span>
    <span class="n">bline</span> <span class="o">=</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s2">&quot;+ &quot;</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">REPLACE_S</span><span class="p">:</span>
            <span class="n">aline</span> <span class="o">+=</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">BOLD_RED</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">]</span> <span class="o">+</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span>
            <span class="n">bline</span> <span class="o">+=</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">BOLD_GREEN</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]</span> <span class="o">+</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DELETE_S</span><span class="p">:</span>
            <span class="n">aline</span> <span class="o">+=</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">BOLD_RED</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">]</span> <span class="o">+</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">INSERT_S</span><span class="p">:</span>
            <span class="n">bline</span> <span class="o">+=</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">BOLD_GREEN</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]</span> <span class="o">+</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">EQUAL_S</span><span class="p">:</span>
            <span class="n">aline</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">]</span>
            <span class="n">bline</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;tag not understood&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aline</span> <span class="o">+</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">bline</span> <span class="o">+</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">redline</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{red}</span><span class="s2">- </span><span class="si">{line}{reset}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">red</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">greenline</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{green}</span><span class="s2">+ </span><span class="si">{line}{reset}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">green</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">highlighted_ndiff</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a highlighted string, with bold characters where different.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">()</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">linesm</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">REPLACE_S</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aline</span><span class="p">,</span> <span class="n">bline</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">bline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">redline</span><span class="p">(</span><span class="n">aline</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">aline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">greenline</span><span class="p">(</span><span class="n">bline</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">bold_str_diff</span><span class="p">(</span><span class="n">aline</span><span class="p">,</span> <span class="n">bline</span><span class="p">,</span> <span class="n">sm</span><span class="o">=</span><span class="n">linesm</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DELETE_S</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aline</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">redline</span><span class="p">(</span><span class="n">aline</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">INSERT_S</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bline</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">greenline</span><span class="p">(</span><span class="n">bline</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">EQUAL_S</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aline</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">aline</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;tag not understood&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">class</span> <span class="nc">HistoryDiffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class helps diff two xonsh history files.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">afile</span><span class="p">,</span> <span class="n">bfile</span><span class="p">,</span> <span class="n">reopen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        afile : file handle or str</span>
<span class="sd">            The first file to diff</span>
<span class="sd">        bfile : file handle or str</span>
<span class="sd">            The second file to diff</span>
<span class="sd">        reopen : bool, optional</span>
<span class="sd">            Whether or not to reopen the file handles each time. The default here is</span>
<span class="sd">            opposite from the LazyJSON default because we know that we will be doing</span>
<span class="sd">            a lot of reading so it is best to keep the handles open.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print a verbose amount of information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">LazyJSON</span><span class="p">(</span><span class="n">afile</span><span class="p">,</span> <span class="n">reopen</span><span class="o">=</span><span class="n">reopen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">LazyJSON</span><span class="p">(</span><span class="n">bfile</span><span class="p">,</span> <span class="n">reopen</span><span class="o">=</span><span class="n">reopen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sm</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="n">autojunk</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_header_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lj</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">lj</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lj</span><span class="o">.</span><span class="n">_f</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">lj</span><span class="p">[</span><span class="s2">&quot;sessionid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; [locked]&quot;</span> <span class="k">if</span> <span class="n">lj</span><span class="p">[</span><span class="s2">&quot;locked&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot; [unlocked]&quot;</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">lj</span><span class="p">[</span><span class="s2">&quot;ts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">ts0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; started: &quot;</span> <span class="o">+</span> <span class="n">ts0</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ts1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; stopped: &quot;</span> <span class="o">+</span> <span class="n">ts1</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; runtime: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ts1</span> <span class="o">-</span> <span class="n">ts0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes a header string difference.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{red}</span><span class="s2">--- </span><span class="si">{aline}{reset}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">{green}</span><span class="s2">+++ </span><span class="si">{bline}{reset}</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">aline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_header_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">),</span>
            <span class="n">bline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_header_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">),</span>
            <span class="n">red</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span>
            <span class="n">green</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span>
            <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_env_both_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_both</span><span class="p">,</span> <span class="n">aenv</span><span class="p">,</span> <span class="n">benv</span><span class="p">):</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">in_both</span><span class="p">):</span>
            <span class="n">aval</span> <span class="o">=</span> <span class="n">aenv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">bval</span> <span class="o">=</span> <span class="n">benv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">aval</span> <span class="o">==</span> <span class="n">bval</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0!r}</span><span class="s2"> is in both, but differs</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">bold_str_diff</span><span class="p">(</span><span class="n">aval</span><span class="p">,</span> <span class="n">bval</span><span class="p">,</span> <span class="n">sm</span><span class="o">=</span><span class="n">sm</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_env_in_one_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">xenv</span><span class="p">):</span>
        <span class="n">only_x</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">only_x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">xstr</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;    </span><span class="si">{0!r}</span><span class="s2">: </span><span class="si">{1!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">xenv</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">only_x</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">xstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">xstr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xstr</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">only_x</span><span class="p">])</span>
        <span class="n">in_x</span> <span class="o">=</span> <span class="s2">&quot;These vars are only in </span><span class="si">{color}{xid}{reset}</span><span class="s2">: {{</span><span class="si">{xstr}</span><span class="s2">}}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">in_x</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="n">xid</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span> <span class="n">xstr</span><span class="o">=</span><span class="n">xstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">envdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the difference between the environments.&quot;&quot;&quot;</span>
        <span class="n">aenv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">benv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">akeys</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">aenv</span><span class="p">)</span>
        <span class="n">bkeys</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">benv</span><span class="p">)</span>
        <span class="n">in_both</span> <span class="o">=</span> <span class="n">akeys</span> <span class="o">&amp;</span> <span class="n">bkeys</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_both</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">akeys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">bkeys</span><span class="p">):</span>
            <span class="n">keydiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_both_diff</span><span class="p">(</span><span class="n">in_both</span><span class="p">,</span> <span class="n">aenv</span><span class="p">,</span> <span class="n">benv</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keydiff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="n">in_a</span> <span class="o">=</span> <span class="n">in_b</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keydiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_both_diff</span><span class="p">(</span><span class="n">in_both</span><span class="p">,</span> <span class="n">aenv</span><span class="p">,</span> <span class="n">benv</span><span class="p">)</span>
            <span class="n">in_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_in_one_diff</span><span class="p">(</span>
                <span class="n">akeys</span><span class="p">,</span> <span class="n">bkeys</span><span class="p">,</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;sessionid&quot;</span><span class="p">],</span> <span class="n">aenv</span>
            <span class="p">)</span>
            <span class="n">in_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_in_one_diff</span><span class="p">(</span>
                <span class="n">bkeys</span><span class="p">,</span> <span class="n">akeys</span><span class="p">,</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;sessionid&quot;</span><span class="p">],</span> <span class="n">benv</span>
            <span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Environment</span><span class="se">\n</span><span class="s2">-----------</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">in_a</span> <span class="o">+</span> <span class="n">keydiff</span> <span class="o">+</span> <span class="n">in_b</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_cmd_in_one_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">xlj</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;cmd #</span><span class="si">{i}</span><span class="s2"> only in </span><span class="si">{color}{xid}{reset}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="n">xid</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">lt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{color}{pre}{reset}</span><span class="s2"> </span><span class="si">{line}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">lt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pre</span><span class="o">=</span><span class="s2">&quot;&gt;&gt;&gt;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">lt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">xlj</span><span class="p">[</span><span class="s2">&quot;cmds&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;Note: no output stored&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">out</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_cmd_out_and_rtn_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">aout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;cmds&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">bout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;cmds&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># s += &#39;Note: neither output stored\n&#39;</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">bout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;sessionid&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Note: only </span><span class="si">{red}{aid}{reset}</span><span class="s2"> output stored</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">red</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span> <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">aout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;sessionid&quot;</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Note: only </span><span class="si">{green}{bid}{reset}</span><span class="s2"> output stored</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">green</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span> <span class="n">bid</span><span class="o">=</span><span class="n">bid</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">aout</span> <span class="o">!=</span> <span class="n">bout</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Outputs differ</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">highlighted_ndiff</span><span class="p">(</span><span class="n">aout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">bout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">artn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;cmds&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">]</span>
        <span class="n">brtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;cmds&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">artn</span> <span class="o">!=</span> <span class="n">brtn</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;Return vals </span><span class="si">{red}{artn}{reset}</span><span class="s2"> &amp; </span><span class="si">{green}{brtn}{reset}</span><span class="s2"> differ</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">red</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span>
                <span class="n">green</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span>
                <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span>
                <span class="n">artn</span><span class="o">=</span><span class="n">artn</span><span class="p">,</span>
                <span class="n">brtn</span><span class="o">=</span><span class="n">brtn</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_cmd_replace_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ainp</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">binp</span><span class="p">,</span> <span class="n">bid</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;cmd #</span><span class="si">{i}</span><span class="s2"> in </span><span class="si">{red}{aid}{reset}</span><span class="s2"> is replaced by </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;cmd #</span><span class="si">{j}</span><span class="s2"> in </span><span class="si">{green}{bid}{reset}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
            <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
            <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
            <span class="n">bid</span><span class="o">=</span><span class="n">bid</span><span class="p">,</span>
            <span class="n">red</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span>
            <span class="n">green</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span>
            <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">highlighted_ndiff</span><span class="p">(</span><span class="n">ainp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">binp</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_out_and_rtn_diff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">cmdsdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the difference of the commands themselves.&quot;&quot;&quot;</span>
        <span class="n">aid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;sessionid&quot;</span><span class="p">]</span>
        <span class="n">bid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;sessionid&quot;</span><span class="p">]</span>
        <span class="n">ainps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;inp&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;cmds&quot;</span><span class="p">]]</span>
        <span class="n">binps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;inp&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;cmds&quot;</span><span class="p">]]</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">set_seqs</span><span class="p">(</span><span class="n">ainps</span><span class="p">,</span> <span class="n">binps</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">REPLACE_S</span><span class="p">:</span>
                <span class="n">zipper</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ainp</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">binp</span> <span class="ow">in</span> <span class="n">zipper</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">),</span> <span class="n">ainps</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">),</span> <span class="n">binps</span><span class="p">[</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_in_one_diff</span><span class="p">(</span><span class="n">ainp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_in_one_diff</span><span class="p">(</span><span class="n">binp</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">bid</span><span class="p">,</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_replace_diff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ainp</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">binp</span><span class="p">,</span> <span class="n">bid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">DELETE_S</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ainps</span><span class="p">[</span><span class="n">i1</span><span class="p">:</span><span class="n">i2</span><span class="p">],</span> <span class="n">i1</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_in_one_diff</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">INSERT_S</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">binps</span><span class="p">[</span><span class="n">j1</span><span class="p">:</span><span class="n">j2</span><span class="p">],</span> <span class="n">j1</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_in_one_diff</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">bid</span><span class="p">,</span> <span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">EQUAL_S</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">)):</span>
                    <span class="n">odiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmd_out_and_rtn_diff</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">odiff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;cmd #</span><span class="si">{i}</span><span class="s2"> in </span><span class="si">{red}{aid}{reset}</span><span class="s2"> input is the same as </span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;cmd #</span><span class="si">{j}</span><span class="s2"> in </span><span class="si">{green}{bid}{reset}</span><span class="s2">, but output differs:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">h</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                            <span class="n">aid</span><span class="o">=</span><span class="n">aid</span><span class="p">,</span>
                            <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
                            <span class="n">bid</span><span class="o">=</span><span class="n">bid</span><span class="p">,</span>
                            <span class="n">red</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span>
                            <span class="n">green</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">GREEN</span><span class="p">,</span>
                            <span class="n">reset</span><span class="o">=</span><span class="n">COLORS</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">odiff</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;tag not understood&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">return</span> <span class="s2">&quot;Commands</span><span class="se">\n</span><span class="s2">--------</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Formats the difference between the two history files.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">()</span>
        <span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">envdiff</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">ed</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdsdiff</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">cd</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>


<span class="n">_HD_PARSER</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">dh_create_parser</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_HD_PARSER</span>
    <span class="n">p_was_none</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_HD_PARSER</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">p_was_none</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_HD_PARSER</span>
    <span class="k">if</span> <span class="n">p_was_none</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="s2">&quot;diff-history&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;diffs two xonsh history files&quot;</span>
        <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--reopen&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;reopen&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;make lazy file loading reopen files each time&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;whether to print even more information&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;first file in diff&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;second file in diff&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_was_none</span><span class="p">:</span>
        <span class="n">_HD_PARSER</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">dh_main_action</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">hd</span> <span class="o">=</span> <span class="n">HistoryDiffer</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">reopen</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">reopen</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">print_color</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">format</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">stdout</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># dirstack</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Directory stack and associated utilities for the xonsh shell.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated argparse</span>
<span class="c1"># amalgamated glob</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated subprocess</span>
<span class="c1"># amalgamated typing</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.events</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="n">DIRSTACK</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="sd">&quot;&quot;&quot;A list containing the currently remembered directories.&quot;&quot;&quot;</span>
<span class="n">_unc_tempDrives</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="sd">&quot;&quot;&quot; drive: sharePath for temp drive letters we create for UNC mapping&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_unc_check_enabled</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Check whether CMD.EXE is enforcing no-UNC-as-working-directory check.</span>

<span class="sd">    Check can be disabled by setting {HKCU, HKLM}/SOFTWARE\Microsoft\Command Processor\DisableUNCCheck:REG_DWORD=1</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if `CMD.EXE` is enforcing the check (default Windows situation)</span>
<span class="sd">        False if check is explicitly disabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="kn">import</span> <span class="nn">winreg</span>

    <span class="n">wval</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">OpenKey</span><span class="p">(</span>
            <span class="n">winreg</span><span class="o">.</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;software\microsoft\command processor&quot;</span>
        <span class="p">)</span>
        <span class="n">wval</span><span class="p">,</span> <span class="n">wtype</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">QueryValueEx</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;DisableUNCCheck&quot;</span><span class="p">)</span>
        <span class="n">winreg</span><span class="o">.</span><span class="n">CloseKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">wval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key2</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">OpenKey</span><span class="p">(</span>
                <span class="n">winreg</span><span class="o">.</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;software\microsoft\command processor&quot;</span>
            <span class="p">)</span>
            <span class="n">wval</span><span class="p">,</span> <span class="n">wtype</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">QueryValueEx</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="s2">&quot;DisableUNCCheck&quot;</span><span class="p">)</span>
            <span class="n">winreg</span><span class="o">.</span><span class="n">CloseKey</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># NOQA</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">wval</span> <span class="k">else</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_is_unc_path</span><span class="p">(</span><span class="n">some_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;True if path starts with 2 backward (or forward, due to python path hacking) slashes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">some_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="ow">and</span> <span class="n">some_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">some_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="ow">and</span> <span class="n">some_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">altsep</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_unc_map_temp_drive</span><span class="p">(</span><span class="n">unc_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Map a new temporary drive letter for each distinct share,</span>
<span class="sd">    unless `CMD.EXE` is not insisting on non-UNC working directory.</span>

<span class="sd">    Emulating behavior of `CMD.EXE` `pushd`, create a new mapped drive (starting from Z: towards A:, skipping existing</span>
<span class="sd">     drive letters) for each new UNC path user selects.</span>

<span class="sd">    Args:</span>
<span class="sd">        unc_path: the path specified by user.  Assumed to be a UNC path of form \\&lt;server&gt;\share...</span>

<span class="sd">    Returns:</span>
<span class="sd">        a replacement for `unc_path` to be used as the actual new working directory.</span>
<span class="sd">        Note that the drive letter may be a the same as one already mapped if the server and share portion of `unc_path`</span>
<span class="sd">         is the same as one still active on the stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_unc_tempDrives</span>
    <span class="k">assert</span> <span class="n">unc_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">altsep</span><span class="p">),</span> <span class="s2">&quot;unc_path is UNC form of path&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_unc_check_enabled</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">unc_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unc_share</span><span class="p">,</span> <span class="n">rem_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">unc_path</span><span class="p">)</span>
        <span class="n">unc_share</span> <span class="o">=</span> <span class="n">unc_share</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">_unc_tempDrives</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_unc_tempDrives</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span class="n">unc_share</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">rem_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">dord</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>  <span class="c1"># find unused drive letter starting from z:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;NET&quot;</span><span class="p">,</span> <span class="s2">&quot;USE&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">unc_share</span><span class="p">],</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">_unc_tempDrives</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">unc_share</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">rem_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_unc_unmap_temp_drive</span><span class="p">(</span><span class="n">left_drive</span><span class="p">,</span> <span class="n">cwd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unmap a temporary drive letter if it is no longer needed.</span>
<span class="sd">    Called after popping `DIRSTACK` and changing to new working directory, so we need stack *and*</span>
<span class="sd">    new current working directory to be sure drive letter no longer needed.</span>

<span class="sd">    Args:</span>
<span class="sd">        left_drive: driveletter (and colon) of working directory we just left</span>
<span class="sd">        cwd: full path of new current working directory</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">_unc_tempDrives</span>

    <span class="k">if</span> <span class="n">left_drive</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_unc_tempDrives</span><span class="p">:</span>  <span class="c1"># if not one we&#39;ve mapped, don&#39;t unmap it</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">DIRSTACK</span> <span class="o">+</span> <span class="p">[</span><span class="n">cwd</span><span class="p">]:</span>  <span class="c1"># if still in use , don&#39;t unmap it.</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">left_drive</span><span class="p">):</span>
            <span class="k">return</span>

    <span class="n">_unc_tempDrives</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">left_drive</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;NET&quot;</span><span class="p">,</span> <span class="s2">&quot;USE&quot;</span><span class="p">,</span> <span class="n">left_drive</span><span class="p">,</span> <span class="s2">&quot;/delete&quot;</span><span class="p">],</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>


<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_chdir&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_chdir(olddir: str, newdir: str) -&gt; None</span>

<span class="sd">Fires when the current directory is changed for any reason.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_cwd</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_change_working_directory</span><span class="p">(</span><span class="n">newdir</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">newdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">follow_symlinks</span><span class="p">:</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="n">absnew</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">absnew</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">get_sep</span><span class="p">()):</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">new</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;..&quot;</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;OLDPWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old</span>
        <span class="k">if</span> <span class="n">new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">absnew</span>

    <span class="c1"># Fire event if the path actually changed</span>
    <span class="k">if</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]:</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_chdir</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">olddir</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">newdir</span><span class="o">=</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_try_cdpath</span><span class="p">(</span><span class="n">apath</span><span class="p">):</span>
    <span class="c1"># NOTE: this CDPATH implementation differs from the bash one.</span>
    <span class="c1"># In bash if a CDPATH is set, an unqualified local folder</span>
    <span class="c1"># is considered after all CDPATHs, example:</span>
    <span class="c1"># CDPATH=$HOME/src (with src/xonsh/ inside)</span>
    <span class="c1"># $ cd xonsh -&gt; src/xonsh (with xonsh/xonsh)</span>
    <span class="c1"># a second $ cd xonsh has no effects, to move in the nested xonsh</span>
    <span class="c1"># in bash a full $ cd ./xonsh is needed.</span>
    <span class="c1"># In xonsh a relative folder is always preferred.</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">cdpaths</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CDPATH&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cdp</span> <span class="ow">in</span> <span class="n">cdpaths</span><span class="p">:</span>
        <span class="n">globber</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cdp</span><span class="p">,</span> <span class="n">apath</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cdpath_prefixed_path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">globber</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cdpath_prefixed_path</span>
    <span class="k">return</span> <span class="n">apath</span>


<span class="k">def</span> <span class="nf">cd</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Changes the directory.</span>

<span class="sd">    If no directory is specified (i.e. if `args` is None) then this</span>
<span class="sd">    changes to the current user&#39;s home directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">oldpwd</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OLDPWD&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span>

    <span class="n">follow_symlinks</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-P&quot;</span><span class="p">:</span>
        <span class="n">follow_symlinks</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">oldpwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">oldpwd</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;cd: no previous directory stored</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;cd: Invalid destination: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;cd: Invalid destination: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">):</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;cd: Too few elements in dirstack (</span><span class="si">{0}</span><span class="s2"> elements)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">)),</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">DIRSTACK</span><span class="p">[</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">_try_cdpath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;cd takes 0 or 1 arguments, not </span><span class="si">{0}</span><span class="s2">. An additional `-P` &quot;</span>
                <span class="s2">&quot;flag can be passed in first position to follow symlinks.&quot;</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;cd: no such file or directory: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;cd: </span><span class="si">{0}</span><span class="s2"> is not a directory</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;cd: permission denied: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">ON_WINDOWS</span>
        <span class="ow">and</span> <span class="n">_is_unc_path</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">_unc_check_enabled</span><span class="p">()</span>
        <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTO_PUSHD&quot;</span><span class="p">))</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cd: can&#39;t cd to UNC path on Windows, unless $AUTO_PUSHD set or reg entry &quot;</span>
            <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;HKCU\SOFTWARE\MICROSOFT\Command Processor\DisableUNCCheck:DWORD = 1&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># now, push the directory onto the dirstack if AUTO_PUSHD is set</span>
    <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTO_PUSHD&quot;</span><span class="p">):</span>
        <span class="n">pushd</span><span class="p">([</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">and</span> <span class="n">_is_unc_path</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">_unc_map_temp_drive</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">pushd_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s2">&quot;pushd&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-n&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;cd&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Suppresses the normal change of directory when&quot;</span>
        <span class="s2">&quot; adding directories to the stack, so that only the&quot;</span>
        <span class="s2">&quot; stack is manipulated.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;quiet&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not call dirs, regardless of $PUSHD_SILENT&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">pushd</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;xonsh command: pushd</span>

<span class="sd">    Adds a directory to the top of the directory stack, or rotates the stack,</span>
<span class="sd">    making the new top of the stack the current working directory.</span>

<span class="sd">    On Windows, if the path is a UNC path (begins with `\\&lt;server&gt;\&lt;share&gt;`) and if the `DisableUNCCheck` registry</span>
<span class="sd">    value is not enabled, creates a temporary mapped drive letter and sets the working directory there, emulating</span>
<span class="sd">    behavior of `PUSHD` in `CMD.EXE`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DIRSTACK</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">pushd_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>

    <span class="n">pwd</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PUSHD_MINUS&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">BACKWARD</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">FORWARD</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BACKWARD</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="n">FORWARD</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_pwd</span> <span class="o">=</span> <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;pushd: Directory stack is empty</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">):</span>
        <span class="n">new_pwd</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dir</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to pushd: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to pushd: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Too few elements in dirstack (</span><span class="si">{0}</span><span class="s2"> elements)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">)),</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">FORWARD</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">):</span>
                <span class="n">new_pwd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_pwd</span> <span class="o">=</span> <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">num</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">BACKWARD</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_pwd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_pwd</span> <span class="o">=</span> <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to pushd: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">new_pwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">and</span> <span class="n">_is_unc_path</span><span class="p">(</span><span class="n">new_pwd</span><span class="p">):</span>
            <span class="n">new_pwd</span> <span class="o">=</span> <span class="n">_unc_map_temp_drive</span><span class="p">(</span><span class="n">new_pwd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span>
            <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">pwd</span><span class="p">))</span>
            <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">new_pwd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">new_pwd</span><span class="p">))</span>

    <span class="n">maxsize</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DIRSTACK_SIZE&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxsize</span><span class="p">:</span>
        <span class="n">DIRSTACK</span> <span class="o">=</span> <span class="n">DIRSTACK</span><span class="p">[:</span><span class="n">maxsize</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PUSHD_SILENT&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dirs</span><span class="p">([],</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">popd_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s2">&quot;popd&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-n&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;cd&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Suppresses the normal change of directory when&quot;</span>
        <span class="s2">&quot; adding directories to the stack, so that only the&quot;</span>
        <span class="s2">&quot; stack is manipulated.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;quiet&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not call dirs, regardless of $PUSHD_SILENT&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">popd</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    xonsh command: popd</span>

<span class="sd">    Removes entries from the directory stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DIRSTACK</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">pushd_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>

    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PUSHD_MINUS&quot;</span><span class="p">):</span>
        <span class="n">BACKWARD</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">FORWARD</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BACKWARD</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">FORWARD</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_pwd</span> <span class="o">=</span> <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;popd: Directory stack is empty</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to popd: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to popd: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Too few elements in dirstack (</span><span class="si">{0}</span><span class="s2"> elements)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">)),</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">FORWARD</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">):</span>
                <span class="n">new_pwd</span> <span class="o">=</span> <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_pwd</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">DIRSTACK</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">num</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">BACKWARD</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_pwd</span> <span class="o">=</span> <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_pwd</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">DIRSTACK</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to popd: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">new_pwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
            <span class="n">pwd</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span>

            <span class="n">_change_working_directory</span><span class="p">(</span><span class="n">new_pwd</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
                <span class="n">drive</span><span class="p">,</span> <span class="n">rem_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
                <span class="n">_unc_unmap_temp_drive</span><span class="p">(</span><span class="n">drive</span><span class="o">.</span><span class="n">casefold</span><span class="p">(),</span> <span class="n">new_pwd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">quiet</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PUSHD_SILENT&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dirs</span><span class="p">([],</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">dirs_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s2">&quot;dirs&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;clear&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Clears the directory stack by deleting all of&quot;</span> <span class="s2">&quot; the entries.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;print_long&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print the directory stack with one entry per&quot;</span> <span class="s2">&quot; line.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print the directory stack with one entry per&quot;</span>
        <span class="s2">&quot; line, prefixing each entry with its index in the&quot;</span>
        <span class="s2">&quot; stack.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-l&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;long&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Produces a longer listing; the default listing&quot;</span>
        <span class="s2">&quot; format uses a tilde to denote the home directory.&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">dirs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;xonsh command: dirs</span>

<span class="sd">    Displays the list of currently remembered directories.  Can also be used</span>
<span class="sd">    to clear the directory stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DIRSTACK</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">dirs_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">dirstack</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">])]</span> <span class="o">+</span> <span class="n">DIRSTACK</span>

    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PUSHD_MINUS&quot;</span><span class="p">):</span>
        <span class="n">BACKWARD</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">FORWARD</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BACKWARD</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">FORWARD</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="p">:</span>
        <span class="n">DIRSTACK</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">long</span><span class="p">:</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">dirstack</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;~&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dirstack</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
            <span class="n">blanks</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">pad</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ix</span><span class="p">)))</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blanks</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">print_long</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">N</span>
    <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to dirs: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to dirs: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)),</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Too few elements in dirstack (</span><span class="si">{0}</span><span class="s2"> elements)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)),</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">BACKWARD</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">num</span>
        <span class="k">elif</span> <span class="n">N</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">FORWARD</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">num</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid argument to dirs: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">1</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>

<span class="c1">#</span>
<span class="c1"># execer</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Implements the xonsh executer.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated types</span>
<span class="c1"># amalgamated inspect</span>
<span class="c1"># amalgamated builtins</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="c1"># amalgamated xonsh.ast</span>
<span class="c1"># amalgamated xonsh.parser</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="k">class</span> <span class="nc">Execer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Executes xonsh code in a context.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&lt;xonsh-code&gt;&quot;</span><span class="p">,</span>
        <span class="n">debug_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">parser_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">xonsh_ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scriptcache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cacheall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            File we are to execute.</span>
<span class="sd">        debug_level : int, optional</span>
<span class="sd">            Debugging level to use in lexing and parsing.</span>
<span class="sd">        parser_args : dict, optional</span>
<span class="sd">            Arguments to pass down to the parser.</span>
<span class="sd">        unload : bool, optional</span>
<span class="sd">            Whether or not to unload xonsh builtins upon deletion.</span>
<span class="sd">        xonsh_ctx : dict or None, optional</span>
<span class="sd">            Xonsh xontext to load as xonsh.built_ins.XSH.ctx</span>
<span class="sd">        scriptcache : bool, optional</span>
<span class="sd">            Whether or not to use a precompiled bytecode cache when execing</span>
<span class="sd">            code, default: True.</span>
<span class="sd">        cacheall : bool, optional</span>
<span class="sd">            Whether or not to cache all xonsh code, and not just files. If this</span>
<span class="sd">            is set to true, it will cache command line input too, default: False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser_args</span> <span class="o">=</span> <span class="n">parser_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span><span class="o">**</span><span class="n">parser_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">=</span> <span class="n">debug_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unload</span> <span class="o">=</span> <span class="n">unload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptcache</span> <span class="o">=</span> <span class="n">scriptcache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cacheall</span> <span class="o">=</span> <span class="n">cacheall</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctxtransformer</span> <span class="o">=</span> <span class="n">CtxAwareTransformer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">XSH</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">execer</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">xonsh_ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unload</span><span class="p">:</span>
            <span class="n">XSH</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses xonsh code in a context-aware fashion. For context-free</span>
<span class="sd">        parsing, please use the Parser class directly or pass in</span>
<span class="sd">        transform=False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">transform</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                <span class="nb">input</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">debug_level</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Parsing actually happens in a couple of phases. The first is a</span>
        <span class="c1"># shortcut for a context-free parser. Normally, all subprocess</span>
        <span class="c1"># lines should be wrapped in $(), to indicate that they are a</span>
        <span class="c1"># subproc. But that would be super annoying. Unfortunately, Python</span>
        <span class="c1"># mode - after indentation - is whitespace agnostic while, using</span>
        <span class="c1"># the Python token, subproc mode is whitespace aware. That is to say,</span>
        <span class="c1"># in Python mode &quot;ls -l&quot;, &quot;ls-l&quot;, and &quot;ls - l&quot; all parse to the</span>
        <span class="c1"># same AST because whitespace doesn&#39;t matter to the minus binary op.</span>
        <span class="c1"># However, these phases all have very different meaning in subproc</span>
        <span class="c1"># mode. The &#39;right&#39; way to deal with this is to make the entire</span>
        <span class="c1"># grammar whitespace aware, and then ignore all of the whitespace</span>
        <span class="c1"># tokens for all of the Python rules. The lazy way implemented here</span>
        <span class="c1"># is to parse a line a second time with a $() wrapper if it fails</span>
        <span class="c1"># the first time. This is a context-free phase.</span>
        <span class="n">tree</span><span class="p">,</span> <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ctx_free</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Now we need to perform context-aware AST transformation. This is</span>
        <span class="c1"># because the &quot;ls -l&quot; is valid Python. The only way that we know</span>
        <span class="c1"># it is not actually Python is by checking to see if the first token</span>
        <span class="c1"># (ls) is part of the execution context. If it isn&#39;t, then we will</span>
        <span class="c1"># assume that this line is supposed to be a subprocess line, assuming</span>
        <span class="c1"># it also is valid as a subprocess line.</span>
        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctxtransformer</span><span class="o">.</span><span class="n">ctxvisit</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">debug_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">,</span>
        <span class="n">glbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">locs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compiles xonsh code into a Python code object, which may then</span>
<span class="sd">        be execed or evaled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_filename</span>
        <span class="k">if</span> <span class="n">glbs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">locs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stacklevel</span><span class="p">):</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
            <span class="n">glbs</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span> <span class="k">if</span> <span class="n">glbs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">glbs</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span> <span class="k">if</span> <span class="n">locs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">locs</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">builtins</span><span class="p">))</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">glbs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">locs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># handles comment only input</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">glbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">locs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluates (and returns) xonsh code.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span>
                <span class="n">glbs</span><span class="o">=</span><span class="n">glbs</span><span class="p">,</span>
                <span class="n">locs</span><span class="o">=</span><span class="n">locs</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># handles comment only input</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">glbs</span><span class="p">,</span> <span class="n">locs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">,</span>
        <span class="n">glbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">locs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute xonsh code.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">input</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="nb">input</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span>
                <span class="n">glbs</span><span class="o">=</span><span class="n">glbs</span><span class="p">,</span>
                <span class="n">locs</span><span class="o">=</span><span class="n">locs</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># handles comment only input</span>
        <span class="k">return</span> <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">glbs</span><span class="p">,</span> <span class="n">locs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_debug_wrapping</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">sbpline</span><span class="p">,</span> <span class="n">last_error_line</span><span class="p">,</span> <span class="n">last_error_col</span><span class="p">,</span> <span class="n">maxcol</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;print some debugging info if asked for.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">:</span><span class="si">{2}{3}</span><span class="s2"> - </span><span class="si">{4}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">:</span><span class="si">{2}{3}</span><span class="s2"> + </span><span class="si">{5}</span><span class="s2">&quot;</span>
            <span class="n">mstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">maxcol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">maxcol</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">last_error_line</span><span class="p">,</span> <span class="n">last_error_col</span><span class="p">,</span> <span class="n">mstr</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">sbpline</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_ctx_free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logical_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">last_error_line</span> <span class="o">=</span> <span class="n">last_error_col</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">original_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">greedy</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">logical_input</span><span class="p">:</span>
            <span class="n">beg_spaces</span> <span class="o">=</span> <span class="n">starting_whitespace</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">beg_spaces</span><span class="p">)</span> <span class="p">:]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">parsed</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                    <span class="nb">input</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                    <span class="n">debug_level</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">IndentationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">original_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">original_error</span>
            <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">original_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">original_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">last_error_line</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">lineno</span>
                    <span class="ow">and</span> <span class="n">last_error_col</span> <span class="ow">in</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">original_error</span> <span class="kn">from</span> <span class="bp">None</span>
                <span class="k">elif</span> <span class="n">last_error_line</span> <span class="o">!=</span> <span class="n">e</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">lineno</span><span class="p">:</span>
                    <span class="n">original_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="n">last_error_col</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span>
                <span class="n">last_error_line</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">lineno</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">last_error_line</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">line</span><span class="p">,</span> <span class="n">nlogical</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_logical_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nlogical</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">logical_input</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">sbpline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ctx_free</span><span class="p">(</span>
                        <span class="n">line</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">logical_input</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print_debug_wrapping</span><span class="p">(</span>
                        <span class="n">line</span><span class="p">,</span> <span class="n">sbpline</span><span class="p">,</span> <span class="n">last_error_line</span><span class="p">,</span> <span class="n">last_error_col</span><span class="p">,</span> <span class="n">maxcol</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)</span>
                    <span class="n">replace_logical_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">sbpline</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">nlogical</span><span class="p">)</span>
                    <span class="n">last_error_col</span> <span class="o">+=</span> <span class="mi">3</span>
                    <span class="nb">input</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># whitespace only lines are not valid syntax in Python&#39;s</span>
                    <span class="c1"># interactive mode=&#39;single&#39;, who knew?! Just ignore them.</span>
                    <span class="c1"># this might cause actual syntax errors to have bad line</span>
                    <span class="c1"># numbers reported, but should only affect interactive mode</span>
                    <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">last_error_line</span> <span class="o">=</span> <span class="n">last_error_col</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="nb">input</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">last_error_line</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ends_with_colon_token</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># catch non-indented blocks and raise error.</span>
                    <span class="n">prev_indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
                    <span class="n">curr_indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">prev_indent</span> <span class="o">==</span> <span class="n">curr_indent</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">original_error</span>
                <span class="n">lexer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span>
                <span class="n">maxcol</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">greedy</span>
                    <span class="k">else</span> <span class="n">find_next_break</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">mincol</span><span class="o">=</span><span class="n">last_error_col</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="n">lexer</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">greedy</span> <span class="ow">and</span> <span class="n">maxcol</span> <span class="ow">in</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">column</span><span class="p">):</span>
                    <span class="c1"># go greedy the first time if the syntax error was because</span>
                    <span class="c1"># we hit an end token out of place. This usually indicates</span>
                    <span class="c1"># a subshell or maybe a macro.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">balanced_parens</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">maxcol</span><span class="o">=</span><span class="n">maxcol</span><span class="p">):</span>
                        <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">maxcol</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">sbpline</span> <span class="o">=</span> <span class="n">subproc_toks</span><span class="p">(</span>
                    <span class="n">line</span><span class="p">,</span> <span class="n">returnline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">greedy</span><span class="o">=</span><span class="n">greedy</span><span class="p">,</span> <span class="n">maxcol</span><span class="o">=</span><span class="n">maxcol</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="n">lexer</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">sbpline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># subprocess line had no valid tokens,</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># likely because it only contained a comment.</span>
                        <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="n">last_error_line</span> <span class="o">=</span> <span class="n">last_error_col</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="nb">input</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">greedy</span><span class="p">:</span>
                        <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># or for some other syntax error</span>
                        <span class="k">raise</span> <span class="n">original_error</span>
                <span class="k">elif</span> <span class="n">sbpline</span><span class="p">[</span><span class="n">last_error_col</span><span class="p">:]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                    <span class="s2">&quot;![![&quot;</span>
                <span class="p">)</span> <span class="ow">or</span> <span class="n">sbpline</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;![![&quot;</span><span class="p">):</span>
                    <span class="c1"># if we have already wrapped this in subproc tokens</span>
                    <span class="c1"># and it still doesn&#39;t work, adding more won&#39;t help</span>
                    <span class="c1"># anything</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">greedy</span><span class="p">:</span>
                        <span class="n">greedy</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">original_error</span>
                <span class="c1"># replace the line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_debug_wrapping</span><span class="p">(</span>
                    <span class="n">line</span><span class="p">,</span> <span class="n">sbpline</span><span class="p">,</span> <span class="n">last_error_line</span><span class="p">,</span> <span class="n">last_error_col</span><span class="p">,</span> <span class="n">maxcol</span><span class="o">=</span><span class="n">maxcol</span>
                <span class="p">)</span>
                <span class="n">replace_logical_line</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">sbpline</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">nlogical</span><span class="p">)</span>
                <span class="n">last_error_col</span> <span class="o">+=</span> <span class="mi">3</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logical_input</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">beg_spaces</span> <span class="o">+</span> <span class="nb">input</span>
        <span class="k">return</span> <span class="n">tree</span><span class="p">,</span> <span class="nb">input</span>

<span class="c1">#</span>
<span class="c1"># shell</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The xonsh shell&quot;&quot;&quot;</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated time</span>
<span class="c1"># amalgamated difflib</span>
<span class="c1"># amalgamated warnings</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.events</span>
<span class="kn">from</span> <span class="nn">xonsh.history.dummy</span> <span class="kn">import</span> <span class="n">DummyHistory</span>
<span class="n">xhm</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;xonsh&#39;</span><span class="p">,</span> <span class="s1">&#39;xonsh.history.main&#39;</span><span class="p">,</span> <span class="s1">&#39;xhm&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_transform_command&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_transform_command(cmd: str) -&gt; str</span>

<span class="sd">Fired to request xontribs to transform a command line. Return the transformed</span>
<span class="sd">command, or the same command if no transformation occurs. Only done for</span>
<span class="sd">interactive sessions.</span>

<span class="sd">This may be fired multiple times per command, with other transformers input or</span>
<span class="sd">output, so design any handlers for this carefully.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_precommand&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_precommand(cmd: str) -&gt; None</span>

<span class="sd">Fires just before a command is executed.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_postcommand&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_postcommand(cmd: str, rtn: int, out: str or None, ts: list) -&gt; None</span>

<span class="sd">Fires just after a command is executed. The arguments are the same as history.</span>

<span class="sd">Parameters:</span>

<span class="sd">* ``cmd``: The command that was executed (after transformation)</span>
<span class="sd">* ``rtn``: The result of the command executed (``0`` for success)</span>
<span class="sd">* ``out``: If xonsh stores command output, this is the output</span>
<span class="sd">* ``ts``: Timestamps, in the order of ``[starting, ending]``</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_pre_prompt_format&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_pre_prompt_format() -&gt; None</span>

<span class="sd">Fires before the prompt will be formatted</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_pre_prompt&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_pre_prompt() -&gt; None</span>

<span class="sd">Fires just before showing the prompt</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_post_prompt&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_post_prompt() -&gt; None</span>

<span class="sd">Fires just after the prompt returns</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">transform_command</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">show_diff</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the results of firing the precommand handles.&quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getrecursionlimit</span><span class="p">()</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">src</span>
    <span class="k">while</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">lst</span><span class="p">:</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">src</span>
        <span class="n">srcs</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">on_transform_command</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">src</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">lst</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">s</span>
                <span class="k">break</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">print_exception</span><span class="p">(</span>
                <span class="s2">&quot;Modifications to source input took more than &quot;</span>
                <span class="s2">&quot;the recursion limit number of iterations to &quot;</span>
                <span class="s2">&quot;converge.&quot;</span>
            <span class="p">)</span>
    <span class="n">debug_level</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_DEBUG&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_diff</span> <span class="ow">and</span> <span class="n">debug_level</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span>
            <span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span>
                <span class="n">raw</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">src</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">fromfile</span><span class="o">=</span><span class="s2">&quot;before precommand event&quot;</span><span class="p">,</span>
                <span class="n">tofile</span><span class="o">=</span><span class="s2">&quot;after precommand event&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">src</span>


<span class="k">class</span> <span class="nc">Shell</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main xonsh shell.</span>

<span class="sd">    Initializes execution environment and decides if prompt_toolkit or</span>
<span class="sd">    readline version of shell should be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shell_type_aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
        <span class="s2">&quot;best&quot;</span><span class="p">:</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span>
        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="s2">&quot;dumb&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dumb&quot;</span><span class="p">:</span> <span class="s2">&quot;dumb&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ptk&quot;</span><span class="p">:</span> <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">,</span>  <span class="c1"># there&#39;s only 1 prompt_toolkit shell (now)</span>
        <span class="s2">&quot;prompt-toolkit&quot;</span><span class="p">:</span> <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">:</span> <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rand&quot;</span><span class="p">:</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span>
        <span class="s2">&quot;random&quot;</span><span class="p">:</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rl&quot;</span><span class="p">:</span> <span class="s2">&quot;readline&quot;</span><span class="p">,</span>
        <span class="s2">&quot;readline&quot;</span><span class="p">:</span> <span class="s2">&quot;readline&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">choose_shell_type</span><span class="p">(</span><span class="n">init_shell_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># pick a valid shell -- if no shell is specified by the user,</span>
        <span class="c1"># shell type is pulled from env</span>
        <span class="c1"># extracted for testability</span>
        <span class="n">shell_type</span> <span class="o">=</span> <span class="n">init_shell_type</span>
        <span class="k">if</span> <span class="n">shell_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">shell_type</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SHELL_TYPE&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="c1"># This bricks interactive xonsh</span>
                <span class="c1"># Can happen from the use of .xinitrc, .xsession, etc</span>
                <span class="c1"># odd logic.  We don&#39;t override if shell.__init__( shell_type=&quot;none&quot;),</span>
                <span class="c1"># only if it come from environment?</span>
                <span class="n">shell_type</span> <span class="o">=</span> <span class="s2">&quot;best&quot;</span>
        <span class="n">shell_type</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">shell_type_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shell_type</span><span class="p">,</span> <span class="n">shell_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span> <span class="ow">or</span> <span class="n">shell_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shell_type</span> <span class="o">=</span> <span class="n">best_shell_type</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">env</span> <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TERM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;dumb&quot;</span><span class="p">:</span>
            <span class="n">shell_type</span> <span class="o">=</span> <span class="s2">&quot;dumb&quot;</span>
        <span class="k">elif</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="n">shell_type</span> <span class="o">=</span> <span class="n">simple_random_choice</span><span class="p">((</span><span class="s2">&quot;readline&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_prompt_toolkit</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;prompt-toolkit&#39; python package is not installed. Falling back to readline.&quot;</span>
                <span class="p">)</span>
                <span class="n">shell_type</span> <span class="o">=</span> <span class="s2">&quot;readline&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">ptk_above_min_supported</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Installed prompt-toolkit version &lt; v</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> is not &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="o">*</span><span class="n">minimum_required_ptk_version</span>
                    <span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;supported. Falling back to readline.&quot;</span>
                <span class="p">)</span>
                <span class="n">shell_type</span> <span class="o">=</span> <span class="s2">&quot;readline&quot;</span>
            <span class="k">if</span> <span class="n">init_shell_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ptk1&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_toolkit1&quot;</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;$SHELL_TYPE=&#39;</span><span class="si">{}</span><span class="s2">&#39; now deprecated, please update your run control file&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">init_shell_type</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">shell_type</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execer</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shell_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        execer : Execer</span>
<span class="sd">            An execer instance capable of running xonsh code.</span>
<span class="sd">        ctx : Mapping, optional</span>
<span class="sd">            The execution context for the shell (e.g. the globals namespace).</span>
<span class="sd">            If none, this is computed by loading the rc files. If not None,</span>
<span class="sd">            this no additional context is computed and this is used</span>
<span class="sd">            directly.</span>
<span class="sd">        shell_type : str, optional</span>
<span class="sd">            The shell type to start, such as &#39;readline&#39;, &#39;prompt_toolkit1&#39;,</span>
<span class="sd">            or &#39;random&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execer</span> <span class="o">=</span> <span class="n">execer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ctx</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>

        <span class="c1"># build history backend before creating shell</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">):</span>
            <span class="n">XSH</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">xhm</span><span class="o">.</span><span class="n">construct_history</span><span class="p">(</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">detype</span><span class="p">(),</span>
                <span class="n">ts</span><span class="o">=</span><span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="kc">None</span><span class="p">],</span>
                <span class="n">locked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_HISTORY_FILE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_HISTORY_FILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">XSH</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">DummyHistory</span><span class="p">()</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_HISTORY_FILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">shell_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_shell_type</span><span class="p">(</span><span class="n">shell_type</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shell_type</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;SHELL_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shell_type</span>

        <span class="c1"># actually make the shell</span>
        <span class="k">if</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">xonsh.base_shell</span> <span class="kn">import</span> <span class="n">BaseShell</span> <span class="k">as</span> <span class="n">shell_class</span>
        <span class="k">elif</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">xonsh.ptk_shell.shell</span> <span class="kn">import</span> <span class="n">PromptToolkitShell</span> <span class="k">as</span> <span class="n">shell_class</span>
        <span class="k">elif</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;readline&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">xonsh.readline_shell</span> <span class="kn">import</span> <span class="n">ReadlineShell</span> <span class="k">as</span> <span class="n">shell_class</span>
        <span class="k">elif</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;jupyter&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">xonsh.jupyter_shell</span> <span class="kn">import</span> <span class="n">JupyterShell</span> <span class="k">as</span> <span class="n">shell_class</span>
        <span class="k">elif</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;dumb&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">xonsh.dumb_shell</span> <span class="kn">import</span> <span class="n">DumbShell</span> <span class="k">as</span> <span class="n">shell_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">XonshError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not recognized as a shell type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shell_type</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">shell_class</span><span class="p">(</span><span class="n">execer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">execer</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># allows history garbage collector to start running</span>
        <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">gc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">wait_for_shell</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delegates calls to appropriate shell instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># style_tools</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Xonsh color styling tools that simulate pygments, when it is unavailable.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.color_tools</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="k">class</span> <span class="nc">_TokenType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forked from the pygments project</span>
<span class="sd">    https://bitbucket.org/birkenfeld/pygments-main</span>
<span class="sd">    Copyright (c) 2006-2017 by the respective authors, All rights reserved.</span>
<span class="sd">    See https://bitbucket.org/birkenfeld/pygments-main/raw/05818a4ef9891d9ac22c851f7b3ea4b4fce460ab/AUTHORS</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">while</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">buf</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c1"># no need to call super.__init__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">val</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">and</span> <span class="n">val</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">==</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">_TokenType</span><span class="p">(</span><span class="bp">self</span> <span class="o">+</span> <span class="p">(</span><span class="n">val</span><span class="p">,))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Token&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># These instances are supposed to be singletons</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="c1"># These instances are supposed to be singletons</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="n">Token</span> <span class="o">=</span> <span class="n">_TokenType</span><span class="p">()</span>
<span class="n">Color</span> <span class="o">=</span> <span class="n">Token</span><span class="o">.</span><span class="n">Color</span>


<span class="k">def</span> <span class="nf">partial_color_tokenize</span><span class="p">(</span><span class="n">template</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tokenizes a template string containing colors. Will return a list</span>
<span class="sd">    of tuples mapping the token to the string which has that color.</span>
<span class="sd">    These sub-strings maybe templates themselves.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xonsh.built_ins</span> <span class="kn">import</span> <span class="n">XSH</span>

    <span class="k">if</span> <span class="n">HAS_PYGMENTS</span> <span class="ow">and</span> <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">styler</span><span class="o">.</span><span class="n">styles</span>
    <span class="k">elif</span> <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="n">DEFAULT_STYLE_DICT</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="n">RESET</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">toks</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">_partial_color_tokenize_main</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">styles</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Color</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span> <span class="n">template</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">styles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">styles</span><span class="p">[</span><span class="n">color</span><span class="p">]</span>  <span class="c1"># ensure color is available</span>
    <span class="k">return</span> <span class="n">toks</span>


<span class="k">def</span> <span class="nf">_partial_color_tokenize_main</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">styles</span><span class="p">):</span>
    <span class="n">bopen</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span>
    <span class="n">bclose</span> <span class="o">=</span> <span class="s2">&quot;}&quot;</span>
    <span class="n">colon</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span>
    <span class="n">expl</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="n">RESET</span>
    <span class="n">fg</span> <span class="o">=</span> <span class="n">bg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">literal</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="n">FORMATTER</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">template</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="n">literal</span>
        <span class="k">elif</span> <span class="n">iscolor</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="n">literal</span>
            <span class="n">next_color</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">color_by_name</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">next_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">color</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">styles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">styles</span><span class="p">[</span><span class="n">color</span><span class="p">]</span>  <span class="c1"># ensure color is available</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">next_color</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">literal</span><span class="p">,</span> <span class="n">bopen</span><span class="p">,</span> <span class="n">field</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">conv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expl</span><span class="p">)</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colon</span><span class="p">)</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bclose</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="n">literal</span>
    <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">color</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">toks</span><span class="p">,</span> <span class="n">color</span>


<span class="k">def</span> <span class="nf">color_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a color name to a color token, foreground name,</span>
<span class="sd">    and background name.  Will take into consideration current foreground</span>
<span class="sd">    and background colors, if provided.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Color name.</span>
<span class="sd">    fg : str, optional</span>
<span class="sd">        Foreground color name.</span>
<span class="sd">    bg : str, optional</span>
<span class="sd">        Background color name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tok : Token</span>
<span class="sd">        Pygments Token.Color subclass</span>
<span class="sd">    fg : str or None</span>
<span class="sd">        New computed foreground color name.</span>
<span class="sd">    bg : str or None</span>
<span class="sd">        New computed background color name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,</span> <span class="s2">&quot;NO_COLOR&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;NO_COLOR&quot;</span><span class="p">:</span>
            <span class="n">warn_deprecated_no_color</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Color</span><span class="o">.</span><span class="n">RESET</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">RE_BACKGROUND</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># must be foreground color</span>
        <span class="n">fg</span> <span class="o">=</span> <span class="n">norm_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="n">norm_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># assemble token</span>
    <span class="k">if</span> <span class="n">fg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tokname</span> <span class="o">=</span> <span class="s2">&quot;RESET&quot;</span>
    <span class="k">elif</span> <span class="n">fg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tokname</span> <span class="o">=</span> <span class="n">bg</span>
    <span class="k">elif</span> <span class="n">bg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tokname</span> <span class="o">=</span> <span class="n">fg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tokname</span> <span class="o">=</span> <span class="n">fg</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span> <span class="o">+</span> <span class="n">bg</span>
    <span class="n">tok</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Color</span><span class="p">,</span> <span class="n">tokname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tok</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">bg</span>


<span class="k">def</span> <span class="nf">norm_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Normalizes a color name.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;HEX&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">style_as_faded</span><span class="p">(</span><span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Remove the colors from the template string and style as faded.&quot;&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">partial_color_tokenize</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="n">without_color</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">sect</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sect</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">])</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">{#d3d3d3}&quot;</span> <span class="o">+</span> <span class="n">without_color</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">&quot;</span>


<span class="n">DEFAULT_STYLE_DICT</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="n">Token</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_BLACK</span><span class="p">:</span> <span class="s2">&quot;bg:ansiblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_BLUE</span><span class="p">:</span> <span class="s2">&quot;bg:ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_CYAN</span><span class="p">:</span> <span class="s2">&quot;bg:ansicyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_GREEN</span><span class="p">:</span> <span class="s2">&quot;bg:ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_INTENSE_BLACK</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_INTENSE_BLUE</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_INTENSE_CYAN</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightcyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_INTENSE_GREEN</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightgreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_INTENSE_PURPLE</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightmagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_INTENSE_RED</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_INTENSE_WHITE</span><span class="p">:</span> <span class="s2">&quot;bg:ansiwhite&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_INTENSE_YELLOW</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_PURPLE</span><span class="p">:</span> <span class="s2">&quot;bg:ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_RED</span><span class="p">:</span> <span class="s2">&quot;bg:ansired&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_WHITE</span><span class="p">:</span> <span class="s2">&quot;bg:ansigray&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BACKGROUND_YELLOW</span><span class="p">:</span> <span class="s2">&quot;bg:ansiyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BLACK</span><span class="p">:</span> <span class="s2">&quot;ansiblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">:</span> <span class="s2">&quot;ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_BLACK</span><span class="p">:</span> <span class="s2">&quot;bold ansiblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_BLUE</span><span class="p">:</span> <span class="s2">&quot;bold ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_CYAN</span><span class="p">:</span> <span class="s2">&quot;bold ansicyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_GREEN</span><span class="p">:</span> <span class="s2">&quot;bold ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_INTENSE_BLACK</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_INTENSE_BLUE</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_INTENSE_CYAN</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightcyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_INTENSE_GREEN</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightgreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_INTENSE_PURPLE</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightmagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_INTENSE_RED</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_INTENSE_WHITE</span><span class="p">:</span> <span class="s2">&quot;bold ansiwhite&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_INTENSE_YELLOW</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_PURPLE</span><span class="p">:</span> <span class="s2">&quot;bold ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_RED</span><span class="p">:</span> <span class="s2">&quot;bold ansired&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_BLACK</span><span class="p">:</span> <span class="s2">&quot;bold underline ansiblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_BLUE</span><span class="p">:</span> <span class="s2">&quot;bold underline ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_CYAN</span><span class="p">:</span> <span class="s2">&quot;bold underline ansicyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_GREEN</span><span class="p">:</span> <span class="s2">&quot;bold underline ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_INTENSE_BLACK</span><span class="p">:</span> <span class="s2">&quot;bold underline ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_INTENSE_BLUE</span><span class="p">:</span> <span class="s2">&quot;bold underline ansibrightblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_INTENSE_CYAN</span><span class="p">:</span> <span class="s2">&quot;bold underline ansibrightcyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_INTENSE_GREEN</span><span class="p">:</span> <span class="s2">&quot;bold underline ansibrightgreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_INTENSE_PURPLE</span><span class="p">:</span> <span class="s2">&quot;bold underline ansibrightmagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_INTENSE_RED</span><span class="p">:</span> <span class="s2">&quot;bold underline ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_INTENSE_WHITE</span><span class="p">:</span> <span class="s2">&quot;bold underline ansiwhite&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_INTENSE_YELLOW</span><span class="p">:</span> <span class="s2">&quot;bold underline ansibrightyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_PURPLE</span><span class="p">:</span> <span class="s2">&quot;bold underline ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_RED</span><span class="p">:</span> <span class="s2">&quot;bold underline ansired&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_WHITE</span><span class="p">:</span> <span class="s2">&quot;bold underline ansigray&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_UNDERLINE_YELLOW</span><span class="p">:</span> <span class="s2">&quot;bold underline ansiyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_WHITE</span><span class="p">:</span> <span class="s2">&quot;bold ansigray&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">BOLD_YELLOW</span><span class="p">:</span> <span class="s2">&quot;bold ansiyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">CYAN</span><span class="p">:</span> <span class="s2">&quot;ansicyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">GREEN</span><span class="p">:</span> <span class="s2">&quot;ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">INTENSE_BLACK</span><span class="p">:</span> <span class="s2">&quot;ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">INTENSE_BLUE</span><span class="p">:</span> <span class="s2">&quot;ansibrightblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">INTENSE_CYAN</span><span class="p">:</span> <span class="s2">&quot;ansibrightcyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">INTENSE_GREEN</span><span class="p">:</span> <span class="s2">&quot;ansibrightgreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">INTENSE_PURPLE</span><span class="p">:</span> <span class="s2">&quot;ansibrightmagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">INTENSE_RED</span><span class="p">:</span> <span class="s2">&quot;ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">INTENSE_WHITE</span><span class="p">:</span> <span class="s2">&quot;ansiwhite&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">INTENSE_YELLOW</span><span class="p">:</span> <span class="s2">&quot;ansibrightyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">RESET</span><span class="p">:</span> <span class="s2">&quot;noinherit&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">PURPLE</span><span class="p">:</span> <span class="s2">&quot;ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">RED</span><span class="p">:</span> <span class="s2">&quot;ansired&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_BLACK</span><span class="p">:</span> <span class="s2">&quot;underline ansiblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_BLUE</span><span class="p">:</span> <span class="s2">&quot;underline ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_CYAN</span><span class="p">:</span> <span class="s2">&quot;underline ansicyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_GREEN</span><span class="p">:</span> <span class="s2">&quot;underline ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_INTENSE_BLACK</span><span class="p">:</span> <span class="s2">&quot;underline ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_INTENSE_BLUE</span><span class="p">:</span> <span class="s2">&quot;underline ansibrightblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_INTENSE_CYAN</span><span class="p">:</span> <span class="s2">&quot;underline ansibrightcyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_INTENSE_GREEN</span><span class="p">:</span> <span class="s2">&quot;underline ansibrightgreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_INTENSE_PURPLE</span><span class="p">:</span> <span class="s2">&quot;underline ansibrightmagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_INTENSE_RED</span><span class="p">:</span> <span class="s2">&quot;underline ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_INTENSE_WHITE</span><span class="p">:</span> <span class="s2">&quot;underline ansiwhite&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_INTENSE_YELLOW</span><span class="p">:</span> <span class="s2">&quot;underline ansibrightyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_PURPLE</span><span class="p">:</span> <span class="s2">&quot;underline ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_RED</span><span class="p">:</span> <span class="s2">&quot;underline ansired&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_WHITE</span><span class="p">:</span> <span class="s2">&quot;underline ansigray&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">UNDERLINE_YELLOW</span><span class="p">:</span> <span class="s2">&quot;underline ansiyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">WHITE</span><span class="p">:</span> <span class="s2">&quot;ansigray&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">:</span> <span class="s2">&quot;ansiyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Comment</span><span class="p">:</span> <span class="s2">&quot;underline ansicyan&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">Hashbang</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">Multiline</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">Preproc</span><span class="p">:</span> <span class="s2">&quot;underline ansiyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">PreprocFile</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">Single</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Comment</span><span class="o">.</span><span class="n">Special</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span> <span class="s2">&quot;ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Escape</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Deleted</span><span class="p">:</span> <span class="s2">&quot;ansired&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Emph</span><span class="p">:</span> <span class="s2">&quot;underline&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Heading</span><span class="p">:</span> <span class="s2">&quot;bold ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Inserted</span><span class="p">:</span> <span class="s2">&quot;ansibrightgreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Output</span><span class="p">:</span> <span class="s2">&quot;ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Prompt</span><span class="p">:</span> <span class="s2">&quot;bold ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Strong</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Subheading</span><span class="p">:</span> <span class="s2">&quot;bold ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Traceback</span><span class="p">:</span> <span class="s2">&quot;ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Keyword</span><span class="p">:</span> <span class="s2">&quot;bold ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Keyword</span><span class="o">.</span><span class="n">Constant</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Keyword</span><span class="o">.</span><span class="n">Declaration</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Keyword</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Keyword</span><span class="o">.</span><span class="n">Pseudo</span><span class="p">:</span> <span class="s2">&quot;nobold&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Keyword</span><span class="o">.</span><span class="n">Reserved</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Keyword</span><span class="o">.</span><span class="n">Type</span><span class="p">:</span> <span class="s2">&quot;nobold ansired&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">Date</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">Number</span><span class="p">:</span> <span class="s2">&quot;ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">Bin</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">Float</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">Hex</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">Integer</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">Integer</span><span class="o">.</span><span class="n">Long</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">Oct</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="p">:</span> <span class="s2">&quot;ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Affix</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Backtick</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Char</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Delimiter</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Doc</span><span class="p">:</span> <span class="s2">&quot;underline&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Double</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Escape</span><span class="p">:</span> <span class="s2">&quot;bold ansiyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Heredoc</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Interpol</span><span class="p">:</span> <span class="s2">&quot;bold ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Other</span><span class="p">:</span> <span class="s2">&quot;ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Regex</span><span class="p">:</span> <span class="s2">&quot;ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Single</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Symbol</span><span class="p">:</span> <span class="s2">&quot;ansiyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Attribute</span><span class="p">:</span> <span class="s2">&quot;ansibrightyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Builtin</span><span class="p">:</span> <span class="s2">&quot;ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Builtin</span><span class="o">.</span><span class="n">Pseudo</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Class</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Constant</span><span class="p">:</span> <span class="s2">&quot;ansired&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Decorator</span><span class="p">:</span> <span class="s2">&quot;ansibrightmagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Entity</span><span class="p">:</span> <span class="s2">&quot;bold ansigray&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Exception</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightred&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Function</span><span class="p">:</span> <span class="s2">&quot;ansibrightblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">Magic</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Label</span><span class="p">:</span> <span class="s2">&quot;ansibrightyellow&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span> <span class="s2">&quot;bold ansibrightblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Other</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Property</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Tag</span><span class="p">:</span> <span class="s2">&quot;bold ansigreen&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Variable</span><span class="p">:</span> <span class="s2">&quot;ansiblue&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Variable</span><span class="o">.</span><span class="n">Class</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Variable</span><span class="o">.</span><span class="n">Global</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Variable</span><span class="o">.</span><span class="n">Instance</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">Variable</span><span class="o">.</span><span class="n">Magic</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Operator</span><span class="p">:</span> <span class="s2">&quot;ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Operator</span><span class="o">.</span><span class="n">Word</span><span class="p">:</span> <span class="s2">&quot;bold ansimagenta&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Other</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Punctuation</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Text</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">Whitespace</span><span class="p">:</span> <span class="s2">&quot;ansigray&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">PTK</span><span class="o">.</span><span class="n">Aborting</span><span class="p">:</span> <span class="s2">&quot;ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">PTK</span><span class="o">.</span><span class="n">AutoSuggestion</span><span class="p">:</span> <span class="s2">&quot;ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">PTK</span><span class="o">.</span><span class="n">CompletionMenu</span><span class="p">:</span> <span class="s2">&quot;bg:ansigray ansiblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">PTK</span><span class="o">.</span><span class="n">CompletionMenu</span><span class="o">.</span><span class="n">Completion</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">PTK</span><span class="o">.</span><span class="n">CompletionMenu</span><span class="o">.</span><span class="n">Completion</span><span class="o">.</span><span class="n">Current</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightblack ansiwhite&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">PTK</span><span class="o">.</span><span class="n">Scrollbar</span><span class="o">.</span><span class="n">Arrow</span><span class="p">:</span> <span class="s2">&quot;bg:ansiblack ansiwhite bold&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">PTK</span><span class="o">.</span><span class="n">Scrollbar</span><span class="o">.</span><span class="n">Background</span><span class="p">:</span> <span class="s2">&quot;bg:ansibrightblack&quot;</span><span class="p">,</span>
            <span class="n">Token</span><span class="o">.</span><span class="n">PTK</span><span class="o">.</span><span class="n">Scrollbar</span><span class="o">.</span><span class="n">Button</span><span class="p">:</span> <span class="s2">&quot;bg:ansiblack&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;DEFAULT_STYLE_DICT&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># timings</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Timing related functionality for the xonsh shell.</span>

<span class="sd">The following time_it alias and Timer was forked from the IPython project:</span>
<span class="sd">* Copyright (c) 2008-2014, IPython Development Team</span>
<span class="sd">* Copyright (C) 2001-2007 Fernando Perez &lt;fperez@colorado.edu&gt;</span>
<span class="sd">* Copyright (c) 2001, Janko Hauser &lt;jhauser@zscout.de&gt;</span>
<span class="sd">* Copyright (c) 2001, Nathaniel Gray &lt;n8gray@caltech.edu&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="n">gc</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated math</span>
<span class="c1"># amalgamated time</span>
<span class="n">timeit</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;timeit&#39;</span><span class="p">,</span> <span class="s1">&#39;timeit&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated itertools</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.events</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="nd">@lazybool</span>
<span class="k">def</span> <span class="nf">_HAVE_RESOURCE</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">resource</span> <span class="k">as</span> <span class="nn">r</span>

        <span class="n">have</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># There is no distinction of user/system time under windows, so we</span>
        <span class="c1"># just use time.perf_counter() for everything...</span>
        <span class="n">have</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">have</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">resource</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">resource</span> <span class="k">as</span> <span class="nn">r</span>

    <span class="k">return</span> <span class="n">r</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">clocku</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">_HAVE_RESOURCE</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">clocku</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;clocku() -&gt; floating point number</span>
<span class="sd">            Return the *USER* CPU time in seconds since the start of the</span>
<span class="sd">            process.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">clocku</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span>
    <span class="k">return</span> <span class="n">clocku</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">clocks</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">_HAVE_RESOURCE</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">clocks</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;clocks() -&gt; floating point number</span>
<span class="sd">            Return the *SYSTEM* CPU time in seconds since the start of the</span>
<span class="sd">            process.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">clocks</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span>
    <span class="k">return</span> <span class="n">clocks</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">clock</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">_HAVE_RESOURCE</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">clock</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;clock() -&gt; floating point number</span>
<span class="sd">            Return the *TOTAL USER+SYSTEM* CPU time in seconds since the</span>
<span class="sd">            start of the process.&quot;&quot;&quot;</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">u</span> <span class="o">+</span> <span class="n">s</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">clock</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span>
    <span class="k">return</span> <span class="n">clock</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">clock2</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">_HAVE_RESOURCE</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">clock2</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;clock2() -&gt; (t_user,t_system)</span>
<span class="sd">            Similar to clock(), but return a tuple of user/system times.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrusage</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RUSAGE_SELF</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">clock2</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Under windows, system CPU time can&#39;t be measured.</span>
<span class="sd">            This just returns perf_counter() and zero.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">(),</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">clock2</span>


<span class="k">def</span> <span class="nf">format_time</span><span class="p">(</span><span class="n">timespan</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Formats the timespan in a human readable form&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timespan</span> <span class="o">&gt;=</span> <span class="mf">60.0</span><span class="p">:</span>
        <span class="c1"># we have more than a minute, format that in a human readable form</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">leftover</span> <span class="o">=</span> <span class="n">timespan</span>
        <span class="k">for</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leftover</span> <span class="o">/</span> <span class="n">length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">leftover</span> <span class="o">=</span> <span class="n">leftover</span> <span class="o">%</span> <span class="n">length</span>
                <span class="n">time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">suffix</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">leftover</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="c1"># Unfortunately the unicode &#39;micro&#39; symbol can cause problems in</span>
    <span class="c1"># certain terminals.</span>
    <span class="c1"># See bug: https://bugs.launchpad.net/ipython/+bug/348466</span>
    <span class="c1"># Try to prevent crashes by being more secure than it needs to</span>
    <span class="c1"># E.g. eclipse is able to print a mu, but has no sys.stdout.encoding set.</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="s2">&quot;us&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">]</span>  <span class="c1"># the save value</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="s2">&quot;</span><span class="se">\xb5</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\xb5</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">scaling</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">timespan</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">timespan</span><span class="p">))</span> <span class="o">//</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="s2">&quot;{1:.</span><span class="si">{0}</span><span class="s2">g} </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="p">,</span> <span class="n">timespan</span> <span class="o">*</span> <span class="n">scaling</span><span class="p">[</span><span class="n">order</span><span class="p">],</span> <span class="n">units</span><span class="p">[</span><span class="n">order</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">Timer</span><span class="p">(</span><span class="n">timeit</span><span class="o">.</span><span class="n">Timer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Timer class that explicitly uses self.inner</span>
<span class="sd">    which is an undocumented implementation detail of CPython,</span>
<span class="sd">    not shared by PyPy.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Timer.timeit copied from CPython 3.4.2</span>
    <span class="k">def</span> <span class="nf">timeit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">timeit</span><span class="o">.</span><span class="n">default_number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time &#39;number&#39; executions of the main statement.</span>
<span class="sd">        To be precise, this executes the setup statement once, and</span>
<span class="sd">        then returns the time it takes to execute the main statement</span>
<span class="sd">        a number of times, as a float measured in seconds.  The</span>
<span class="sd">        argument is the number of times through the loop, defaulting</span>
<span class="sd">        to one million.  The main statement, the setup statement and</span>
<span class="sd">        the timer function to be used are passed to the constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
        <span class="n">gcold</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gcold</span><span class="p">:</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">timing</span>


<span class="n">INNER_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">def inner(_it, _timer):</span>
<span class="s2">    #setup</span>
<span class="s2">    _t0 = _timer()</span>
<span class="s2">    for _i in _it:</span>
<span class="s2">        </span><span class="si">{stmt}</span><span class="s2"></span>
<span class="s2">    _t1 = _timer()</span>
<span class="s2">    return _t1 - _t0</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">timeit_alias</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs timing study on arguments.&quot;&quot;&quot;</span>
    <span class="c1"># some real args</span>
    <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">quiet</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">repeat</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="c1"># setup</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">ctx</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">timer</span><span class="o">=</span><span class="n">clock</span><span class="p">)</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">innerstr</span> <span class="o">=</span> <span class="n">INNER_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stmt</span><span class="o">=</span><span class="n">stmt</span><span class="p">)</span>
    <span class="c1"># Track compilation time so it can be reported if too long</span>
    <span class="c1"># Minimum time above which compilation time will be reported</span>
    <span class="n">tc_min</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>
    <span class="n">innercode</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">builtins</span><span class="o">.</span><span class="n">compilex</span><span class="p">(</span>
        <span class="n">innerstr</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&lt;xonsh-timeit&gt;&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">glbs</span><span class="o">=</span><span class="n">ctx</span>
    <span class="p">)</span>
    <span class="n">tc</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="c1"># get inner func</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">builtins</span><span class="o">.</span><span class="n">execx</span><span class="p">(</span><span class="n">innercode</span><span class="p">,</span> <span class="n">glbs</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">locs</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">inner</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="s2">&quot;inner&quot;</span><span class="p">]</span>
    <span class="c1"># Check if there is a huge difference between the best and worst timings.</span>
    <span class="n">worst_tuning</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># determine number so that 0.2 &lt;= total time &lt; 2.0</span>
        <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="n">time_number</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
            <span class="n">worst_tuning</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">worst_tuning</span><span class="p">,</span> <span class="n">time_number</span> <span class="o">/</span> <span class="n">number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time_number</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">number</span> <span class="o">*=</span> <span class="mi">10</span>
    <span class="n">all_runs</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_runs</span><span class="p">)</span> <span class="o">/</span> <span class="n">number</span>
    <span class="c1"># print some debug info</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="n">worst</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_runs</span><span class="p">)</span> <span class="o">/</span> <span class="n">number</span>
        <span class="k">if</span> <span class="n">worst_tuning</span><span class="p">:</span>
            <span class="n">worst</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">worst</span><span class="p">,</span> <span class="n">worst_tuning</span><span class="p">)</span>
        <span class="c1"># Check best timing is greater than zero to avoid a</span>
        <span class="c1"># ZeroDivisionError.</span>
        <span class="c1"># In cases where the slowest timing is less than 10 microseconds</span>
        <span class="c1"># we assume that it does not really matter if the fastest</span>
        <span class="c1"># timing is 4 times faster than the slowest timing or not.</span>
        <span class="k">if</span> <span class="n">worst</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">best</span> <span class="ow">and</span> <span class="n">best</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">worst</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;The slowest run took </span><span class="si">{0:0.2f}</span><span class="s2"> times longer than the &quot;</span>
                    <span class="s2">&quot;fastest. This could mean that an intermediate result &quot;</span>
                    <span class="s2">&quot;is being cached.&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">worst</span> <span class="o">/</span> <span class="n">best</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> loops, best of </span><span class="si">{1}</span><span class="s2">: </span><span class="si">{2}</span><span class="s2"> per loop&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">number</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">format_time</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">tc</span> <span class="o">&gt;</span> <span class="n">tc_min</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compiler time: </span><span class="si">{0:.2f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tc</span><span class="p">))</span>
    <span class="k">return</span>


<span class="n">_timings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">clock</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">setup_timings</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_timings</span>
    <span class="k">if</span> <span class="s2">&quot;--timings&quot;</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">:</span>
        <span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
            <span class="s2">&quot;on_timingprobe&quot;</span><span class="p">,</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        on_timingprobe(name: str) -&gt; None</span>

<span class="sd">        Fired to insert some timings into the startuptime list</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_timingprobe</span>
        <span class="k">def</span> <span class="nf">timing_on_timingprobe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_post_cmdloop</span>
        <span class="k">def</span> <span class="nf">timing_on_post_cmdloop</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_post_cmdloop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_post_init</span>
        <span class="k">def</span> <span class="nf">timing_on_post_init</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_post_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_post_rc</span>
        <span class="k">def</span> <span class="nf">timing_on_post_rc</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_post_rc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_postcommand</span>
        <span class="k">def</span> <span class="nf">timing_on_postcommand</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_postcommand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_pre_cmdloop</span>
        <span class="k">def</span> <span class="nf">timing_on_pre_cmdloop</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_pre_cmdloop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_pre_rc</span>
        <span class="k">def</span> <span class="nf">timing_on_pre_rc</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_pre_rc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_precommand</span>
        <span class="k">def</span> <span class="nf">timing_on_precommand</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_precommand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_ptk_create</span>
        <span class="k">def</span> <span class="nf">timing_on_ptk_create</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_ptk_create&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_chdir</span>
        <span class="k">def</span> <span class="nf">timing_on_chdir</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_chdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_pre_prompt_format</span>
        <span class="k">def</span> <span class="nf">timing_on_pre_prompt_format</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_pre_prompt_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_post_prompt</span>
        <span class="k">def</span> <span class="nf">timing_on_post_prompt</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;on_post_prompt&quot;</span><span class="p">:</span> <span class="n">clock</span><span class="p">()}</span>

        <span class="nd">@events</span><span class="o">.</span><span class="n">on_pre_prompt</span>
        <span class="k">def</span> <span class="nf">timing_on_pre_prompt</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">_timings</span>
            <span class="n">_timings</span><span class="p">[</span><span class="s2">&quot;on_pre_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>
            <span class="n">times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_timings</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">times</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">times</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">header_format</span> <span class="o">=</span> <span class="s2">&quot;|{{:&lt;</span><span class="si">{}</span><span class="s2">}}|{{:^11}}|{{:^11}}|&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="n">entry_format</span> <span class="o">=</span> <span class="s2">&quot;|{{:&lt;</span><span class="si">{}</span><span class="s2">}}|{{:^11.3f}}|{{:^11.3f}}|&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="n">sepline</span> <span class="o">=</span> <span class="s2">&quot;|</span><span class="si">{}</span><span class="s2">|</span><span class="si">{}</span><span class="s2">|</span><span class="si">{}</span><span class="s2">|&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">11</span><span class="p">)</span>
            <span class="c1"># Print result table</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Debug level: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;XONSH_DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;Off&quot;</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sepline</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">header_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Event name&quot;</span><span class="p">,</span> <span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="s2">&quot;Delta (s)&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sepline</span><span class="p">)</span>
            <span class="n">prevtime</span> <span class="o">=</span> <span class="n">tstart</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">entry_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">ts</span> <span class="o">-</span> <span class="n">prevtime</span><span class="p">))</span>
                <span class="n">prevtime</span> <span class="o">=</span> <span class="n">ts</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sepline</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># xonfig</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;The xonsh configuration (xonfig) utility.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated ast</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated json</span>
<span class="n">shutil</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;shutil&#39;</span><span class="p">,</span> <span class="s1">&#39;shutil&#39;</span><span class="p">)</span>
<span class="n">random</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">)</span>
<span class="n">pprint</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;pprint&#39;</span><span class="p">,</span> <span class="s1">&#39;pprint&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated tempfile</span>
<span class="c1"># amalgamated textwrap</span>
<span class="c1"># amalgamated argparse</span>
<span class="c1"># amalgamated functools</span>
<span class="c1"># amalgamated itertools</span>
<span class="c1"># amalgamated contextlib</span>
<span class="c1"># amalgamated collections</span>
<span class="c1"># amalgamated typing</span>
<span class="kn">from</span> <span class="nn">xonsh.ply</span> <span class="kn">import</span> <span class="n">ply</span>

<span class="n">wiz</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;xonsh&#39;</span><span class="p">,</span> <span class="s1">&#39;xonsh.wizard&#39;</span><span class="p">,</span> <span class="s1">&#39;wiz&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">xonsh</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">XONSH_VERSION</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="kn">from</span> <span class="nn">xonsh.prompt.base</span> <span class="kn">import</span> <span class="n">is_template_string</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.foreign_shells</span>
<span class="c1"># amalgamated xonsh.xontribs</span>
<span class="c1"># amalgamated xonsh.xontribs_meta</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="n">HR</span> <span class="o">=</span> <span class="s2">&quot;&#39;`-.,_,.-*&#39;`-.,_,.-*&#39;`-.,_,.-*&#39;`-.,_,.-*&#39;`-.,_,.-*&#39;`-.,_,.-*&#39;`-.,_,.-*&#39;&quot;</span>
<span class="n">WIZARD_HEAD</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          {{BOLD_WHITE}}Welcome to the xonsh configuration wizard!{{RESET}}</span>
<span class="s2">          {{YELLOW}}------------------------------------------{{RESET}}</span>
<span class="s2">This will present a guided tour through setting up the xonsh static</span>
<span class="s2">config file. Xonsh will automatically ask you if you want to run this</span>
<span class="s2">wizard if the configuration file does not exist. However, you can</span>
<span class="s2">always rerun this wizard with the xonfig command:</span>

<span class="s2">    $ xonfig wizard</span>

<span class="s2">This wizard will load an existing configuration, if it is available.</span>
<span class="s2">Also never fear when this wizard saves its results! It will create</span>
<span class="s2">a backup of any existing configuration automatically.</span>

<span class="s2">This wizard has two main phases: foreign shell setup and environment</span>
<span class="s2">variable setup. Each phase may be skipped in its entirety.</span>

<span class="s2">For the configuration to take effect, you will need to restart xonsh.</span>

<span class="si">{hr}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">hr</span><span class="o">=</span><span class="n">HR</span>
<span class="p">)</span>

<span class="n">WIZARD_FS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{hr}</span><span class="s2"></span>

<span class="s2">                      {{BOLD_WHITE}}Foreign Shell Setup{{RESET}}</span>
<span class="s2">                      {{YELLOW}}-------------------{{RESET}}</span>
<span class="s2">The xonsh shell has the ability to interface with Bash or zsh</span>
<span class="s2">via the foreign shell interface.</span>

<span class="s2">For configuration, this means that xonsh can load the environment,</span>
<span class="s2">aliases, and functions specified in the config files of these shells.</span>
<span class="s2">Naturally, these shells must be available on the system to work.</span>
<span class="s2">Being able to share configuration (and source) from foreign shells</span>
<span class="s2">makes it easier to transition to and from xonsh.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">hr</span><span class="o">=</span><span class="n">HR</span>
<span class="p">)</span>

<span class="n">WIZARD_ENV</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{hr}</span><span class="s2"></span>

<span class="s2">                  {{BOLD_WHITE}}Environment Variable Setup{{RESET}}</span>
<span class="s2">                  {{YELLOW}}--------------------------{{RESET}}</span>
<span class="s2">The xonsh shell also allows you to setup environment variables from</span>
<span class="s2">the static configuration file. Any variables set in this way are</span>
<span class="s2">superseded by the definitions in the xonshrc or on the command line.</span>
<span class="s2">Still, setting environment variables in this way can help define</span>
<span class="s2">options that are global to the system or user.</span>

<span class="s2">The following lists the environment variable name, its documentation,</span>
<span class="s2">the default value, and the current value. The default and current</span>
<span class="s2">values are presented as pretty repr strings of their Python types.</span>

<span class="s2">{{BOLD_GREEN}}Note:{{RESET}} Simply hitting enter for any environment variable</span>
<span class="s2">will accept the default value for that entry.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">hr</span><span class="o">=</span><span class="n">HR</span>
<span class="p">)</span>

<span class="n">WIZARD_ENV_QUESTION</span> <span class="o">=</span> <span class="s2">&quot;Would you like to set env vars now, &quot;</span> <span class="o">+</span> <span class="n">wiz</span><span class="o">.</span><span class="n">YN</span>

<span class="n">WIZARD_XONTRIB</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{hr}</span><span class="s2"></span>

<span class="s2">                           {{BOLD_WHITE}}Xontribs{{RESET}}</span>
<span class="s2">                           {{YELLOW}}--------{{RESET}}</span>
<span class="s2">No shell is complete without extensions, and xonsh is no exception. Xonsh</span>
<span class="s2">extensions are called {{BOLD_GREEN}}xontribs{{RESET}}, or xonsh contributions.</span>
<span class="s2">Xontribs are dynamically loadable, either by importing them directly or by</span>
<span class="s2">using the &#39;xontrib&#39; command. However, you can also configure xonsh to load</span>
<span class="s2">xontribs automatically on startup prior to loading the run control files.</span>
<span class="s2">This allows the xontrib to be used immediately in your xonshrc files.</span>

<span class="s2">The following describes all xontribs that have been registered with xonsh.</span>
<span class="s2">These come from users, 3rd party developers, or xonsh itself!</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">hr</span><span class="o">=</span><span class="n">HR</span>
<span class="p">)</span>

<span class="n">WIZARD_XONTRIB_QUESTION</span> <span class="o">=</span> <span class="s2">&quot;Would you like to enable xontribs now, &quot;</span> <span class="o">+</span> <span class="n">wiz</span><span class="o">.</span><span class="n">YN</span>

<span class="n">WIZARD_TAIL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Thanks for using the xonsh configuration wizard!&quot;&quot;&quot;</span>


<span class="n">_XONFIG_SOURCE_FOREIGN_SHELL_COMMAND</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;source-foreign&quot;</span><span class="p">,</span> <span class="n">bash</span><span class="o">=</span><span class="s2">&quot;source-bash&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="s2">&quot;source-cmd&quot;</span><span class="p">,</span> <span class="n">zsh</span><span class="o">=</span><span class="s2">&quot;source-zsh&quot;</span>
<span class="p">)</span>

<span class="n">XONSH_JUPYTER_KERNEL</span> <span class="o">=</span> <span class="s2">&quot;xonsh&quot;</span>


<span class="k">def</span> <span class="nf">_dump_xonfig_foreign_shell</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">shell</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;shell&quot;</span><span class="p">]</span>
    <span class="n">shell</span> <span class="o">=</span> <span class="n">CANON_SHELL_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="n">shell</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">_XONFIG_SOURCE_FOREIGN_SHELL_COMMAND</span><span class="p">[</span><span class="n">shell</span><span class="p">]]</span>
    <span class="n">interactive</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interactive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--interactive&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">interactive</span><span class="p">)])</span>
    <span class="n">login</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">login</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--login&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">login</span><span class="p">)])</span>
    <span class="n">envcmd</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;envcmd&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">envcmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--envcmd&quot;</span><span class="p">,</span> <span class="n">envcmd</span><span class="p">])</span>
    <span class="n">aliascmd</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aliasmd&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">aliascmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--aliascmd&quot;</span><span class="p">,</span> <span class="n">aliascmd</span><span class="p">])</span>
    <span class="n">extra_args</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extra_args&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extra_args</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--extra-args&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extra_args</span><span class="p">))])</span>
    <span class="n">safe</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;safe&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">safe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--safe&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">safe</span><span class="p">)])</span>
    <span class="n">prevcmd</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prevcmd&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prevcmd</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--prevcmd&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">prevcmd</span><span class="p">)])</span>
    <span class="n">postcmd</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;postcmd&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">postcmd</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--postcmd&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">postcmd</span><span class="p">)])</span>
    <span class="n">funcscmd</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;funcscmd&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">funcscmd</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--funcscmd&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">funcscmd</span><span class="p">)])</span>
    <span class="n">sourcer</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sourcer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sourcer</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--sourcer&quot;</span><span class="p">,</span> <span class="n">sourcer</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;source-foreign&quot;</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shell</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;echo loading xonsh foreign shell&quot;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_dump_xonfig_env</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
    <span class="n">detyper</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_detyper</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">dval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">detyper</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">detyper</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">dval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">dval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dval</span>
    <span class="k">return</span> <span class="s2">&quot;$</span><span class="si">{name}</span><span class="s2"> = </span><span class="si">{val!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">dval</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_dump_xonfig_xontribs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;xontrib load </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">XONFIG_DUMP_RULES</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;/env/&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;/foreign_shells/*/&quot;</span><span class="p">:</span> <span class="n">_dump_xonfig_foreign_shell</span><span class="p">,</span>
        <span class="s2">&quot;/env/*&quot;</span><span class="p">:</span> <span class="n">_dump_xonfig_env</span><span class="p">,</span>
        <span class="s2">&quot;/env/*/[0-9]*&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;/xontribs/&quot;</span><span class="p">:</span> <span class="n">_dump_xonfig_xontribs</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">make_fs_wiz</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Makes the foreign shell part of the wizard.&quot;&quot;&quot;</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">create_truefalse_cond</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Add a new foreign shell, &quot;</span> <span class="o">+</span> <span class="n">wiz</span><span class="o">.</span><span class="n">YN</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">While</span><span class="p">(</span>
        <span class="n">cond</span><span class="o">=</span><span class="n">cond</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="p">[</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="s2">&quot;shell name (e.g. bash): &quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/shell&quot;</span><span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;interactive shell [bool, default=True]: &quot;</span><span class="p">,</span>
                <span class="n">converter</span><span class="o">=</span><span class="n">to_bool</span><span class="p">,</span>
                <span class="n">show_conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/interactive&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;login shell [bool, default=False]: &quot;</span><span class="p">,</span>
                <span class="n">converter</span><span class="o">=</span><span class="n">to_bool</span><span class="p">,</span>
                <span class="n">show_conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/login&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;env command [str, default=&#39;env&#39;]: &quot;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/envcmd&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;alias command [str, default=&#39;alias&#39;]: &quot;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/aliascmd&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;extra command line arguments [list of str, &quot;</span> <span class="s2">&quot;default=[]]: &quot;</span><span class="p">),</span>
                <span class="n">converter</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">,</span>
                <span class="n">show_conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/extra_args&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;safely handle exceptions [bool, default=True]: &quot;</span><span class="p">,</span>
                <span class="n">converter</span><span class="o">=</span><span class="n">to_bool</span><span class="p">,</span>
                <span class="n">show_conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/safe&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;pre-command [str, default=&#39;&#39;]: &quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/prevcmd&quot;</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;post-command [str, default=&#39;&#39;]: &quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/postcmd&quot;</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;foreign function command [str, default=None]: &quot;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/funcscmd&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
                <span class="s2">&quot;source command [str, default=None]: &quot;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/foreign_shells/</span><span class="si">{idx}</span><span class="s2">/sourcer&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Foreign shell added.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fs</span>


<span class="k">def</span> <span class="nf">_wrap_paragraphs</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps paragraphs instead.&quot;&quot;&quot;</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="n">ENVVAR_MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">{{BOLD_CYAN}}$</span><span class="si">{name}</span><span class="s2">{{RESET}}</span>
<span class="si">{docstr}</span><span class="s2"></span>
<span class="s2">{{RED}}default value:{{RESET}} </span><span class="si">{default}</span><span class="s2"></span>
<span class="s2">{{RED}}current value:{{RESET}} </span><span class="si">{current}</span><span class="s2">&quot;&quot;&quot;</span>

<span class="n">ENVVAR_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{BOLD_GREEN}</span><span class="s2">&gt;&gt;&gt;</span><span class="si">{RESET}</span><span class="s2"> &quot;</span>


<span class="k">def</span> <span class="nf">make_exit_message</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Creates a message for how to exit the wizard.&quot;&quot;&quot;</span>
    <span class="n">shell_type</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell_type</span>
    <span class="n">keyseq</span> <span class="o">=</span> <span class="s2">&quot;Ctrl-D&quot;</span> <span class="k">if</span> <span class="n">shell_type</span> <span class="o">==</span> <span class="s2">&quot;readline&quot;</span> <span class="k">else</span> <span class="s2">&quot;Ctrl-C&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;To exit the wizard at any time, press </span><span class="si">{BOLD_UNDERLINE_CYAN}</span><span class="s2">&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="n">keyseq</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="k">def</span> <span class="nf">make_envvar</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a StoreNonEmpty node for an environment variable.&quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">vd</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_docs</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vd</span><span class="o">.</span><span class="n">is_configurable</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">vd</span><span class="o">.</span><span class="n">doc_default</span>
    <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_wrap_paragraphs</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">69</span><span class="p">)</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_template_string</span><span class="p">(</span><span class="n">curr</span><span class="p">):</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;{{&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;}}&quot;</span><span class="p">)</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">69</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">curr</span><span class="p">:</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">curr</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">ENVVAR_MESSAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">current</span><span class="o">=</span><span class="n">curr</span><span class="p">,</span>
        <span class="n">docstr</span><span class="o">=</span><span class="n">_wrap_paragraphs</span><span class="p">(</span><span class="n">vd</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">69</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">mnode</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">converter</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_converter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/env/&quot;</span> <span class="o">+</span> <span class="n">name</span>
    <span class="n">pnode</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span>
        <span class="n">ENVVAR_PROMPT</span><span class="p">,</span>
        <span class="n">converter</span><span class="o">=</span><span class="n">converter</span><span class="p">,</span>
        <span class="n">show_conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
        <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">store_raw</span><span class="o">=</span><span class="n">vd</span><span class="o">.</span><span class="n">can_store_as_str</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">mnode</span><span class="p">,</span> <span class="n">pnode</span>


<span class="k">def</span> <span class="nf">_make_flat_wiz</span><span class="p">(</span><span class="n">kidfunc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">kids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">kidfunc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">flatkids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">flatkids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">wizard</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">Wizard</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="n">flatkids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wizard</span>


<span class="k">def</span> <span class="nf">make_env_wiz</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Makes an environment variable wizard.&quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">_make_flat_wiz</span><span class="p">(</span><span class="n">make_envvar</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">w</span>


<span class="n">XONTRIB_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{BOLD_GREEN}</span><span class="s2">Add this xontrib</span><span class="si">{RESET}</span><span class="s2">, &quot;</span> <span class="o">+</span> <span class="n">wiz</span><span class="o">.</span><span class="n">YN</span>


<span class="k">def</span> <span class="nf">_xontrib_path</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># need this to append only based on user-selected size</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;xontribs&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">visitor</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xontribs&quot;</span><span class="p">,</span> <span class="p">())))</span>


<span class="k">def</span> <span class="nf">make_xontrib</span><span class="p">(</span><span class="n">xon_item</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Xontrib</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Makes a message and StoreNonEmpty node for a xontrib.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">xontrib</span> <span class="o">=</span> <span class="n">xon_item</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&lt;unknown-xontrib-name&gt;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{BOLD_CYAN}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">xontrib</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{RED}</span><span class="s2">url:</span><span class="si">{RESET}</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="n">xontrib</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">xontrib</span><span class="o">.</span><span class="n">package</span><span class="p">:</span>
        <span class="n">pkg</span> <span class="o">=</span> <span class="n">xontrib</span><span class="o">.</span><span class="n">package</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{RED}</span><span class="s2">package:</span><span class="si">{RESET}</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xontrib</span><span class="o">.</span><span class="n">url</span> <span class="ow">and</span> <span class="n">pkg</span><span class="o">.</span><span class="n">url</span> <span class="o">!=</span> <span class="n">xontrib</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{RED}</span><span class="s2">package-url:</span><span class="si">{RESET}</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">license</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{RED}</span><span class="s2">license:</span><span class="si">{RESET}</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="n">license</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{PURPLE}</span><span class="s2">installed?</span><span class="si">{RESET}</span><span class="s2"> &quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;no&quot;</span> <span class="k">if</span> <span class="n">find_xontrib</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="n">_wrap_paragraphs</span><span class="p">(</span><span class="n">xontrib</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">69</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mnode</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">convert</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">name</span> <span class="k">if</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">wiz</span><span class="o">.</span><span class="n">Unstorable</span>
    <span class="n">pnode</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">StoreNonEmpty</span><span class="p">(</span><span class="n">XONTRIB_PROMPT</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="n">convert</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">_xontrib_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mnode</span><span class="p">,</span> <span class="n">pnode</span>


<span class="k">def</span> <span class="nf">make_xontribs_wiz</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Makes a xontrib wizard.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_make_flat_wiz</span><span class="p">(</span><span class="n">make_xontrib</span><span class="p">,</span> <span class="n">get_xontribs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">make_xonfig_wizard</span><span class="p">(</span><span class="n">default_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_wizard_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a configuration wizard for xonsh config file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    default_file : str, optional</span>
<span class="sd">        Default filename to save and load to. User will still be prompted.</span>
<span class="sd">    confirm : bool, optional</span>
<span class="sd">        Confirm that the main part of the wizard should be run.</span>
<span class="sd">    no_wizard_file : str, optional</span>
<span class="sd">        Filename for that will flag to future runs that the wizard should not be</span>
<span class="sd">        run again. If None (default), this defaults to default_file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">Wizard</span><span class="p">(</span>
        <span class="n">children</span><span class="o">=</span><span class="p">[</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">WIZARD_HEAD</span><span class="p">),</span>
            <span class="n">make_exit_message</span><span class="p">(),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">WIZARD_FS</span><span class="p">),</span>
            <span class="n">make_fs_wiz</span><span class="p">(),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">WIZARD_ENV</span><span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">YesNo</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">WIZARD_ENV_QUESTION</span><span class="p">,</span> <span class="n">yes</span><span class="o">=</span><span class="n">make_env_wiz</span><span class="p">(),</span> <span class="n">no</span><span class="o">=</span><span class="n">wiz</span><span class="o">.</span><span class="n">Pass</span><span class="p">()),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">WIZARD_XONTRIB</span><span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">YesNo</span><span class="p">(</span>
                <span class="n">question</span><span class="o">=</span><span class="n">WIZARD_XONTRIB_QUESTION</span><span class="p">,</span> <span class="n">yes</span><span class="o">=</span><span class="n">make_xontribs_wiz</span><span class="p">(),</span> <span class="n">no</span><span class="o">=</span><span class="n">wiz</span><span class="o">.</span><span class="n">Pass</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">HR</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">FileInserter</span><span class="p">(</span>
                <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;# XONSH WIZARD START&quot;</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;# XONSH WIZARD END&quot;</span><span class="p">,</span>
                <span class="n">dump_rules</span><span class="o">=</span><span class="n">XONFIG_DUMP_RULES</span><span class="p">,</span>
                <span class="n">default_file</span><span class="o">=</span><span class="n">default_file</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">wiz</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">WIZARD_TAIL</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">confirm</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Would you like to run the xonsh configuration wizard now?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;1. Yes (You can abort at any time)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;2. No, but ask me next time.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;3. No, and don&#39;t ask me again.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;1, 2, or 3 [default: 2]? &quot;</span>
        <span class="p">)</span>
        <span class="n">no_wizard_file</span> <span class="o">=</span> <span class="n">default_file</span> <span class="k">if</span> <span class="n">no_wizard_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">no_wizard_file</span>
        <span class="n">passer</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">Pass</span><span class="p">()</span>
        <span class="n">saver</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">SaveJSON</span><span class="p">(</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ask_filename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_file</span><span class="o">=</span><span class="n">no_wizard_file</span>
        <span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">Question</span><span class="p">(</span>
            <span class="n">q</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">passer</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="n">saver</span><span class="p">},</span> <span class="n">converter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="mi">2</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">w</span>


<span class="k">def</span> <span class="nf">_wizard</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">shell</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">shell</span>
    <span class="n">xonshrcs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSHRC&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">xonshrcs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">xonshrcs</span> <span class="ow">and</span> <span class="n">ns</span><span class="o">.</span><span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ns</span><span class="o">.</span><span class="n">file</span>
    <span class="n">no_wiz</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_CONFIG_DIR&quot;</span><span class="p">),</span> <span class="s2">&quot;no-wizard&quot;</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">make_xonfig_wizard</span><span class="p">(</span>
        <span class="n">default_file</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">confirm</span><span class="p">,</span> <span class="n">no_wizard_file</span><span class="o">=</span><span class="n">no_wiz</span>
    <span class="p">)</span>
    <span class="n">tempenv</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PROMPT&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;XONSH_STORE_STDOUT&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="n">wiz</span><span class="o">.</span><span class="n">PromptVisitor</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">store_in_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multiline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">force_hide</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_STORE_STDOUT&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;_force_hide&quot;</span><span class="p">):</span>
            <span class="n">orig</span><span class="p">,</span> <span class="n">shell</span><span class="o">.</span><span class="n">_force_hide</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">_force_hide</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">yield</span>
            <span class="n">shell</span><span class="o">.</span><span class="n">_force_hide</span> <span class="o">=</span> <span class="n">orig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span>

    <span class="k">with</span> <span class="n">force_hide</span><span class="p">(),</span> <span class="n">env</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">tempenv</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pv</span><span class="o">.</span><span class="n">visit</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="n">print_exception</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_xonfig_format_human</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">wcol1</span> <span class="o">=</span> <span class="n">wcol2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">wcol1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wcol1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subval</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">wcol2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wcol2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">subval</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wcol2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wcol2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">wcol1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;+&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">wcol2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;+</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">row</span> <span class="o">=</span> <span class="s2">&quot;| {key!s:&lt;</span><span class="si">{wcol1}</span><span class="s2">} | {val!s:&lt;</span><span class="si">{wcol2}</span><span class="s2">} |</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">hr</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">row</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">wcol1</span><span class="o">=</span><span class="n">wcol1</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">subval</span><span class="p">,</span> <span class="n">wcol2</span><span class="o">=</span><span class="n">wcol2</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">row</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">wcol1</span><span class="o">=</span><span class="n">wcol1</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">wcol2</span><span class="o">=</span><span class="n">wcol2</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="n">hr</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">_xonfig_format_json</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">}</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;xonsh&quot;</span><span class="p">,</span> <span class="n">XONSH_VERSION</span><span class="p">)]</span>
    <span class="n">hash_</span><span class="p">,</span> <span class="n">date_</span> <span class="o">=</span> <span class="n">githash</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hash_</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Git SHA&quot;</span><span class="p">,</span> <span class="n">hash_</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Commit Date&quot;</span><span class="p">,</span> <span class="n">date_</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Python&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">PYTHON_VERSION_INFO</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;PLY&quot;</span><span class="p">,</span> <span class="n">ply</span><span class="o">.</span><span class="n">__version__</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;have readline&quot;</span><span class="p">,</span> <span class="n">is_readline_available</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;prompt toolkit&quot;</span><span class="p">,</span> <span class="n">ptk_version</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;shell type&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SHELL_TYPE&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;history backend&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_HISTORY_BACKEND&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;pygments&quot;</span><span class="p">,</span> <span class="n">pygments_version</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;on posix&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_POSIX</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;on linux&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_LINUX</span><span class="p">)),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">ON_LINUX</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;distro&quot;</span><span class="p">,</span> <span class="n">linux_distro</span><span class="p">()))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;on wsl&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_WSL</span><span class="p">))),</span>
    <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;on darwin&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_DARWIN</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;on windows&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_WINDOWS</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;on cygwin&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_CYGWIN</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;on msys2&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ON_MSYS</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;is superuser&quot;</span><span class="p">,</span> <span class="n">is_superuser</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;default encoding&quot;</span><span class="p">,</span> <span class="n">DEFAULT_ENCODING</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;xonsh encoding&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;encoding errors&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">jup_ksm</span> <span class="o">=</span> <span class="n">jup_kernel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">jupyter_client.kernelspec</span> <span class="kn">import</span> <span class="n">KernelSpecManager</span>

        <span class="n">jup_ksm</span> <span class="o">=</span> <span class="n">KernelSpecManager</span><span class="p">()</span>
        <span class="n">jup_kernel</span> <span class="o">=</span> <span class="n">jup_ksm</span><span class="o">.</span><span class="n">find_kernel_specs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XONSH_JUPYTER_KERNEL</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s2">&quot;on jupyter&quot;</span><span class="p">,</span> <span class="n">jup_ksm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;jupyter kernel&quot;</span><span class="p">,</span> <span class="n">jup_kernel</span><span class="p">)])</span>

    <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s2">&quot;xontrib&quot;</span><span class="p">,</span> <span class="n">xontribs_loaded</span><span class="p">())])</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">_xonfig_format_json</span> <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">json</span> <span class="k">else</span> <span class="n">_xonfig_format_human</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">_styles</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">)</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">color_style_names</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">styles</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">styles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="n">curr</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;* </span><span class="si">{GREEN}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">style</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">style</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">print_color</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_str_colors</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="n">color_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">)))</span>
    <span class="n">grper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">cols</span> <span class="o">//</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">color_names</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">grper</span><span class="p">):</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">//</span> <span class="n">n</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;{&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">buf</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_tok_colors</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">xonsh.style_tools</span> <span class="kn">import</span> <span class="n">Color</span>

    <span class="n">nc</span> <span class="o">=</span> <span class="n">Color</span><span class="o">.</span><span class="n">RESET</span>
    <span class="n">names_toks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cmap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Token.Color.&quot;</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">names_toks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">color_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names_toks</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">)))</span>
    <span class="n">grper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">cols</span> <span class="o">//</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">color_names</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">grper</span><span class="p">):</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">//</span> <span class="n">n</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">names_toks</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">name</span><span class="p">))</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">toks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nc</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">toks</span>


<span class="k">def</span> <span class="nf">_colors</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">columns</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span>
    <span class="n">columns</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ON_WINDOWS</span><span class="p">)</span>
    <span class="n">style_stash</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">style</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">color_style_names</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid style: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">style</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">style</span>

    <span class="n">color_map</span> <span class="o">=</span> <span class="n">color_style</span><span class="p">()</span>
    <span class="n">akey</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">color_map</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">akey</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_str_colors</span><span class="p">(</span><span class="n">color_map</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_tok_colors</span><span class="p">(</span><span class="n">color_map</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
    <span class="n">print_color</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">style_stash</span>


<span class="k">def</span> <span class="nf">_tutorial</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">webbrowser</span>

    <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;http://xon.sh/tutorial.html&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_web</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;xonsh.webconfig&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">orig_args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>


<span class="k">def</span> <span class="nf">_jupyter_kernel</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make xonsh available as a Jupyter kernel.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">jupyter_client.kernelspec</span> <span class="kn">import</span> <span class="n">KernelSpecManager</span><span class="p">,</span> <span class="n">NoSuchKernel</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Jupyter not found in current Python environment&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="n">ksm</span> <span class="o">=</span> <span class="n">KernelSpecManager</span><span class="p">()</span>

    <span class="n">root</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">root</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">prefix</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">prefix</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">prefix</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">user</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;argv&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
            <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xonsh.jupyter_kernel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{connection_file}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Xonsh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;xonsh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;codemirror_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="c1"># os.path.join isn&#39;t used since prefix is probably absolute</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="n">prefix</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">old_jup_kernel</span> <span class="o">=</span> <span class="n">ksm</span><span class="o">.</span><span class="n">get_kernel_spec</span><span class="p">(</span><span class="n">XONSH_JUPYTER_KERNEL</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old_jup_kernel</span><span class="o">.</span><span class="n">resource_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Removing existing Jupyter kernel found at </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">old_jup_kernel</span><span class="o">.</span><span class="n">resource_dir</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">ksm</span><span class="o">.</span><span class="n">remove_kernel_spec</span><span class="p">(</span><span class="n">XONSH_JUPYTER_KERNEL</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NoSuchKernel</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
        <span class="c1"># Ensure that conda-build detects the hard coded prefix</span>
        <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;argv&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;argv&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">altsep</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">altsep</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">)</span>  <span class="c1"># Starts off as 700, not user readable</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;kernel.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installing Jupyter kernel spec:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  root: </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  as user: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  combined prefix </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  prefix: </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="n">ksm</span><span class="o">.</span><span class="n">install_kernel_spec</span><span class="p">(</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">XONSH_JUPYTER_KERNEL</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_xonfig_create_parser</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="s2">&quot;xonfig&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Manages xonsh configuration.&quot;</span>
    <span class="p">)</span>
    <span class="n">subp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;action&quot;</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;displays configuration information, &quot;</span> <span class="s2">&quot;default action&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--json&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;reports results as json&quot;</span>
    <span class="p">)</span>
    <span class="n">web</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;web&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Launch configurator in browser.&quot;</span><span class="p">)</span>
    <span class="n">web</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-browser&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;browser&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;don&#39;t open browser&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">wiz</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;wizard&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Launch configurator in terminal&quot;</span><span class="p">)</span>
    <span class="n">wiz</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;config file location, default=$XONSHRC&quot;</span>
    <span class="p">)</span>
    <span class="n">wiz</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--confirm&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;confirm that the wizard should be run.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">sty</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;styles&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;prints available xonsh color styles&quot;</span><span class="p">)</span>
    <span class="n">sty</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--json&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;reports results as json&quot;</span>
    <span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;colors&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;preview color style&quot;</span><span class="p">)</span>
    <span class="n">colors</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;style to preview, default: &lt;current&gt;&quot;</span>
    <span class="p">)</span>
    <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;tutorial&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Launch tutorial in browser.&quot;</span><span class="p">)</span>
    <span class="n">kern</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;jupyter-kernel&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Generate xonsh kernel for jupyter.&quot;</span><span class="p">)</span>
    <span class="n">kern</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--user&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Install kernel spec in user config directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">kern</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--root&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Install relative to this alternate root directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">kern</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--prefix&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Installation prefix for bin, lib, etc.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">p</span>


<span class="n">XONFIG_MAIN_ACTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">_info</span><span class="p">,</span>
    <span class="s2">&quot;web&quot;</span><span class="p">:</span> <span class="n">_web</span><span class="p">,</span>
    <span class="s2">&quot;wizard&quot;</span><span class="p">:</span> <span class="n">_wizard</span><span class="p">,</span>
    <span class="s2">&quot;styles&quot;</span><span class="p">:</span> <span class="n">_styles</span><span class="p">,</span>
    <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="n">_colors</span><span class="p">,</span>
    <span class="s2">&quot;tutorial&quot;</span><span class="p">:</span> <span class="n">_tutorial</span><span class="p">,</span>
    <span class="s2">&quot;jupyter-kernel&quot;</span><span class="p">:</span> <span class="n">_jupyter_kernel</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">xonfig_main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main xonfig entry point.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">XONFIG_MAIN_ACTIONS</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">}</span>
    <span class="p">):</span>
        <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">_xonfig_create_parser</span><span class="p">()</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">ns</span><span class="o">.</span><span class="n">orig_args</span> <span class="o">=</span> <span class="n">args</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># apply default action</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">XONFIG_MAIN_ACTIONS</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">action</span><span class="p">](</span><span class="n">ns</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">STRIP_COLOR_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;{.*?}&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_align_string</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Align and pad a color formatted string&quot;&quot;&quot;</span>
    <span class="n">linelen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">STRIP_COLOR_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">))</span>
    <span class="n">padlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">linelen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;^&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fill</span> <span class="o">*</span> <span class="p">(</span><span class="n">padlen</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">string</span> <span class="o">+</span> <span class="n">fill</span> <span class="o">*</span> <span class="p">(</span><span class="n">padlen</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">padlen</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fill</span> <span class="o">*</span> <span class="n">padlen</span> <span class="o">+</span> <span class="n">string</span>
    <span class="k">elif</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span> <span class="o">+</span> <span class="n">fill</span> <span class="o">*</span> <span class="n">padlen</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">TAGLINES</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s2">&quot;Exofrills in the shell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;No frills in the shell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Become the Lord of the Files&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Break out of your shell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The only shell that is also a shell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;All that is and all that shell be&quot;</span><span class="p">,</span>
        <span class="s2">&quot;It cannot be that hard&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Pass the xonsh, Piggy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Piggy glanced nervously into hell and cradled the xonsh&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The xonsh is a symbol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;It is pronounced conch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Snailed it&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Starfish loves you&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Come snail away&quot;</span><span class="p">,</span>
        <span class="s2">&quot;This is Major Tom to Ground Xonshtrol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sally sells csh and keeps xonsh to herself&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Nice indeed. Everything&#39;s accounted for, except your old shell.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;I wanna thank you for putting me back in my snail shell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Crustaceanly Yours&quot;</span><span class="p">,</span>
        <span class="s2">&quot;With great shell comes great reproducibility&quot;</span><span class="p">,</span>
        <span class="s2">&quot;None shell pass&quot;</span><span class="p">,</span>
        <span class="s2">&quot;You shell not pass!&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The x-on shell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Ever wonder why there isn&#39;t a Taco Shell? Because it is a corny idea.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The carcolh will catch you!&quot;</span><span class="p">,</span>
        <span class="s2">&quot;People xonshtantly mispronounce these things&quot;</span><span class="p">,</span>
        <span class="s2">&quot;WHAT...is your favorite shell?&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Conches for the xonsh god!&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Python-powered, cross-platform, Unix-gazing shell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Tab completion in Alderaan places&quot;</span><span class="p">,</span>
        <span class="s2">&quot;This fix was trickier than expected&quot;</span><span class="p">,</span>
    <span class="p">]</span>


<span class="c1"># list of strings or tuples (string, align, fill)</span>
<span class="n">WELCOME_MSG</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;Welcome to the xonsh shell </span><span class="si">{version}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
    <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;{{INTENSE_RED}}~{{RESET}} </span><span class="si">{tagline}</span><span class="s2"> {{INTENSE_RED}}~{{RESET}}&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
    <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;{{INTENSE_BLACK}}&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
    <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span>
        <span class="s2">&quot;{{INTENSE_BLACK}}Create ~/.xonshrc file manually or use xonfig to suppress the welcome message&quot;</span><span class="p">,</span>
        <span class="s2">&quot;^&quot;</span><span class="p">,</span>
        <span class="s2">&quot; &quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;{{INTENSE_BLACK}}Start from commands:&quot;</span><span class="p">,</span>
    <span class="s2">&quot;  {{GREEN}}xonfig{{RESET}} web         {{INTENSE_BLACK}}# Run the configuration tool in the browser to create ~/.xonshrc {{RESET}}&quot;</span><span class="p">,</span>
    <span class="s2">&quot;  {{GREEN}}xonfig{{RESET}} tutorial    {{INTENSE_BLACK}}# Open the xonsh tutorial in the browser{{RESET}}&quot;</span><span class="p">,</span>
    <span class="s2">&quot;[SHELL_TYPE_WARNING]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="s2">&quot;{{INTENSE_BLACK}}&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
    <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">print_welcome_screen</span><span class="p">():</span>
    <span class="n">shell_type</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SHELL_TYPE&quot;</span><span class="p">)</span>
    <span class="n">subst</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tagline</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">TAGLINES</span><span class="p">)),</span> <span class="n">version</span><span class="o">=</span><span class="n">XONSH_VERSION</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">WELCOME_MSG</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">elem</span> <span class="o">==</span> <span class="s2">&quot;[SHELL_TYPE_WARNING]&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shell_type</span> <span class="o">!=</span> <span class="s2">&quot;prompt_toolkit&quot;</span><span class="p">:</span>
                <span class="n">print_color</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n{{</span><span class="s2">INTENSE_BLACK</span><span class="se">}}</span><span class="s2">You are currently using the </span><span class="si">{</span><span class="n">shell_type</span><span class="si">}</span><span class="s2"> backend. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;For interactive tab-completion, on-the-fly syntax highlighting, and more, install prompt_toolkit by running:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;  </span><span class="se">{{</span><span class="s2">GREEN</span><span class="se">}}</span><span class="s2">xpip</span><span class="se">{{</span><span class="s2">RESET</span><span class="se">}}</span><span class="s2"> install -U &#39;xonsh[full]&#39;&quot;</span>
                <span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">subst</span><span class="p">)</span>
        <span class="n">termwidth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">_align_string</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">elem</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">termwidth</span><span class="p">)</span>
        <span class="n">print_color</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">print_color</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># base_shell</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The base class for xonsh shell&quot;&quot;&quot;</span>
<span class="c1"># amalgamated io</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated time</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.codecache</span>
<span class="c1"># amalgamated xonsh.completer</span>
<span class="kn">from</span> <span class="nn">xonsh.prompt.base</span> <span class="kn">import</span> <span class="n">multiline_prompt</span><span class="p">,</span> <span class="n">PromptFormatter</span>
<span class="c1"># amalgamated xonsh.events</span>
<span class="c1"># amalgamated xonsh.shell</span>
<span class="c1"># amalgamated xonsh.lazyimps</span>
<span class="c1"># amalgamated xonsh.ansi_colors</span>
<span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ctypes</span>

    <span class="n">kernel32</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span>  <span class="c1"># type:ignore</span>
    <span class="n">kernel32</span><span class="o">.</span><span class="n">SetConsoleTitleW</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_wchar_p</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_TeeStdBuf</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">RawIOBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dispatcher for bytes to two buffers, as std stream buffer and an</span>
<span class="sd">    in memory buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stdbuf</span><span class="p">,</span> <span class="n">membuf</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prestd</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">poststd</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stdbuf : BytesIO-like or StringIO-like</span>
<span class="sd">            The std stream buffer.</span>
<span class="sd">        membuf : BytesIO-like</span>
<span class="sd">            The in memory stream buffer.</span>
<span class="sd">        encoding : str or None, optional</span>
<span class="sd">            The encoding of the stream. Only used if stdbuf is a text stream,</span>
<span class="sd">            rather than a binary one. Defaults to $XONSH_ENCODING if None.</span>
<span class="sd">        errors : str or None, optional</span>
<span class="sd">            The error form for the encoding of the stream. Only used if stdbuf</span>
<span class="sd">            is a text stream, rather than a binary one. Deafults to</span>
<span class="sd">            $XONSH_ENCODING_ERRORS if None.</span>
<span class="sd">        prestd : bytes, optional</span>
<span class="sd">            The prefix to prepend to the standard buffer.</span>
<span class="sd">        poststd : bytes, optional</span>
<span class="sd">            The postfix to append to the standard buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdbuf</span> <span class="o">=</span> <span class="n">stdbuf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">membuf</span> <span class="o">=</span> <span class="n">membuf</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prestd</span> <span class="o">=</span> <span class="n">prestd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poststd</span> <span class="o">=</span> <span class="n">poststd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_std_is_binary</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stdbuf</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="n">stdbuf</span><span class="p">,</span> <span class="s2">&quot;_redirect_to&quot;</span>
        <span class="p">)</span>  <span class="c1"># VS Code terminal window - has encoding attr but won&#39;t accept str</span>

    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the file descriptor of the std buffer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdbuf</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the location in both the stdbuf and the membuf.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdbuf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">membuf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Truncate both buffers.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdbuf</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">membuf</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read bytes into buffer from both streams.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_is_binary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdbuf</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">membuf</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write bytes into both buffers.&quot;&quot;&quot;</span>
        <span class="n">std_b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prestd</span><span class="p">:</span>
            <span class="n">std_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prestd</span> <span class="o">+</span> <span class="n">b</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststd</span><span class="p">:</span>
            <span class="n">std_b</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststd</span>
        <span class="c1"># write to stdbuf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_is_binary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">std_b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">std_b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">membuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_TeeStd</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">TextIOBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tees a std stream into an in-memory container and the original stream.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">prestd</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">poststd</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the buffer in the sys module, e.g. &#39;stdout&#39;.</span>
<span class="sd">        mem : io.TextIOBase-like</span>
<span class="sd">            The in-memory text-based representation.</span>
<span class="sd">        prestd : str, optional</span>
<span class="sd">            The prefix to prepend to the standard stream.</span>
<span class="sd">        poststd : str, optional</span>
<span class="sd">            The postfix to append to the standard stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="n">mem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prestd</span> <span class="o">=</span> <span class="n">prestd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poststd</span> <span class="o">=</span> <span class="n">poststd</span>
        <span class="n">preb</span> <span class="o">=</span> <span class="n">prestd</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">mem</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">mem</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">postb</span> <span class="o">=</span> <span class="n">poststd</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">mem</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">mem</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="s2">&quot;buffer&quot;</span><span class="p">):</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_TeeStdBuf</span><span class="p">(</span><span class="n">std</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">mem</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">prestd</span><span class="o">=</span><span class="n">preb</span><span class="p">,</span> <span class="n">poststd</span><span class="o">=</span><span class="n">postb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TextIO does not have buffer as part of the API, so std streams</span>
            <span class="c1"># may not either.</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">_TeeStdBuf</span><span class="p">(</span>
                <span class="n">std</span><span class="p">,</span>
                <span class="n">mem</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="n">mem</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
                <span class="n">errors</span><span class="o">=</span><span class="n">mem</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
                <span class="n">prestd</span><span class="o">=</span><span class="n">preb</span><span class="p">,</span>
                <span class="n">poststd</span><span class="o">=</span><span class="n">postb</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The encoding of the in-memory buffer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">encoding</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The errors of the in-memory buffer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">errors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">newlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The newlines of the in-memory buffer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">newlines</span>

    <span class="k">def</span> <span class="nf">_replace_std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span>
        <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace_std</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restores the original std stream.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace_std</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes data to the original std stream and the in-memory object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">std_s</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prestd</span><span class="p">:</span>
            <span class="n">std_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prestd</span> <span class="o">+</span> <span class="n">std_s</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststd</span><span class="p">:</span>
            <span class="n">std_s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">std_s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flushes both the original stdout and the buffer.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tunnel fileno() calls to the std stream.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seek to a location in both streams.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seek to a location in both streams.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This operation is not supported.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">io</span><span class="o">.</span><span class="n">UnsupportedOperation</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read from the in-memory stream and seek to a new location in the</span>
<span class="sd">        std stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a line from the in-memory stream and seek to a new location</span>
<span class="sd">        in the std stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;delegate the method to the underlying io-wrapper&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">:</span>  <span class="c1"># it happens to be reset sometimes</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Tee</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class that merges tee&#39;d stdout and stderr into a single stream.</span>

<span class="sd">    This represents what a user would actually see on the command line.</span>
<span class="sd">    This class has the same interface as io.TextIOWrapper, except that</span>
<span class="sd">    the buffer is optional.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint is a stupid about counting public methods when using inheritance.</span>
    <span class="c1"># pylint: disable=too-few-public-methods</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">newline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">line_buffering</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">write_through</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
            <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">,</span>
            <span class="n">line_buffering</span><span class="o">=</span><span class="n">line_buffering</span><span class="p">,</span>
            <span class="n">write_through</span><span class="o">=</span><span class="n">write_through</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">_TeeStd</span><span class="p">(</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
        <span class="n">prestderr</span> <span class="o">=</span> <span class="n">format_std_prepost</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_STDERR_PREFIX&quot;</span><span class="p">))</span>
        <span class="n">poststderr</span> <span class="o">=</span> <span class="n">format_std_prepost</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_STDERR_POSTFIX&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">_TeeStd</span><span class="p">(</span>
            <span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">prestd</span><span class="o">=</span><span class="n">prestderr</span><span class="p">,</span> <span class="n">poststd</span><span class="o">=</span><span class="n">poststderr</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">line_buffering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">line_buffering</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes the buffer as well as the stdout and stderr tees.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the current contents of the in-memory buffer.&quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="k">class</span> <span class="nc">BaseShell</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The xonsh shell.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execer</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execer</span> <span class="o">=</span> <span class="n">execer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completer</span> <span class="o">=</span> <span class="n">Completer</span><span class="p">()</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;completer&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_starts_with_space</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_styler</span> <span class="o">=</span> <span class="n">DefaultNotGiven</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_formatter</span> <span class="o">=</span> <span class="n">PromptFormatter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accumulated_inputs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precwd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># The current working directory just before execution of the line</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">styler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_styler</span> <span class="ow">is</span> <span class="n">DefaultNotGiven</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">HAS_PYGMENTS</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">xonsh.pyghooks</span> <span class="kn">import</span> <span class="n">XonshStyle</span>

                <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_styler</span> <span class="o">=</span> <span class="n">XonshStyle</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_styler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_styler</span>

    <span class="nd">@styler</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">styler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_styler</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@styler</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">styler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_styler</span> <span class="o">=</span> <span class="n">DefaultNotGiven</span>

    <span class="k">def</span> <span class="nf">emptyline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when an empty line has been entered.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">singleline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a single line of input from the shell.&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> has not implemented singleline().&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">precmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called just before execution of line.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">line</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span> <span class="k">else</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">raw_line</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implements code execution.&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span><span class="p">:</span>  <span class="c1"># this is the first line</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_line</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">src_starts_with_space</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">src_starts_with_space</span> <span class="o">=</span> <span class="n">raw_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span>
        <span class="n">src</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">events</span><span class="o">.</span><span class="n">on_precommand</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">src</span><span class="p">)</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">history</span>  <span class="c1"># pylint: disable=no-member</span>
        <span class="n">ts1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
        <span class="n">tee</span> <span class="o">=</span> <span class="n">Tee</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
        <span class="n">ts0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run_compiled_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">)</span>
            <span class="n">ts1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># returncode for success</span>
        <span class="k">except</span> <span class="n">XonshError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># return code for failure</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="n">print_exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># return code for failure</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">ts1</span> <span class="o">=</span> <span class="n">ts1</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">tee_out</span> <span class="o">=</span> <span class="n">tee</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_history</span><span class="p">(</span>
                <span class="n">inp</span><span class="o">=</span><span class="n">src</span><span class="p">,</span>
                <span class="n">ts</span><span class="o">=</span><span class="p">[</span><span class="n">ts0</span><span class="p">,</span> <span class="n">ts1</span><span class="p">],</span>
                <span class="n">spc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_starts_with_space</span><span class="p">,</span>
                <span class="n">tee_out</span><span class="o">=</span><span class="n">tee_out</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">precwd</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accumulated_inputs</span> <span class="o">+=</span> <span class="n">src</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">tee_out</span>
                <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_APPEND_NEWLINE&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">tee_out</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">tee</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fix_cwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>  <span class="c1"># pylint: disable=no-member</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_append_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tee_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append information about the command to the history.</span>

<span class="sd">        This also handles on_postcommand because this is the place where all the</span>
<span class="sd">        information is available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">history</span>  <span class="c1"># pylint: disable=no-member</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;rtn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">tee_out</span> <span class="o">=</span> <span class="n">tee_out</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">last_out</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_out</span> <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">last_out</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tee_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">last_out</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tee_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tee_out</span>
        <span class="k">elif</span> <span class="n">last_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tee_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tee_out</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">last_out</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_postcommand</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span>
            <span class="n">cmd</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;inp&quot;</span><span class="p">],</span> <span class="n">rtn</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;rtn&quot;</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ts</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;ts&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">last_cmd_out</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_fix_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the cwd changed out from under us.&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># directory has been deleted out from under us, most likely</span>
            <span class="n">pwd</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PWD&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pwd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># we have no idea where we are</span>
                <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;invalid directory&gt;&quot;</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pwd</span><span class="p">):</span>
                <span class="c1"># unclear why os.getcwd() failed. do nothing.</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># OK PWD is really gone.</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{UNDERLINE_INTENSE_WHITE}{BACKGROUND_INTENSE_BLACK}</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;xonsh: working directory does not exist: &quot;</span> <span class="o">+</span> <span class="n">pwd</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_color</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;PWD&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
            <span class="c1"># $PWD is missing from env, recreate it</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cwd</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]):</span>
            <span class="c1"># The working directory has changed without updating $PWD, fix this</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cwd</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;OLDPWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old</span>
            <span class="n">events</span><span class="o">.</span><span class="n">on_chdir</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">olddir</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">newdir</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pushes a line onto the buffer and compiles the code in a way that</span>
<span class="sd">        enables multiline input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">transform_command</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compiles source code and returns the (possibly modified) source and</span>
<span class="sd">        a valid code object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_cache</span> <span class="o">=</span> <span class="n">should_use_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execer</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_cache</span><span class="p">:</span>
            <span class="n">codefname</span> <span class="o">=</span> <span class="n">code_cache_name</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">cachefname</span> <span class="o">=</span> <span class="n">get_cache_filename</span><span class="p">(</span><span class="n">codefname</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">usecache</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">code_cache_check</span><span class="p">(</span><span class="n">cachefname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">usecache</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_buffer</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">code</span>
        <span class="n">lincont</span> <span class="o">=</span> <span class="n">get_line_continuation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">lincont</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="n">glbs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">locs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_cache</span><span class="p">:</span>
                <span class="n">update_cache</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">cachefname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_buffer</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="n">partial_string_info</span> <span class="o">=</span> <span class="n">check_for_partial_string</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">in_partial_string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">partial_string_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">partial_string_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">or</span> <span class="n">src</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_partial_string</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_buffer</span><span class="p">()</span>
                <span class="n">print_exception</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_buffer</span><span class="p">()</span>
            <span class="n">print_exception</span><span class="p">()</span>
            <span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">reset_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resets the line buffer.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">settitle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets terminal title.&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>  <span class="c1"># pylint: disable=no-member</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TERM&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Shells running in emacs sets TERM to &quot;dumb&quot; or &quot;eterm-color&quot;.</span>
        <span class="c1"># Do not set title for these to avoid garbled prompt.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">term</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ON_WINDOWS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">term</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;dumb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eterm-color&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linux&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_formatter</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">and</span> <span class="s2">&quot;ANSICON&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">kernel32</span><span class="o">.</span><span class="n">SetConsoleTitleW</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="n">closefd</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># prevent xonsh from answering interactive questions</span>
                <span class="c1"># on the next command by writing the title</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">]0;</span><span class="si">{0}</span><span class="se">\x07</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtains the current prompt string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span> <span class="o">=</span> <span class="n">multiline_prompt</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                    <span class="n">print_exception</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span> <span class="o">=</span> <span class="s2">&quot;&lt;multiline prompt error&gt; &quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>  <span class="c1"># pylint: disable=no-member</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PROMPT&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_formatter</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="n">print_exception</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settitle</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">format_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Formats the colors in a string. ``BaseShell``&#39;s default implementation</span>
<span class="sd">        of this method uses colors based on ANSI color codes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ansi_partial_color_format</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="n">hide</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints a string in color. This base implementation&#39;s colors are based</span>
<span class="sd">        on ANSI color codes if a string was given as input. If a list of token</span>
<span class="sd">        pairs is given, it will color based on pygments, if available. If</span>
<span class="sd">        pygments is not available, it will print a colorless string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_color</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">HAS_PYGMENTS</span><span class="p">:</span>
            <span class="c1"># assume this is a list of (Token, str) tuples and format it</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">styler</span><span class="o">.</span><span class="n">style_name</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">)</span>
            <span class="n">style_proxy</span> <span class="o">=</span> <span class="n">pyghooks</span><span class="o">.</span><span class="n">xonsh_style_proxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">styler</span><span class="p">)</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">pyghooks</span><span class="o">.</span><span class="n">XonshTerminal256Formatter</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style_proxy</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># assume this is a list of (Token, str) tuples and remove color</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">string</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">color_style_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an iterable of all available style names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">color_style</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the current color map.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">restore_tty_sanity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An interface for resetting the TTY stdin mode. This is highly</span>
<span class="sd">        dependent on the shell backend. Also it is mostly optional since</span>
<span class="sd">        it only affects ^Z backgrounding behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<span class="c1">#</span>
<span class="c1"># environ</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Environment for the xonsh shell.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated pprint</span>
<span class="c1"># amalgamated textwrap</span>
<span class="n">locale</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;locale&#39;</span><span class="p">,</span> <span class="s1">&#39;locale&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated glob</span>
<span class="c1"># amalgamated warnings</span>
<span class="c1"># amalgamated contextlib</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="c1"># amalgamated subprocess</span>
<span class="c1"># amalgamated platform</span>
<span class="c1"># amalgamated typing</span>
<span class="kn">from</span> <span class="nn">xonsh</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">XONSH_VERSION</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.codecache</span>
<span class="c1"># amalgamated xonsh.dirstack</span>
<span class="c1"># amalgamated xonsh.events</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.ansi_colors</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;xonsh&#39;</span><span class="p">,</span> <span class="s1">&#39;xonsh.prompt.base&#39;</span><span class="p">,</span> <span class="s1">&#39;prompt&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">xonsh.prompt.gitstatus</span> <span class="kn">import</span> <span class="n">_DEFS</span> <span class="k">as</span> <span class="n">GITSTATUS_FIELD_DEFS</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_envvar_new&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_envvar_new(name: str, value: Any) -&gt; None</span>

<span class="sd">Fires after a new environment variable is created.</span>
<span class="sd">Note: Setting envvars inside the handler might</span>
<span class="sd">cause a recursion until the limit.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_envvar_change&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_envvar_change(name: str, oldvalue: Any, newvalue: Any) -&gt; None</span>

<span class="sd">Fires after an environment variable is changed.</span>
<span class="sd">Note: Setting envvars inside the handler might</span>
<span class="sd">cause a recursion until the limit.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_pre_spec_run_ls&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_pre_spec_run_ls(spec: xonsh.built_ins.SubprocSpec) -&gt; None</span>

<span class="sd">Fires right before a SubprocSpec.run() is called for the ls</span>
<span class="sd">command.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_lscolors_change&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_lscolors_change(key: str, oldvalue: Any, newvalue: Any) -&gt; None</span>

<span class="sd">Fires after a value in LS_COLORS changes, when a new key is added (oldvalue is None)</span>
<span class="sd">or when an existing key is deleted (newvalue is None).</span>
<span class="sd">LS_COLORS values must be (ANSI color) strings, None is unambiguous.</span>
<span class="sd">Does not fire when the whole environment variable changes (see on_envvar_change).</span>
<span class="sd">Does not fire for each value when LS_COLORS is first instantiated.</span>
<span class="sd">Normal usage is to arm the event handler, then read (not modify) all existing values.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">HELP_TEMPLATE</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s2">&quot;{{INTENSE_RED}}</span><span class="si">{envvar}</span><span class="s2">{{RESET}}:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;{{INTENSE_YELLOW}}</span><span class="si">{docstr}</span><span class="s2">{{RESET}}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;default: {{CYAN}}</span><span class="si">{default}</span><span class="s2">{{RESET}}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;configurable: {{CYAN}}</span><span class="si">{configurable}</span><span class="s2">{{RESET}}&quot;</span>
    <span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">LOCALE_CATS</span><span class="p">():</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;LC_CTYPE&quot;</span><span class="p">:</span> <span class="n">locale</span><span class="o">.</span><span class="n">LC_CTYPE</span><span class="p">,</span>
        <span class="s2">&quot;LC_COLLATE&quot;</span><span class="p">:</span> <span class="n">locale</span><span class="o">.</span><span class="n">LC_COLLATE</span><span class="p">,</span>
        <span class="s2">&quot;LC_NUMERIC&quot;</span><span class="p">:</span> <span class="n">locale</span><span class="o">.</span><span class="n">LC_NUMERIC</span><span class="p">,</span>
        <span class="s2">&quot;LC_MONETARY&quot;</span><span class="p">:</span> <span class="n">locale</span><span class="o">.</span><span class="n">LC_MONETARY</span><span class="p">,</span>
        <span class="s2">&quot;LC_TIME&quot;</span><span class="p">:</span> <span class="n">locale</span><span class="o">.</span><span class="n">LC_TIME</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="s2">&quot;LC_MESSAGES&quot;</span><span class="p">):</span>
        <span class="n">lc</span><span class="p">[</span><span class="s2">&quot;LC_MESSAGES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">LC_MESSAGES</span>
    <span class="k">return</span> <span class="n">lc</span>


<span class="k">def</span> <span class="nf">locale_convert</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a converter for a locale key.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">lc_converter</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">LOCALE_CATS</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">LOCALE_CATS</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to set locale </span><span class="si">{0!r}</span><span class="s2"> to </span><span class="si">{1!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">lc_converter</span>


<span class="k">def</span> <span class="nf">to_debug</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts value using to_bool_or_int() and sets this value on as the</span>
<span class="sd">    execer&#39;s debug level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">to_bool_or_int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">execer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">XSH</span><span class="o">.</span><span class="n">execer</span><span class="o">.</span><span class="n">debug_level</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="c1">#</span>
<span class="c1"># $LS_COLORS tools</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">LsColors</span><span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helps convert to/from $LS_COLORS format, respecting the xonsh color style.</span>
<span class="sd">    This accepts the same inputs as dict(). The special value ``target`` is</span>
<span class="sd">    replaced by no color, but sets a flag for cognizant application (see is_target()).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">default_settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;*.7z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.Z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.aac&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.ace&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.alz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.arc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.arj&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.asf&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.au&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.avi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.bmp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.bz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.bz2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.cab&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.cgm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.cpio&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.deb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.dl&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.dwm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.dz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.ear&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.emf&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.esd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.flac&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.flc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.fli&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.flv&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.gif&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.gl&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.gz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.jar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.jpeg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.jpg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.lha&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.lrz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.lz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.lz4&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.lzh&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.lzma&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.lzo&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.m2v&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.m4a&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.m4v&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mid&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.midi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mjpeg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mjpg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mka&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mkv&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mng&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mov&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mp3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mp4&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mp4v&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mpc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mpeg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.mpg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.nuv&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.oga&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.ogg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.ogm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.ogv&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.ogx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.opus&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.pbm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.pcx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.pgm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.png&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.ppm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.qt&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.ra&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.rar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.rm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.rmvb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.rpm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.rz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.sar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.spx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.svg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.svgz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.swm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.t7z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.taz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tbz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tbz2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tga&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tgz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tif&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tiff&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tlz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.txz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tzo&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.tzst&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.vob&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.war&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.wav&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.webm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.wim&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.wmv&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.xbm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.xcf&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.xpm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.xspf&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.xwd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.xz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.yuv&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.zip&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.zoo&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;*.zst&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_RED&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;bd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BACKGROUND_BLACK&quot;</span><span class="p">,</span> <span class="s2">&quot;YELLOW&quot;</span><span class="p">),</span>
        <span class="s2">&quot;ca&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BLACK&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKGROUND_RED&quot;</span><span class="p">),</span>
        <span class="s2">&quot;cd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BACKGROUND_BLACK&quot;</span><span class="p">,</span> <span class="s2">&quot;YELLOW&quot;</span><span class="p">),</span>
        <span class="s2">&quot;di&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_BLUE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;do&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;ex&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_GREEN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;fi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;ln&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_CYAN&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;mh&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;mi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;or&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BACKGROUND_BLACK&quot;</span><span class="p">,</span> <span class="s2">&quot;RED&quot;</span><span class="p">),</span>
        <span class="s2">&quot;ow&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BLUE&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKGROUND_GREEN&quot;</span><span class="p">),</span>
        <span class="s2">&quot;pi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BACKGROUND_BLACK&quot;</span><span class="p">,</span> <span class="s2">&quot;YELLOW&quot;</span><span class="p">),</span>
        <span class="s2">&quot;rs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;sg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BLACK&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKGROUND_YELLOW&quot;</span><span class="p">),</span>
        <span class="s2">&quot;so&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BOLD_PURPLE&quot;</span><span class="p">,),</span>
        <span class="s2">&quot;st&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;WHITE&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKGROUND_BLUE&quot;</span><span class="p">),</span>
        <span class="s2">&quot;su&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;WHITE&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKGROUND_RED&quot;</span><span class="p">),</span>
        <span class="s2">&quot;tw&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;BLACK&quot;</span><span class="p">,</span> <span class="s2">&quot;BACKGROUND_GREEN&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">target_value</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span>  <span class="c1"># special value to set for ln=target</span>
    <span class="n">target_color</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,)</span>  <span class="c1"># repres in color space</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ini_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ini_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ini_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">LsColors</span><span class="o">.</span><span class="n">target_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">LsColors</span><span class="o">.</span><span class="n">target_color</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">LsColors</span><span class="o">.</span><span class="n">target_value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">LsColors</span><span class="o">.</span><span class="n">target_color</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">old_value</span> <span class="o">!=</span> <span class="n">value</span>
        <span class="p">):</span>  <span class="c1"># bug won&#39;t fire if new value is &#39;target&#39; and old value happened to be no color.</span>
            <span class="n">events</span><span class="o">.</span><span class="n">on_lscolors_change</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">oldvalue</span><span class="o">=</span><span class="n">old_value</span><span class="p">,</span> <span class="n">newvalue</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_lscolors_change</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">oldvalue</span><span class="o">=</span><span class="n">old_value</span><span class="p">,</span> <span class="n">newvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">(...)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">_repr_pretty_</span> <span class="o">=</span> <span class="n">to_repr_pretty_</span>

    <span class="k">def</span> <span class="nf">is_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True if key is &#39;target&#39;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span>

    <span class="k">def</span> <span class="nf">detype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;De-types the instance, allowing it to be exported to the environment.&quot;&quot;&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">key</span>
                    <span class="o">+</span> <span class="s2">&quot;=&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">LsColors</span><span class="o">.</span><span class="n">target_value</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span>
                            <span class="k">else</span> <span class="n">ansi_color_name_to_escape_code</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">style_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current XONSH_COLOR_STYLE value&quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">XSH</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">env_style_name</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style_name</span> <span class="o">!=</span> <span class="n">env_style_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_style_name</span> <span class="o">=</span> <span class="n">env_style_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">style</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ANSI color style for the current XONSH_COLOR_STYLE&quot;&quot;&quot;</span>
        <span class="n">style_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="o">=</span> <span class="n">ansi_style_by_name</span><span class="p">(</span><span class="n">style_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromstring</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new instance of the LsColors class from a colon-separated</span>
<span class="sd">        string of dircolor-valid keys to ANSI color escape sequences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ini_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># string inputs always use default codes, so translating into</span>
        <span class="c1"># xonsh names should be done from defaults</span>
        <span class="n">reversed_default</span> <span class="o">=</span> <span class="n">ansi_reverse_style</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">esc</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                <span class="c1"># not a valid item</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">esc</span> <span class="o">==</span> <span class="n">LsColors</span><span class="o">.</span><span class="n">target_value</span><span class="p">:</span>  <span class="c1"># really only for &#39;ln&#39;</span>
                <span class="n">ini_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">esc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ini_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ansi_color_escape_code_to_name</span><span class="p">(</span>
                        <span class="n">esc</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">reversed_style</span><span class="o">=</span><span class="n">reversed_default</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xonsh:warning:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="n">ini_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ini_dict</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromdircolors</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs an LsColors instance by running dircolors.</span>
<span class="sd">        If a filename is provided, it is passed down to the dircolors command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assemble command</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dircolors&quot;</span><span class="p">,</span> <span class="s2">&quot;-b&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># get env</span>
        <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
            <span class="n">denv</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">detype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">denv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># run dircolors</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">denv</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">default_settings</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts an object to LsColors, if needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_lscolors</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if an object is an instance of LsColors&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">LsColors</span><span class="p">)</span>


<span class="nd">@events</span><span class="o">.</span><span class="n">on_pre_spec_run_ls</span>
<span class="k">def</span> <span class="nf">ensure_ls_colors_in_env</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This ensures that the $LS_COLORS environment variable is in the</span>
<span class="sd">    environment. This fires exactly once upon the first time the</span>
<span class="sd">    ls command is called.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="k">if</span> <span class="s2">&quot;LS_COLORS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">_d</span><span class="p">:</span>
        <span class="c1"># this adds it to the env too</span>
        <span class="n">default_lscolors</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">events</span><span class="o">.</span><span class="n">on_pre_spec_run_ls</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">ensure_ls_colors_in_env</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># Ensurers</span>
<span class="c1">#</span>

<span class="c1"># we use this as a registry of common ensurers; valuable for user interface</span>
<span class="n">ENSURERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">is_bool</span><span class="p">,</span> <span class="n">to_bool</span><span class="p">,</span> <span class="n">bool_to_str</span><span class="p">),</span>
    <span class="s2">&quot;str&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">is_string</span><span class="p">,</span> <span class="n">ensure_string</span><span class="p">,</span> <span class="n">ensure_string</span><span class="p">),</span>
    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">is_path</span><span class="p">,</span> <span class="n">str_to_path</span><span class="p">,</span> <span class="n">path_to_str</span><span class="p">),</span>
    <span class="s2">&quot;env_path&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">is_env_path</span><span class="p">,</span> <span class="n">str_to_env_path</span><span class="p">,</span> <span class="n">env_path_to_str</span><span class="p">),</span>
    <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">is_float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
    <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">is_int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
<span class="p">}</span>


<span class="c1">#</span>
<span class="c1"># Defaults</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator for making callable default values.&quot;&quot;&quot;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">_xonsh_callable_default</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">is_callable_default</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if a value is a callable default.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">callable</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;_xonsh_callable_default&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="n">DEFAULT_TITLE</span> <span class="o">=</span> <span class="s2">&quot;{current_job:</span><span class="si">{}</span><span class="s2"> | }</span><span class="si">{user}</span><span class="s2">@</span><span class="si">{hostname}</span><span class="s2">: </span><span class="si">{cwd}</span><span class="s2"> | xonsh&quot;</span>


<span class="nd">@default_value</span>
<span class="k">def</span> <span class="nf">xonsh_data_dir</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensures and returns the $XONSH_DATA_DIR&quot;&quot;&quot;</span>
    <span class="n">xdd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XDG_DATA_HOME&quot;</span><span class="p">),</span> <span class="s2">&quot;xonsh&quot;</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">xdd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xdd</span>


<span class="nd">@default_value</span>
<span class="k">def</span> <span class="nf">xonsh_config_dir</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensures and returns the $XONSH_CONFIG_DIR&quot;&quot;&quot;</span>
    <span class="n">xcd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XDG_CONFIG_HOME&quot;</span><span class="p">),</span> <span class="s2">&quot;xonsh&quot;</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">xcd</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xcd</span>


<span class="k">def</span> <span class="nf">xonshconfig</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensures and returns the $XONSHCONFIG&quot;&quot;&quot;</span>
    <span class="n">xcd</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_CONFIG_DIR&quot;</span><span class="p">)</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xcd</span><span class="p">,</span> <span class="s2">&quot;config.json&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xc</span>


<span class="nd">@default_value</span>
<span class="k">def</span> <span class="nf">default_xonshrc</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new instance of the default xonshrc tuple.&quot;&quot;&quot;</span>
    <span class="n">xcdrc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xonsh_config_dir</span><span class="p">(</span><span class="n">env</span><span class="p">),</span> <span class="s2">&quot;rc.xsh&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="n">dxrc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os_environ</span><span class="p">[</span><span class="s2">&quot;ALLUSERSPROFILE&quot;</span><span class="p">],</span> <span class="s2">&quot;xonsh&quot;</span><span class="p">,</span> <span class="s2">&quot;xonshrc&quot;</span><span class="p">),</span>
            <span class="n">xcdrc</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.xonshrc&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dxrc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;/etc/xonshrc&quot;</span><span class="p">,</span> <span class="n">xcdrc</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.xonshrc&quot;</span><span class="p">))</span>
    <span class="c1"># Check if old config file exists and issue warning</span>
    <span class="n">old_config_filename</span> <span class="o">=</span> <span class="n">xonshconfig</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">old_config_filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;WARNING! old style configuration (&quot;</span>
            <span class="o">+</span> <span class="n">old_config_filename</span>
            <span class="o">+</span> <span class="s2">&quot;) is no longer supported. &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;Please migrate to xonshrc.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">dxrc</span>


<span class="nd">@default_value</span>
<span class="k">def</span> <span class="nf">default_xonshrcdir</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="n">xdgrcd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xonsh_config_dir</span><span class="p">(</span><span class="n">env</span><span class="p">),</span> <span class="s2">&quot;rc.d&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os_environ</span><span class="p">[</span><span class="s2">&quot;ALLUSERSPROFILE&quot;</span><span class="p">],</span> <span class="s2">&quot;xonsh&quot;</span><span class="p">,</span> <span class="s2">&quot;rc.d&quot;</span><span class="p">),</span> <span class="n">xdgrcd</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;/etc/xonsh/rc.d&quot;</span><span class="p">,</span> <span class="n">xdgrcd</span><span class="p">)</span>


<span class="nd">@default_value</span>
<span class="k">def</span> <span class="nf">xonsh_append_newline</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Appends a newline if we are in interactive mode&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


<span class="nd">@default_value</span>
<span class="k">def</span> <span class="nf">default_lscolors</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets a default instanse of LsColors&quot;&quot;&quot;</span>
    <span class="n">inherited_lscolors</span> <span class="o">=</span> <span class="n">os_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LS_COLORS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inherited_lscolors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lsc</span> <span class="o">=</span> <span class="n">LsColors</span><span class="o">.</span><span class="n">fromdircolors</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lsc</span> <span class="o">=</span> <span class="n">LsColors</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">inherited_lscolors</span><span class="p">)</span>
    <span class="c1"># have to place this in the env, so it is applied</span>
    <span class="n">env</span><span class="p">[</span><span class="s2">&quot;LS_COLORS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lsc</span>
    <span class="k">return</span> <span class="n">lsc</span>


<span class="n">VarKeyType</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tp</span><span class="o">.</span><span class="n">Pattern</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Var</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Named tuples whose elements represent environment variable</span>
<span class="sd">    validation, conversion, detyping; default values; and documentation.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    validate : func</span>
<span class="sd">        Validator function returning a bool; checks that the variable is of the</span>
<span class="sd">        expected type.</span>
<span class="sd">    convert : func</span>
<span class="sd">        Function to convert variable from a string representation to its type.</span>
<span class="sd">    detype : func</span>
<span class="sd">        Function to convert variable from its type to a string representation.</span>
<span class="sd">    default</span>
<span class="sd">        Default value for variable. If set to DefaultNotGiven, raise KeyError</span>
<span class="sd">        instead of returning this default value.  Used for env vars defined</span>
<span class="sd">        outside of Xonsh.</span>
<span class="sd">    doc : str, optional</span>
<span class="sd">       The environment variable docstring.</span>
<span class="sd">    doc_default : str, optional</span>
<span class="sd">        Custom docstring for the default value for complex defaults.</span>
<span class="sd">    is_configurable : bool, optional</span>
<span class="sd">        Flag for whether the environment variable is configurable or not.</span>
<span class="sd">    can_store_as_str : bool, optional</span>
<span class="sd">        Flag for whether the environment variable should be stored as a</span>
<span class="sd">        string. This is used when persisting a variable that is not JSON</span>
<span class="sd">        serializable to the config file. For example, sets, frozensets, and</span>
<span class="sd">        potentially other non-trivial data types. default, False.</span>
<span class="sd">    pattern</span>
<span class="sd">        a regex pattern to match for the given variable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">validate</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">always_true</span>
    <span class="n">convert</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">detype</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensure_string</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Any</span> <span class="o">=</span> <span class="n">DefaultNotGiven</span>
    <span class="n">doc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">is_configurable</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">LazyBool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">doc_default</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DefaultNotGivenType</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultNotGiven</span>
    <span class="n">can_store_as_str</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">VarKeyType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">with_default</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">doc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DefaultNotGivenType</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultNotGiven</span><span class="p">,</span>
        <span class="n">type_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;fill arguments from the value of default&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">type_str</span><span class="p">:</span>
            <span class="n">cls_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">type_str</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;LazyBool&quot;</span><span class="p">:</span> <span class="s2">&quot;bool&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="n">ENSURERS</span> <span class="ow">and</span> <span class="s2">&quot;validate&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">validator</span><span class="p">,</span> <span class="n">convertor</span><span class="p">,</span> <span class="n">detyper</span> <span class="o">=</span> <span class="n">ENSURERS</span><span class="p">[</span><span class="n">type_str</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;validate&quot;</span><span class="p">:</span> <span class="n">validator</span><span class="p">,</span> <span class="s2">&quot;convert&quot;</span><span class="p">:</span> <span class="n">convertor</span><span class="p">,</span> <span class="s2">&quot;detype&quot;</span><span class="p">:</span> <span class="n">detyper</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">Var</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">doc_default</span><span class="o">=</span><span class="n">doc_default</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">no_default</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
            <span class="n">default</span><span class="o">=</span><span class="n">DefaultNotGiven</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">type_str</span><span class="o">=</span><span class="n">type_str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">for_locale</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lcle</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">validate</span><span class="o">=</span><span class="n">always_false</span><span class="p">,</span>
            <span class="n">convert</span><span class="o">=</span><span class="n">locale_convert</span><span class="p">(</span><span class="n">lcle</span><span class="p">),</span>
            <span class="n">detype</span><span class="o">=</span><span class="n">ensure_string</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="n">lcle</span><span class="p">)),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VarKeyType</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="ow">or</span> <span class="n">var_name</span>


<span class="k">class</span> <span class="nc">Xettings</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parent class - All setting classes will be inheriting from this.</span>
<span class="sd">    The first line of those class&#39;s docstring will become the group&#39;s title.</span>
<span class="sd">    Rest of the docstring will become the description of that Group of settings.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_settings</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">VarKeyType</span><span class="p">,</span> <span class="n">Var</span><span class="p">]]:</span>
        <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var_name</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">var</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">var_name</span><span class="p">),</span> <span class="n">var</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_groups</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">_seen</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="s2">&quot;Xettings&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">bases</span><span class="p">:</span> <span class="s2">&quot;Xettings&quot;</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">_seen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_seen</span><span class="p">:</span>
                <span class="n">_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span><span class="o">*</span><span class="n">bases</span><span class="p">,</span> <span class="n">sub</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">get_settings</span><span class="p">())</span>
                <span class="k">yield from</span> <span class="n">Xettings</span><span class="o">.</span><span class="n">_get_groups</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">_seen</span><span class="p">,</span> <span class="o">*</span><span class="n">bases</span><span class="p">,</span> <span class="n">sub</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;Xettings&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">VarKeyType</span><span class="p">,</span> <span class="n">Var</span><span class="p">],</span> <span class="o">...</span><span class="p">]]</span>
    <span class="p">]:</span>
        <span class="k">yield from</span> <span class="n">Xettings</span><span class="o">.</span><span class="n">_get_groups</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_doc</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">inspect</span>

        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_group_title</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_doc</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">doc</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_group_description</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_doc</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="k">class</span> <span class="nc">GeneralSetting</span><span class="p">(</span><span class="n">Xettings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;General&quot;&quot;&quot;</span>

    <span class="n">AUTO_CONTINUE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;If ``True``, automatically resume stopped jobs when they are disowned. &quot;</span>
        <span class="s2">&quot;When stopped jobs are disowned and this option is ``False``, a warning &quot;</span>
        <span class="s2">&quot;will print information about how to continue the stopped process.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">COMMANDS_CACHE_SIZE_WARNING</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mi">6000</span><span class="p">,</span>
        <span class="s2">&quot;Number of files on the PATH above which a warning is shown.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">COMMANDS_CACHE_SAVE_INTERMEDIATE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;If enabled, the CommandsCache saved between runs and can reduce the startup time.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">HOSTNAME</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default_value</span><span class="p">(</span><span class="k">lambda</span> <span class="n">env</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()),</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Automatically set to the name of the current host.&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">HOSTTYPE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default_value</span><span class="p">(</span><span class="k">lambda</span> <span class="n">env</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">machine</span><span class="p">()),</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Automatically set to a string that fully describes the system type on which xonsh is executing.&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">LANG</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;C.UTF-8&quot;</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Fallback locale setting for systems where it matters&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">LC_COLLATE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">for_locale</span><span class="p">(</span><span class="s2">&quot;LC_COLLATE&quot;</span><span class="p">)</span>
    <span class="n">LC_CTYPE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">for_locale</span><span class="p">(</span><span class="s2">&quot;LC_CTYPE&quot;</span><span class="p">)</span>
    <span class="n">LC_MONETARY</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">for_locale</span><span class="p">(</span><span class="s2">&quot;LC_MONETARY&quot;</span><span class="p">)</span>
    <span class="n">LC_NUMERIC</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">for_locale</span><span class="p">(</span><span class="s2">&quot;LC_NUMERIC&quot;</span><span class="p">)</span>
    <span class="n">LC_TIME</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">for_locale</span><span class="p">(</span><span class="s2">&quot;LC_TIME&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="s2">&quot;LC_MESSAGES&quot;</span><span class="p">):</span>
        <span class="n">LC_MESSAGES</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">for_locale</span><span class="p">(</span><span class="s2">&quot;LC_MESSAGES&quot;</span><span class="p">)</span>

    <span class="n">LOADED_RC_FILES</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_bool_seq</span><span class="p">,</span>
        <span class="n">csv_to_bool_seq</span><span class="p">,</span>
        <span class="n">bool_seq_to_csv</span><span class="p">,</span>
        <span class="p">(),</span>
        <span class="s2">&quot;Whether or not any of the xonsh run control files were loaded at &quot;</span>
        <span class="s2">&quot;startup. This is a sequence of bools in Python that is converted &quot;</span>
        <span class="s2">&quot;to a CSV list in string form, ie ``[True, False]`` becomes &quot;</span>
        <span class="s2">&quot;``&#39;True,False&#39;``.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">OLDPWD</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Used to represent a previous present working directory.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">PATH_DEFAULT</span><span class="p">,</span>
        <span class="s2">&quot;List of strings representing where to look for executables.&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;env_path&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;On Windows: it is ``Path`` value of register&#39;s &quot;</span>
        <span class="s2">&quot;``HKEY_LOCAL_MACHINE</span><span class="se">\\</span><span class="s2">SYSTEM</span><span class="se">\\</span><span class="s2">CurrentControlSet</span><span class="se">\\</span><span class="s2">Control</span><span class="se">\\</span><span class="s2">Session Manager</span><span class="se">\\</span><span class="s2">Environment``. &quot;</span>
        <span class="s2">&quot;On Mac OSX: ``(&#39;/usr/local/bin&#39;, &#39;/usr/bin&#39;, &#39;/bin&#39;, &#39;/usr/sbin&#39;, &#39;/sbin&#39;)`` &quot;</span>
        <span class="s2">&quot;On Linux &amp; on Cygwin &amp; on MSYS, when detected that the distro &quot;</span>
        <span class="s2">&quot;is like arch, the default PATH is &quot;</span>
        <span class="s2">&quot;``(&#39;/usr/local/sbin&#39;, &#39;/usr/local/bin&#39;, &#39;/usr/bin&#39;, &quot;</span>
        <span class="s2">&quot;&#39;/usr/bin/site_perl&#39;, &#39;/usr/bin/vendor_perl&#39;, &#39;/usr/bin/core_perl&#39;)``&quot;</span>
        <span class="s2">&quot; and otherwise is &quot;</span>
        <span class="s2">&quot;``(&#39;~/bin&#39;, &#39;/usr/local/sbin&#39;, &#39;/usr/local/bin&#39;, &#39;/usr/sbin&#39;,&quot;</span>
        <span class="s2">&quot;&#39;/usr/bin&#39;, &#39;/sbin&#39;, &#39;/bin&#39;, &#39;/usr/games&#39;, &#39;/usr/local/games&#39;)``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PATHEXT</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_nonstring_seq_of_strings</span><span class="p">,</span>
        <span class="n">pathsep_to_upper_seq</span><span class="p">,</span>
        <span class="n">seq_to_upper_pathsep</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;.COM&quot;</span><span class="p">,</span> <span class="s2">&quot;.EXE&quot;</span><span class="p">,</span> <span class="s2">&quot;.BAT&quot;</span><span class="p">,</span> <span class="s2">&quot;.CMD&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="s2">&quot;Sequence of extension strings (eg, ``.EXE``) for &quot;</span>
        <span class="s2">&quot;filtering valid executables by. Each element must be &quot;</span>
        <span class="s2">&quot;uppercase.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">RAISE_SUBPROC_ERROR</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not to raise an error if a subprocess (captured or &quot;</span>
        <span class="s2">&quot;uncaptured) returns a non-zero exit status, which indicates failure. &quot;</span>
        <span class="s2">&quot;This is most useful in xonsh scripts or modules where failures &quot;</span>
        <span class="s2">&quot;should cause an end to execution. This is less useful at a terminal. &quot;</span>
        <span class="s2">&quot;The error that is raised is a ``subprocess.CalledProcessError``.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_SUBPROC_CAPTURED_PRINT_STDERR</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;If ``True`` the stderr from captured subproc will be printed automatically.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">TERM</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">no_default</span><span class="p">(</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;TERM is sometimes set by the terminal emulator. This is used (when &quot;</span>
        <span class="s2">&quot;valid) to determine whether the terminal emulator can support &quot;</span>
        <span class="s2">&quot;the selected shell, or whether or not to set the title. Users shouldn&#39;t &quot;</span>
        <span class="s2">&quot;need to set this themselves. Note that this variable should be set as &quot;</span>
        <span class="s2">&quot;early as possible in order to ensure it is effective. Here are a few &quot;</span>
        <span class="s2">&quot;options:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* Set this from the program that launches xonsh. On POSIX systems, </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  this can be performed by using env, e.g. </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  ``/usr/bin/env TERM=xterm-color xonsh`` or similar.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* From the xonsh command line, namely ``xonsh -DTERM=xterm-color``.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s1">&#39;* In the config file with ``{&quot;env&quot;: {&quot;TERM&quot;: &quot;xterm-color&quot;}}``.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="s2">&quot;* Lastly, in xonshrc with ``$TERM``</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Ideally, your terminal emulator will set this correctly but that does &quot;</span>
        <span class="s2">&quot;not always happen.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_CAPTURE_ALWAYS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Try to capture output of commands run without explicit capturing.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;If True, xonsh will capture the output of commands run directly or in ``![]``.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Setting to True has the following disadvantages:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* Some interactive commands won&#39;t work properly (like when ``git`` invokes an interactive editor).</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  For more information see discussion at https://github.com/xonsh/xonsh/issues/3672.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;* Stopping these commands with ^Z (i.e. ``SIGTSTP``)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  is disabled as it causes deadlocked terminals.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  ``SIGTSTP`` may still be issued and only the physical pressing</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  of ``Ctrl+Z`` is ignored.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Regardless of this value, commands run in ``$()``, ``!()`` or with an IO redirection (``&gt;`` or ``|``) &quot;</span>
        <span class="s2">&quot;will always be captured.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Setting this to True depends on ``$THREAD_SUBPROCS`` being True.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">THREAD_SUBPROCS</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_bool_or_none</span><span class="p">,</span>
        <span class="n">to_bool_or_none</span><span class="p">,</span>
        <span class="n">bool_or_none_to_str</span><span class="p">,</span>
        <span class="ow">not</span> <span class="n">ON_CYGWIN</span><span class="p">,</span>
        <span class="s2">&quot;Note: The ``$XONSH_CAPTURE_ALWAYS`` variable introduces finer control &quot;</span>
        <span class="s2">&quot;and you should probably use that instead.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Whether or not to try to run subrocess mode in a Python thread, &quot;</span>
        <span class="s2">&quot;when trying to capture its output. There are various trade-offs.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;If True, xonsh is able capture &amp; store the stdin, stdout, and stderr </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  of threadable subprocesses.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The disadvantages are listed in ``$XONSH_CAPTURE_ALWAYS``.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The desired effect is often up to the command, user, or use case.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;None values are for internal use only and are used to turn off &quot;</span>
        <span class="s2">&quot;threading when loading xonshrc files. This is done because Bash &quot;</span>
        <span class="s2">&quot;was automatically placing new xonsh instances in the background &quot;</span>
        <span class="s2">&quot;at startup when threadable subprocs were used. Please see &quot;</span>
        <span class="s2">&quot;https://github.com/xonsh/xonsh/pull/3705 for more information.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">UPDATE_OS_ENVIRON</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;If True ``os_environ`` will always be updated &quot;</span>
        <span class="s2">&quot;when the xonsh environment changes. The environment can be reset to &quot;</span>
        <span class="s2">&quot;the default value by calling ``__xonsh__.env.undo_replace_env()``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XDG_CONFIG_HOME</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="s2">&quot;.config&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;Open desktop standard configuration home dir. This is the same &quot;</span>
        <span class="s2">&quot;default as used in the standard.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``~/.config``&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XDG_DATA_HOME</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="s2">&quot;.local&quot;</span><span class="p">,</span> <span class="s2">&quot;share&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;Open desktop standard data home dir. This is the same default as &quot;</span>
        <span class="s2">&quot;used in the standard.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``~/.local/share``&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSHRC</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">default_xonshrc</span><span class="p">,</span>
        <span class="s2">&quot;A list of the locations of run control files, if they exist.  User &quot;</span>
        <span class="s2">&quot;defined run control file will supersede values set in system-wide &quot;</span>
        <span class="s2">&quot;control file if there is a naming collision. $THREAD_SUBPROCS=None &quot;</span>
        <span class="s2">&quot;when reading in run control files.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;On Linux &amp; Mac OSX: ``[&#39;/etc/xonshrc&#39;, &#39;~/.config/xonsh/rc.xsh&#39;, &#39;~/.xonshrc&#39;]``</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">On Windows: &quot;</span>
            <span class="s2">&quot;``[&#39;%ALLUSERSPROFILE%</span><span class="se">\\\\</span><span class="s2">xonsh</span><span class="se">\\\\</span><span class="s2">xonshrc&#39;, &#39;~/.config/xonsh/rc.xsh&#39;, &#39;~/.xonshrc&#39;]``&quot;</span>
        <span class="p">),</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;env_path&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSHRC_DIR</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">default_xonshrcdir</span><span class="p">,</span>
        <span class="s2">&quot;A list of directories, from which all .xsh files will be loaded &quot;</span>
        <span class="s2">&quot;at startup, sorted in lexographic order. Files in these directories &quot;</span>
        <span class="s2">&quot;are loaded after any files in XONSHRC.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;On Linux &amp; Mac OSX: ``[&#39;/etc/xonsh/rc.d&#39;, &#39;~/.config/xonsh/rc.d&#39;]``</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;On Windows: &quot;</span>
            <span class="s2">&quot;``[&#39;%ALLUSERSPROFILE%</span><span class="se">\\\\</span><span class="s2">xonsh</span><span class="se">\\\\</span><span class="s2">rc.d&#39;, &#39;~/.config/xonsh/rc.d&#39;]``&quot;</span>
        <span class="p">),</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;env_path&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_APPEND_NEWLINE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">xonsh_append_newline</span><span class="p">,</span>
        <span class="s2">&quot;Append new line when a partial line is preserved in output.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``$XONSH_INTERACTIVE``&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;bool&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_CACHE_SCRIPTS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Controls whether the code for scripts run from xonsh will be cached&quot;</span>
        <span class="s2">&quot; (``True``) or re-compiled each time (``False``).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_CACHE_EVERYTHING</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Controls whether all code (including code entered at the interactive&quot;</span>
        <span class="s2">&quot; prompt) will be cached.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_CONFIG_DIR</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">xonsh_config_dir</span><span class="p">,</span>
        <span class="s2">&quot;This is the location where xonsh configuration information is stored.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``$XDG_CONFIG_HOME/xonsh``&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_COLOR_STYLE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sets the color style for xonsh colors. This is a style name, not &quot;</span>
        <span class="s2">&quot;a color map. Run ``xonfig styles`` to see the available styles.&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_DATETIME_FORMAT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The format that is used for ``datetime.strptime()`` in various places, &quot;</span>
        <span class="s2">&quot;i.e the history timestamp option.&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_DEBUG</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">always_false</span><span class="p">,</span>
        <span class="n">to_debug</span><span class="p">,</span>
        <span class="n">bool_or_int_to_str</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;Sets the xonsh debugging level. This may be an integer or a boolean. &quot;</span>
        <span class="s2">&quot;Setting it to ``1`` will get some basic information like input transformation, command replacement. &quot;</span>
        <span class="s2">&quot;With ``2`` or a higher number will make more debugging information &quot;</span>
        <span class="s2">&quot;presented, like PLY parsing messages.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_NO_AMALGAMATE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Setting this variable prior to starting xonsh to a truthy value will suppress amalgamated imports.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_DATA_DIR</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">xonsh_data_dir</span><span class="p">,</span>
        <span class="s2">&quot;This is the location where xonsh data files are stored, such as &quot;</span> <span class="s2">&quot;history.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``$XDG_DATA_HOME/xonsh``&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_ENCODING</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">DEFAULT_ENCODING</span><span class="p">,</span>
        <span class="s2">&quot;This is the encoding that xonsh should use for subprocess operations.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``sys.getdefaultencoding()``&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_ENCODING_ERRORS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;surrogateescape&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The flag for how to handle encoding errors should they happen. &quot;</span>
        <span class="s2">&quot;Any string flag that has been previously registered with Python &quot;</span>
        <span class="s2">&quot;is allowed. See the &#39;Python codecs documentation&#39; &quot;</span>
        <span class="s2">&quot;(https://docs.python.org/3/library/codecs.html#error-handlers) &quot;</span>
        <span class="s2">&quot;for more information and available options.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``surrogateescape``&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_INTERACTIVE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;``True`` if xonsh is running interactively, and ``False`` otherwise.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_LOGIN</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;``True`` if xonsh is running as a login shell, and ``False`` otherwise.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_PROC_FREQUENCY</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mf">1e-4</span><span class="p">,</span>
        <span class="s2">&quot;The process frequency is the time that &quot;</span>
        <span class="s2">&quot;xonsh process threads sleep for while running command pipelines. &quot;</span>
        <span class="s2">&quot;The value has units of seconds [s].&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_SHOW_TRACEBACK</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Controls if a traceback is shown if exceptions occur in the shell. &quot;</span>
        <span class="s2">&quot;Set to ``True`` to always show traceback or ``False`` to always hide. &quot;</span>
        <span class="s2">&quot;If undefined then the traceback is hidden but a notice is shown on how &quot;</span>
        <span class="s2">&quot;to enable the full traceback.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_SOURCE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;When running a xonsh script, this variable contains the absolute path &quot;</span>
        <span class="s2">&quot;to the currently executing script&#39;s file.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_STORE_STDIN</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not to store the stdin that is supplied to the &quot;</span>
        <span class="s2">&quot;``!()`` and ``![]`` operators.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_STYLE_OVERRIDES</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_str_str_dict</span><span class="p">,</span>
        <span class="n">to_str_str_dict</span><span class="p">,</span>
        <span class="n">dict_to_str</span><span class="p">,</span>
        <span class="p">{},</span>
        <span class="s2">&quot;A dictionary containing custom prompt_toolkit/pygments style definitions.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The following style definitions are supported:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - ``pygments.token.Token`` - ``$XONSH_STYLE_OVERRIDES[Token.Keyword] = &#39;#ff0000&#39;``</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - pygments token name (string) - ``$XONSH_STYLE_OVERRIDES[&#39;Token.Keyword&#39;] = &#39;#ff0000&#39;``</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - ptk style name (string) - ``$XONSH_STYLE_OVERRIDES[&#39;pygments.keyword&#39;] = &#39;#ff0000&#39;``</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;(The rules above are all have the same effect.)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_TRACE_SUBPROC</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Set to ``True`` to show arguments list of every executed subprocess command.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_TRACE_COMPLETIONS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Set to ``True`` to show completers invoked and their return values.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_TRACEBACK_LOGFILE</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_logfile_opt</span><span class="p">,</span>
        <span class="n">to_logfile_opt</span><span class="p">,</span>
        <span class="n">logfile_opt_to_str</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;Specifies a file to store the traceback log to, regardless of whether &quot;</span>
        <span class="s2">&quot;``XONSH_SHOW_TRACEBACK`` has been set. Its value must be a writable file &quot;</span>
        <span class="s2">&quot;or None / the empty string if traceback logging is not desired. &quot;</span>
        <span class="s2">&quot;Logging to a file is not enabled by default.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">STAR_PATH</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">no_default</span><span class="p">(</span><span class="s2">&quot;env_path&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w*PATH$&quot;</span><span class="p">))</span>
    <span class="n">STAR_DIRS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">no_default</span><span class="p">(</span><span class="s2">&quot;env_path&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w*DIRS$&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ChangeDirSetting</span><span class="p">(</span><span class="n">Xettings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;``cd`` Behavior&quot;&quot;&quot;</span>

    <span class="n">AUTO_CD</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Flag to enable changing to a directory by entering the dirname or &quot;</span>
        <span class="s2">&quot;full path only (without the cd command).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">AUTO_PUSHD</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Flag for automatically pushing directories onto the directory stack.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">CDPATH</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="p">(),</span>
        <span class="s2">&quot;A list of paths to be used as roots for a cd, breaking compatibility &quot;</span>
        <span class="s2">&quot;with Bash, xonsh always prefer an existing relative path.&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;env_path&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DIRSTACK_SIZE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;Maximum size of the directory stack.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PUSHD_MINUS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Flag for directory pushing functionality. False is the normal behavior.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PUSHD_SILENT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not to suppress directory stack manipulation output.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">COMPLETE_DOTS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;matching&quot;</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Flag to specify how current and previous directories should be &quot;</span>
        <span class="s2">&quot;tab completed  (&#39;./&#39;, &#39;../&#39;):&quot;</span>
        <span class="s2">&quot;    - ``always`` Always complete paths with ./ and ../</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - ``never`` Never complete paths with ./ and ../</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - ``matching`` Complete if path starts with . or ..&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">InterpreterSetting</span><span class="p">(</span><span class="n">Xettings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interpreter Behavior&quot;&quot;&quot;</span>

    <span class="n">DOTGLOB</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;Globbing files with &quot;*&quot; or &quot;**&quot; will also match &#39;</span>
        <span class="s2">&quot;dotfiles, or those &#39;hidden&#39; files whose names &quot;</span>
        <span class="s2">&quot;begin with a literal &#39;.&#39;. Such files are filtered &quot;</span>
        <span class="s2">&quot;out by default.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">EXPAND_ENV_VARS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Toggles whether environment variables are expanded inside of strings &quot;</span>
        <span class="s2">&quot;in subprocess mode.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">FOREIGN_ALIASES_SUPPRESS_SKIP_MESSAGE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not foreign aliases should suppress the message &quot;</span>
        <span class="s2">&quot;that informs the user when a foreign alias has been skipped &quot;</span>
        <span class="s2">&quot;because it already exists in xonsh.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">FOREIGN_ALIASES_OVERRIDE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not foreign aliases should override xonsh aliases &quot;</span>
        <span class="s2">&quot;with the same name. Note that setting of this must happen in the &quot;</span>
        <span class="s2">&quot;environment that xonsh was started from. &quot;</span>
        <span class="s2">&quot;It cannot be set in the ``.xonshrc`` as loading of foreign aliases happens before&quot;</span>
        <span class="s2">&quot;``.xonshrc`` is parsed&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">GLOB_SORTED</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Toggles whether globbing results are manually sorted. If ``False``, &quot;</span>
        <span class="s2">&quot;the results are returned in arbitrary order.&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">PromptSetting</span><span class="p">(</span><span class="n">Xettings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interactive Prompt&quot;&quot;&quot;</span>

    <span class="n">COLOR_INPUT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Flag for syntax highlighting interactive input.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">COLOR_RESULTS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Flag for syntax highlighting return values.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DYNAMIC_CWD_WIDTH</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_dynamic_cwd_width</span><span class="p">,</span>
        <span class="n">to_dynamic_cwd_tuple</span><span class="p">,</span>
        <span class="n">dynamic_cwd_tuple_to_str</span><span class="p">,</span>
        <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Maximum length in number of characters &quot;</span>
        <span class="s2">&quot;or as a percentage for the ``cwd`` prompt variable. For example, &quot;</span>
        <span class="s1">&#39;&quot;20&quot; is a twenty character width and &quot;10%&quot; is ten percent of the &#39;</span>
        <span class="s2">&quot;number of columns available.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">DYNAMIC_CWD_ELISION_CHAR</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The string used to show a shortened directory in a shortened cwd, &quot;</span>
        <span class="s2">&quot;e.g. ``&#39;&#39;``.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">IGNOREEOF</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Prevents Ctrl-D from exiting the shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">INDENT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;    &quot;</span><span class="p">,</span>
        <span class="s2">&quot;Indentation string for multiline input&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">LS_COLORS</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_lscolors</span><span class="p">,</span>
        <span class="n">LsColors</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span>
        <span class="n">detype</span><span class="p">,</span>
        <span class="n">default_lscolors</span><span class="p">,</span>
        <span class="s2">&quot;Color settings for ``ls`` command line utility and, &quot;</span>
        <span class="s2">&quot;with ``$SHELL_TYPE=&#39;prompt_toolkit&#39;``, file arguments in subprocess mode.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``*.7z=1;0;31:*.Z=1;0;31:*.aac=0;36:*.ace=1;0;31:&quot;</span>
        <span class="s2">&quot;*.alz=1;0;31:*.arc=1;0;31:*.arj=1;0;31:*.asf=1;0;35:*.au=0;36:&quot;</span>
        <span class="s2">&quot;*.avi=1;0;35:*.bmp=1;0;35:*.bz=1;0;31:*.bz2=1;0;31:*.cab=1;0;31:&quot;</span>
        <span class="s2">&quot;*.cgm=1;0;35:*.cpio=1;0;31:*.deb=1;0;31:*.dl=1;0;35:*.dwm=1;0;31:&quot;</span>
        <span class="s2">&quot;*.dz=1;0;31:*.ear=1;0;31:*.emf=1;0;35:*.esd=1;0;31:*.flac=0;36:&quot;</span>
        <span class="s2">&quot;*.flc=1;0;35:*.fli=1;0;35:*.flv=1;0;35:*.gif=1;0;35:*.gl=1;0;35:&quot;</span>
        <span class="s2">&quot;*.gz=1;0;31:*.jar=1;0;31:*.jpeg=1;0;35:*.jpg=1;0;35:*.lha=1;0;31:&quot;</span>
        <span class="s2">&quot;*.lrz=1;0;31:*.lz=1;0;31:*.lz4=1;0;31:*.lzh=1;0;31:*.lzma=1;0;31&quot;</span>
        <span class="s2">&quot;:*.lzo=1;0;31:*.m2v=1;0;35:*.m4a=0;36:*.m4v=1;0;35:*.mid=0;36:&quot;</span>
        <span class="s2">&quot;*.midi=0;36:*.mjpeg=1;0;35:*.mjpg=1;0;35:*.mka=0;36:*.mkv=1;0;35:&quot;</span>
        <span class="s2">&quot;*.mng=1;0;35:*.mov=1;0;35:*.mp3=0;36:*.mp4=1;0;35:*.mp4v=1;0;35:&quot;</span>
        <span class="s2">&quot;*.mpc=0;36:*.mpeg=1;0;35:*.mpg=1;0;35:*.nuv=1;0;35:*.oga=0;36:&quot;</span>
        <span class="s2">&quot;*.ogg=0;36:*.ogm=1;0;35:*.ogv=1;0;35:*.ogx=1;0;35:*.opus=0;36:&quot;</span>
        <span class="s2">&quot;*.pbm=1;0;35:*.pcx=1;0;35:*.pgm=1;0;35:*.png=1;0;35:*.ppm=1;0;35:&quot;</span>
        <span class="s2">&quot;*.qt=1;0;35:*.ra=0;36:*.rar=1;0;31:*.rm=1;0;35:*.rmvb=1;0;35:&quot;</span>
        <span class="s2">&quot;*.rpm=1;0;31:*.rz=1;0;31:*.sar=1;0;31:*.spx=0;36:*.svg=1;0;35:&quot;</span>
        <span class="s2">&quot;*.svgz=1;0;35:*.swm=1;0;31:*.t7z=1;0;31:*.tar=1;0;31:*.taz=1;0;31:&quot;</span>
        <span class="s2">&quot;*.tbz=1;0;31:*.tbz2=1;0;31:*.tga=1;0;35:*.tgz=1;0;31:*.tif=1;0;35:&quot;</span>
        <span class="s2">&quot;*.tiff=1;0;35:*.tlz=1;0;31:*.txz=1;0;31:*.tz=1;0;31:*.tzo=1;0;31:&quot;</span>
        <span class="s2">&quot;*.tzst=1;0;31:*.vob=1;0;35:*.war=1;0;31:*.wav=0;36:*.webm=1;0;35:&quot;</span>
        <span class="s2">&quot;*.wim=1;0;31:*.wmv=1;0;35:*.xbm=1;0;35:*.xcf=1;0;35:*.xpm=1;0;35:&quot;</span>
        <span class="s2">&quot;*.xspf=0;36:*.xwd=1;0;35:*.xz=1;0;31:*.yuv=1;0;35:*.z=1;0;31:&quot;</span>
        <span class="s2">&quot;*.zip=1;0;31:*.zoo=1;0;31:*.zst=1;0;31:bd=40;0;33:ca=0;30;41:&quot;</span>
        <span class="s2">&quot;cd=40;0;33:di=1;0;34:do=1;0;35:ex=1;0;32:ln=1;0;36:mh=0:mi=0:&quot;</span>
        <span class="s2">&quot;or=40;0;31:ow=0;34;42:pi=40;0;33:rs=0:sg=0;30;43:so=1;0;35:&quot;</span>
        <span class="s2">&quot;st=0;37;44:su=0;37;41:tw=0;30;42``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">MULTILINE_PROMPT</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_string_or_callable</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="s2">&quot;.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Prompt text for 2nd+ lines of input, may be str or function which &quot;</span>
        <span class="s2">&quot;returns a str.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PRETTY_PRINT_RESULTS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;Flag for &quot;pretty printing&quot; return values.&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PROMPT</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_string_or_callable</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">.</span><span class="n">default_prompt</span><span class="p">(),</span>
        <span class="s2">&quot;The prompt text. May contain keyword arguments which are &quot;</span>
        <span class="s2">&quot;auto-formatted, see &#39;Customizing the Prompt&#39; at &quot;</span>
        <span class="s2">&quot;http://xon.sh/tutorial.html#customizing-the-prompt. &quot;</span>
        <span class="s2">&quot;This value is never inherited from parent processes.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``xonsh.environ.DEFAULT_PROMPT``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PROMPT_FIELDS</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">always_true</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">.</span><span class="n">PROMPT_FIELDS</span><span class="p">,</span>
        <span class="s2">&quot;Dictionary containing variables to be used when formatting $PROMPT &quot;</span>
        <span class="s2">&quot;and $TITLE. See &#39;Customizing the Prompt&#39; &quot;</span>
        <span class="s2">&quot;http://xon.sh/tutorial.html#customizing-the-prompt&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``xonsh.prompt.PROMPT_FIELDS``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PROMPT_REFRESH_INTERVAL</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># keep as float</span>
        <span class="s2">&quot;Interval (in seconds) to evaluate and update ``$PROMPT``, ``$RIGHT_PROMPT`` &quot;</span>
        <span class="s2">&quot;and ``$BOTTOM_TOOLBAR``. The default is zero (no update). &quot;</span>
        <span class="s2">&quot;NOTE: ``$UPDATE_PROMPT_ON_KEYPRESS`` must be set to ``True`` for this &quot;</span>
        <span class="s2">&quot;variable to take effect.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PROMPT_TOKENS_FORMATTER</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">callable</span><span class="p">,</span>
        <span class="n">convert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">detype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">prompt</span><span class="o">.</span><span class="n">prompt_tokens_formatter_default</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Final processor that receives all tokens in the prompt template. &quot;</span>
        <span class="s2">&quot;It gives option to format the prompt with different prefix based on other tokens values. &quot;</span>
        <span class="s2">&quot;Highly useful for implementing something like powerline theme.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``xonsh.prompt.base.prompt_tokens_formatter_default``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">RIGHT_PROMPT</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_string_or_callable</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Template string for right-aligned text &quot;</span>
        <span class="s2">&quot;at the prompt. This may be parametrized in the same way as &quot;</span>
        <span class="s2">&quot;the ``$PROMPT`` variable. Currently, this is only available in the &quot;</span>
        <span class="s2">&quot;prompt-toolkit shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">BOTTOM_TOOLBAR</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_string_or_callable</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Template string for the bottom toolbar. &quot;</span>
        <span class="s2">&quot;This may be parametrized in the same way as &quot;</span>
        <span class="s2">&quot;the ``$PROMPT`` variable. Currently, this is only available in the &quot;</span>
        <span class="s2">&quot;prompt-toolkit shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">SHELL_TYPE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;best&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Which shell is used. Currently two base shell types are supported:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - ``readline`` that is backed by Python&#39;s readline module</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - ``prompt_toolkit`` that uses external library of the same name</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - ``random`` selects a random shell from the above on startup</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    - ``best`` selects the most feature-rich shell available on the</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;       user&#39;s system</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;To use the ``prompt_toolkit`` shell you need to have the &quot;</span>
        <span class="s2">&quot;`prompt_toolkit &lt;https://github.com/jonathanslenders/python-prompt-toolkit&gt;`_&quot;</span>
        <span class="s2">&quot; library installed. To specify which shell should be used, do so in &quot;</span>
        <span class="s2">&quot;the run control file.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``best``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">SUGGEST_COMMANDS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;When a user types an invalid command, xonsh will try to offer &quot;</span>
        <span class="s2">&quot;suggestions of similar valid commands if this is True.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">SUGGEST_MAX_NUM</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;xonsh will show at most this many suggestions in response to an &quot;</span>
        <span class="s2">&quot;invalid command. If negative, there is no limit to how many &quot;</span>
        <span class="s2">&quot;suggestions are shown.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">SUGGEST_THRESHOLD</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;An error threshold. If the Levenshtein distance between the entered &quot;</span>
        <span class="s2">&quot;command and a valid command is less than this value, the valid &quot;</span>
        <span class="s1">&#39;command will be offered as a suggestion.  Also used for &quot;fuzzy&quot; &#39;</span>
        <span class="s2">&quot;tab completion of paths.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">SUPPRESS_BRANCH_TIMEOUT_MESSAGE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not to suppress branch timeout warning messages when getting </span><span class="si">{gitstatus}</span><span class="s2"> PROMPT_FIELD.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">TITLE</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_string_or_callable</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="n">DEFAULT_TITLE</span><span class="p">,</span>
        <span class="s2">&quot;The title text for the window in which xonsh is running. Formatted &quot;</span>
        <span class="s2">&quot;in the same manner as ``$PROMPT``, see &#39;Customizing the Prompt&#39; &quot;</span>
        <span class="s2">&quot;http://xon.sh/tutorial.html#customizing-the-prompt.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``xonsh.environ.DEFAULT_TITLE``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">UPDATE_PROMPT_ON_KEYPRESS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Disables caching the prompt between commands, &quot;</span>
        <span class="s2">&quot;so that it would be reevaluated on each keypress. &quot;</span>
        <span class="s2">&quot;Disabled by default because of the incurred performance penalty.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">VC_BRANCH_TIMEOUT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mf">0.2</span> <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="k">else</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;The timeout (in seconds) for version control &quot;</span>
        <span class="s2">&quot;branch computations. This is a timeout per subprocess call, so the &quot;</span>
        <span class="s2">&quot;total time to compute will be larger than this in many cases.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">VC_GIT_INCLUDE_UNTRACKED</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not untracked file changes should count as &#39;dirty&#39; in git.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">VC_HG_SHOW_BRANCH</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not to show the Mercurial branch in the prompt.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">VIRTUAL_ENV</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">no_default</span><span class="p">(</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Path to the currently active Python environment.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_GITSTATUS_</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;Symbols for gitstatus prompt. Default values are: </span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;* ``XONSH_GITSTATUS_</span><span class="si">{</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">``: ``</span><span class="si">{</span><span class="n">fld</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">``&quot;</span>
                <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">GITSTATUS_FIELD_DEFS</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;XONSH_GITSTATUS_*&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_GITSTATUS_FIELDS_HIDDEN</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="p">(),</span>
        <span class="s2">&quot;Fields to hide in </span><span class="si">{gitstatus}</span><span class="s2"> prompt (all fields below are shown by default.) </span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;* ``</span><span class="si">{</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">``</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">GITSTATUS_FIELD_DEFS</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HASH&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">XONSH_HISTORY_MATCH_ANYWHERE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;When searching history from a partial string (by pressing up arrow), &quot;</span>
        <span class="s2">&quot;match command history anywhere in a given line (not just the start)&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_STDERR_PREFIX</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;A format string, using the same keys and colors as ``$PROMPT``, that &quot;</span>
        <span class="s2">&quot;is prepended whenever stderr is displayed. This may be used in &quot;</span>
        <span class="s2">&quot;conjunction with ``$XONSH_STDERR_POSTFIX`` to close out the block.&quot;</span>
        <span class="s2">&quot;For example, to have stderr appear on a red background, the &quot;</span>
        <span class="s1">&#39;prefix &amp; postfix pair would be &quot;</span><span class="si">{BACKGROUND_RED}</span><span class="s1">&quot; &amp; &quot;</span><span class="si">{RESET}</span><span class="s1">&quot;.&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_STDERR_POSTFIX</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;A format string, using the same keys and colors as ``$PROMPT``, that &quot;</span>
        <span class="s2">&quot;is appended whenever stderr is displayed. This may be used in &quot;</span>
        <span class="s2">&quot;conjunction with ``$XONSH_STDERR_PREFIX`` to start the block.&quot;</span>
        <span class="s2">&quot;For example, to have stderr appear on a red background, the &quot;</span>
        <span class="s1">&#39;prefix &amp; postfix pair would be &quot;</span><span class="si">{BACKGROUND_RED}</span><span class="s1">&quot; &amp; &quot;</span><span class="si">{RESET}</span><span class="s1">&quot;.&#39;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">PromptHistorySetting</span><span class="p">(</span><span class="n">Xettings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interactive Prompt History&quot;&quot;&quot;</span>

    <span class="n">XONSH_HISTORY_BACKEND</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_history_backend</span><span class="p">,</span>
        <span class="n">to_itself</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Set which history backend to use. Options are: &#39;json&#39;, &quot;</span>
        <span class="s2">&quot;&#39;sqlite&#39;, and &#39;dummy&#39;. The default is &#39;json&#39;. &quot;</span>
        <span class="s2">&quot;``XONSH_HISTORY_BACKEND`` also accepts a class type that inherits &quot;</span>
        <span class="s2">&quot;from ``xonsh.history.base.History``, or its instance.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_HISTORY_FILE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;Location of history file set by history backend (default) or set by the user.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;path&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">HISTCONTROL</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_string_set</span><span class="p">,</span>
        <span class="n">csv_to_set</span><span class="p">,</span>
        <span class="n">set_to_csv</span><span class="p">,</span>
        <span class="nb">set</span><span class="p">(),</span>
        <span class="s2">&quot;A set of strings (comma-separated list in string form) of options &quot;</span>
        <span class="s2">&quot;that determine what commands are saved to the history list. By &quot;</span>
        <span class="s2">&quot;default all commands are saved. The option ``ignoredups`` will not &quot;</span>
        <span class="s2">&quot;save the command if it matches the previous command. The option &quot;</span>
        <span class="s2">&quot;``ignoreerr`` will cause any commands that fail (i.e. return non-zero &quot;</span>
        <span class="s2">&quot;exit status) to not be added to the history list. The option &quot;</span>
        <span class="s2">&quot;``erasedups`` will remove all previous commands that matches and updates the frequency. &quot;</span>
        <span class="s2">&quot;Note: ``erasedups`` is supported only in sqlite backend).&quot;</span><span class="p">,</span>
        <span class="n">can_store_as_str</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_HISTORY_SIZE</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_history_tuple</span><span class="p">,</span>
        <span class="n">to_history_tuple</span><span class="p">,</span>
        <span class="n">history_tuple_to_str</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">8128</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">),</span>
        <span class="s2">&quot;Value and units tuple that sets the size of history after garbage &quot;</span>
        <span class="s2">&quot;collection. Canonical units are:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- ``commands`` for the number of past commands executed,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- ``files`` for the number of history files to keep,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- ``s`` for the number of seconds in the past that are allowed, and</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- ``b`` for the number of bytes that history may consume.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Common abbreviations, such as &#39;6 months&#39; or &#39;1 GB&#39; are also allowed.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;``(8128, &#39;commands&#39;)`` or ``&#39;8128 commands&#39;``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_STORE_STDOUT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether or not to store the ``stdout`` and ``stderr`` streams in the &quot;</span>
        <span class="s2">&quot;history files.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_HISTORY_SAVE_CWD</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Save current working directory to the history.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">PTKSetting</span><span class="p">(</span><span class="n">PromptSetting</span><span class="p">):</span>  <span class="c1"># sub-classing -&gt; sub-group</span>
    <span class="sd">&quot;&quot;&quot;Prompt Toolkit shell</span>
<span class="sd">    Only usable with ``$SHELL_TYPE=prompt_toolkit.``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">AUTO_SUGGEST</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Enable automatic command suggestions based on history, like in the fish &quot;</span>
        <span class="s2">&quot;shell.</span><span class="se">\n\n</span><span class="s2">Pressing the right arrow key inserts the currently &quot;</span>
        <span class="s2">&quot;displayed suggestion. &quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">AUTO_SUGGEST_IN_COMPLETIONS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Places the auto-suggest result as the first option in the completions. &quot;</span>
        <span class="s2">&quot;This enables you to tab complete the auto-suggestion.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">MOUSE_SUPPORT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Enable mouse support in the ``prompt_toolkit`` shell. This allows &quot;</span>
        <span class="s2">&quot;clicking for positioning the cursor or selecting a completion. In &quot;</span>
        <span class="s2">&quot;some terminals however, this disables the ability to scroll back &quot;</span>
        <span class="s2">&quot;through the history of the terminal. Only usable with &quot;</span>
        <span class="s2">&quot;``$SHELL_TYPE=prompt_toolkit``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PROMPT_TOOLKIT_COLOR_DEPTH</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">always_false</span><span class="p">,</span>
        <span class="n">ptk2_color_depth_setter</span><span class="p">,</span>
        <span class="n">ensure_string</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;The color depth used by prompt toolkit 2. Possible values are: &quot;</span>
        <span class="s2">&quot;``DEPTH_1_BIT``, ``DEPTH_4_BIT``, ``DEPTH_8_BIT``, ``DEPTH_24_BIT`` &quot;</span>
        <span class="s2">&quot;colors. Default is an empty string which means that prompt toolkit decide.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">PTK_STYLE_OVERRIDES</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_str_str_dict</span><span class="p">,</span>
        <span class="n">to_str_str_dict</span><span class="p">,</span>
        <span class="n">dict_to_str</span><span class="p">,</span>
        <span class="p">{},</span>
        <span class="s2">&quot;A dictionary containing custom prompt_toolkit style definitions. (deprecated)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">VI_MODE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Flag to enable ``vi_mode`` in the ``prompt_toolkit`` shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_AUTOPAIR</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether Xonsh will auto-insert matching parentheses, brackets, and &quot;</span>
        <span class="s2">&quot;quotes. Only available under the prompt-toolkit shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">XONSH_COPY_ON_DELETE</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Whether to copy words/lines to clipboard on deletion (must be set in .xonshrc file).&quot;</span>
        <span class="s2">&quot;Only available under the prompt-toolkit shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">AsyncPromptSetting</span><span class="p">(</span><span class="n">PTKSetting</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Asynchronous Prompt</span>
<span class="sd">    Load $PROMPT in background without blocking read-eval loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ASYNC_INVALIDATE_INTERVAL</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mf">0.05</span><span class="p">,</span>
        <span class="s2">&quot;When ENABLE_ASYNC_PROMPT is True, it may call the redraw frequently. &quot;</span>
        <span class="s2">&quot;This is to group such calls into one that happens within that timeframe. &quot;</span>
        <span class="s2">&quot;The number is set in seconds.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ASYNC_PROMPT_THREAD_WORKERS</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_int</span><span class="p">,</span>
        <span class="n">to_int_or_none</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;Define the number of workers used by the ASYC_PROPMT&#39;s pool. &quot;</span>
        <span class="s2">&quot;By default it is the same as defined by Python&#39;s concurrent.futures.ThreadPoolExecutor class.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ENABLE_ASYNC_PROMPT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;When enabled the prompt is rendered using threads. &quot;</span>
        <span class="s2">&quot;$PROMPT_FIELD that take long will be updated in the background and will not affect prompt speed. &quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">AutoCompletionSetting</span><span class="p">(</span><span class="n">Xettings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tab-completion behavior.&quot;&quot;&quot;</span>

    <span class="n">BASH_COMPLETIONS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;This is a list (or tuple) of strings that specifies where the &quot;</span>
        <span class="s2">&quot;``bash_completion`` script may be found. &quot;</span>
        <span class="s2">&quot;The first valid path will be used. For better performance, &quot;</span>
        <span class="s2">&quot;bash-completion v2.x is recommended since it lazy-loads individual &quot;</span>
        <span class="s2">&quot;completion scripts. &quot;</span>
        <span class="s2">&quot;For both bash-completion v1.x and v2.x, paths of individual completion &quot;</span>
        <span class="s2">&quot;scripts (like ``.../completes/ssh``) do not need to be included here. &quot;</span>
        <span class="s2">&quot;The default values are platform &quot;</span>
        <span class="s2">&quot;dependent, but sane. To specify an alternate list, do so in the run &quot;</span>
        <span class="s2">&quot;control file.&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">BASH_COMPLETIONS_DEFAULT</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Normally this is:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    ``(&#39;/usr/share/bash-completion/bash_completion&#39;, )``</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;But, on Mac it is:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    ``(&#39;/usr/local/share/bash-completion/bash_completion&#39;, &quot;</span>
            <span class="s2">&quot;&#39;/usr/local/etc/bash_completion&#39;)``</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Other OS-specific defaults may be added in the future.&quot;</span>
        <span class="p">),</span>
        <span class="n">type_str</span><span class="o">=</span><span class="s2">&quot;env_path&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">CASE_SENSITIVE_COMPLETIONS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="n">ON_LINUX</span><span class="p">,</span>
        <span class="s2">&quot;Sets whether completions should be case sensitive or case &quot;</span> <span class="s2">&quot;insensitive.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;True on Linux, False otherwise.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">COMPLETIONS_BRACKETS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Flag to enable/disable inclusion of square brackets and parentheses &quot;</span>
        <span class="s2">&quot;in Python attribute completions.&quot;</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">COMPLETION_QUERY_LIMIT</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mi">100</span><span class="p">,</span>
        <span class="s2">&quot;The number of completions to display before the user is asked &quot;</span>
        <span class="s2">&quot;for confirmation.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">FUZZY_PATH_COMPLETION</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Toggles &#39;fuzzy&#39; matching of paths for tab completion, which is only &quot;</span>
        <span class="s2">&quot;used as a fallback if no other completions succeed but can be used &quot;</span>
        <span class="s2">&quot;as a way to adjust for typographical errors. If ``True``, then, e.g.,&quot;</span>
        <span class="s2">&quot; ``xonhs`` will match ``xonsh``.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">SUBSEQUENCE_PATH_COMPLETION</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Toggles subsequence matching of paths for tab completion. &quot;</span>
        <span class="s2">&quot;If ``True``, then, e.g., ``~/u/ro`` can match ``~/lou/carcolh``.&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">PTKCompletionSetting</span><span class="p">(</span><span class="n">AutoCompletionSetting</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prompt Toolkit tab-completion&quot;&quot;&quot;</span>

    <span class="n">COMPLETIONS_CONFIRM</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;While tab-completions menu is displayed, press &lt;Enter&gt; to confirm &quot;</span>
        <span class="s2">&quot;completion instead of running command. This only affects the &quot;</span>
        <span class="s2">&quot;prompt-toolkit shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">COMPLETIONS_DISPLAY</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_completions_display_value</span><span class="p">,</span>
        <span class="n">to_completions_display_value</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="s2">&quot;multi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Configure if and how Python completions are displayed by the &quot;</span>
        <span class="s2">&quot;``prompt_toolkit`` shell.</span><span class="se">\n\n</span><span class="s2">This option does not affect Bash &quot;</span>
        <span class="s2">&quot;completions, auto-suggestions, etc.</span><span class="se">\n\n</span><span class="s2">Changing it at runtime will &quot;</span>
        <span class="s2">&quot;take immediate effect, so you can quickly disable and enable &quot;</span>
        <span class="s2">&quot;completions during shell sessions.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- If ``$COMPLETIONS_DISPLAY`` is ``none`` or ``false``, do not display&quot;</span>
        <span class="s2">&quot; those completions.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- If ``$COMPLETIONS_DISPLAY`` is ``single``, display completions in a</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  single column while typing.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- If ``$COMPLETIONS_DISPLAY`` is ``multi`` or ``true``, display completions&quot;</span>
        <span class="s2">&quot; in multiple columns while typing.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- If ``$COMPLETIONS_DISPLAY`` is ``readline``, display completions</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;  will emulate the behavior of readline.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;These option values are not case- or type-sensitive, so e.g. &quot;</span>
        <span class="s2">&quot;writing ``$COMPLETIONS_DISPLAY = None`` &quot;</span>
        <span class="s2">&quot;and ``$COMPLETIONS_DISPLAY = &#39;none&#39;`` are equivalent. Only usable with &quot;</span>
        <span class="s2">&quot;``$SHELL_TYPE=prompt_toolkit``&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">COMPLETIONS_MENU_ROWS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;Number of rows to reserve for tab-completions menu if &quot;</span>
        <span class="s2">&quot;``$COMPLETIONS_DISPLAY`` is ``single`` or ``multi``. This only affects the &quot;</span>
        <span class="s2">&quot;prompt-toolkit shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">COMPLETION_MODE</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">is_completion_mode</span><span class="p">,</span>
        <span class="n">to_completion_mode</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mode of tab completion in prompt-toolkit shell (only).</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&#39;default&#39;, the default, selects the common prefix of completions on first TAB,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;then cycles through all completions.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;&#39;menu-complete&#39; selects the first whole completion on the first TAB, </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;then cycles through the remaining completions, then the common prefix.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">COMPLETION_IN_THREAD</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;When generating the completions takes time, &quot;</span>
        <span class="s2">&quot;its better to do this in a background thread. &quot;</span>
        <span class="s2">&quot;When this is True, background threads is used for completion.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">UPDATE_COMPLETIONS_ON_KEYPRESS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Completions display is evaluated and presented whenever a key is &quot;</span>
        <span class="s2">&quot;pressed. This avoids the need to press TAB, except to cycle through &quot;</span>
        <span class="s2">&quot;the possibilities. This currently only affects the prompt-toolkit shell.&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">WindowsSetting</span><span class="p">(</span><span class="n">GeneralSetting</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Windows OS</span>
<span class="sd">    Windows OS specific settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ANSICON</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">no_default</span><span class="p">(</span>
        <span class="s2">&quot;str&quot;</span><span class="p">,</span>
        <span class="s2">&quot;This is used on Windows to set the title, if available.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">FORCE_POSIX_PATHS</span> <span class="o">=</span> <span class="n">Var</span><span class="o">.</span><span class="n">with_default</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;Forces forward slashes (``/``) on Windows systems when using auto &quot;</span>
        <span class="s2">&quot;completion if set to anything truthy.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="n">ON_WINDOWS</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">INTENSIFY_COLORS_ON_WIN</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
        <span class="n">always_false</span><span class="p">,</span>
        <span class="n">intensify_colors_on_win_setter</span><span class="p">,</span>
        <span class="n">bool_to_str</span><span class="p">,</span>
        <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;Enhance style colors for readability &quot;</span>
        <span class="s2">&quot;when using the default terminal (``cmd.exe``) on Windows. Blue colors, &quot;</span>
        <span class="s2">&quot;which are hard to read, are replaced with cyan. Other colors are &quot;</span>
        <span class="s2">&quot;generally replaced by their bright counter parts.&quot;</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="n">ON_WINDOWS</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># Please keep the following in alphabetic order - scopatz</span>
<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">DEFAULT_VARS</span><span class="p">():</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="n">Xettings</span><span class="o">.</span><span class="n">get_groups</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
            <span class="n">dv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
    <span class="k">return</span> <span class="n">dv</span>


<span class="c1">#</span>
<span class="c1"># actual environment</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">Env</span><span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A xonsh environment, whose variables have limited typing</span>
<span class="sd">    (unlike BASH). Most variables are, by default, strings (like BASH).</span>
<span class="sd">    However, the following rules also apply based on variable-name:</span>

<span class="sd">    * PATH: any variable whose name ends in PATH is a list of strings.</span>
<span class="sd">    * XONSH_HISTORY_SIZE: this variable is an (int | float, str) tuple.</span>
<span class="sd">    * LC_* (locale categories): locale category names get/set the Python</span>
<span class="sd">      locale via locale.getlocale() and locale.setlocale() functions.</span>

<span class="sd">    An Env instance may be converted to an untyped version suitable for</span>
<span class="sd">    use in a subprocess.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If no initial environment is given, os_environ is used.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># sentinel value for non existing envvars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_value</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_env</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">DEFAULT_VARS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">os_environ</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="n">path_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;PATH&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path_key</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">path_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;PATH&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">:</span>
            <span class="c1"># this is here so the PATH is accessible to subprocs and so that</span>
            <span class="c1"># it can be modified in-place in the xonshrc file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">PATH_DEFAULT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">detype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">detyper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_detyper</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">detyper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># cannot be detyped</span>
                <span class="k">continue</span>
            <span class="n">deval</span> <span class="o">=</span> <span class="n">detyper</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">deval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># cannot be detyped</span>
                <span class="k">continue</span>
            <span class="n">ctx</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="n">ctx</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">replace_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replaces the contents of os_environ with a detyped version</span>
<span class="sd">        of the xonsh environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orig_env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">os_environ</span><span class="p">)</span>
        <span class="n">os_environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">os_environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detype</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">undo_replace_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replaces the contents of os_environ with a detyped version</span>
<span class="sd">        of the xonsh environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os_environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">os_environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orig_env</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orig_env</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_default_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">always_true</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">_get_default_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">_get_default_detyper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">ensure_string</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">get_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets a validator for the given key.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">validate</span>

        <span class="c1"># necessary for keys that match regexes, such as `*PATH`s</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">validator</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">validate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_validator</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">validator</span>

    <span class="k">def</span> <span class="nf">get_converter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets a converter for the given key.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">convert</span>

        <span class="c1"># necessary for keys that match regexes, such as `*PATH`s</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">converter</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">convert</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_converter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">converter</span>

    <span class="k">def</span> <span class="nf">get_detyper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets a detyper for the given key.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">detype</span>

        <span class="c1"># necessary for keys that match regexes, such as `*PATH`s</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">detyper</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">detype</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">detyper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_detyper</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">detyper</span>

    <span class="k">def</span> <span class="nf">get_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets default for the given key.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DefaultNotGiven</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">get_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the documentation for the environment variable.&quot;&quot;&quot;</span>
        <span class="n">vd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vd</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">doc_default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vd</span><span class="o">.</span><span class="n">doc_default</span> <span class="ow">is</span> <span class="n">DefaultNotGiven</span><span class="p">:</span>
            <span class="n">var_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;&lt;default not set&gt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">default</span>
            <span class="n">dval</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;not defined&quot;</span>
                <span class="k">if</span> <span class="n">var_default</span> <span class="ow">is</span> <span class="n">DefaultNotGiven</span>
                <span class="k">else</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">var_default</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">vd</span> <span class="o">=</span> <span class="n">vd</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">doc_default</span><span class="o">=</span><span class="n">dval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vd</span>

    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get information about a specific environment variable.&quot;&quot;&quot;</span>
        <span class="n">vardocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_docs</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">vardocs</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">))</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">HELP_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">envvar</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">docstr</span><span class="o">=</span><span class="n">docstr</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">vardocs</span><span class="o">.</span><span class="n">doc_default</span><span class="p">,</span>
            <span class="n">configurable</span><span class="o">=</span><span class="n">vardocs</span><span class="o">.</span><span class="n">is_configurable</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">print_color</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_manually_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if an environment variable has been manually set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides a context manager for temporarily swapping out certain</span>
<span class="sd">        environment variables with other values. On exit from the context</span>
<span class="sd">        manager, the original values are restored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># single positional argument should be a dict-like object</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">NotImplemented</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># kwargs could also have been sent in</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">NotImplemented</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">exception</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># restore the values</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span> <span class="kn">from</span> <span class="bp">None</span>

    <span class="c1">#</span>
    <span class="c1"># Mutable mapping interface</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DefaultNotGiven</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_callable_default</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Unknown environment variable: $</span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">MutableSet</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">MutableSequence</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_validator</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_converter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">detyper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_detyper</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="c1"># existing envvars can have any value including None</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;UPDATE_OS_ENVIRON&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replace_env</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">detyper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deval</span> <span class="o">=</span> <span class="n">detyper</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">deval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">os_environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">deval</span>
        <span class="k">if</span> <span class="n">old_value</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_value</span><span class="p">:</span>
            <span class="n">events</span><span class="o">.</span><span class="n">on_envvar_new</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_value</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">events</span><span class="o">.</span><span class="n">on_envvar_change</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">oldvalue</span><span class="o">=</span><span class="n">old_value</span><span class="p">,</span> <span class="n">newvalue</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_detyped</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;UPDATE_OS_ENVIRON&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">os_environ</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">os_environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Unknown environment variable: $</span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The environment will look up default values from its own defaults if a</span>
<span class="sd">        default is not given here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DefaultNotGiven</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">rawkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An iterator that returns all environment keys in their original form.</span>
<span class="sd">        This include string &amp; compiled regular expression keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)</span>
            <span class="o">|</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">k</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DefaultNotGiven</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawkeys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">key</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DefaultNotGiven</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">(...)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="n">always_true</span><span class="p">,</span>
        <span class="n">convert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">detype</span><span class="o">=</span><span class="n">ensure_string</span><span class="p">,</span>
        <span class="n">is_configurable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">doc_default</span><span class="o">=</span><span class="n">DefaultNotGiven</span><span class="p">,</span>
        <span class="n">can_store_as_str</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register an enviornment variable with optional type handling,</span>
<span class="sd">        default value, doc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Environment variable name to register. Typically all caps.</span>
<span class="sd">        type : str, optional,  {&#39;bool&#39;, &#39;str&#39;, &#39;path&#39;, &#39;env_path&#39;, &#39;int&#39;, &#39;float&#39;}</span>
<span class="sd">            Variable type. If not one of the available presets, use `validate`,</span>
<span class="sd">            `convert`, and `detype` to specify type behavior.</span>
<span class="sd">        default : optional</span>
<span class="sd">            Default value for variable. ``ValueError`` raised if type does not match</span>
<span class="sd">            that specified by `type` (or `validate`).</span>
<span class="sd">        doc : str, optional</span>
<span class="sd">            Docstring for variable.</span>
<span class="sd">        validate : func, optional</span>
<span class="sd">            Function to validate type.</span>
<span class="sd">        convert : func, optional</span>
<span class="sd">            Function to convert variable from a string representation to its type.</span>
<span class="sd">        detype : func, optional</span>
<span class="sd">            Function to convert variable from its type to a string representation.</span>
<span class="sd">        is_configurable : bool, optional</span>
<span class="sd">            Flag for whether the environment variable is configurable or not.</span>
<span class="sd">        doc_default : str, optional</span>
<span class="sd">            Custom docstring for the default value for complex defaults.</span>
<span class="sd">        can_store_as_str : bool, optional</span>
<span class="sd">            Flag for whether the environment variable should be stored as a</span>
<span class="sd">            string. This is used when persisting a variable that is not JSON</span>
<span class="sd">            serializable to the config file. For example, sets, frozensets, and</span>
<span class="sd">            potentially other non-trivial data types. default, False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;env_path&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">validate</span><span class="p">,</span> <span class="n">convert</span><span class="p">,</span> <span class="n">detype</span> <span class="o">=</span> <span class="n">ENSURERS</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_callable_default</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="ow">or</span> <span class="n">validate</span><span class="p">(</span><span class="n">default</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Default value for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not match type specified &quot;</span>
                    <span class="s2">&quot;by validate and is not a callable default.&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Var</span><span class="p">(</span>
            <span class="n">validate</span><span class="p">,</span>
            <span class="n">convert</span><span class="p">,</span>
            <span class="n">detype</span><span class="p">,</span>
            <span class="n">default</span><span class="p">,</span>
            <span class="n">doc</span><span class="p">,</span>
            <span class="n">is_configurable</span><span class="p">,</span>
            <span class="n">doc_default</span><span class="p">,</span>
            <span class="n">can_store_as_str</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">deregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deregister an enviornment variable and all its type handling,</span>
<span class="sd">        default value, doc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Environment variable name to deregister. Typically all caps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_yield_executables</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="n">base_name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">executables_in</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">fbase</span><span class="p">,</span> <span class="n">fext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">base_name</span> <span class="o">==</span> <span class="n">fbase</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ext</span> <span class="o">==</span> <span class="n">fext</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">executables_in</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">return</span>


<span class="k">def</span> <span class="nf">locate_binary</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locates an executable on the file system.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">XSH</span><span class="o">.</span><span class="n">commands_cache</span><span class="o">.</span><span class="n">locate_binary</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">xonshrc_context</span><span class="p">(</span>
    <span class="n">rcfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rcdirs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">execer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempts to read in all xonshrc files and return the context.</span>
<span class="sd">    The xonsh environment here is updated to reflect which RC files and</span>
<span class="sd">    directory locations will have been loaded (if they existed). The updated</span>
<span class="sd">    environment vars might be different (or empty) depending on CLI options</span>
<span class="sd">    (--rc, --no-rc) or whether the session is interactive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loaded</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;LOADED_RC_FILES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ctx</span>
    <span class="k">if</span> <span class="n">rcfiles</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rcdirs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">env</span>
    <span class="n">orig_thread</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;THREAD_SUBPROCS&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="s2">&quot;THREAD_SUBPROCS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">rcfiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSHRC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rcfiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rcfile</span> <span class="ow">in</span> <span class="n">rcfiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rcfile</span><span class="p">):</span>
                <span class="n">loaded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">xonsh_script_run_control</span><span class="p">(</span>
                <span class="n">rcfile</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">execer</span><span class="o">=</span><span class="n">execer</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="n">login</span>
            <span class="p">)</span>
            <span class="n">loaded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rcdirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSHRC_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rcdirs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rcdir</span> <span class="ow">in</span> <span class="n">rcdirs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">rcdir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">rcfile</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rcdir</span><span class="p">,</span> <span class="s2">&quot;*.xsh&quot;</span><span class="p">))):</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">xonsh_script_run_control</span><span class="p">(</span>
                        <span class="n">rcfile</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">execer</span><span class="o">=</span><span class="n">execer</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="n">login</span>
                    <span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;THREAD_SUBPROCS&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;THREAD_SUBPROCS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_thread</span>
    <span class="k">return</span> <span class="n">ctx</span>


<span class="k">def</span> <span class="nf">windows_foreign_env_fixes</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Environment fixes for Windows. Operates in-place.&quot;&quot;&quot;</span>
    <span class="c1"># remove these bash variables which only cause problems.</span>
    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HOME&quot;</span><span class="p">,</span> <span class="s2">&quot;OLDPWD&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">ctx</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
    <span class="c1"># Override path-related bash variables; on Windows bash uses</span>
    <span class="c1"># /c/Windows/System32 syntax instead of C:\\Windows\\System32</span>
    <span class="c1"># which messes up these environment variables for xonsh.</span>
    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;TMP&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">os_environ</span><span class="p">:</span>
            <span class="n">ctx</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="n">os_environ</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">ctx</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
    <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_cwd</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">foreign_env_fixes</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Environment fixes for all operating systems&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;PROMPT&quot;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;PROMPT&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_RcPath</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class used exclusively to know which entry was added temporarily to</span>
<span class="sd">    sys.path while loading rc files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">xonsh_script_run_control</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">execer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a xonsh file and applies it as a run control.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">execer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__file__&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)}</span>
    <span class="n">rc_dir</span> <span class="o">=</span> <span class="n">_RcPath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rc_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">swap_values</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
            <span class="n">run_script_with_cache</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">execer</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;syntax error in xonsh run control file </span><span class="si">{0!r}</span><span class="s2">: </span><span class="si">{1!s}</span><span class="s2">&quot;</span>
        <span class="n">print_exception</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;error running xonsh run control file </span><span class="si">{0!r}</span><span class="s2">: </span><span class="si">{1!s}</span><span class="s2">&quot;</span>
        <span class="n">print_exception</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">rc_dir</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loaded</span>


<span class="k">def</span> <span class="nf">default_env</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructs a default xonsh environment.&quot;&quot;&quot;</span>
    <span class="c1"># in order of increasing precedence</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;BASH_COMPLETIONS&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">DEFAULT_VARS</span><span class="p">[</span><span class="s2">&quot;BASH_COMPLETIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span><span class="p">),</span>
        <span class="s2">&quot;PROMPT_FIELDS&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">DEFAULT_VARS</span><span class="p">[</span><span class="s2">&quot;PROMPT_FIELDS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span><span class="p">),</span>
        <span class="s2">&quot;XONSH_VERSION&quot;</span><span class="p">:</span> <span class="n">XONSH_VERSION</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os_environ</span><span class="p">)</span>
    <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;PWD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_cwd</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># These can cause problems for programs (#2543)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;LINES&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;COLUMNS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># other shells&#39; PROMPT definitions generally don&#39;t work in XONSH:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;PROMPT&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># finalize env</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ctx</span>


<span class="k">def</span> <span class="nf">make_args_env</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a dictionary containing the $ARGS and $ARG&lt;N&gt; environment</span>
<span class="sd">    variables. If the supplied ARGS is None, then sys.argv is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ARG&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)}</span>
    <span class="n">env</span><span class="p">[</span><span class="s2">&quot;ARGS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># make a copy so we don&#39;t interfere with original variable</span>
    <span class="k">return</span> <span class="n">env</span>

<span class="c1">#</span>
<span class="c1"># imphooks</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Import hooks for importing xonsh source files.</span>

<span class="sd">This module registers the hooks it defines when it is imported.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated contextlib</span>
<span class="c1"># amalgamated importlib</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated types</span>
<span class="kn">from</span> <span class="nn">importlib.abc</span> <span class="kn">import</span> <span class="n">MetaPathFinder</span><span class="p">,</span> <span class="n">SourceLoader</span><span class="p">,</span> <span class="n">Loader</span>
<span class="kn">from</span> <span class="nn">importlib.machinery</span> <span class="kn">import</span> <span class="n">ModuleSpec</span>

<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.events</span>
<span class="c1"># amalgamated xonsh.execer</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">ENCODING_LINE</span><span class="p">():</span>
    <span class="c1"># this regex comes from PEP 263</span>
    <span class="c1"># https://www.python.org/dev/peps/pep-0263/#defining-the-encoding</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;^[ </span><span class="se">\t\f</span><span class="s2">]*#.*?coding[:=][ </span><span class="se">\t</span><span class="s2">]*([-_.a-zA-Z0-9]+)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_source_encoding</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds the source encoding given bytes representing a file by checking</span>
<span class="sd">    a special comment at either the first or second line of the source file.</span>
<span class="sd">    https://docs.python.org/3/howto/unicode.html#unicode-literals-in-python-source-code</span>
<span class="sd">    If no encoding is found, UTF-8 codec with BOM signature will be returned</span>
<span class="sd">    as it skips an optional UTF-8 encoded BOM at the start of the data</span>
<span class="sd">    and is otherwise the same as UTF-8</span>
<span class="sd">    https://docs.python.org/3/library/codecs.html#module-encodings.utf_8_sig</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">utf8</span> <span class="o">=</span> <span class="s2">&quot;utf-8-sig&quot;</span>
    <span class="n">first</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ENCODING_LINE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">utf8</span><span class="p">)</span>
    <span class="n">second</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ENCODING_LINE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">utf8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">utf8</span>


<span class="k">class</span> <span class="nc">XonshImportHook</span><span class="p">(</span><span class="n">MetaPathFinder</span><span class="p">,</span> <span class="n">SourceLoader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the import hook for xonsh source files.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XonshImportHook</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filenames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">execer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">execer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">execer</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">execer</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_execer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execer</span> <span class="o">=</span> <span class="n">execer</span> <span class="o">=</span> <span class="n">Execer</span><span class="p">(</span><span class="n">unload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execer</span>
        <span class="k">return</span> <span class="n">execer</span>

    <span class="c1">#</span>
    <span class="c1"># MetaPathFinder methods</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">find_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the spec for a xonsh module if it exists.&quot;&quot;&quot;</span>
        <span class="n">dot</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">path</span>
        <span class="k">if</span> <span class="n">dot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fullname</span> <span class="ow">and</span> <span class="n">dot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">dot</span><span class="p">]</span> <span class="o">+</span> <span class="n">path</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">fullname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.xsh&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">p</span><span class="p">)}:</span>
                <span class="k">continue</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">ModuleSpec</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filenames</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">return</span> <span class="n">spec</span>

    <span class="c1">#</span>
    <span class="c1"># SourceLoader methods</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">create_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a xonsh module with the appropriate attributes.&quot;&quot;&quot;</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">mod</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">__loader__</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">__package__</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">parent</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">mod</span>

    <span class="k">def</span> <span class="nf">get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the filename for a module&#39;s fullname.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filenames</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the bytes for a path.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">OSError</span>

    <span class="k">def</span> <span class="nf">get_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the code object for a xonsh file.&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;xonsh file </span><span class="si">{0!r}</span><span class="s2"> could not be found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="n">execer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execer</span>
        <span class="n">execer</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dummy for modules</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">execer</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">glbs</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">locs</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fullname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;could not find fullname to module&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">find_source_encoding</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">src</span> <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">src</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">src</span>


<span class="c1">#</span>
<span class="c1"># Import events</span>
<span class="c1">#</span>
<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_import_pre_find_spec&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_import_pre_find_spec(fullname: str, path: str, target: module or None) -&gt; None</span>

<span class="sd">Fires before any import find_spec() calls have been executed. The parameters</span>
<span class="sd">here are the same as importlib.abc.MetaPathFinder.find_spec(). Namely,</span>

<span class="sd">:``fullname``: The full name of the module to import.</span>
<span class="sd">:``path``: None if a top-level import, otherwise the ``__path__`` of the parent</span>
<span class="sd">          package.</span>
<span class="sd">:``target``: Target module used to make a better guess about the package spec.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_import_post_find_spec&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_import_post_find_spec(spec, fullname, path, target) -&gt; None</span>

<span class="sd">Fires after all import find_spec() calls have been executed. The parameters</span>
<span class="sd">here the spec and the arguments importlib.abc.MetaPathFinder.find_spec(). Namely,</span>

<span class="sd">:``spec``: A ModuleSpec object if the spec was found, or None if it was not.</span>
<span class="sd">:``fullname``: The full name of the module to import.</span>
<span class="sd">:``path``: None if a top-level import, otherwise the ``__path__`` of the parent</span>
<span class="sd">          package.</span>
<span class="sd">:``target``: Target module used to make a better guess about the package spec.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_import_pre_create_module&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_import_pre_create_module(spec: ModuleSpec) -&gt; None</span>

<span class="sd">Fires right before a module is created by its loader. The only parameter</span>
<span class="sd">is the spec object. See importlib for more details.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_import_post_create_module&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_import_post_create_module(module: Module, spec: ModuleSpec) -&gt; None</span>

<span class="sd">Fires after a module is created by its loader but before the loader returns it.</span>
<span class="sd">The parameters here are the module object itself and the spec object.</span>
<span class="sd">See importlib for more details.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_import_pre_exec_module&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_import_pre_exec_module(module: Module) -&gt; None</span>

<span class="sd">Fires right before a module is executed by its loader. The only parameter</span>
<span class="sd">is the module itself. See importlib for more details.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_import_post_exec_module&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_import_post_create_module(module: Module) -&gt; None</span>

<span class="sd">Fires after a module is executed by its loader but before the loader returns it.</span>
<span class="sd">The only parameter is the module itself. See importlib for more details.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_should_dispatch_xonsh_import_event_loader</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Figures out if we should dispatch to a load event&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">on_import_pre_create_module</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">on_import_post_create_module</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">on_import_pre_exec_module</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">on_import_post_exec_module</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">XonshImportEventHook</span><span class="p">(</span><span class="n">MetaPathFinder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the import hook for firing xonsh events on import.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fullname_stack</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">append_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A context manager for appending and then removing a name from the</span>
<span class="sd">        fullname stack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fullname_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="k">yield</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullname_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#</span>
    <span class="c1"># MetaPathFinder methods</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">find_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the spec for a xonsh module if it exists.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fullname_stack</span><span class="p">):</span>
            <span class="c1"># don&#39;t execute if we are already in the stack.</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">npre</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">on_import_pre_find_spec</span><span class="p">)</span>
        <span class="n">npost</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">on_import_post_find_spec</span><span class="p">)</span>
        <span class="n">dispatch_load</span> <span class="o">=</span> <span class="n">_should_dispatch_xonsh_import_event_loader</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">npre</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">events</span><span class="o">.</span><span class="n">on_import_pre_find_spec</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span>
                <span class="n">fullname</span><span class="o">=</span><span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">npost</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dispatch_load</span><span class="p">:</span>
            <span class="c1"># no events to fire, proceed normally and prevent recursion</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># now find the spec</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_stack</span><span class="p">(</span><span class="n">fullname</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="c1"># fire post event</span>
        <span class="k">if</span> <span class="n">npost</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">events</span><span class="o">.</span><span class="n">on_import_post_find_spec</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span>
                <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">dispatch_load</span> <span class="ow">and</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="p">,</span> <span class="s2">&quot;create_module&quot;</span><span class="p">):</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">XonshImportEventLoader</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spec</span>


<span class="n">_XIEVL_WRAPPED_ATTRIBUTES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;load_module&quot;</span><span class="p">,</span>
        <span class="s2">&quot;module_repr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;get_data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;get_resource_filename&quot;</span><span class="p">,</span>
        <span class="s2">&quot;get_resource_stream&quot;</span><span class="p">,</span>
        <span class="s2">&quot;get_resource_string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;has_resource&quot;</span><span class="p">,</span>
        <span class="s2">&quot;has_metadata&quot;</span><span class="p">,</span>
        <span class="s2">&quot;get_metadata&quot;</span><span class="p">,</span>
        <span class="s2">&quot;get_metadata_lines&quot;</span><span class="p">,</span>
        <span class="s2">&quot;resource_isdir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata_isdir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;resource_listdir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata_listdir&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">XonshImportEventLoader</span><span class="p">(</span><span class="n">Loader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that dispatches loader calls to another loader and fires relevant</span>
<span class="sd">    xonsh events.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loader</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">loader</span>

    <span class="c1">#</span>
    <span class="c1"># Loader methods</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">create_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates and returns the module object.&quot;&quot;&quot;</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_import_pre_create_module</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">create_module</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_import_post_create_module</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">mod</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mod</span>

    <span class="k">def</span> <span class="nf">exec_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Executes the module in its own namespace.&quot;&quot;&quot;</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_import_pre_exec_module</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">)</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_import_post_exec_module</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rtn</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_XIEVL_WRAPPED_ATTRIBUTES</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">install_import_hooks</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Install Xonsh import hooks in ``sys.meta_path`` in order for ``.xsh`` files</span>
<span class="sd">    to be importable and import events to be fired.</span>

<span class="sd">    Can safely be called many times, will be no-op if xonsh import hooks are</span>
<span class="sd">    already present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">found_imp</span> <span class="o">=</span> <span class="n">found_event</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="n">XonshImportHook</span><span class="p">):</span>
            <span class="n">found_imp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="n">XonshImportEventHook</span><span class="p">):</span>
            <span class="n">found_event</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">found_imp</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XonshImportHook</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">found_event</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">XonshImportEventHook</span><span class="p">())</span>


<span class="c1"># alias to deprecated name</span>
<span class="n">install_hook</span> <span class="o">=</span> <span class="n">install_import_hooks</span>

<span class="c1">#</span>
<span class="c1"># inspectors</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Tools for inspecting Python objects.</span>

<span class="sd">This file was forked from the IPython project:</span>

<span class="sd">* Copyright (c) 2008-2014, IPython Development Team</span>
<span class="sd">* Copyright (C) 2001-2007 Fernando Perez &lt;fperez@colorado.edu&gt;</span>
<span class="sd">* Copyright (c) 2001, Janko Hauser &lt;jhauser@zscout.de&gt;</span>
<span class="sd">* Copyright (c) 2001, Nathaniel Gray &lt;n8gray@caltech.edu&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated io</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated types</span>
<span class="c1"># amalgamated inspect</span>
<span class="c1"># amalgamated itertools</span>
<span class="n">linecache</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;linecache&#39;</span><span class="p">,</span> <span class="s1">&#39;linecache&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.tokenize</span>
<span class="c1"># amalgamated xonsh.openpy</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.lazyimps</span>
<span class="c1"># amalgamated xonsh.style_tools</span>
<span class="n">_func_call_docstring</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="o">.</span><span class="fm">__call__</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;_func_call_docstring&quot;</span>
<span class="p">)</span>
<span class="n">_object_init_docstring</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;_object_init_docstring&quot;</span>
<span class="p">)</span>

<span class="n">_builtin_type_docstrings</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;_builtin_type_docstrings&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_builtin_func_type</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="nb">all</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;_builtin_func_type&quot;</span><span class="p">)</span>
<span class="c1"># Bound methods have the same type as builtin functions</span>
<span class="n">_builtin_meth_type</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">upper</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;_builtin_meth_type&quot;</span>
<span class="p">)</span>

<span class="n">info_fields</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;type_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base_class&quot;</span><span class="p">,</span>
        <span class="s2">&quot;string_form&quot;</span><span class="p">,</span>
        <span class="s2">&quot;namespace&quot;</span><span class="p">,</span>
        <span class="s2">&quot;length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;definition&quot;</span><span class="p">,</span>
        <span class="s2">&quot;docstring&quot;</span><span class="p">,</span>
        <span class="s2">&quot;source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;init_definition&quot;</span><span class="p">,</span>
        <span class="s2">&quot;class_docstring&quot;</span><span class="p">,</span>
        <span class="s2">&quot;init_docstring&quot;</span><span class="p">,</span>
        <span class="s2">&quot;call_def&quot;</span><span class="p">,</span>
        <span class="s2">&quot;call_docstring&quot;</span><span class="p">,</span>
        <span class="c1"># These won&#39;t be printed but will be used to determine how to</span>
        <span class="c1"># format the object</span>
        <span class="s2">&quot;ismagic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;isalias&quot;</span><span class="p">,</span>
        <span class="s2">&quot;isclass&quot;</span><span class="p">,</span>
        <span class="s2">&quot;argspec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;found&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;info_fields&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">object_info</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make an object info dict with all fields present.&quot;&quot;&quot;</span>
    <span class="n">infodict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="n">info_fields</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]))</span>
    <span class="n">infodict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">infodict</span>


<span class="k">def</span> <span class="nf">get_encoding</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get encoding for python source file defining obj</span>

<span class="sd">    Returns None if obj is not defined in a sourcefile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ofile</span> <span class="o">=</span> <span class="n">find_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="c1"># run contents of file through pager starting at line where the object</span>
    <span class="c1"># is defined, as long as the file isn&#39;t binary and is actually on the</span>
    <span class="c1"># filesystem.</span>
    <span class="k">if</span> <span class="n">ofile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">ofile</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.so&quot;</span><span class="p">,</span> <span class="s2">&quot;.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;.pyd&quot;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ofile</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Print only text files, not extension binaries.  Note that</span>
        <span class="c1"># getsourcelines returns lineno with 1-offset and page() uses</span>
        <span class="c1"># 0-offset, so we must adjust.</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>  <span class="c1"># Tweaked to use io.open for Python 2</span>
            <span class="n">encoding</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">detect_encoding</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoding</span>


<span class="k">def</span> <span class="nf">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stable wrapper around inspect.getdoc.</span>

<span class="sd">    This can&#39;t crash because of attribute problems.</span>

<span class="sd">    It also attempts to call a getdoc() method on the given object.  This</span>
<span class="sd">    allows objects which provide their docstrings via non-standard mechanisms</span>
<span class="sd">    (like Pyro proxies) to still be inspected by ipython&#39;s ? system.&quot;&quot;&quot;</span>
    <span class="c1"># Allow objects to offer customized documentation via a getdoc method:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getdoc</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint:disable=broad-except</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if we get extra info, we add it to the normal docstring.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">cleandoc</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">get_encoding</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cast_unicode</span><span class="p">(</span><span class="n">docstr</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint:disable=broad-except</span>
        <span class="c1"># Harden against an inspect failure, which can occur with</span>
        <span class="c1"># SWIG-wrapped extensions.</span>
        <span class="k">raise</span>


<span class="k">def</span> <span class="nf">getsource</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">is_binary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around inspect.getsource.</span>

<span class="sd">    This can be modified by other projects to provide customized source</span>
<span class="sd">    extraction.</span>

<span class="sd">    Inputs:</span>

<span class="sd">    - obj: an object whose source code we will attempt to extract.</span>

<span class="sd">    Optional inputs:</span>

<span class="sd">    - is_binary: whether the object is known to come from a binary source.</span>
<span class="sd">      This implementation will skip returning any output for binary objects,</span>
<span class="sd">      but custom extractors may know how to meaningfully process them.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">is_binary</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># get source if obj was decorated with @decorator</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__wrapped__</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">):</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">get_encoding</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cast_unicode</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_simple_callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;True if obj is a function ()&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_builtin_func_type</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_builtin_meth_type</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">getargspec</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around :func:`inspect.getfullargspec` on Python 3, and</span>
<span class="sd">    :func:inspect.getargspec` on Python 2.</span>

<span class="sd">    In addition to functions and methods, this can also handle objects with a</span>
<span class="sd">    ``__call__`` attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">safe_hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_simple_callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__call__</span>

    <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">format_argspec</span><span class="p">(</span><span class="n">argspec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format argspect, convenience wrapper around inspect&#39;s.</span>

<span class="sd">    This takes a dict instead of ordered arguments and calls</span>
<span class="sd">    inspect.format_argspec with the arguments in the necessary order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">formatargspec</span><span class="p">(</span>
        <span class="n">argspec</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">],</span> <span class="n">argspec</span><span class="p">[</span><span class="s2">&quot;varargs&quot;</span><span class="p">],</span> <span class="n">argspec</span><span class="p">[</span><span class="s2">&quot;varkw&quot;</span><span class="p">],</span> <span class="n">argspec</span><span class="p">[</span><span class="s2">&quot;defaults&quot;</span><span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">call_tip</span><span class="p">(</span><span class="n">oinfo</span><span class="p">,</span> <span class="n">format_call</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract call tip data from an oinfo dict.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    oinfo : dict</span>
<span class="sd">    format_call : bool, optional</span>
<span class="sd">        If True, the call line is formatted and returned as a string.  If not, a</span>
<span class="sd">        tuple of (name, argspec) is returned.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    call_info : None, str or (str, dict) tuple.</span>
<span class="sd">        When format_call is True, the whole call information is formatted as a</span>
<span class="sd">        single string.  Otherwise, the object&#39;s name and its argspec dict are</span>
<span class="sd">        returned.  If no call information is available, None is returned.</span>
<span class="sd">    docstring : str or None</span>
<span class="sd">        The most relevant docstring for calling purposes is returned, if</span>
<span class="sd">        available.  The priority is: call docstring for callable instances, then</span>
<span class="sd">        constructor docstring for classes, then main object&#39;s docstring otherwise</span>
<span class="sd">        (regular functions).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get call definition</span>
    <span class="n">argspec</span> <span class="o">=</span> <span class="n">oinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;argspec&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">argspec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">call_line</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Callable objects will have &#39;self&#39; as their first argument, prune</span>
        <span class="c1"># it out if it&#39;s there for clarity (since users do *not* pass an</span>
        <span class="c1"># extra first argument explicitly).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">has_self</span> <span class="o">=</span> <span class="n">argspec</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_self</span><span class="p">:</span>
                <span class="n">argspec</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argspec</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">call_line</span> <span class="o">=</span> <span class="n">oinfo</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">format_argspec</span><span class="p">(</span><span class="n">argspec</span><span class="p">)</span>

    <span class="c1"># Now get docstring.</span>
    <span class="c1"># The priority is: call docstring, constructor docstring, main one.</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">oinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;call_docstring&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">oinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;init_docstring&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">oinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;docstring&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">call_line</span><span class="p">,</span> <span class="n">doc</span>


<span class="k">def</span> <span class="nf">find_file</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the absolute path to the file where an object was defined.</span>

<span class="sd">    This is essentially a robust wrapper around `inspect.getabsfile`.</span>

<span class="sd">    Returns None if no file can be found.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : any Python object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fname : str</span>
<span class="sd">        The absolute path to the file where the object was defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get source if obj was decorated with @decorator</span>
    <span class="k">if</span> <span class="n">safe_hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__wrapped__</span>

    <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getabsfile</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="c1"># For an instance, the file that matters is where its class was</span>
        <span class="c1"># declared.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getabsfile</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Can happen for builtins</span>
                <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">cast_unicode</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_source_lines</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the line number in a file where an object was defined.</span>

<span class="sd">    This is essentially a robust wrapper around `inspect.getsourcelines`.</span>

<span class="sd">    Returns None if no file can be found.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : any Python object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lineno : int</span>
<span class="sd">        The line number where the object definition starts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get source if obj was decorated with @decorator</span>
    <span class="k">if</span> <span class="n">safe_hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__wrapped__&quot;</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__wrapped__</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># For instances, try the class object like getsource() does</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">):</span>
                <span class="n">lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lineno</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">lineno</span>


<span class="k">class</span> <span class="nc">Inspector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inspects objects.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">str_detail_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_detail_level</span> <span class="o">=</span> <span class="n">str_detail_level</span>

    <span class="k">def</span> <span class="nf">_getdef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the call signature for any callable object.</span>

<span class="sd">        If any exception is generated, None is returned instead and the</span>
<span class="sd">        exception is suppressed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdef</span> <span class="o">=</span> <span class="n">oname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">cast_unicode</span><span class="p">(</span><span class="n">hdef</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">noinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">oname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic message when no information is found.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No </span><span class="si">%s</span><span class="s2"> found&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oname</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">oname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pdef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the call signature for any callable object.</span>

<span class="sd">        If the object is a class, print the constructor information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Object is not callable.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__head</span><span class="p">(</span><span class="s2">&quot;Class constructor information:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdef</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noinfo</span><span class="p">(</span><span class="s2">&quot;definition header&quot;</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pdoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the docstring for any object.</span>

<span class="sd">        Optional</span>

<span class="sd">        -formatter: a function to run the docstring through for specially</span>
<span class="sd">        formatted docstrings.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__head</span>  <span class="c1"># For convenience</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ds</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="s2">&quot;Class docstring:&quot;</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">):</span>
            <span class="n">init_ds</span> <span class="o">=</span> <span class="n">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">init_ds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="s2">&quot;Init docstring:&quot;</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span><span class="p">(</span><span class="n">init_ds</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">call_ds</span> <span class="o">=</span> <span class="n">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">call_ds</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="s2">&quot;Call docstring:&quot;</span><span class="p">))</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span><span class="p">(</span><span class="n">call_ds</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noinfo</span><span class="p">(</span><span class="s2">&quot;documentation&quot;</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">psource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the source code for an object.&quot;&quot;&quot;</span>
        <span class="c1"># Flush the source cache because inspect can return out-of-date source</span>
        <span class="n">linecache</span><span class="o">.</span><span class="n">checkcache</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">getsource</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noinfo</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the whole file where an object was defined.&quot;&quot;&quot;</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">find_source_lines</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noinfo</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">ofile</span> <span class="o">=</span> <span class="n">find_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="c1"># run contents of file through pager starting at line where the object</span>
        <span class="c1"># is defined, as long as the file isn&#39;t binary and is actually on the</span>
        <span class="c1"># filesystem.</span>
        <span class="k">if</span> <span class="n">ofile</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.so&quot;</span><span class="p">,</span> <span class="s2">&quot;.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;.pyd&quot;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%r</span><span class="s2"> is binary, not printing.&quot;</span> <span class="o">%</span> <span class="n">ofile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ofile</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%r</span><span class="s2"> does not exist, not printing.&quot;</span> <span class="o">%</span> <span class="n">ofile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Print only text files, not extension binaries.  Note that</span>
            <span class="c1"># getsourcelines returns lineno with 1-offset and page() uses</span>
            <span class="c1"># 0-offset, so we must adjust.</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">read_py_file</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="n">skip_encoding_cookie</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_format_fields_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">title_width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Formats a list of fields for display using color strings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fields : list</span>
<span class="sd">            A list of 2-tuples: (field_title, field_content)</span>
<span class="sd">        title_width : int</span>
<span class="sd">            How many characters to pad titles to. Default to longest title.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">title_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">title_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">title_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{BOLD_RED}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="si">{RESET}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">title_width</span> <span class="o">-</span> <span class="n">title_len</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast_unicode</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">+</span> <span class="n">cast_unicode</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">format_color</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_format_fields_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">title_width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Formats a list of fields for display using color tokens from</span>
<span class="sd">        pygments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fields : list</span>
<span class="sd">            A list of 2-tuples: (field_title, field_content)</span>
<span class="sd">        title_width : int</span>
<span class="sd">            How many characters to pad titles to. Default to longest title.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">title_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">title_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">title_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{BOLD_RED}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="si">{RESET}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">title_width</span> <span class="o">-</span> <span class="n">title_len</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">partial_color_tokenize</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">content</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">content</span>
                <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_format_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">title_width</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Formats a list of fields for display using color tokens from</span>
<span class="sd">        pygments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fields : list</span>
<span class="sd">            A list of 2-tuples: (field_title, field_content)</span>
<span class="sd">        title_width : int</span>
<span class="sd">            How many characters to pad titles to. Default to longest title.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">HAS_PYGMENTS</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_fields_tokens</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">title_width</span><span class="o">=</span><span class="n">title_width</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rtn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_fields_str</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">title_width</span><span class="o">=</span><span class="n">title_width</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rtn</span>

    <span class="c1"># The fields to be displayed by pinfo: (fancy_name, key_in_info_dict)</span>
    <span class="n">pinfo_fields1</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;type_name&quot;</span><span class="p">)]</span>

    <span class="n">pinfo_fields2</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;String form&quot;</span><span class="p">,</span> <span class="s2">&quot;string_form&quot;</span><span class="p">)]</span>

    <span class="n">pinfo_fields3</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;Length&quot;</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;File&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Definition&quot;</span><span class="p">,</span> <span class="s2">&quot;definition&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">pinfo_fields_obj</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;Class docstring&quot;</span><span class="p">,</span> <span class="s2">&quot;class_docstring&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Init docstring&quot;</span><span class="p">,</span> <span class="s2">&quot;init_docstring&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Call def&quot;</span><span class="p">,</span> <span class="s2">&quot;call_def&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;Call docstring&quot;</span><span class="p">,</span> <span class="s2">&quot;call_docstring&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">pinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detail_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show detailed information about an object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : object</span>
<span class="sd">        oname : str, optional</span>
<span class="sd">            name of the variable pointing to the object.</span>
<span class="sd">        info : dict, optional</span>
<span class="sd">            a structure with some information fields which may have been</span>
<span class="sd">            precomputed already.</span>
<span class="sd">        detail_level : int, optional</span>
<span class="sd">            if set to 1, more information is given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="n">oname</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">detail_level</span><span class="o">=</span><span class="n">detail_level</span><span class="p">)</span>
        <span class="n">displayfields</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">add_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">displayfields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">title</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()))</span>

        <span class="n">add_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinfo_fields1</span><span class="p">)</span>
        <span class="n">add_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinfo_fields2</span><span class="p">)</span>

        <span class="c1"># Namespace</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Interactive&quot;</span><span class="p">:</span>
            <span class="n">displayfields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Namespace&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()))</span>

        <span class="n">add_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinfo_fields3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;isclass&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;init_definition&quot;</span><span class="p">]:</span>
            <span class="n">displayfields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Init definition&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;init_definition&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()))</span>

        <span class="c1"># Source or docstring, depending on detail level and whether</span>
        <span class="c1"># source found.</span>
        <span class="k">if</span> <span class="n">detail_level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">displayfields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Source&quot;</span><span class="p">,</span> <span class="n">cast_unicode</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])))</span>
        <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;docstring&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">displayfields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Docstring&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;docstring&quot;</span><span class="p">]))</span>

        <span class="c1"># Constructor info for classes</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;isclass&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;init_docstring&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">displayfields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Init docstring&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;init_docstring&quot;</span><span class="p">]))</span>

        <span class="c1"># Info for objects:</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinfo_fields_obj</span><span class="p">)</span>

        <span class="c1"># Finally send to printer/pager:</span>
        <span class="k">if</span> <span class="n">displayfields</span><span class="p">:</span>
            <span class="n">print_color</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_fields</span><span class="p">(</span><span class="n">displayfields</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detail_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute a dict with detailed information about an object.</span>

<span class="sd">        Optional arguments:</span>

<span class="sd">        - oname: name of the variable pointing to the object.</span>

<span class="sd">        - info: a structure with some information fields which may have been</span>
<span class="sd">          precomputed already.</span>

<span class="sd">        - detail_level: if set to 1, more information is given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ismagic</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">isalias</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ospace</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ismagic</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">ismagic</span>
            <span class="n">isalias</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">isalias</span>
            <span class="n">ospace</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">namespace</span>
        <span class="c1"># Get docstring, special-casing aliases:</span>
        <span class="k">if</span> <span class="n">isalias</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="s2">&quot;Alias to the system command:</span><span class="se">\n</span><span class="s2">  </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="s2">&quot;Alias: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="s2">&quot;Alias to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Docstring:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="s2">&quot;&lt;no docstring&gt;&quot;</span>

        <span class="c1"># store output in a dict, we initialize it here and fill it as we go</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">oname</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">isalias</span><span class="o">=</span><span class="n">isalias</span><span class="p">,</span> <span class="n">ismagic</span><span class="o">=</span><span class="n">ismagic</span><span class="p">)</span>

        <span class="n">string_max</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># max size of strings to show (snipped if longer)</span>
        <span class="n">shalf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">string_max</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ismagic</span><span class="p">:</span>
            <span class="n">obj_type_name</span> <span class="o">=</span> <span class="s2">&quot;Magic function&quot;</span>
        <span class="k">elif</span> <span class="n">isalias</span><span class="p">:</span>
            <span class="n">obj_type_name</span> <span class="o">=</span> <span class="s2">&quot;System alias&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj_type_name</span> <span class="o">=</span> <span class="n">obj_type</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;type_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_type_name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bclass</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;base_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bclass</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># String form, but snip if too long in ? form (full in ??)</span>
        <span class="k">if</span> <span class="n">detail_level</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_detail_level</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ostr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">str_head</span> <span class="o">=</span> <span class="s2">&quot;string_form&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">detail_level</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">string_max</span><span class="p">:</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">[:</span><span class="n">shalf</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &lt;...&gt; &quot;</span> <span class="o">+</span> <span class="n">ostr</span><span class="p">[</span><span class="o">-</span><span class="n">shalf</span><span class="p">:]</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_head</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">()))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">q</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">ostr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="n">str_head</span><span class="p">]</span> <span class="o">=</span> <span class="n">ostr</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">ospace</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ospace</span>

        <span class="c1"># Length (for strings and lists)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Filename where object was defined</span>
        <span class="n">binary_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">find_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if anything goes wrong, we don&#39;t want to show source, so it&#39;s as</span>
            <span class="c1"># if the file was binary</span>
            <span class="n">binary_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.so&quot;</span><span class="p">,</span> <span class="s2">&quot;.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;.pyd&quot;</span><span class="p">)):</span>
                <span class="n">binary_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;Dynamically generated function. &quot;</span> <span class="s2">&quot;No source code available.&quot;</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname</span>

        <span class="c1"># Docstrings only in detail 0 mode, since source contains them (we</span>
        <span class="c1"># avoid repetitions).  If source fails, we add them back, see below.</span>
        <span class="k">if</span> <span class="n">ds</span> <span class="ow">and</span> <span class="n">detail_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;docstring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>

        <span class="c1"># Original source code for any callable</span>
        <span class="k">if</span> <span class="n">detail_level</span><span class="p">:</span>
            <span class="c1"># Flush the source cache because inspect can return out-of-date</span>
            <span class="c1"># source</span>
            <span class="n">linecache</span><span class="o">.</span><span class="n">checkcache</span><span class="p">()</span>
            <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">getsource</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">binary_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__class__&quot;</span><span class="p">):</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="n">getsource</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">binary_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">HAS_PYGMENTS</span><span class="p">:</span>
                        <span class="n">lexer</span> <span class="o">=</span> <span class="n">pyghooks</span><span class="o">.</span><span class="n">XonshLexer</span><span class="p">()</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pygments</span><span class="o">.</span><span class="n">lex</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="n">lexer</span><span class="p">))</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint:disable=broad-except</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">ds</span> <span class="ow">and</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;docstring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>

        <span class="c1"># Constructor docstring for classes</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;isclass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># reconstruct the function definition and print it:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj_init</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">init_def</span> <span class="o">=</span> <span class="n">init_ds</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">init_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdef</span><span class="p">(</span><span class="n">obj_init</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
                <span class="n">init_ds</span> <span class="o">=</span> <span class="n">getdoc</span><span class="p">(</span><span class="n">obj_init</span><span class="p">)</span>
                <span class="c1"># Skip Python&#39;s auto-generated docstrings</span>
                <span class="k">if</span> <span class="n">init_ds</span> <span class="o">==</span> <span class="n">_object_init_docstring</span><span class="p">:</span>
                    <span class="n">init_ds</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">init_def</span> <span class="ow">or</span> <span class="n">init_ds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">init_def</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;init_definition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_def</span>
                <span class="k">if</span> <span class="n">init_ds</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;init_docstring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_ds</span>

        <span class="c1"># and class docstring for instances:</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># reconstruct the function definition and print it:</span>
            <span class="n">defln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdef</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">defln</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;definition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defln</span>

            <span class="c1"># First, check whether the instance docstring is identical to the</span>
            <span class="c1"># class one, and print it separately if they don&#39;t coincide.  In</span>
            <span class="c1"># most cases they will, but it&#39;s nice to print all the info for</span>
            <span class="c1"># objects which use instance-customized docstrings.</span>
            <span class="k">if</span> <span class="n">ds</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">class_ds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">class_ds</span> <span class="o">=</span> <span class="n">getdoc</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="c1"># Skip Python&#39;s auto-generated docstrings</span>
                <span class="k">if</span> <span class="n">class_ds</span> <span class="ow">in</span> <span class="n">_builtin_type_docstrings</span><span class="p">:</span>
                    <span class="n">class_ds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">class_ds</span> <span class="ow">and</span> <span class="n">ds</span> <span class="o">!=</span> <span class="n">class_ds</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;class_docstring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_ds</span>

            <span class="c1"># Next, try to show constructor docstrings</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">init_ds</span> <span class="o">=</span> <span class="n">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
                <span class="c1"># Skip Python&#39;s auto-generated docstrings</span>
                <span class="k">if</span> <span class="n">init_ds</span> <span class="o">==</span> <span class="n">_object_init_docstring</span><span class="p">:</span>
                    <span class="n">init_ds</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">init_ds</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">init_ds</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;init_docstring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_ds</span>

            <span class="c1"># Call form docstring for callable instances</span>
            <span class="k">if</span> <span class="n">safe_hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_simple_callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="n">call_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getdef</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__call__</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">call_def</span><span class="p">:</span>
                    <span class="n">call_def</span> <span class="o">=</span> <span class="n">call_def</span>
                    <span class="c1"># it may never be the case that call def and definition</span>
                    <span class="c1"># differ, but don&#39;t include the same signature twice</span>
                    <span class="k">if</span> <span class="n">call_def</span> <span class="o">!=</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;definition&quot;</span><span class="p">):</span>
                        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;call_def&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_def</span>
                <span class="n">call_ds</span> <span class="o">=</span> <span class="n">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
                <span class="c1"># Skip Python&#39;s auto-generated docstrings</span>
                <span class="k">if</span> <span class="n">call_ds</span> <span class="o">==</span> <span class="n">_func_call_docstring</span><span class="p">:</span>
                    <span class="n">call_ds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">call_ds</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;call_docstring&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_ds</span>

        <span class="c1"># Compute the object&#39;s argspec as a callable.  The key is to decide</span>
        <span class="c1"># whether to pull it from the object itself, from its __init__ or</span>
        <span class="c1"># from its __call__ method.</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c1"># Old-style classes need not have an __init__</span>
            <span class="n">callable_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">callable_obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">callable_obj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">callable_obj</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">argspec</span> <span class="o">=</span> <span class="n">getargspec</span><span class="p">(</span><span class="n">callable_obj</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="c1"># For extensions/builtins we can&#39;t retrieve the argspec</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># named tuples&#39; _asdict() method returns an OrderedDict, but we</span>
                <span class="c1"># we want a normal</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;argspec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argspec_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">argspec</span><span class="o">.</span><span class="n">_asdict</span><span class="p">())</span>
                <span class="c1"># We called this varkw before argspec became a named tuple.</span>
                <span class="c1"># With getfullargspec it&#39;s also called varkw.</span>
                <span class="k">if</span> <span class="s2">&quot;varkw&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argspec_dict</span><span class="p">:</span>
                    <span class="n">argspec_dict</span><span class="p">[</span><span class="s2">&quot;varkw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argspec_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;keywords&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">object_info</span><span class="p">(</span><span class="o">**</span><span class="n">out</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># aliases</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Aliases for the xonsh shell.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated inspect</span>
<span class="c1"># amalgamated argparse</span>
<span class="c1"># amalgamated collections.abc</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.dirstack</span>
<span class="c1"># amalgamated xonsh.environ</span>
<span class="c1"># amalgamated xonsh.foreign_shells</span>
<span class="c1"># amalgamated xonsh.jobs</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.timings</span>
<span class="c1"># amalgamated xonsh.xontribs</span>
<span class="c1"># amalgamated xonsh.ast</span>
<span class="n">xca</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;xonsh&#39;</span><span class="p">,</span> <span class="s1">&#39;xonsh.completers._aliases&#39;</span><span class="p">,</span> <span class="s1">&#39;xca&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated xonsh.history.main</span>
<span class="n">xxw</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;xonsh&#39;</span><span class="p">,</span> <span class="s1">&#39;xonsh.xoreutils.which&#39;</span><span class="p">,</span> <span class="s1">&#39;xxw&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">xonsh.xoreutils.umask</span> <span class="kn">import</span> <span class="n">umask</span>

<span class="k">if</span> <span class="n">ON_POSIX</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">xonsh.xoreutils.ulimit</span> <span class="kn">import</span> <span class="n">ulimit</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">EXEC_ALIAS_RE</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;@\(|\$\(|!\(|\$\[|!\[|\&amp;\&amp;|\|\||\s+and\s+|\s+or\s+|[&gt;|&lt;]&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Aliases</span><span class="p">(</span><span class="n">cabc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a location to hold and look up aliases.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the (possibly modified) value. If the key is not present,</span>
<span class="sd">        then `default` is returned.</span>
<span class="sd">        If the value is callable, it is returned without modification. If it</span>
<span class="sd">        is an iterable of strings it will be evaluated recursively to expand</span>
<span class="sd">        other aliases, resulting in a new list or a &quot;partially applied&quot;</span>
<span class="sd">        callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">)</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_alias</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">seen_tokens</span><span class="o">=</span><span class="p">{</span><span class="n">key</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;alias of </span><span class="si">{!r}</span><span class="s2"> has an inappropriate type: </span><span class="si">{!r}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">eval_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">seen_tokens</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span> <span class="n">acc_args</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;Evaluates&quot; the alias ``value``, by recursively looking up the leftmost</span>
<span class="sd">        token and &quot;expanding&quot; if it&#39;s also an alias.</span>

<span class="sd">        A value like ``[&quot;cmd&quot;, &quot;arg&quot;]`` might transform like this:</span>
<span class="sd">        ``&gt; [&quot;cmd&quot;, &quot;arg&quot;] -&gt; [&quot;ls&quot;, &quot;-al&quot;, &quot;arg&quot;] -&gt; callable()``</span>
<span class="sd">        where ``cmd=ls -al`` and ``ls`` is an alias with its value being a</span>
<span class="sd">        callable.  The resulting callable will be &quot;partially applied&quot; with</span>
<span class="sd">        ``[&quot;-al&quot;, &quot;arg&quot;]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Beware of mutability: default values for keyword args are evaluated</span>
        <span class="c1"># only once.</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">partial_eval_alias</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">acc_args</span><span class="o">=</span><span class="n">acc_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expand_path</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">expand_path</span>
            <span class="n">token</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">expand_path</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">seen_tokens</span> <span class="ow">or</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">:</span>
                <span class="c1"># ^ Making sure things like `egrep=egrep --color=auto` works,</span>
                <span class="c1"># and that `l` evals to `ls --color=auto -CF` if `l=ls -CF`</span>
                <span class="c1"># and `ls=ls --color=auto`</span>
                <span class="n">rtn</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="p">]</span>
                <span class="n">rtn</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
                <span class="n">rtn</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">acc_args</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rtn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seen_tokens</span> <span class="o">=</span> <span class="n">seen_tokens</span> <span class="o">|</span> <span class="p">{</span><span class="n">token</span><span class="p">}</span>
                <span class="n">acc_args</span> <span class="o">=</span> <span class="n">rest</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">acc_args</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">[</span><span class="n">token</span><span class="p">],</span> <span class="n">seen_tokens</span><span class="p">,</span> <span class="n">acc_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">expand_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cursor_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Expands any aliases present in line if alias does not point to a</span>
<span class="sd">        builtin function and if alias is only a single command.</span>
<span class="sd">        The command won&#39;t be expanded if the cursor&#39;s inside/behind it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">XSH</span><span class="o">.</span><span class="n">aliases</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">),</span> <span class="n">cabc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="n">word_idx</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">word_edge</span> <span class="o">=</span> <span class="n">word_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cursor_index</span> <span class="o">&gt;</span> <span class="n">word_edge</span><span class="p">:</span>
                <span class="c1"># the cursor isn&#39;t inside/behind the word</span>
                <span class="n">expansion</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">word_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">expansion</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">word_edge</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="c1">#</span>
    <span class="c1"># Mutable mapping interface</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="s2">&quot;&lt;exec-alias:&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
            <span class="k">if</span> <span class="n">EXEC_ALIAS_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># We have a sub-command (e.g. $(cmd)) or IO redirect (e.g. &gt;&gt;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExecAlias</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">isexpression</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="c1"># expansion substitution</span>
                <span class="n">lexer</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">execer</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">lexer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">strip_simple_quotes</span><span class="p">,</span> <span class="n">lexer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># need to exec alias</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExecAlias</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_common_or</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Aliases</span><span class="p">(</span><span class="n">new_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_or</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_or</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ior__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">(</span><span class="si">{2}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span>
        <span class="p">)</span>

    <span class="n">_repr_pretty_</span> <span class="o">=</span> <span class="n">to_repr_pretty_</span>


<span class="k">class</span> <span class="nc">ExecAlias</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Provides a callable alias for xonsh source code.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&lt;exec-alias&gt;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        src : str</span>
<span class="sd">            Source code that will be</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">execer</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">execer</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># execute as though we are at the call site</span>

        <span class="n">alias_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">alias_args</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;arg</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>

        <span class="k">with</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">alias_args</span><span class="p">):</span>
            <span class="n">execer</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                <span class="n">glbs</span><span class="o">=</span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">,</span>
                <span class="n">locs</span><span class="o">=</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;ExecAlias(</span><span class="si">{0!r}</span><span class="s2">, filename=</span><span class="si">{1!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PartialEvalAliasBase</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Partially evaluated alias.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">acc_args</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : callable</span>
<span class="sd">            A function to dispatch to.</span>
<span class="sd">        acc_args : sequence of strings, optional</span>
<span class="sd">            Additional arguments to prepent to the argument list passed in</span>
<span class="sd">            when the alias is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span> <span class="o">=</span> <span class="n">acc_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">(</span><span class="si">{f!r}</span><span class="s2">, acc_args=</span><span class="si">{acc_args!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">acc_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">PartialEvalAlias0</span><span class="p">(</span><span class="n">PartialEvalAliasBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;callable alias </span><span class="si">{f!r}</span><span class="s2"> takes no arguments, but {args!f} provided. &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Of these </span><span class="si">{acc_args!r}</span><span class="s2"> were partially applied.&quot;</span>
            <span class="k">raise</span> <span class="n">XonshError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">acc_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PartialEvalAlias1</span><span class="p">(</span><span class="n">PartialEvalAliasBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PartialEvalAlias2</span><span class="p">(</span><span class="n">PartialEvalAliasBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PartialEvalAlias3</span><span class="p">(</span><span class="n">PartialEvalAliasBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PartialEvalAlias4</span><span class="p">(</span><span class="n">PartialEvalAliasBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PartialEvalAlias5</span><span class="p">(</span><span class="n">PartialEvalAliasBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PartialEvalAlias6</span><span class="p">(</span><span class="n">PartialEvalAliasBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acc_args</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>


<span class="n">PARTIAL_EVAL_ALIASES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">PartialEvalAlias0</span><span class="p">,</span>
    <span class="n">PartialEvalAlias1</span><span class="p">,</span>
    <span class="n">PartialEvalAlias2</span><span class="p">,</span>
    <span class="n">PartialEvalAlias3</span><span class="p">,</span>
    <span class="n">PartialEvalAlias4</span><span class="p">,</span>
    <span class="n">PartialEvalAlias5</span><span class="p">,</span>
    <span class="n">PartialEvalAlias6</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">partial_eval_alias</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">acc_args</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;Dispatches the appropriate eval alias based on the number of args to the original callable alias</span>
<span class="sd">    and how many arguments to apply.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># no partial needed if no extra args</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">acc_args</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="c1"># need to dispatch</span>
    <span class="n">numargs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_ONLY</span>
            <span class="ow">or</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
        <span class="p">):</span>
            <span class="n">numargs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ALIAS_KWARG_NAMES</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">param</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span><span class="p">:</span>
            <span class="n">numargs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">numargs</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PARTIAL_EVAL_ALIASES</span><span class="p">[</span><span class="n">numargs</span><span class="p">](</span><span class="n">f</span><span class="p">,</span> <span class="n">acc_args</span><span class="o">=</span><span class="n">acc_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Expected proxy with 6 or fewer arguments for </span><span class="si">{}</span><span class="s2">, not </span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="n">XonshError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ALIAS_KWARG_NAMES</span><span class="p">),</span> <span class="n">numargs</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># Actual aliases below</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">xonsh_exit</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends signal to exit shell.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">clean_jobs</span><span class="p">():</span>
        <span class="c1"># Do not exit if jobs not cleaned up</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">()</span>  <span class="c1"># gimme a newline</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">xonsh_reset</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clears __xonsh__.ctx&quot;&quot;&quot;</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">_SOURCE_FOREIGN_PARSER</span><span class="p">():</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Sources a file written in a foreign shell language.&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s2">&quot;source-foreign&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name or path to the foreign shell&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;files_or_code&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;file paths to source or code in the target &quot;</span> <span class="s2">&quot;language.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--interactive&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">to_bool</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;whether the sourced shell should be interactive&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;interactive&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-l&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--login&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">to_bool</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;whether the sourced shell should be login&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;login&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--envcmd&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;envcmd&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;command to print environment&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--aliascmd&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;aliascmd&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;command to print aliases&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--extra-args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;extra_args&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">())),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;extra arguments needed to run the shell&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--safe&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">to_bool</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;whether the source shell should be run safely, &quot;</span>
        <span class="s2">&quot;and not raise any errors, even if they occur.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;safe&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--prevcmd&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;prevcmd&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;command(s) to run before any other commands, &quot;</span>
        <span class="s2">&quot;replaces traditional source.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--postcmd&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;postcmd&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;command(s) to run after all other commands&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--funcscmd&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;funcscmd&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;code to find locations of all native functions &quot;</span> <span class="s2">&quot;in the shell language.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--sourcer&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;sourcer&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the source command in the target shell &quot;</span> <span class="s2">&quot;language, default: source.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--use-tmpfile&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">to_bool</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;whether the commands for source shell should be &quot;</span>
        <span class="s2">&quot;written to a temporary file.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_tmpfile&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--seterrprevcmd&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;seterrprevcmd&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;command(s) to set exit-on-error before any&quot;</span> <span class="s2">&quot;other commands.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--seterrpostcmd&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;seterrpostcmd&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;command(s) to set exit-on-error after all&quot;</span> <span class="s2">&quot;other commands.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--overwrite-aliases&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;overwrite_aliases&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;flag for whether or not sourced aliases should &quot;</span>
        <span class="s2">&quot;replace the current xonsh aliases.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--suppress-skip-message&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;suppress_skip_message&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;flag for whether or not skip messages should be suppressed.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--show&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;show&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Will show the script output.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--dry-run&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;dryrun&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Will not actually source the file.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">source_foreign</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sources a file written in a foreign shell language.&quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">_SOURCE_FOREIGN_PARSER</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">ns</span><span class="o">.</span><span class="n">suppress_skip_message</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FOREIGN_ALIASES_SUPPRESS_SKIP_MESSAGE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">suppress_skip_message</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">ns</span><span class="o">.</span><span class="n">suppress_skip_message</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">prevcmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># don&#39;t change prevcmd if given explicitly</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">files_or_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># we have filename to source</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">prevcmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">sourcer</span><span class="p">,</span> <span class="s1">&#39;&quot; &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">files_or_code</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">ns</span><span class="o">.</span><span class="n">prevcmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">prevcmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">files_or_code</span><span class="p">)</span>  <span class="c1"># code to run, no files</span>
    <span class="n">foreign_shell_data</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>  <span class="c1"># make sure that we don&#39;t get prev src</span>
    <span class="n">fsenv</span><span class="p">,</span> <span class="n">fsaliases</span> <span class="o">=</span> <span class="n">foreign_shell_data</span><span class="p">(</span>
        <span class="n">shell</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">shell</span><span class="p">,</span>
        <span class="n">login</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
        <span class="n">interactive</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">interactive</span><span class="p">,</span>
        <span class="n">envcmd</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">envcmd</span><span class="p">,</span>
        <span class="n">aliascmd</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">aliascmd</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">extra_args</span><span class="p">,</span>
        <span class="n">safe</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">safe</span><span class="p">,</span>
        <span class="n">prevcmd</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">prevcmd</span><span class="p">,</span>
        <span class="n">postcmd</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">postcmd</span><span class="p">,</span>
        <span class="n">funcscmd</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">funcscmd</span><span class="p">,</span>
        <span class="n">sourcer</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">sourcer</span><span class="p">,</span>
        <span class="n">use_tmpfile</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">use_tmpfile</span><span class="p">,</span>
        <span class="n">seterrprevcmd</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">seterrprevcmd</span><span class="p">,</span>
        <span class="n">seterrpostcmd</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">seterrpostcmd</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">show</span><span class="p">,</span>
        <span class="n">dryrun</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">dryrun</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">fsenv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">dryrun</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;xonsh: error: Source failed: </span><span class="si">{0!r}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">prevcmd</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;xonsh: error: Possible reasons: File not found or syntax error</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># apply results</span>
    <span class="n">denv</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">detype</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fsenv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">denv</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="n">denv</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="k">continue</span>  <span class="c1"># no change from original</span>
        <span class="n">env</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="c1"># Remove any env-vars that were unset by the script.</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">denv</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fsenv</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Update aliases</span>
    <span class="n">baliases</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">aliases</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fsaliases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">baliases</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="n">baliases</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="k">continue</span>  <span class="c1"># no change from original</span>
        <span class="k">elif</span> <span class="n">ns</span><span class="o">.</span><span class="n">overwrite_aliases</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">baliases</span><span class="p">:</span>
            <span class="n">baliases</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="n">ns</span><span class="o">.</span><span class="n">suppress_skip_message</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Skipping application of </span><span class="si">{0!r}</span><span class="s2"> alias from </span><span class="si">{1!r}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;since it shares a name with an existing xonsh alias. &quot;</span>
                <span class="s1">&#39;Use &quot;--overwrite-alias&quot; option to apply it anyway.&#39;</span>
                <span class="s1">&#39;You may prevent this message with &quot;--suppress-skip-message&quot; or &#39;</span>
                <span class="s1">&#39;&quot;$FOREIGN_ALIASES_SUPPRESS_SKIP_MESSAGE = True&quot;.&#39;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">shell</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>


<span class="nd">@unthreadable</span>
<span class="k">def</span> <span class="nf">source_alias</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Executes the contents of the provided files in the current context.</span>
<span class="sd">    If sourced file isn&#39;t found in cwd, search for file along $PATH to source</span>
<span class="sd">    instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">locate_binary</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_DEBUG&quot;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;source: </span><span class="si">{}</span><span class="s2">: No such file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;must source at least one file, &quot;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot; does not exist.&quot;</span>
                    <span class="p">)</span>
                <span class="k">break</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">fext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fext</span> <span class="ow">and</span> <span class="n">fext</span> <span class="o">!=</span> <span class="s2">&quot;.xsh&quot;</span> <span class="ow">and</span> <span class="n">fext</span> <span class="o">!=</span> <span class="s2">&quot;.py&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;attempting to source non-xonsh file! If you are &quot;</span>
                <span class="s2">&quot;trying to source a file in another language, &quot;</span>
                <span class="s2">&quot;then please use the appropriate source command. &quot;</span>
                <span class="s2">&quot;For example, source-bash script.sh&quot;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">src</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">ctx</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__file__&quot;</span><span class="p">:</span> <span class="n">fpath</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fpath</span><span class="p">)}</span>
        <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="o">**</span><span class="n">make_args_env</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:])),</span> <span class="n">swap_values</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">XSH</span><span class="o">.</span><span class="n">builtins</span><span class="o">.</span><span class="n">execx</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">fpath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">print_color</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{RED}</span><span class="s2">You may be attempting to source non-xonsh file! &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{RESET}</span><span class="s2">If you are trying to source a file in &quot;</span>
                    <span class="s2">&quot;another language, then please use the appropriate &quot;</span>
                    <span class="s2">&quot;source command. For example, </span><span class="si">{GREEN}</span><span class="s2">source-bash &quot;</span>
                    <span class="s2">&quot;script.sh</span><span class="si">{RESET}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span>


<span class="k">def</span> <span class="nf">source_cmd</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple cmd.exe-specific wrapper around source-foreign.&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">locate_binary</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpath</span> <span class="k">if</span> <span class="n">fpath</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;xonsh: error: File not found: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">prevcmd</span> <span class="o">=</span> <span class="s2">&quot;call &quot;</span>
    <span class="n">prevcmd</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">argvquote</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
    <span class="n">prevcmd</span> <span class="o">=</span> <span class="n">escape_windows_cmd_string</span><span class="p">(</span><span class="n">prevcmd</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--prevcmd=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prevcmd</span><span class="p">))</span>
    <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--interactive=0&quot;</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--sourcer=call&quot;</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--envcmd=set&quot;</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--seterrpostcmd=if errorlevel 1 exit 1&quot;</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--use-tmpfile=1&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">PROMPT</span><span class="o">=</span><span class="s2">&quot;$P$G&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">source_foreign</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">xexec</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;exec [-h|--help] [-cl] [-a name] command [args...]</span>

<span class="sd">    exec (also aliased as xexec) uses the os.execvpe() function to</span>
<span class="sd">    replace the xonsh process with the specified program. This provides</span>
<span class="sd">    the functionality of the bash &#39;exec&#39; builtin::</span>

<span class="sd">        &gt;&gt;&gt; exec bash -l -i</span>
<span class="sd">        bash $</span>

<span class="sd">    The &#39;-h&#39; and &#39;--help&#39; options print this message and exit.</span>
<span class="sd">    If the &#39;-l&#39; option is supplied, the shell places a dash at the</span>
<span class="sd">    beginning of the zeroth argument passed to command to simulate login</span>
<span class="sd">    shell.</span>
<span class="sd">    The &#39;-c&#39; option causes command to be executed with an empty environment.</span>
<span class="sd">    If &#39;-a&#39; is supplied, the shell passes name as the zeroth argument</span>
<span class="sd">    to the executed command.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This command **is not** the same as the Python builtin function</span>
<span class="sd">    exec(). That function is for running Python code. This command,</span>
<span class="sd">    which shares the same name as the sh-lang statement, is for launching</span>
<span class="sd">    a command directly in the same process. In the event of a name conflict,</span>
<span class="sd">    please use the xexec command directly or dive into subprocess mode</span>
<span class="sd">    explicitly with ![exec command]. For more details, please see</span>
<span class="sd">    http://xon.sh/faq.html#exec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;xonsh: exec: no args specified</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">xexec</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;xonsh: exec: no command specified</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">command</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">login</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">denv</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">clean</span><span class="p">:</span>
        <span class="n">denv</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">detype</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execvpe</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">denv</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;xonsh: exec: file not found: </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">AWitchAWitch</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">SUPPRESS</span> <span class="o">=</span> <span class="s2">&quot;==SUPPRESS==&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">option_strings</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">SUPPRESS</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">SUPPRESS</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">option_strings</span><span class="o">=</span><span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">dest</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">webbrowser</span>

        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;https://github.com/xonsh/xonsh/commit/f49b400&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">xonfig</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs the xonsh configuration utility.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xonsh.xonfig</span> <span class="kn">import</span> <span class="n">xonfig_main</span>  <span class="c1"># lazy import</span>

    <span class="k">return</span> <span class="n">xonfig_main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="nd">@unthreadable</span>
<span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs the xonsh tracer utility.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xonsh.tracer</span> <span class="kn">import</span> <span class="n">tracermain</span>  <span class="c1"># lazy import</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tracermain</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">showcmd</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;usage: showcmd [-h|--help|cmd args]</span>

<span class="sd">    Displays the command and arguments as a list of strings that xonsh would</span>
<span class="sd">    run in subprocess mode. This is useful for determining how xonsh evaluates</span>
<span class="sd">    your commands and arguments prior to running these commands.</span>

<span class="sd">    optional arguments:</span>
<span class="sd">      -h, --help            show this help message and exit</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">      &gt;&gt;&gt; showcmd echo $USER &quot;can&#39;t&quot; hear &quot;the sea&quot;</span>
<span class="sd">      [&#39;echo&#39;, &#39;I&#39;, &quot;can&#39;t&quot;, &#39;hear&#39;, &#39;the sea&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;--help&quot;</span><span class="p">}):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">showcmd</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">displayhook</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">detect_xpip_alias</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the correct invocation to get xonsh&#39;s pip</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;executable&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">:</span> <span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sorry, unable to run pip on your system (missing sys.executable)&quot;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">basecmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;pip&quot;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ON_WINDOWS</span> <span class="ow">or</span> <span class="n">IN_APPIMAGE</span><span class="p">:</span>
            <span class="c1"># XXX: Does windows have an installation mode that requires UAC?</span>
            <span class="k">return</span> <span class="n">basecmd</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;sudo&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">basecmd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">basecmd</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Something freaky happened, return something that&#39;ll probably work</span>
        <span class="k">return</span> <span class="n">basecmd</span>


<span class="k">def</span> <span class="nf">make_default_aliases</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Creates a new default aliases dictionary.&quot;&quot;&quot;</span>
    <span class="n">default_aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cd&quot;</span><span class="p">:</span> <span class="n">cd</span><span class="p">,</span>
        <span class="s2">&quot;pushd&quot;</span><span class="p">:</span> <span class="n">pushd</span><span class="p">,</span>
        <span class="s2">&quot;popd&quot;</span><span class="p">:</span> <span class="n">popd</span><span class="p">,</span>
        <span class="s2">&quot;dirs&quot;</span><span class="p">:</span> <span class="n">dirs</span><span class="p">,</span>
        <span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="n">jobs</span><span class="p">,</span>
        <span class="s2">&quot;fg&quot;</span><span class="p">:</span> <span class="n">fg</span><span class="p">,</span>
        <span class="s2">&quot;bg&quot;</span><span class="p">:</span> <span class="n">bg</span><span class="p">,</span>
        <span class="s2">&quot;disown&quot;</span><span class="p">:</span> <span class="n">disown</span><span class="p">,</span>
        <span class="s2">&quot;EOF&quot;</span><span class="p">:</span> <span class="n">xonsh_exit</span><span class="p">,</span>
        <span class="s2">&quot;exit&quot;</span><span class="p">:</span> <span class="n">xonsh_exit</span><span class="p">,</span>
        <span class="s2">&quot;quit&quot;</span><span class="p">:</span> <span class="n">xonsh_exit</span><span class="p">,</span>
        <span class="s2">&quot;exec&quot;</span><span class="p">:</span> <span class="n">xexec</span><span class="p">,</span>
        <span class="s2">&quot;xexec&quot;</span><span class="p">:</span> <span class="n">xexec</span><span class="p">,</span>
        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source_alias</span><span class="p">,</span>
        <span class="s2">&quot;source-zsh&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;source-foreign&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">,</span> <span class="s2">&quot;--sourcer=source&quot;</span><span class="p">],</span>
        <span class="s2">&quot;source-bash&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;source-foreign&quot;</span><span class="p">,</span> <span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="s2">&quot;--sourcer=source&quot;</span><span class="p">],</span>
        <span class="s2">&quot;source-cmd&quot;</span><span class="p">:</span> <span class="n">source_cmd</span><span class="p">,</span>
        <span class="s2">&quot;source-foreign&quot;</span><span class="p">:</span> <span class="n">source_foreign</span><span class="p">,</span>
        <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="n">xhm</span><span class="o">.</span><span class="n">history_main</span><span class="p">,</span>
        <span class="s2">&quot;trace&quot;</span><span class="p">:</span> <span class="n">trace</span><span class="p">,</span>
        <span class="s2">&quot;timeit&quot;</span><span class="p">:</span> <span class="n">timeit_alias</span><span class="p">,</span>
        <span class="s2">&quot;umask&quot;</span><span class="p">:</span> <span class="n">umask</span><span class="p">,</span>
        <span class="s2">&quot;xonfig&quot;</span><span class="p">:</span> <span class="n">xonfig</span><span class="p">,</span>
        <span class="s2">&quot;scp-resume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;rsync&quot;</span><span class="p">,</span> <span class="s2">&quot;--partial&quot;</span><span class="p">,</span> <span class="s2">&quot;-h&quot;</span><span class="p">,</span> <span class="s2">&quot;--progress&quot;</span><span class="p">,</span> <span class="s2">&quot;--rsh=ssh&quot;</span><span class="p">],</span>
        <span class="s2">&quot;showcmd&quot;</span><span class="p">:</span> <span class="n">showcmd</span><span class="p">,</span>
        <span class="s2">&quot;ipynb&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;jupyter&quot;</span><span class="p">,</span> <span class="s2">&quot;notebook&quot;</span><span class="p">,</span> <span class="s2">&quot;--no-browser&quot;</span><span class="p">],</span>
        <span class="s2">&quot;which&quot;</span><span class="p">:</span> <span class="n">xxw</span><span class="o">.</span><span class="n">which</span><span class="p">,</span>
        <span class="s2">&quot;xontrib&quot;</span><span class="p">:</span> <span class="n">xontribs_main</span><span class="p">,</span>
        <span class="s2">&quot;completer&quot;</span><span class="p">:</span> <span class="n">xca</span><span class="o">.</span><span class="n">completer_alias</span><span class="p">,</span>
        <span class="s2">&quot;xpip&quot;</span><span class="p">:</span> <span class="n">detect_xpip_alias</span><span class="p">(),</span>
        <span class="s2">&quot;xonsh-reset&quot;</span><span class="p">:</span> <span class="n">xonsh_reset</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">ON_POSIX</span><span class="p">:</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;ulimit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ulimit</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="c1"># Borrow builtin commands from cmd.exe.</span>
        <span class="n">windows_cmd_aliases</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cls&quot;</span><span class="p">,</span>
            <span class="s2">&quot;copy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;del&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;echo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;erase&quot;</span><span class="p">,</span>
            <span class="s2">&quot;md&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mkdir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mklink&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ren&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rename&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rmdir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vol&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">windows_cmd_aliases</span><span class="p">:</span>
            <span class="n">default_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cmd&quot;</span><span class="p">,</span> <span class="s2">&quot;/c&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;call&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source-cmd&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;source-bat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source-cmd&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;clear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cls&quot;</span>
        <span class="k">if</span> <span class="n">ON_ANACONDA</span><span class="p">:</span>
            <span class="c1"># Add aliases specific to the Anaconda python distribution.</span>
            <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;activate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source-cmd&quot;</span><span class="p">,</span> <span class="s2">&quot;activate.bat&quot;</span><span class="p">]</span>
            <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;deactivate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source-cmd&quot;</span><span class="p">,</span> <span class="s2">&quot;deactivate.bat&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">locate_binary</span><span class="p">(</span><span class="s2">&quot;sudo&quot;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">xonsh.winutils</span> <span class="k">as</span> <span class="nn">winutils</span>

            <span class="k">def</span> <span class="nf">sudo</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;You need to provide an executable to run as &quot;</span> <span class="s2">&quot;Administrator.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">locate_binary</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">winutils</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">cmd</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">windows_cmd_aliases</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/D&quot;</span><span class="p">,</span> <span class="s2">&quot;/C&quot;</span><span class="p">,</span> <span class="s2">&quot;CD&quot;</span><span class="p">,</span> <span class="n">_get_cwd</span><span class="p">(),</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span>
                    <span class="k">return</span> <span class="n">winutils</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Cannot find the path for executable &quot;</span><span class="si">{0}</span><span class="s1">&quot;.&#39;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

            <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;sudo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sudo</span>
    <span class="k">elif</span> <span class="n">ON_DARWIN</span><span class="p">:</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">,</span> <span class="s2">&quot;-G&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ON_FREEBSD</span> <span class="ow">or</span> <span class="n">ON_DRAGONFLY</span><span class="p">:</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;grep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;grep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;egrep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;egrep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;fgrep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fgrep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">,</span> <span class="s2">&quot;-G&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ON_NETBSD</span><span class="p">:</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;grep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;grep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;egrep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;egrep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;fgrep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fgrep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ON_OPENBSD</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;grep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;grep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;egrep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;egrep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;fgrep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fgrep&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">]</span>
        <span class="n">default_aliases</span><span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">,</span> <span class="s2">&quot;--color=auto&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">default_aliases</span>

<span class="c1">#</span>
<span class="c1"># main</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The main xonsh script.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated sys</span>
<span class="n">enum</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;enum&#39;</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated argparse</span>
<span class="c1"># amalgamated builtins</span>
<span class="c1"># amalgamated contextlib</span>
<span class="c1"># amalgamated signal</span>
<span class="c1"># amalgamated traceback</span>
<span class="kn">from</span> <span class="nn">xonsh</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="c1"># amalgamated xonsh.timings</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.shell</span>
<span class="c1"># amalgamated xonsh.pretty</span>
<span class="c1"># amalgamated xonsh.execer</span>
<span class="c1"># amalgamated xonsh.jobs</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.codecache</span>
<span class="c1"># amalgamated xonsh.xonfig</span>
<span class="c1"># amalgamated xonsh.xontribs</span>
<span class="c1"># amalgamated xonsh.lazyimps</span>
<span class="c1"># amalgamated xonsh.imphooks</span>
<span class="c1"># amalgamated xonsh.events</span>
<span class="c1"># amalgamated xonsh.environ</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="n">xpp</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;xonsh&#39;</span><span class="p">,</span> <span class="s1">&#39;xonsh.procs.pipelines&#39;</span><span class="p">,</span> <span class="s1">&#39;xpp&#39;</span><span class="p">)</span>
<span class="n">events</span><span class="o">.</span><span class="n">transmogrify</span><span class="p">(</span><span class="s2">&quot;on_post_init&quot;</span><span class="p">,</span> <span class="s2">&quot;LoadEvent&quot;</span><span class="p">)</span>
<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_post_init&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_post_init() -&gt; None</span>

<span class="sd">Fired after all initialization is finished and we&#39;re ready to do work.</span>

<span class="sd">NOTE: This is fired before the wizard is automatically started.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">transmogrify</span><span class="p">(</span><span class="s2">&quot;on_exit&quot;</span><span class="p">,</span> <span class="s2">&quot;LoadEvent&quot;</span><span class="p">)</span>
<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_exit&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_exit() -&gt; None</span>

<span class="sd">Fired after all commands have been executed, before tear-down occurs.</span>

<span class="sd">NOTE: All the caveats of the ``atexit`` module also apply to this event.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">events</span><span class="o">.</span><span class="n">transmogrify</span><span class="p">(</span><span class="s2">&quot;on_pre_cmdloop&quot;</span><span class="p">,</span> <span class="s2">&quot;LoadEvent&quot;</span><span class="p">)</span>
<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_pre_cmdloop&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_pre_cmdloop() -&gt; None</span>

<span class="sd">Fired just before the command loop is started, if it is.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">transmogrify</span><span class="p">(</span><span class="s2">&quot;on_post_cmdloop&quot;</span><span class="p">,</span> <span class="s2">&quot;LoadEvent&quot;</span><span class="p">)</span>
<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_post_cmdloop&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_post_cmdloop() -&gt; None</span>

<span class="sd">Fired just after the command loop finishes, if it is.</span>

<span class="sd">NOTE: All the caveats of the ``atexit`` module also apply to this event.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">transmogrify</span><span class="p">(</span><span class="s2">&quot;on_pre_rc&quot;</span><span class="p">,</span> <span class="s2">&quot;LoadEvent&quot;</span><span class="p">)</span>
<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_pre_rc&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_pre_rc() -&gt; None</span>

<span class="sd">Fired just before rc files are loaded, if they are.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">events</span><span class="o">.</span><span class="n">transmogrify</span><span class="p">(</span><span class="s2">&quot;on_post_rc&quot;</span><span class="p">,</span> <span class="s2">&quot;LoadEvent&quot;</span><span class="p">)</span>
<span class="n">events</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span>
    <span class="s2">&quot;on_post_rc&quot;</span><span class="p">,</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">on_post_rc() -&gt; None</span>

<span class="sd">Fired just after rc files are loaded, if they are.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_setproctitle</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Proxy function for loading process title&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">setproctitle</span> <span class="kn">import</span> <span class="n">setproctitle</span> <span class="k">as</span> <span class="n">spt</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="n">spt</span>


<span class="k">def</span> <span class="nf">path_argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a path only if the path is actually legal</span>

<span class="sd">    This is very similar to argparse.FileType, except that it doesn&#39;t return</span>
<span class="sd">    an open file handle, but rather simply validates the path.&quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0!r}</span><span class="s2"> must be a valid path to a file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">parser</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;xonsh&quot;</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-h&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--help&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;help&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show help and exit.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-V&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--version&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show version information and exit.&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;xonsh/</span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run a single command and exit.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;command&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--interactive&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Force running in interactive mode.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;force_interactive&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-l&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--login&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run as a login shell.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;login&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--config-path&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;config_path&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">path_argument</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--rc&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The xonshrc files to load, these may be either xonsh &quot;</span>
        <span class="s2">&quot;files or JSON-based static configuration files.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;rc&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">path_argument</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-rc&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not load the .xonshrc files.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;norc&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-script-cache&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not cache scripts as they are run.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;scriptcache&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--cache-everything&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use a cache, even for interactive commands.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;cacheall&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-D&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;defines&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Define an environment variable, in the form of &quot;</span>
        <span class="s2">&quot;-DNAME=VAL. May be used many times.&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;ITEM&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--shell-type&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;What kind of shell should be used. &quot;</span>
        <span class="s2">&quot;Possible options: &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">shell_type_aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="o">+</span> <span class="s2">&quot;. Warning! If set this overrides $SHELL_TYPE variable.&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;SHELL_TYPE&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;shell_type&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">shell_type_aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--timings&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Prints timing information before the prompt is shown. &quot;</span>
        <span class="s2">&quot;This is useful while tracking down performance issues &quot;</span>
        <span class="s2">&quot;and investigating startup times.&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;timings&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;file&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;script-file&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If present, execute the script in script-file and exit.&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Additional arguments to the script specified by script-file.&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">REMAINDER</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">_pprint_displayhook</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">builtins</span><span class="o">.</span><span class="n">_</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Set &#39;_&#39; to None to avoid recursion</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">xpp</span><span class="o">.</span><span class="n">HiddenCommandPipeline</span><span class="p">):</span>
        <span class="n">builtins</span><span class="o">.</span><span class="n">_</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">printed_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PRETTY_PRINT_RESULTS&quot;</span><span class="p">):</span>
        <span class="n">printed_val</span> <span class="o">=</span> <span class="n">pretty</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">printed_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># pretty may fail (i.e for unittest.mock.Mock)</span>
        <span class="n">printed_val</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">HAS_PYGMENTS</span> <span class="ow">and</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COLOR_RESULTS&quot;</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pygments</span><span class="o">.</span><span class="n">lex</span><span class="p">(</span><span class="n">printed_val</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="n">pyghooks</span><span class="o">.</span><span class="n">XonshLexer</span><span class="p">()))</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SHELL_TYPE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;prompt_toolkit&quot;</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">print_color</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">printed_val</span><span class="p">)</span>  <span class="c1"># black &amp; white case</span>
    <span class="n">builtins</span><span class="o">.</span><span class="n">_</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">XonshMode</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">single_command</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">script_from_file</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">script_from_stdin</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">interactive</span> <span class="o">=</span> <span class="mi">3</span>


<span class="k">def</span> <span class="nf">start_services</span><span class="p">(</span><span class="n">shell_kwargs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pre_env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts up the essential services in the proper order.</span>
<span class="sd">    This returns the environment instance as a convenience.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pre_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pre_env</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">install_import_hooks</span><span class="p">()</span>
    <span class="c1"># create execer, which loads builtins</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">shell_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ctx&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">to_bool_or_int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;XONSH_DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">))</span>
    <span class="n">events</span><span class="o">.</span><span class="n">on_timingprobe</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;pre_execer_init&quot;</span><span class="p">)</span>
    <span class="n">execer</span> <span class="o">=</span> <span class="n">Execer</span><span class="p">(</span>
        <span class="n">xonsh_ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
        <span class="n">debug_level</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="n">scriptcache</span><span class="o">=</span><span class="n">shell_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scriptcache&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">cacheall</span><span class="o">=</span><span class="n">shell_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cacheall&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">events</span><span class="o">.</span><span class="n">on_timingprobe</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;post_execer_init&quot;</span><span class="p">)</span>
    <span class="c1"># load rc files</span>
    <span class="n">login</span> <span class="o">=</span> <span class="n">shell_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pre_env</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">env</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># determine which RC files to load, including whether any RC directories</span>
    <span class="c1"># should be scanned for such files</span>
    <span class="k">if</span> <span class="n">shell_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;norc&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">interactive</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">force_interactive</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">login</span>
    <span class="p">):</span>
        <span class="c1"># if --no-rc was passed, or we&#39;re not in an interactive shell and</span>
        <span class="c1"># interactive mode was not forced, then disable loading RC files and dirs</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">rcd</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="n">shell_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rc&quot;</span><span class="p">):</span>
        <span class="c1"># if an explicit --rc was passed, then we should load only that RC</span>
        <span class="c1"># file, and nothing else (ignore both XONSHRC and XONSHRC_DIR)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">shell_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rc&quot;</span><span class="p">)</span>
        <span class="n">rcd</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># otherwise, get the RC files from XONSHRC, and RC dirs from XONSHRC_DIR</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSHRC&quot;</span><span class="p">)</span>
        <span class="n">rcd</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSHRC_DIR&quot;</span><span class="p">)</span>

    <span class="n">events</span><span class="o">.</span><span class="n">on_pre_rc</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
    <span class="n">xonshrc_context</span><span class="p">(</span>
        <span class="n">rcfiles</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">rcdirs</span><span class="o">=</span><span class="n">rcd</span><span class="p">,</span> <span class="n">execer</span><span class="o">=</span><span class="n">execer</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="n">login</span>
    <span class="p">)</span>
    <span class="n">events</span><span class="o">.</span><span class="n">on_post_rc</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
    <span class="c1"># create shell</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">Shell</span><span class="p">(</span><span class="n">execer</span><span class="o">=</span><span class="n">execer</span><span class="p">,</span> <span class="o">**</span><span class="n">shell_kwargs</span><span class="p">)</span>
    <span class="n">ctx</span><span class="p">[</span><span class="s2">&quot;__name__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;__main__&quot;</span>
    <span class="k">return</span> <span class="n">env</span>


<span class="k">def</span> <span class="nf">premain</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setup for main xonsh entry point. Returns parsed arguments.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">argv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">setup_timings</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">setproctitle</span> <span class="o">=</span> <span class="n">get_setproctitle</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">setproctitle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">setproctitle</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;xonsh&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">))</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="n">shell_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;shell_type&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">shell_type</span><span class="p">,</span>
        <span class="s2">&quot;completer&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;scriptcache&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">scriptcache</span><span class="p">,</span>
        <span class="s2">&quot;cacheall&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">cacheall</span><span class="p">,</span>
        <span class="s2">&quot;ctx&quot;</span><span class="p">:</span> <span class="n">XSH</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">login</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
        <span class="n">args</span><span class="o">.</span><span class="n">login</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">norc</span><span class="p">:</span>
        <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;norc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">rc</span><span class="p">:</span>
        <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;rc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">rc</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">displayhook</span> <span class="o">=</span> <span class="n">_pprint_displayhook</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">single_command</span>
        <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;shell_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">script_from_file</span>
        <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;shell_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">force_interactive</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">script_from_stdin</span>
        <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;shell_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">interactive</span>
        <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;completer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">pre_env</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;XONSH_LOGIN&quot;</span><span class="p">:</span> <span class="n">shell_kwargs</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">],</span>
        <span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">force_interactive</span>
        <span class="ow">or</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">interactive</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">start_services</span><span class="p">(</span><span class="n">shell_kwargs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pre_env</span><span class="o">=</span><span class="n">pre_env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">defines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">defines</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">_failback_to_other_shells</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
    <span class="c1"># only failback for interactive shell; if we cannot tell, treat it</span>
    <span class="c1"># as an interactive one for safe.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">err</span>

    <span class="n">foreign_shell</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># look first in users login shell $SHELL.</span>
    <span class="c1"># use real os.environ, in case Xonsh hasn&#39;t initialized yet</span>
    <span class="c1"># but don&#39;t fail back to same shell that just failed.</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">env_shell</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SHELL&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_shell</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">env_shell</span><span class="p">)</span> <span class="ow">and</span> <span class="n">env_shell</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">foreign_shell</span> <span class="o">=</span> <span class="n">env_shell</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># otherwise, find acceptable shell from (unix) list of installed shells.</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">foreign_shell</span><span class="p">:</span>
        <span class="n">excluded_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xonsh&quot;</span><span class="p">,</span> <span class="s2">&quot;screen&quot;</span><span class="p">]</span>
        <span class="n">shells_file</span> <span class="o">=</span> <span class="s2">&quot;/etc/shells&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">shells_file</span><span class="p">):</span>
            <span class="c1"># right now, it will always break here on Windows</span>
            <span class="k">raise</span> <span class="n">err</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shells_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shell</span> <span class="ow">in</span> <span class="n">excluded_list</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">foreign_shell</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="n">foreign_shell</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Xonsh encountered an issue during launch&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failback to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">foreign_shell</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execlp</span><span class="p">(</span><span class="n">foreign_shell</span><span class="p">,</span> <span class="n">foreign_shell</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">err</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">premain</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main_xonsh</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">_failback_to_other_shells</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main_xonsh</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main entry point for xonsh cli.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">func_sig_ttin_ttou</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTTIN</span><span class="p">,</span> <span class="n">func_sig_ttin_ttou</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTTOU</span><span class="p">,</span> <span class="n">func_sig_ttin_ttou</span><span class="p">)</span>

    <span class="n">events</span><span class="o">.</span><span class="n">on_post_init</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">shell</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">history</span>
    <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">shell</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">]:</span>
        <span class="n">shell</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;exit&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">})</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="c1"># enter the shell</span>

            <span class="c1"># Setted again here because it is possible to call main_xonsh() without calling premain(), namely in the tests.</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">ignore_sigtstp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_INTERACTIVE&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSHRC&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">print_welcome_screen</span><span class="p">()</span>
            <span class="n">events</span><span class="o">.</span><span class="n">on_pre_cmdloop</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shell</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">cmdloop</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">events</span><span class="o">.</span><span class="n">on_post_cmdloop</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">single_command</span><span class="p">:</span>
            <span class="c1"># run a single command and exit</span>
            <span class="n">run_code_with_cache</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(),</span> <span class="n">shell</span><span class="o">.</span><span class="n">execer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">history</span><span class="o">.</span><span class="n">last_cmd_rtn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exit_code</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">last_cmd_rtn</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">script_from_file</span><span class="p">:</span>
            <span class="c1"># run a script contained in a file</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">args</span>
                <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">make_args_env</span><span class="p">())</span>  <span class="c1"># $ARGS is not sys.argv</span>
                <span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_SOURCE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">shell</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;__file__&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">:</span> <span class="s2">&quot;__main__&quot;</span><span class="p">})</span>
                <span class="n">run_script_with_cache</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">shell</span><span class="o">.</span><span class="n">execer</span><span class="p">,</span> <span class="n">glb</span><span class="o">=</span><span class="n">shell</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xonsh: </span><span class="si">{0}</span><span class="s2">: No such file or directory.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
                <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">XonshMode</span><span class="o">.</span><span class="n">script_from_stdin</span><span class="p">:</span>
            <span class="c1"># run a script given on stdin</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">run_code_with_cache</span><span class="p">(</span>
                <span class="n">code</span><span class="p">,</span> <span class="n">shell</span><span class="o">.</span><span class="n">execer</span><span class="p">,</span> <span class="n">glb</span><span class="o">=</span><span class="n">shell</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span>
            <span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_exit</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
    <span class="n">postmain</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exit_code</span>


<span class="k">def</span> <span class="nf">postmain</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Teardown for main xonsh entry point, accepts parsed arguments.&quot;&quot;&quot;</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="kc">None</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">main_context</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator that runs pre- and post-main() functions. This has two iterations.</span>
<span class="sd">    The first yields the shell. The second returns None but cleans</span>
<span class="sd">    up the shell.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">premain</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">XSH</span><span class="o">.</span><span class="n">shell</span>
    <span class="n">postmain</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">shell_type</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="p">((</span><span class="s2">&quot;RAISE_SUBPROC_ERROR&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),),</span>
    <span class="n">aliases</span><span class="o">=</span><span class="p">(),</span>
    <span class="n">xontribs</span><span class="o">=</span><span class="p">(),</span>
    <span class="n">threadable_predictors</span><span class="o">=</span><span class="p">(),</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts up a new xonsh shell. Calling this in function in another</span>
<span class="sd">    packages ``__init__.py`` will allow xonsh to be fully used in the</span>
<span class="sd">    package in headless or headed mode. This function is primarily indended to</span>
<span class="sd">    make starting up xonsh for 3rd party packages easier.</span>

<span class="sd">    Here is example of using this at the top of an ``__init__.py``::</span>

<span class="sd">        from xonsh.main import setup</span>
<span class="sd">        setup()</span>
<span class="sd">        del setup</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ctx : dict-like or None, optional</span>
<span class="sd">        The xonsh context to start with. If None, an empty dictionary</span>
<span class="sd">        is provided.</span>
<span class="sd">    shell_type : str, optional</span>
<span class="sd">        The type of shell to start. By default this is &#39;none&#39;, indicating</span>
<span class="sd">        we should start in headless mode.</span>
<span class="sd">    env : dict-like, optional</span>
<span class="sd">        Environment to update the current environment with after the shell</span>
<span class="sd">        has been initialized.</span>
<span class="sd">    aliases : dict-like, optional</span>
<span class="sd">        Aliases to add after the shell has been initialized.</span>
<span class="sd">    xontribs : iterable of str, optional</span>
<span class="sd">        Xontrib names to load.</span>
<span class="sd">    threadable_predictors : dict-like, optional</span>
<span class="sd">        Threadable predictors to start up with. These overide the defaults.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ctx</span>
    <span class="c1"># setup xonsh ctx and execer</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="s2">&quot;__xonsh__&quot;</span><span class="p">):</span>
        <span class="n">execer</span> <span class="o">=</span> <span class="n">Execer</span><span class="p">(</span><span class="n">xonsh_ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">XSH</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">execer</span><span class="o">=</span><span class="n">execer</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="n">Shell</span><span class="p">(</span><span class="n">execer</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">shell_type</span><span class="o">=</span><span class="n">shell_type</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">install_import_hooks</span><span class="p">()</span>
    <span class="n">XSH</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xontribs</span><span class="p">:</span>
        <span class="n">xontribs_load</span><span class="p">(</span><span class="n">xontribs</span><span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">commands_cache</span><span class="o">.</span><span class="n">threadable_predictors</span>
    <span class="n">tp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">threadable_predictors</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># readline_shell</span>
<span class="c1">#</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The readline based xonsh shell.</span>

<span class="sd">Portions of this code related to initializing the readline library</span>
<span class="sd">are included from the IPython project.  The IPython project is:</span>

<span class="sd">* Copyright (c) 2008-2014, IPython Development Team</span>
<span class="sd">* Copyright (c) 2001-2007, Fernando Perez &lt;fernando.perez@colorado.edu&gt;</span>
<span class="sd">* Copyright (c) 2001, Janko Hauser &lt;jhauser@zscout.de&gt;</span>
<span class="sd">* Copyright (c) 2001, Nathaniel Gray &lt;n8gray@caltech.edu&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated sys</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;cmd&#39;</span><span class="p">)</span>
<span class="n">select</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated shutil</span>
<span class="c1"># amalgamated importlib</span>
<span class="c1"># amalgamated threading</span>
<span class="c1"># amalgamated collections</span>
<span class="n">xct</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;xonsh&#39;</span><span class="p">,</span> <span class="s1">&#39;xonsh.completers.tools&#39;</span><span class="p">,</span> <span class="s1">&#39;xct&#39;</span><span class="p">)</span>
<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.base_shell</span>
<span class="c1"># amalgamated xonsh.ansi_colors</span>
<span class="c1"># amalgamated from xonsh.prompt.base import multiline_prompt</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.lazyimps</span>
<span class="c1"># amalgamated xonsh.events</span>
<span class="n">readline</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">RL_COMPLETION_SUPPRESS_APPEND</span> <span class="o">=</span> <span class="n">RL_LIB</span> <span class="o">=</span> <span class="n">RL_STATE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">RL_COMPLETION_QUERY_ITEMS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">RL_CAN_RESIZE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">RL_DONE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">RL_VARIABLE_VALUE</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_RL_STATE_DONE</span> <span class="o">=</span> <span class="mh">0x1000000</span>
<span class="n">_RL_STATE_ISEARCH</span> <span class="o">=</span> <span class="mh">0x0000080</span>

<span class="n">_RL_PREV_CASE_SENSITIVE_COMPLETIONS</span> <span class="o">=</span> <span class="s2">&quot;to-be-set&quot;</span>


<span class="k">def</span> <span class="nf">setup_readline</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Sets up the readline module and completion suppression, if available.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">RL_COMPLETION_SUPPRESS_APPEND</span><span class="p">,</span> <span class="n">RL_LIB</span><span class="p">,</span> <span class="n">RL_CAN_RESIZE</span><span class="p">,</span> <span class="n">RL_STATE</span><span class="p">,</span> <span class="n">readline</span><span class="p">,</span> <span class="n">RL_COMPLETION_QUERY_ITEMS</span>
    <span class="k">if</span> <span class="n">RL_COMPLETION_SUPPRESS_APPEND</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">_rlmod_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;gnureadline&quot;</span><span class="p">,</span> <span class="s2">&quot;readline&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">readline</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">_rlmod_name</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;readline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">readline</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">readline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;Skipping setup. Because no `readline` implementation available.</span>
<span class="sd">            Please install a backend (`readline`, `prompt-toolkit`, etc) to use</span>
<span class="sd">            `xonsh` interactively.</span>
<span class="sd">            See https://github.com/xonsh/xonsh/issues/1170&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="kn">import</span> <span class="nn">ctypes</span>
    <span class="kn">import</span> <span class="nn">ctypes.util</span>

    <span class="n">uses_libedit</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">and</span> <span class="s2">&quot;libedit&quot;</span> <span class="ow">in</span> <span class="n">readline</span><span class="o">.</span><span class="vm">__doc__</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">set_completer_delims</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\t\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Cygwin seems to hang indefinitely when querying the readline lib</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ON_CYGWIN</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ON_MSYS</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">readline</span><span class="o">.</span><span class="vm">__file__</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)):</span>
        <span class="n">RL_LIB</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">readline</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">RL_COMPLETION_SUPPRESS_APPEND</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span>
                <span class="n">lib</span><span class="p">,</span> <span class="s2">&quot;rl_completion_suppress_append&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># not all versions of readline have this symbol, ie Macs sometimes</span>
            <span class="n">RL_COMPLETION_SUPPRESS_APPEND</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">RL_COMPLETION_QUERY_ITEMS</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span>
                <span class="n">lib</span><span class="p">,</span> <span class="s2">&quot;rl_completion_query_items&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># not all versions of readline have this symbol, ie Macs sometimes</span>
            <span class="n">RL_COMPLETION_QUERY_ITEMS</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">RL_STATE</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="s2">&quot;rl_readline_state&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">RL_CAN_RESIZE</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="s2">&quot;rl_reset_screen_size&quot;</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="c1"># reads in history</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">set_history_length</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ReadlineHistoryAdder</span><span class="p">()</span>
    <span class="c1"># sets up IPython-like history matching with up and down</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">e[B&quot;: history-search-forward&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">e[A&quot;: history-search-backward&#39;</span><span class="p">)</span>
    <span class="c1"># Setup Shift-Tab to indent</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">e[Z&quot;: &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INDENT&quot;</span><span class="p">)))</span>

    <span class="c1"># handle tab completion differences found in libedit readline compatibility</span>
    <span class="c1"># as discussed at http://stackoverflow.com/a/7116997</span>
    <span class="k">if</span> <span class="n">uses_libedit</span> <span class="ow">and</span> <span class="n">ON_DARWIN</span><span class="p">:</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s2">&quot;bind ^I rl_complete&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">78</span><span class="p">,</span>
                    <span class="s2">&quot;libedit detected - readline will not be well behaved, including but not limited to:&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;   * crashes on tab completion&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;   * incorrect history navigation&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;   * corrupting long-lines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;   * failure to wrap or indent lines properly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;It is highly recommended that you install gnureadline, which is installable with:&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;     xpip install gnureadline&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">78</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s2">&quot;tab: complete&quot;</span><span class="p">)</span>
    <span class="c1"># try to load custom user settings</span>
    <span class="n">inputrc_name</span> <span class="o">=</span> <span class="n">os_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INPUTRC&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inputrc_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uses_libedit</span><span class="p">:</span>
            <span class="n">inputrc_name</span> <span class="o">=</span> <span class="s2">&quot;.editrc&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputrc_name</span> <span class="o">=</span> <span class="s2">&quot;.inputrc&quot;</span>
        <span class="n">inputrc_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="n">inputrc_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ON_WINDOWS</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inputrc_name</span><span class="p">)):</span>
        <span class="n">inputrc_name</span> <span class="o">=</span> <span class="s2">&quot;/etc/inputrc&quot;</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="n">winutils</span><span class="o">.</span><span class="n">enable_virtual_terminal_processing</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inputrc_name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">readline</span><span class="o">.</span><span class="n">read_init_file</span><span class="p">(</span><span class="n">inputrc_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># this seems to fail with libedit</span>
            <span class="n">print_exception</span><span class="p">(</span><span class="s2">&quot;xonsh: could not load readline default init file.&quot;</span><span class="p">)</span>

    <span class="c1"># Protection against paste jacking (issue #1154)</span>
    <span class="c1"># This must be set after the init file is loaded since read_init_file()</span>
    <span class="c1"># automatically disables bracketed paste</span>
    <span class="c1"># (https://github.com/python/cpython/pull/24108)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s2">&quot;set enable-bracketed-paste on&quot;</span><span class="p">)</span>

    <span class="c1"># properly reset input typed before the first prompt</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">set_startup_hook</span><span class="p">(</span><span class="n">carriage_return</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">teardown_readline</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Tears down up the readline module, if available.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">readline</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="k">return</span>


<span class="k">def</span> <span class="nf">_rebind_case_sensitive_completions</span><span class="p">():</span>
    <span class="c1"># handle case sensitive, see Github issue #1342 for details</span>
    <span class="k">global</span> <span class="n">_RL_PREV_CASE_SENSITIVE_COMPLETIONS</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CASE_SENSITIVE_COMPLETIONS&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">case_sensitive</span> <span class="ow">is</span> <span class="n">_RL_PREV_CASE_SENSITIVE_COMPLETIONS</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">case_sensitive</span><span class="p">:</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s2">&quot;set completion-ignore-case off&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s2">&quot;set completion-ignore-case on&quot;</span><span class="p">)</span>
    <span class="n">_RL_PREV_CASE_SENSITIVE_COMPLETIONS</span> <span class="o">=</span> <span class="n">case_sensitive</span>


<span class="k">def</span> <span class="nf">fix_readline_state_after_ctrl_c</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fix to allow Ctrl-C to exit reverse-i-search.</span>

<span class="sd">    Based on code from:</span>
<span class="sd">        http://bugs.python.org/file39467/raw_input__workaround_demo.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
        <span class="c1"># hack to make pyreadline mimic the desired behavior</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_q</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">rl</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">process_keyevent_queue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_q</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">RL_STATE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">RL_STATE</span><span class="o">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">_RL_STATE_ISEARCH</span><span class="p">:</span>
        <span class="n">RL_STATE</span><span class="o">.</span><span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_RL_STATE_ISEARCH</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">RL_STATE</span><span class="o">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">_RL_STATE_DONE</span><span class="p">:</span>
        <span class="n">RL_STATE</span><span class="o">.</span><span class="n">value</span> <span class="o">|=</span> <span class="n">_RL_STATE_DONE</span>


<span class="k">def</span> <span class="nf">rl_completion_suppress_append</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the rl_completion_suppress_append variable, if possible.</span>
<span class="sd">    A value of 1 (default) means to suppress, a value of 0 means to enable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">RL_COMPLETION_SUPPRESS_APPEND</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">RL_COMPLETION_SUPPRESS_APPEND</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">rl_completion_query_items</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the rl_completion_query_items variable, if possible.</span>
<span class="sd">    A None value will set this to $COMPLETION_QUERY_LIMIT, otherwise any integer</span>
<span class="sd">    is accepted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">RL_COMPLETION_QUERY_ITEMS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COMPLETION_QUERY_LIMIT&quot;</span><span class="p">)</span>
    <span class="n">RL_COMPLETION_QUERY_ITEMS</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">rl_variable_dumper</span><span class="p">(</span><span class="n">readable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dumps the currently set readline variables. If readable is True, then this</span>
<span class="sd">    output may be used in an inputrc file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">RL_LIB</span><span class="o">.</span><span class="n">rl_variable_dumper</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">readable</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">rl_variable_value</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the currently set value for a readline configuration variable.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">RL_VARIABLE_VALUE</span>
    <span class="k">if</span> <span class="n">RL_VARIABLE_VALUE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ctypes</span>

        <span class="n">RL_VARIABLE_VALUE</span> <span class="o">=</span> <span class="n">RL_LIB</span><span class="o">.</span><span class="n">rl_variable_value</span>
        <span class="n">RL_VARIABLE_VALUE</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
    <span class="n">enc</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING&quot;</span><span class="p">),</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_ENCODING_ERRORS&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
    <span class="n">rtn</span> <span class="o">=</span> <span class="n">RL_VARIABLE_VALUE</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rtn</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>


<span class="nd">@lazyobject</span>
<span class="k">def</span> <span class="nf">rl_on_new_line</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Grabs one of a few possible redisplay functions in readline.&quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rl_on_new_line&quot;</span><span class="p">,</span> <span class="s2">&quot;rl_forced_update_display&quot;</span><span class="p">,</span> <span class="s2">&quot;rl_redisplay&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">RL_LIB</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">print_for_newline</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="n">func</span> <span class="o">=</span> <span class="n">print_for_newline</span>
    <span class="k">return</span> <span class="n">func</span>


<span class="k">def</span> <span class="nf">_insert_text_func</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">readline</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a function to insert text via readline.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">inserter</span><span class="p">():</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">redisplay</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">inserter</span>


<span class="k">def</span> <span class="nf">_render_completions</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">prefix_len</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Render the completions according to the required prefix_len.</span>

<span class="sd">    Readline will replace the current prefix with the chosen rendered completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chopped</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[:</span><span class="o">-</span><span class="n">prefix_len</span><span class="p">]</span> <span class="k">if</span> <span class="n">prefix_len</span> <span class="k">else</span> <span class="n">prefix</span>

    <span class="n">rendered_completions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">completions</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">xct</span><span class="o">.</span><span class="n">RichCompletion</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">prefix_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">prefix_len</span><span class="p">:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[:</span> <span class="o">-</span><span class="n">comp</span><span class="o">.</span><span class="n">prefix_len</span><span class="p">]</span> <span class="o">+</span> <span class="n">comp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">comp</span>
        <span class="k">elif</span> <span class="n">chopped</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">chopped</span> <span class="o">+</span> <span class="n">comp</span>
        <span class="n">rendered_completions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rendered_completions</span>


<span class="n">DEDENT_TOKENS</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;raise&quot;</span><span class="p">,</span> <span class="s2">&quot;return&quot;</span><span class="p">,</span> <span class="s2">&quot;pass&quot;</span><span class="p">,</span> <span class="s2">&quot;break&quot;</span><span class="p">,</span> <span class="s2">&quot;continue&quot;</span><span class="p">]),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;DEDENT_TOKENS&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ReadlineShell</span><span class="p">(</span><span class="n">BaseShell</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">Cmd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The readline based xonsh shell.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completekey</span><span class="o">=</span><span class="s2">&quot;tab&quot;</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">completekey</span><span class="o">=</span><span class="n">completekey</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">setup_readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_force_hide</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_complete_only_last_table</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Truth table for completions, keys are:</span>
            <span class="c1"># (prefix_begs_quote, prefix_ends_quote, i_ends_quote,</span>
            <span class="c1">#  last_starts_with_prefix, i_has_space)</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdqueue</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">teardown_readline</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">singleline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_in_history</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads a single line of input. The store_in_history kwarg</span>
<span class="sd">        flags whether the input should be stored in readline&#39;s in-memory</span>
<span class="sd">        history.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">store_in_history</span><span class="p">:</span>  <span class="c1"># store current position to remove it later</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">readline</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">store_in_history</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_current_history_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_pre_prompt_format</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_pre_prompt</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
        <span class="n">rtn</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">events</span><span class="o">.</span><span class="n">on_post_prompt</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">store_in_history</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">readline</span><span class="o">.</span><span class="n">remove_history_item</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rtn</span>

    <span class="k">def</span> <span class="nf">parseline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overridden to no-op.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">_querycompletions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completions</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns whether or not we should show completions. 0 means that prefixes</span>
<span class="sd">        should not be shown, 1 means that there is a common prefix among all completions</span>
<span class="sd">        and they should be shown, while 2 means that there is no common prefix but</span>
<span class="sd">        we are under the query limit and they should be shown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">completions</span><span class="p">]):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">completions</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COMPLETION_QUERY_LIMIT&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Display all </span><span class="si">{}</span><span class="s2"> possibilities? &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">completions</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;(</span><span class="si">{GREEN}</span><span class="s2">y</span><span class="si">{RESET}</span><span class="s2"> or </span><span class="si">{RED}</span><span class="s2">n</span><span class="si">{RESET}</span><span class="s2">)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_color</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">yn</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
        <span class="k">while</span> <span class="n">yn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;yn&quot;</span><span class="p">:</span>
            <span class="n">yn</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">show_completions</span> <span class="o">=</span> <span class="n">to_bool</span><span class="p">(</span><span class="n">yn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_completions</span><span class="p">:</span>
            <span class="n">rl_on_new_line</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">columnize</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="n">more_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_color</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{YELLOW}</span><span class="s2">===</span><span class="si">{RESET}</span><span class="s2"> more or &quot;</span>
            <span class="s2">&quot;</span><span class="si">{PURPLE}</span><span class="s2">(</span><span class="si">{RESET}</span><span class="s2">q</span><span class="si">{PURPLE}</span><span class="s2">)</span><span class="si">{RESET}</span><span class="s2">uit &quot;</span>
            <span class="s2">&quot;</span><span class="si">{YELLOW}</span><span class="s2">===</span><span class="si">{RESET}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">more_msg</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">q</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
                <span class="n">rl_on_new_line</span><span class="p">()</span>
                <span class="k">return</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">rl_on_new_line</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">completedefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">begidx</span><span class="p">,</span> <span class="n">endidx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implements tab-completion for text.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">completer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">rl_completion_suppress_append</span><span class="p">()</span>  <span class="c1"># this needs to be called each time</span>
        <span class="n">_rebind_case_sensitive_completions</span><span class="p">()</span>
        <span class="n">rl_completion_query_items</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mi">999999999</span><span class="p">)</span>
        <span class="n">prev_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">completions</span><span class="p">,</span> <span class="n">plen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">completer</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="n">line</span><span class="p">,</span>
            <span class="n">begidx</span><span class="p">,</span>
            <span class="n">endidx</span><span class="p">,</span>
            <span class="n">ctx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span>
            <span class="n">multiline_text</span><span class="o">=</span><span class="n">prev_text</span> <span class="o">+</span> <span class="n">line</span><span class="p">,</span>
            <span class="n">cursor_index</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">prev_text</span><span class="p">)</span> <span class="o">+</span> <span class="n">endidx</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rtn_completions</span> <span class="o">=</span> <span class="n">_render_completions</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">plen</span><span class="p">)</span>

        <span class="n">rtn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prefix_begs_quote</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">prefix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="n">prefix_ends_quote</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rtn_completions</span><span class="p">:</span>
            <span class="n">i_ends_quote</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">last_starts_prefix</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">i_has_space</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">i</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">prefix_begs_quote</span><span class="p">,</span>
                <span class="n">prefix_ends_quote</span><span class="p">,</span>
                <span class="n">i_ends_quote</span><span class="p">,</span>
                <span class="n">last_starts_prefix</span><span class="p">,</span>
                <span class="n">i_has_space</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rtn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_only_last_table</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">else</span> <span class="n">i</span><span class="p">)</span>
        <span class="c1"># return based on show completions</span>
        <span class="n">show_completions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_querycompletions</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="n">endidx</span> <span class="o">-</span> <span class="n">begidx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_completions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">show_completions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rtn</span>
        <span class="k">elif</span> <span class="n">show_completions</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">completions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;query completions flag not understood.&quot;</span><span class="p">)</span>

    <span class="c1"># tab complete on first index too</span>
    <span class="n">completenames</span> <span class="o">=</span> <span class="n">completedefault</span>  <span class="c1"># type:ignore</span>

    <span class="k">def</span> <span class="nf">_load_remaining_input_into_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">buf</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmdqueue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">postcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called just before execution of line. For readline, this handles the</span>
<span class="sd">        automatic indentation of code blocks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">readline</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stop</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">elif</span> <span class="n">ends_with_colon_token</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())]</span>
                <span class="n">ind</span> <span class="o">+=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INDENT&quot;</span><span class="p">)</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="n">_insert_text_func</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">readline</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span> <span class="o">=</span> <span class="n">ind</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">DEDENT_TOKENS</span><span class="p">:</span>
                <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INDENT&quot;</span><span class="p">))]</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="n">_insert_text_func</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">readline</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span> <span class="o">=</span> <span class="n">ind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())]</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span><span class="p">:</span>
                    <span class="n">insert_func</span> <span class="o">=</span> <span class="n">_insert_text_func</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">readline</span><span class="p">)</span>
                    <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="n">insert_func</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span> <span class="o">=</span> <span class="n">ind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stop</span>

    <span class="k">def</span> <span class="nf">_cmdloop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intro</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Repeatedly issue a prompt, accept input, parse an initial prefix</span>
<span class="sd">        off the received input, and dispatch to action methods, passing them</span>
<span class="sd">        the remainder of the line as argument.</span>

<span class="sd">        This was forked from Lib/cmd.py from the Python standard library v3.4.3,</span>
<span class="sd">        (C) Python Software Foundation, 2015.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preloop</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rawinput</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">completekey</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">readline</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">old_completer</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_completer</span><span class="p">()</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_completer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">)</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completekey</span> <span class="o">+</span> <span class="s2">&quot;: complete&quot;</span><span class="p">)</span>
                <span class="n">have_readline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">have_readline</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">intro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intro</span> <span class="o">=</span> <span class="n">intro</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intro</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intro</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">exec_now</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdqueue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdqueue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                    <span class="n">exec_now</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rawinput</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exec_now</span><span class="p">:</span>
                    <span class="n">inserter</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="kc">None</span> <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_insert_text_func</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">readline</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">inserter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="n">inserter</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleline</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IGNOREEOF&quot;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Use &quot;exit&quot; to leave the shell.&#39;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;EOF&quot;</span>
                    <span class="k">if</span> <span class="n">inserter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_color</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">line</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">exec_now</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;EOF&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">have_readline</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;EOF&quot;</span><span class="p">:</span>
                        <span class="n">readline</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
                    <span class="c1"># select() is not fully functional on windows</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_remaining_input_into_queue</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precmd</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onecmd</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postcmd</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ON_WINDOWS</span><span class="p">:</span>
                    <span class="n">winutils</span><span class="o">.</span><span class="n">enable_virtual_terminal_processing</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postloop</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rawinput</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">completekey</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">readline</span>

                    <span class="n">readline</span><span class="o">.</span><span class="n">set_completer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_completer</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cmdloop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intro</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">XSH</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cmdloop</span><span class="p">(</span><span class="n">intro</span><span class="o">=</span><span class="n">intro</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">()</span>  <span class="c1"># Gives a newline</span>
                <span class="n">fix_readline_state_after_ctrl_c</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_buffer</span><span class="p">()</span>
                <span class="n">intro</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtains the current prompt string.&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">RL_LIB</span><span class="p">,</span> <span class="n">RL_CAN_RESIZE</span>
        <span class="k">if</span> <span class="n">RL_CAN_RESIZE</span><span class="p">:</span>
            <span class="c1"># This is needed to support some system where line-wrapping doesn&#39;t</span>
            <span class="c1"># work. This is a bug in upstream Python, or possibly readline.</span>
            <span class="n">RL_LIB</span><span class="o">.</span><span class="n">rl_reset_screen_size</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">need_more_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span> <span class="o">=</span> <span class="n">multiline_prompt</span><span class="p">(</span><span class="n">curr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_prompt</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                    <span class="n">print_exception</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span> <span class="o">=</span> <span class="s2">&quot;&lt;multiline prompt error&gt; &quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlprompt</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>  <span class="c1"># pylint: disable=no-member</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PROMPT&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_formatter</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="n">print_exception</span><span class="p">()</span>
        <span class="n">hide</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_hide</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_hide</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ansi_partial_color_format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">),</span> <span class="n">hide</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_prompt</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settitle</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">format_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Readline implementation of color formatting. This uses ANSI color</span>
<span class="sd">        codes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hide</span> <span class="o">=</span> <span class="n">hide</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_hide</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_hide</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ansi_partial_color_format</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="n">hide</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_color</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">hide</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># assume this is a list of (Token, str) tuples and format it</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span>
            <span class="n">style_overrides_env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_STYLE_OVERRIDES&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">styler</span><span class="o">.</span><span class="n">style_name</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">styler</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">style_overrides_env</span><span class="p">)</span>
            <span class="n">style_proxy</span> <span class="o">=</span> <span class="n">pyghooks</span><span class="o">.</span><span class="n">xonsh_style_proxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">styler</span><span class="p">)</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">pyghooks</span><span class="o">.</span><span class="n">XonshTerminal256Formatter</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style_proxy</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">color_style_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an iterable of all available style names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ansi_color_style_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">color_style</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the current color map.&quot;&quot;&quot;</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ansi_color_style</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restore_tty_sanity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An interface for resetting the TTY stdin mode. This is highly</span>
<span class="sd">        dependent on the shell backend. Also it is mostly optional since</span>
<span class="sd">        it only affects ^Z backgrounding behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ON_POSIX</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">stty</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">commands_cache</span><span class="o">.</span><span class="n">lazyget</span><span class="p">(</span><span class="s2">&quot;stty&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># If available, we should just call the stty utility. This call should</span>
        <span class="c1"># not throw even if stty fails. It should also be noted that subprocess</span>
        <span class="c1"># calls, like the following, seem to be ineffective:</span>
        <span class="c1">#       subprocess.call([stty, &#39;sane&#39;], shell=True)</span>
        <span class="c1"># My guess is that this is because Popen does some crazy redirecting</span>
        <span class="c1"># under the covers. This effectively hides the true TTY stdin handle</span>
        <span class="c1"># from stty. To get around this we have to use the lower level</span>
        <span class="c1"># os.system() function.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">stty</span> <span class="o">+</span> <span class="s2">&quot; sane&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ReadlineHistoryAdder</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait_for_gc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Thread responsible for adding inputs from history to the</span>
<span class="sd">        current readline instance. May wait for the history garbage</span>
<span class="sd">        collector to finish.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ReadlineHistoryAdder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_gc</span> <span class="o">=</span> <span class="n">wait_for_gc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">readline</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">XSH</span><span class="o">.</span><span class="n">history</span>
        <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hist</span><span class="o">.</span><span class="n">all_items</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_history_item</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">readline</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">RL_LIB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">RL_LIB</span><span class="o">.</span><span class="n">history_set_pos</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1">#</span>
<span class="c1"># tracer</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Implements a xonsh tracer.&quot;&quot;&quot;</span>
<span class="c1"># amalgamated os</span>
<span class="c1"># amalgamated re</span>
<span class="c1"># amalgamated sys</span>
<span class="c1"># amalgamated inspect</span>
<span class="c1"># amalgamated argparse</span>
<span class="c1"># amalgamated linecache</span>
<span class="c1"># amalgamated importlib</span>
<span class="c1"># amalgamated functools</span>
<span class="c1"># amalgamated typing</span>
<span class="c1"># amalgamated xonsh.lazyasd</span>
<span class="c1"># amalgamated xonsh.platform</span>
<span class="c1"># amalgamated xonsh.tools</span>
<span class="c1"># amalgamated xonsh.inspectors</span>
<span class="c1"># amalgamated xonsh.lazyimps</span>
<span class="c1"># amalgamated xonsh.procs.pipelines</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="n">_LazyModule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;xonsh&#39;</span><span class="p">,</span> <span class="s1">&#39;xonsh.prompt.cwd&#39;</span><span class="p">,</span> <span class="s1">&#39;prompt&#39;</span><span class="p">)</span>
<span class="n">terminal</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;pygments.formatters.terminal&quot;</span><span class="p">),</span>
    <span class="nb">globals</span><span class="p">(),</span>
    <span class="s2">&quot;terminal&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">TracerType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a xonsh tracer object, which keeps track of all tracing</span>
<span class="sd">    state. This is a singleton.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_inst</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;TracerType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">valid_events</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;call&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_inst</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TracerType</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inst</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_tracer</span> <span class="o">=</span> <span class="n">DefaultNotGiven</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usecolor</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span> <span class="o">=</span> <span class="n">pyghooks</span><span class="o">.</span><span class="n">XonshLexer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">TerminalFormatter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># filename, lineno tuple</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">color_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usecolor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specify whether or not the tracer output should be colored.&quot;&quot;&quot;</span>
        <span class="c1"># we have to use a function to set usecolor because of the way that</span>
        <span class="c1"># lazyasd works. Namely, it cannot dispatch setattr to the target</span>
        <span class="c1"># object without being unable to access its own __dict__. This makes</span>
        <span class="c1"># setting an attr look like getting a function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usecolor</span> <span class="o">=</span> <span class="n">usecolor</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts tracing a file.&quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_tracer</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
        <span class="n">files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">normabspath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">frame</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">normabspath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">f_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops tracing a file.&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">normabspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_tracer</span><span class="p">)</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">frame</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">normabspath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">frame</span><span class="o">.</span><span class="n">f_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_tracer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_tracer</span> <span class="o">=</span> <span class="n">DefaultNotGiven</span>

    <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implements a line tracing function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_events</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">find_file</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">tracer_format_line</span><span class="p">(</span>
                    <span class="n">fname</span><span class="p">,</span>
                    <span class="n">lineno</span><span class="p">,</span>
                    <span class="n">line</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usecolor</span><span class="p">,</span>
                    <span class="n">lexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lexer</span><span class="p">,</span>
                    <span class="n">formatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">print_color</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="n">curr</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span>


<span class="n">tracer</span> <span class="o">=</span> <span class="n">LazyObject</span><span class="p">(</span><span class="n">TracerType</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="s2">&quot;tracer&quot;</span><span class="p">)</span>

<span class="n">COLORLESS_LINE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{fname}</span><span class="s2">:</span><span class="si">{lineno}</span><span class="s2">:</span><span class="si">{line}</span><span class="s2">&quot;</span>
<span class="n">COLOR_LINE</span> <span class="o">=</span> <span class="s2">&quot;{{PURPLE}}</span><span class="si">{fname}</span><span class="s2">{{BLUE}}:&quot;</span> <span class="s2">&quot;{{GREEN}}</span><span class="si">{lineno}</span><span class="s2">{{BLUE}}:&quot;</span> <span class="s2">&quot;{{RESET}}&quot;</span>


<span class="k">def</span> <span class="nf">tracer_format_line</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Formats a trace line suitable for printing.&quot;&quot;&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">prompt</span><span class="o">.</span><span class="n">_replace_home</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">COLORLESS_LINE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>
    <span class="n">cline</span> <span class="o">=</span> <span class="n">COLOR_LINE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_PYGMENTS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cline</span> <span class="o">+</span> <span class="n">line</span>
    <span class="c1"># OK, so we have pygments</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">pyghooks</span><span class="o">.</span><span class="n">partial_color_tokenize</span><span class="p">(</span><span class="n">cline</span><span class="p">)</span>
    <span class="n">lexer</span> <span class="o">=</span> <span class="n">lexer</span> <span class="ow">or</span> <span class="n">pyghooks</span><span class="o">.</span><span class="n">XonshLexer</span><span class="p">()</span>
    <span class="n">tokens</span> <span class="o">+=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lex</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="n">lexer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">tokens</span>


<span class="c1">#</span>
<span class="c1"># Command line interface</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_find_caller</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Somewhat hacky method of finding the __file__ based on the line executed.&quot;&quot;&quot;</span>
    <span class="n">re_line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^;\s|&amp;&lt;&gt;]+\s+&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">3</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">re_line</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fname</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">lineno</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">re_line</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="c1"># There is a bug in CPython such that getouterframes(curr, context=1)</span>
            <span class="c1"># will actually return the 2nd line in the code_context field, even though</span>
            <span class="c1"># line number is itself correct. We manually fix that in this branch.</span>
            <span class="k">return</span> <span class="n">fname</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;xonsh: warning: __file__ name could not be found. You may be &quot;</span>
            <span class="s2">&quot;trying to trace interactively. Please pass in the file names &quot;</span>
            <span class="s2">&quot;you want to trace explicitly.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_on</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turns on tracing for files.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ns</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;__file__&quot;</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">_find_caller</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tracer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_off</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turns off tracing for files.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ns</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;__file__&quot;</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">_find_caller</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tracer</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_color</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manages color action for tracer CLI.&quot;&quot;&quot;</span>
    <span class="n">tracer</span><span class="o">.</span><span class="n">color_output</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">toggle</span><span class="p">)</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_tracer_create_parser</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Creates tracer argument parser&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="s2">&quot;trace&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;tool for tracing xonsh code as it runs.&quot;</span>
    <span class="p">)</span>
    <span class="n">subp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;action&quot;</span><span class="p">)</span>
    <span class="n">onp</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;begins tracing selected files.&quot;</span>
    <span class="p">)</span>
    <span class="n">onp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;files&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;__file__&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s1">&#39;file paths to watch, use &quot;__file__&quot; (default) to select &#39;</span>
            <span class="s2">&quot;the current file.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">off</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;del&quot;</span><span class="p">,</span> <span class="s2">&quot;rm&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;removes selected files fom tracing.&quot;</span>
    <span class="p">)</span>
    <span class="n">off</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;files&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;__file__&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s1">&#39;file paths to stop watching, use &quot;__file__&quot; (default) to &#39;</span>
            <span class="s2">&quot;select the current file.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">subp</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;output color management for tracer.&quot;</span><span class="p">)</span>
    <span class="n">col</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;toggle&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">to_bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;true/false, y/n, etc. to toggle color usage.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>


<span class="n">_TRACER_MAIN_ACTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;on&quot;</span><span class="p">:</span> <span class="n">_on</span><span class="p">,</span>
    <span class="s2">&quot;add&quot;</span><span class="p">:</span> <span class="n">_on</span><span class="p">,</span>
    <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">_on</span><span class="p">,</span>
    <span class="s2">&quot;rm&quot;</span><span class="p">:</span> <span class="n">_off</span><span class="p">,</span>
    <span class="s2">&quot;off&quot;</span><span class="p">:</span> <span class="n">_off</span><span class="p">,</span>
    <span class="s2">&quot;del&quot;</span><span class="p">:</span> <span class="n">_off</span><span class="p">,</span>
    <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="n">_off</span><span class="p">,</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">_color</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">tracermain</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main function for tracer command-line interface.&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">_tracer_create_parser</span><span class="p">()</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">usecolor</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">captured</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xpp</span><span class="o">.</span><span class="n">STDOUT_CAPTURE_KINDS</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span>
    <span class="n">tracer</span><span class="o">.</span><span class="n">color_output</span><span class="p">(</span><span class="n">usecolor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_TRACER_MAIN_ACTIONS</span><span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">action</span><span class="p">](</span><span class="n">ns</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># dumb_shell</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;A dumb shell for when $TERM == &#39;dumb&#39;, which usually happens in emacs.&quot;&quot;&quot;</span>

<span class="c1"># amalgamated from xonsh.built_ins import XSH</span>
<span class="c1"># amalgamated xonsh.readline_shell</span>
<span class="k">class</span> <span class="nc">DumbShell</span><span class="p">(</span><span class="n">ReadlineShell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dumb shell for when $TERM == &#39;dumb&#39;, which usually happens in emacs.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">XSH</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;XONSH_COLOR_STYLE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;emacs&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../../contents.html" title="contents">
          <img class="logo" src="../../_static/ascii_conch_part_transparent_tight.png" alt="Logo"/>
        </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../contents.html">xonsh 0.10.0.dev117.dev117 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">xonsh.__amalgam__</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Anthony Scopatz.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.1.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>